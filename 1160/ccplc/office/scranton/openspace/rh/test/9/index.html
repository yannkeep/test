<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlashForge ‚Äî ePOP!up</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-abyss:#010104;
  --bg-deep:#030308;
  --bg-dark:#080810;
  --bg-base:#0c0e1c;
  --bg-elevated:#12142a;
  --bg-surface:#181a32;
  --panel:rgba(12,14,28,0.8);
  --panel-solid:#0c0e1c;
  --border:#1e2040;
  --border-glow:rgba(177,156,217,0.4);
  --text:#e8eaf0;
  --text-dim:#8892b0;
  --text-muted:#5a6080;
  --lilac:#b19cd9;
  --lilac-bright:#d4c4ff;
  --lilac-dim:#8b7aaf;
  --green:#00ff88;
  --green-dim:#00cc6a;
  --cyan:#00f0ff;
  --magenta:#ff00aa;
  --purple:#8b5cf6;
  --danger:#ff4757;
  --warning:#ffa502;
  --sr-again:#ff4757;
  --sr-hard:#ffa502;
  --sr-good:#00ff88;
  --sr-easy:#00f0ff;
  --radius:10px;
  --radius-lg:14px;
  --radius-xl:20px;
  --font-mono:'Fira Code',monospace;
  --font-sans:'Space Grotesk',system-ui,sans-serif;
  --glow-lilac:0 0 30px rgba(177,156,217,0.5);
  --glow-green:0 0 30px rgba(0,255,136,0.5);
  --glow-cyan:0 0 25px rgba(0,240,255,0.4);
}

html,body{height:100%;overflow:hidden}
body{font-family:var(--font-mono);background:var(--bg-deep);color:var(--text)}

/* === BACKGROUND === */
.aurora{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.aurora::before{
  content:'';position:absolute;width:250%;height:250%;top:-75%;left:-75%;
  background:
    radial-gradient(ellipse 60% 40% at 25% 30%,rgba(177,156,217,0.12),transparent 50%),
    radial-gradient(ellipse 50% 35% at 75% 70%,rgba(0,255,136,0.08),transparent 50%),
    radial-gradient(ellipse 45% 30% at 50% 50%,rgba(0,240,255,0.06),transparent 50%);
  animation:auroraDrift 30s ease-in-out infinite;
}
@keyframes auroraDrift{
  0%,100%{transform:translate(0,0) rotate(0deg)}
  50%{transform:translate(2%,3%) rotate(1deg)}
}

.blob{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;mix-blend-mode:screen;opacity:0.4}
.blob-1{width:500px;height:500px;background:radial-gradient(circle,rgba(177,156,217,0.3),transparent 70%);top:-150px;left:-150px;animation:blobA 25s ease-in-out infinite}
.blob-2{width:400px;height:400px;background:radial-gradient(circle,rgba(0,255,136,0.25),transparent 70%);bottom:-100px;right:-100px;animation:blobB 30s ease-in-out infinite}
.blob-3{width:300px;height:300px;background:radial-gradient(circle,rgba(0,240,255,0.2),transparent 70%);top:50%;left:60%;animation:blobC 20s ease-in-out infinite}
@keyframes blobA{0%,100%{transform:translate(0,0)}50%{transform:translate(80px,60px)}}
@keyframes blobB{0%,100%{transform:translate(0,0)}50%{transform:translate(-60px,-50px)}}
@keyframes blobC{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.2)}}

.grid-bg{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background-image:linear-gradient(rgba(177,156,217,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(177,156,217,0.03) 1px,transparent 1px);
  background-size:60px 60px;
  mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black,transparent);
}

.scanline{
  position:fixed;top:0;left:0;width:100%;height:3px;
  background:linear-gradient(90deg,transparent,var(--lilac),var(--cyan),var(--green),var(--lilac),transparent);
  animation:scanMove 6s linear infinite;opacity:0.6;pointer-events:none;z-index:9998;
  box-shadow:0 0 20px rgba(177,156,217,0.5),0 0 40px rgba(0,240,255,0.3);
}
@keyframes scanMove{0%{transform:translateY(-100%)}100%{transform:translateY(100vh)}}

.crt{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.02) 2px,rgba(0,0,0,0.02) 4px);pointer-events:none;z-index:9997}

/* === APP LAYOUT === */
.app{position:relative;z-index:10;height:100vh;display:flex;flex-direction:column}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;
  background:var(--panel);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);
}
.header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--lilac-dim),var(--green-dim),var(--lilac-dim),transparent)}

.logo{display:flex;align-items:center;gap:0.75rem}
.logo-icon{
  width:42px;height:42px;background:linear-gradient(135deg,var(--lilac),var(--purple));
  border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1.4rem;
  box-shadow:var(--glow-lilac);
}
.logo-text{
  font-family:var(--font-sans);font-size:1.3rem;font-weight:700;letter-spacing:0.1em;
  background:linear-gradient(135deg,var(--lilac-bright),var(--cyan),var(--green));
  background-size:200% 200%;-webkit-background-clip:text;background-clip:text;color:transparent;
  animation:gradFlow 8s ease infinite;
}
@keyframes gradFlow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.logo-sub{font-size:0.65rem;color:var(--text-muted);letter-spacing:0.15em}

.nav{display:flex;gap:0.5rem}
.nav-btn{
  padding:0.55rem 1.1rem;background:transparent;border:1px solid transparent;border-radius:var(--radius);
  color:var(--text-dim);font-family:var(--font-mono);font-size:0.8rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;gap:0.4rem;
}
.nav-btn:hover{color:var(--text);background:rgba(177,156,217,0.1);border-color:var(--border)}
.nav-btn.active{color:var(--green);background:rgba(0,255,136,0.1);border-color:var(--green-dim);box-shadow:var(--glow-green)}

.actions{display:flex;gap:0.6rem}
.btn{
  padding:0.55rem 1rem;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text);font-family:var(--font-mono);font-size:0.8rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;gap:0.4rem;
}
.btn:hover{background:rgba(177,156,217,0.15);border-color:var(--lilac-dim);transform:translateY(-2px);box-shadow:var(--glow-lilac)}
.btn-primary{background:linear-gradient(135deg,var(--lilac-dim),var(--purple));border-color:var(--lilac);color:#fff}
.btn-primary:hover{background:linear-gradient(135deg,var(--lilac),var(--purple))}
.btn-success{background:rgba(0,255,136,0.15);border-color:var(--green-dim);color:var(--green)}
.btn-success:hover{background:rgba(0,255,136,0.25);border-color:var(--green);box-shadow:var(--glow-green)}

/* === MAIN === */
.main{flex:1;display:flex;overflow:hidden}

/* Sidebar */
.sidebar{
  width:260px;background:var(--panel);backdrop-filter:blur(20px);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
}
.sidebar-head{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.sidebar-title{font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em}
.sidebar-add{
  width:26px;height:26px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;
  color:var(--lilac);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-size:0.9rem;
}
.sidebar-add:hover{background:var(--lilac);color:var(--bg-deep);border-color:var(--lilac)}

.deck-list{flex:1;overflow-y:auto;padding:0.5rem}
.deck-item{
  padding:0.75rem 0.9rem;border-radius:var(--radius);margin-bottom:0.35rem;cursor:pointer;
  border:1px solid transparent;transition:all 0.2s;position:relative;
}
.deck-item:hover{background:rgba(177,156,217,0.08);border-color:var(--border)}
.deck-item.active{background:rgba(0,255,136,0.1);border-color:var(--green-dim)}
.deck-item.active .deck-name{color:var(--green)}
.deck-name{font-size:0.85rem;font-weight:500;margin-bottom:0.2rem}
.deck-meta{font-size:0.7rem;color:var(--text-muted);display:flex;gap:0.6rem}

.stats-box{padding:1rem;border-top:1px solid var(--border);background:var(--bg-elevated)}
.stats-title{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.6rem}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.4rem}
.stat{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:0.5rem;text-align:center}
.stat-val{font-family:var(--font-sans);font-size:1.1rem;font-weight:700;color:var(--lilac)}
.stat-val.g{color:var(--green)}.stat-val.c{color:var(--cyan)}.stat-val.o{color:var(--warning)}
.stat-lbl{font-size:0.55rem;color:var(--text-muted);text-transform:uppercase}

/* === CONTENT === */
.content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.view{display:none;flex:1;flex-direction:column;overflow:hidden}
.view.active{display:flex}

/* Cards header */
.cards-head{
  padding:1rem 1.5rem;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
}
.cards-info h2{font-family:var(--font-sans);font-size:1.05rem;font-weight:600}
.cards-info span{font-size:0.75rem;color:var(--text-muted)}
.search-box{
  display:flex;align-items:center;background:var(--bg-elevated);border:1px solid var(--border);
  border-radius:var(--radius);padding:0 0.7rem;transition:all 0.2s;
}
.search-box:focus-within{border-color:var(--lilac);box-shadow:var(--glow-lilac)}
.search-box span{color:var(--text-muted);margin-right:0.4rem}
.search-box input{
  background:none;border:none;color:var(--text);font-family:var(--font-mono);font-size:0.8rem;
  padding:0.5rem 0;width:160px;
}
.search-box input:focus{outline:none}
.search-box input::placeholder{color:var(--text-muted)}

/* Cards grid ‚Äî QUESTIONS ONLY */
.cards-scroll{flex:1;overflow-y:auto;padding:1.5rem}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}

.card-tile{
  background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1.2rem;cursor:pointer;transition:all 0.25s;position:relative;min-height:120px;
  display:flex;flex-direction:column;
}
.card-tile::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius-lg) var(--radius-lg) 0 0;
  background:linear-gradient(90deg,var(--lilac),var(--cyan));opacity:0;transition:opacity 0.2s;
}
.card-tile:hover{border-color:var(--lilac-dim);transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.3),var(--glow-lilac)}
.card-tile:hover::before{opacity:1}

.card-q{font-size:0.9rem;line-height:1.55;flex:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.card-foot{display:flex;justify-content:space-between;align-items:center;margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid var(--border)}
.card-level{display:flex;gap:3px}
.lvl-dot{width:8px;height:8px;border-radius:50%;background:var(--border)}
.lvl-dot.on{background:var(--green)}
.card-hint{font-size:0.65rem;color:var(--text-muted)}

/* Empty */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}
.empty-icon{font-size:3.5rem;margin-bottom:1rem;opacity:0.3}
.empty-title{font-family:var(--font-sans);font-size:1.15rem;font-weight:600;color:var(--text-dim);margin-bottom:0.4rem}
.empty-text{font-size:0.8rem;color:var(--text-muted);margin-bottom:1.5rem}

/* === CARD VIEWER MODAL (FLIP) === */
.card-viewer{
  position:fixed;inset:0;background:rgba(1,1,4,0.92);backdrop-filter:blur(12px);
  display:none;align-items:center;justify-content:center;z-index:1000;padding:2rem;
}
.card-viewer.open{display:flex}

.viewer-inner{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center}

.viewer-nav{display:flex;gap:0.5rem;margin-bottom:1.5rem}
.viewer-nav-btn{
  padding:0.5rem 1rem;background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text-dim);font-family:var(--font-mono);font-size:0.75rem;cursor:pointer;transition:all 0.2s;
}
.viewer-nav-btn:hover{color:var(--text);border-color:var(--lilac)}
.viewer-nav-btn:disabled{opacity:0.3;cursor:not-allowed}

.viewer-count{font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem}

/* Flashcard 3D ‚Äî OPAQUE */
.flashcard-wrap{perspective:1200px;width:100%}
.flashcard{
  width:100%;min-height:320px;position:relative;transform-style:preserve-3d;
  transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);cursor:pointer;
}
.flashcard.flipped{transform:rotateY(180deg)}

.fc-face{
  position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius-xl);
  padding:2.5rem 2rem;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
}

/* FRONT ‚Äî OPAQUE SOLID */
.fc-front{
  background:linear-gradient(145deg,#12142a 0%,#0c0e1c 100%);
  border:2px solid var(--lilac-dim);
  box-shadow:0 10px 40px rgba(0,0,0,0.5),inset 0 1px 0 rgba(177,156,217,0.1);
}

/* BACK ‚Äî OPAQUE SOLID DIFFERENT COLOR */
.fc-back{
  transform:rotateY(180deg);
  background:linear-gradient(145deg,#0a1a12 0%,#081510 100%);
  border:2px solid var(--green-dim);
  box-shadow:0 10px 40px rgba(0,0,0,0.5),inset 0 1px 0 rgba(0,255,136,0.1);
}

.fc-label{
  font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.2em;
  margin-bottom:1.5rem;
}
.fc-front .fc-label{color:var(--lilac-dim)}
.fc-back .fc-label{color:var(--green-dim)}

.fc-text{font-family:var(--font-sans);font-size:1.15rem;line-height:1.7}
.fc-front .fc-text{color:var(--text)}
.fc-back .fc-text{color:var(--green)}

.fc-hint{position:absolute;bottom:1rem;font-size:0.65rem;color:var(--text-muted)}

/* Viewer actions */
.viewer-actions{display:flex;gap:0.6rem;margin-top:2rem;flex-wrap:wrap;justify-content:center}
.rate-btn{
  padding:0.7rem 1.3rem;background:var(--panel-solid);border:2px solid var(--border);border-radius:var(--radius);
  font-family:var(--font-mono);font-size:0.85rem;cursor:pointer;transition:all 0.2s;
  display:flex;flex-direction:column;align-items:center;min-width:90px;
}
.rate-btn:hover{transform:translateY(-3px)}
.rate-btn.again{border-color:var(--sr-again);color:var(--sr-again)}
.rate-btn.again:hover{background:rgba(255,71,87,0.15);box-shadow:0 0 20px rgba(255,71,87,0.3)}
.rate-btn.hard{border-color:var(--sr-hard);color:var(--sr-hard)}
.rate-btn.hard:hover{background:rgba(255,165,2,0.15);box-shadow:0 0 20px rgba(255,165,2,0.3)}
.rate-btn.good{border-color:var(--sr-good);color:var(--sr-good)}
.rate-btn.good:hover{background:rgba(0,255,136,0.15);box-shadow:0 0 20px rgba(0,255,136,0.3)}
.rate-btn.easy{border-color:var(--sr-easy);color:var(--sr-easy)}
.rate-btn.easy:hover{background:rgba(0,240,255,0.15);box-shadow:0 0 20px rgba(0,240,255,0.3)}
.rate-btn span:last-child{font-size:0.6rem;color:var(--text-muted);margin-top:0.2rem}

.viewer-close{
  position:absolute;top:1.5rem;right:1.5rem;width:40px;height:40px;
  background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text-dim);font-size:1.3rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;
}
.viewer-close:hover{color:var(--danger);border-color:var(--danger)}

.viewer-edit{
  position:absolute;top:1.5rem;right:4.5rem;width:40px;height:40px;
  background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text-dim);font-size:1rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;
}
.viewer-edit:hover{color:var(--lilac);border-color:var(--lilac)}

.viewer-delete{
  position:absolute;top:1.5rem;right:7.5rem;width:40px;height:40px;
  background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text-dim);font-size:1rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;
}
.viewer-delete:hover{color:var(--danger);border-color:var(--danger)}

/* === STUDY VIEW === */
.study-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem}
.study-progress{width:100%;max-width:550px;margin-bottom:2rem}
.prog-bar{height:6px;background:var(--bg-elevated);border-radius:99px;overflow:hidden;margin-bottom:0.4rem}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--lilac),var(--green));transition:width 0.3s}
.prog-text{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted)}

.study-card-wrap{perspective:1200px;width:100%;max-width:550px}
.study-card{
  width:100%;min-height:300px;position:relative;transform-style:preserve-3d;
  transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);cursor:pointer;
}
.study-card.flipped{transform:rotateY(180deg)}

.study-actions{display:flex;gap:0.6rem;margin-top:2rem;flex-wrap:wrap;justify-content:center}

.study-complete{text-align:center;padding:3rem}
.complete-icon{font-size:4rem;margin-bottom:1rem;animation:popIn 0.5s ease}
@keyframes popIn{0%{transform:scale(0)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
.complete-title{font-family:var(--font-sans);font-size:1.8rem;font-weight:700;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:0.4rem}
.complete-sub{color:var(--text-dim);margin-bottom:2rem}
.complete-stats{display:flex;gap:2rem;justify-content:center;margin-bottom:2rem}
.cs{text-align:center}
.cs-val{font-family:var(--font-sans);font-size:2rem;font-weight:700}
.cs-val.g{color:var(--green)}.cs-val.o{color:var(--warning)}.cs-val.r{color:var(--danger)}
.cs-lbl{font-size:0.7rem;color:var(--text-muted)}

/* === MODALS === */
.modal-overlay{
  position:fixed;inset:0;background:rgba(1,1,4,0.9);backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;z-index:1100;padding:2rem;
}
.modal-overlay.open{display:flex}
.modal{
  background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius-xl);
  width:100%;max-width:480px;animation:modalIn 0.25s ease;box-shadow:0 20px 60px rgba(0,0,0,0.5),var(--glow-lilac);
}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-head{padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-family:var(--font-sans);font-size:1rem;font-weight:600}
.modal-x{
  width:30px;height:30px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;
  color:var(--text-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all 0.2s;
}
.modal-x:hover{color:var(--danger);border-color:var(--danger)}
.modal-body{padding:1.5rem;max-height:60vh;overflow-y:auto}
.modal-foot{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.6rem}

.form-group{margin-bottom:1.2rem}
.form-label{display:block;font-size:0.75rem;font-weight:500;color:var(--text-dim);margin-bottom:0.4rem}
.form-input,.form-textarea{
  width:100%;padding:0.7rem 0.9rem;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text);font-family:var(--font-mono);font-size:0.85rem;transition:all 0.2s;
}
.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--lilac);box-shadow:var(--glow-lilac)}
.form-textarea{min-height:100px;resize:vertical;line-height:1.6}

/* Import */
.import-zone{
  border:2px dashed var(--border);border-radius:var(--radius-lg);padding:2rem;text-align:center;
  cursor:pointer;transition:all 0.2s;background:var(--bg-dark);
}
.import-zone:hover{border-color:var(--lilac);background:rgba(177,156,217,0.05)}
.import-zone.dragover{border-color:var(--green);background:rgba(0,255,136,0.05)}
.import-icon{font-size:2.5rem;margin-bottom:0.8rem;color:var(--lilac-dim)}
.import-text{color:var(--text-dim);margin-bottom:0.3rem}
.import-hint{font-size:0.7rem;color:var(--text-muted)}

.import-preview{margin-top:1.5rem;padding:1rem;background:var(--bg-elevated);border-radius:var(--radius);display:none}
.import-preview.show{display:block}
.import-preview-title{font-size:0.75rem;color:var(--text-dim);margin-bottom:0.6rem}
.import-preview-list{max-height:150px;overflow-y:auto}
.import-preview-item{padding:0.5rem;background:var(--panel);border-radius:6px;margin-bottom:0.4rem;font-size:0.8rem}
.import-preview-q{color:var(--lilac)}
.import-count{margin-top:0.8rem;font-size:0.8rem;color:var(--green)}

/* === TOASTS === */
.toasts{position:fixed;bottom:1.5rem;right:1.5rem;z-index:2000;display:flex;flex-direction:column;gap:0.6rem}
.toast{
  padding:0.9rem 1.1rem;background:var(--panel-solid);border:1px solid var(--border);border-radius:var(--radius);
  display:flex;align-items:center;gap:0.6rem;animation:toastIn 0.3s ease;box-shadow:0 8px 30px rgba(0,0,0,0.4);min-width:250px;
}
@keyframes toastIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
.toast.success{border-color:var(--green-dim)}
.toast.error{border-color:var(--danger)}
.toast.info{border-color:var(--cyan)}
.toast-icon{font-size:1.1rem}
.toast.success .toast-icon{color:var(--green)}
.toast.error .toast-icon{color:var(--danger)}
.toast.info .toast-icon{color:var(--cyan)}
.toast-msg{flex:1;font-size:0.8rem}

/* === SCROLLBAR === */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg-base)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--lilac-dim)}

/* === RESPONSIVE === */
@media(max-width:800px){
  .sidebar{display:none}
  .cards-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="aurora"></div>
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>
<div class="grid-bg"></div>
<div class="scanline"></div>
<div class="crt"></div>

<div class="app">
  <header class="header">
    <div class="logo">
      <div class="logo-icon">‚ö°</div>
      <div>
        <div class="logo-text">FlashForge</div>
        <div class="logo-sub">M√©morisation Augment√©e</div>
      </div>
    </div>
    <nav class="nav">
      <button class="nav-btn active" data-view="cards"><span>üìö</span> Cartes</button>
      <button class="nav-btn" data-view="study"><span>üéØ</span> √âtudier</button>
    </nav>
    <div class="actions">
      <button class="btn" onclick="openImport()"><span>üì•</span> Import</button>
      <button class="btn" onclick="exportCSV()"><span>üì§</span> Export</button>
      <button class="btn btn-primary" onclick="openCardModal()"><span>‚ûï</span> Nouvelle</button>
    </div>
  </header>

  <main class="main">
    <aside class="sidebar">
      <div class="sidebar-head">
        <span class="sidebar-title">Mes Decks</span>
        <button class="sidebar-add" onclick="openDeckModal()">‚ûï</button>
      </div>
      <div class="deck-list" id="deckList"></div>
      <div class="stats-box">
        <div class="stats-title">Stats Globales</div>
        <div class="stats-grid">
          <div class="stat"><div class="stat-val" id="sTotal">0</div><div class="stat-lbl">Cartes</div></div>
          <div class="stat"><div class="stat-val g" id="sMaster">0</div><div class="stat-lbl">Ma√Ætris√©es</div></div>
          <div class="stat"><div class="stat-val c" id="sReview">0</div><div class="stat-lbl">√Ä revoir</div></div>
          <div class="stat"><div class="stat-val o" id="sNew">0</div><div class="stat-lbl">Nouvelles</div></div>
        </div>
      </div>
    </aside>

    <div class="content">
      <!-- CARDS VIEW -->
      <div class="view active" id="viewCards">
        <div class="cards-head">
          <div class="cards-info">
            <h2 id="deckTitle">Deck</h2>
            <span id="cardCount">0 cartes</span>
          </div>
          <div class="search-box">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="Rechercher...">
          </div>
        </div>
        <div class="cards-scroll">
          <div class="cards-grid" id="cardsGrid"></div>
        </div>
      </div>

      <!-- STUDY VIEW -->
      <div class="view" id="viewStudy">
        <div class="study-wrap" id="studyWrap"></div>
      </div>
    </div>
  </main>
</div>

<!-- CARD VIEWER -->
<div class="card-viewer" id="cardViewer">
  <button class="viewer-delete" onclick="deleteCurrentCard()" title="Supprimer">üóëÔ∏è</button>
  <button class="viewer-edit" onclick="editCurrentCard()" title="Modifier">‚úèÔ∏è</button>
  <button class="viewer-close" onclick="closeViewer()">√ó</button>
  <div class="viewer-inner">
    <div class="viewer-nav">
      <button class="viewer-nav-btn" onclick="viewerPrev()">‚Üê Pr√©c</button>
      <button class="viewer-nav-btn" onclick="viewerNext()">Suiv ‚Üí</button>
    </div>
    <div class="viewer-count" id="viewerCount">1 / 10</div>
    <div class="flashcard-wrap">
      <div class="flashcard" id="viewerCard" onclick="flipViewer()">
        <div class="fc-face fc-front">
          <div class="fc-label">Question</div>
          <div class="fc-text" id="viewerQ"></div>
          <div class="fc-hint">Cliquez pour retourner</div>
        </div>
        <div class="fc-face fc-back">
          <div class="fc-label">R√©ponse</div>
          <div class="fc-text" id="viewerA"></div>
        </div>
      </div>
    </div>
    <div class="viewer-actions" id="viewerActions">
      <button class="rate-btn again" onclick="rateViewer('again')"><span>üòì</span><span>√Ä revoir</span></button>
      <button class="rate-btn hard" onclick="rateViewer('hard')"><span>ü§î</span><span>Difficile</span></button>
      <button class="rate-btn good" onclick="rateViewer('good')"><span>üòä</span><span>Bien</span></button>
      <button class="rate-btn easy" onclick="rateViewer('easy')"><span>üöÄ</span><span>Facile</span></button>
    </div>
  </div>
</div>

<!-- MODAL: Card -->
<div class="modal-overlay" id="cardModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title" id="cardModalTitle">Nouvelle carte</span>
      <button class="modal-x" onclick="closeCardModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Question</label>
        <textarea class="form-textarea" id="inputQ" placeholder="Entrez la question..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">R√©ponse</label>
        <textarea class="form-textarea" id="inputA" placeholder="Entrez la r√©ponse..."></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeCardModal()">Annuler</button>
      <button class="btn btn-success" onclick="saveCard()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL: Deck -->
<div class="modal-overlay" id="deckModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">Nouveau deck</span>
      <button class="modal-x" onclick="closeDeckModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nom du deck</label>
        <input type="text" class="form-input" id="inputDeck" placeholder="Ex: Citoyennet√© Belge">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeDeckModal()">Annuler</button>
      <button class="btn btn-success" onclick="saveDeck()">üíæ Cr√©er</button>
    </div>
  </div>
</div>

<!-- MODAL: Import -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">Importer des cartes</span>
      <button class="modal-x" onclick="closeImport()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="import-zone" id="importZone">
        <div class="import-icon">üìÅ</div>
        <div class="import-text">Glissez un fichier CSV ici</div>
        <div class="import-hint">ou cliquez pour s√©lectionner</div>
      </div>
      <input type="file" id="importFile" accept=".csv" style="display:none">
      <div class="import-preview" id="importPreview">
        <div class="import-preview-title">Aper√ßu :</div>
        <div class="import-preview-list" id="importList"></div>
        <div class="import-count" id="importCount"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeImport()">Annuler</button>
      <button class="btn btn-success" id="importConfirm" onclick="confirmImport()" style="display:none">‚úÖ Importer</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// ============================================
// DATA
// ============================================
const DEMO = {
  id:'demo',
  name:'üáßüá™ Citoyennet√© Belge',
  cards:[
    {id:'d1',q:"Qu'est-ce que la particratie ?",a:"Syst√®me o√π le pouvoir r√©el appartient aux √©tats-majors des partis plut√¥t qu'aux √©lus ou citoyens.",level:0},
    {id:'d2',q:"Qu'est-ce que la 'lasagne institutionnelle' belge ?",a:"Superposition des niveaux de pouvoir : √âtat f√©d√©ral, 3 R√©gions, 3 Communaut√©s, 10 Provinces, 581 Communes.",level:0},
    {id:'d3',q:"Que signifie l'effet d√©volutif de la case de t√™te ?",a:"Cocher la case en t√™te de liste transf√®re une partie du vote aux candidats dans l'ordre choisi par le parti.",level:0},
    {id:'d4',q:"Qu'est-ce que le KERN ?",a:"Comit√© minist√©riel restreint r√©unissant le Premier Ministre et les Vice-Premiers Ministres de la coalition.",level:0},
    {id:'d5',q:"Qu'est-ce que le 'cordon sanitaire' ?",a:"Accord tacite entre partis traditionnels de ne pas gouverner avec l'extr√™me-droite (Vlaams Belang).",level:0},
    {id:'d6',q:"Qu'est-ce que le pre-bunking ?",a:"Technique de 'vaccination cognitive' : exposer par avance les m√©thodes de manipulation pour immuniser contre la d√©sinformation.",level:0},
    {id:'d7',q:"Qu'est-ce que la loi de Brandolini ?",a:"L'√©nergie pour r√©futer une connerie est sup√©rieure d'un ordre de grandeur √† celle pour la produire.",level:0},
    {id:'d8',q:"Que signifie OSINT ?",a:"Open Source Intelligence ‚Äî Renseignement obtenu √† partir de sources ouvertes et publiques.",level:0},
    {id:'d9',q:"Qu'est-ce que le mod√®le DIKW ?",a:"Data ‚Üí Information ‚Üí Knowledge ‚Üí Wisdom. Transformation de la donn√©e brute en sagesse actionnable.",level:0},
    {id:'d10',q:"Qu'est-ce que l'√âducation Permanente (d√©cret 2003) ?",a:"Cadre l√©gal permettant aux associations de recevoir des subsides pour des activit√©s d'analyse critique et transformation sociale.",level:0}
  ]
};

let data = {decks:[],currentDeck:null};
let viewerIndex = 0;
let viewerFlipped = false;
let editingId = null;
let pendingImport = [];

// ============================================
// STORAGE
// ============================================
function load(){
  try{
    const s = localStorage.getItem('flashforge');
    if(s){
      data = JSON.parse(s);
    }
    if(!data.decks.length){
      data.decks = [DEMO];
      data.currentDeck = DEMO.id;
      save();
    }
    if(!data.currentDeck) data.currentDeck = data.decks[0]?.id;
  }catch(e){
    data = {decks:[DEMO],currentDeck:DEMO.id};
  }
}

function save(){
  localStorage.setItem('flashforge',JSON.stringify(data));
}

function getDeck(){
  return data.decks.find(d=>d.id===data.currentDeck);
}

// ============================================
// CSV PARSER (ROBUST)
// ============================================
function parseCSV(text){
  const results = [];
  const lines = text.split(/\r?\n/);
  
  for(let line of lines){
    line = line.trim();
    if(!line) continue;
    
    let q = '', a = '', inQuote = false, field = 0, current = '';
    
    for(let i = 0; i < line.length; i++){
      const c = line[i];
      const next = line[i+1];
      
      if(c === '"' && !inQuote){
        inQuote = true;
      } else if(c === '"' && inQuote){
        if(next === '"'){
          current += '"';
          i++;
        } else {
          inQuote = false;
        }
      } else if(c === ',' && !inQuote){
        if(field === 0) q = current;
        else a = current;
        current = '';
        field++;
      } else {
        current += c;
      }
    }
    
    if(field === 0) q = current;
    else a = current;
    
    q = q.trim();
    a = a.trim();
    
    if(q && a){
      results.push({q, a});
    }
  }
  
  return results;
}

// ============================================
// RENDER
// ============================================
function render(){
  renderDecks();
  renderCards();
  renderStats();
}

function renderDecks(){
  const el = document.getElementById('deckList');
  el.innerHTML = data.decks.map(d=>{
    const active = d.id === data.currentDeck ? 'active' : '';
    const n = d.cards.length;
    const m = d.cards.filter(c=>c.level>=4).length;
    return `<div class="deck-item ${active}" onclick="selectDeck('${d.id}')">
      <div class="deck-name">${esc(d.name)}</div>
      <div class="deck-meta"><span>üìö ${n}</span><span>‚úÖ ${m}</span></div>
    </div>`;
  }).join('');
}

function renderCards(){
  const deck = getDeck();
  const grid = document.getElementById('cardsGrid');
  const title = document.getElementById('deckTitle');
  const count = document.getElementById('cardCount');
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  if(!deck){
    title.textContent = 'Aucun deck';
    count.textContent = '';
    grid.innerHTML = '<div class="empty"><div class="empty-icon">üìÅ</div><div class="empty-title">Aucun deck</div></div>';
    return;
  }
  
  title.textContent = deck.name;
  
  let cards = deck.cards;
  if(search){
    cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  }
  
  count.textContent = `${cards.length} carte${cards.length!==1?'s':''}`;
  
  if(!cards.length){
    grid.innerHTML = `<div class="empty">
      <div class="empty-icon">${search?'üîç':'üìù'}</div>
      <div class="empty-title">${search?'Aucun r√©sultat':'Deck vide'}</div>
      <div class="empty-text">${search?'Essayez d\'autres termes':'Ajoutez votre premi√®re carte'}</div>
      ${!search?'<button class="btn btn-success" onclick="openCardModal()">‚ûï Nouvelle carte</button>':''}
    </div>`;
    return;
  }
  
  // QUESTIONS ONLY - NO ANSWERS VISIBLE
  grid.innerHTML = cards.map((c,i)=>{
    const dots = Array(5).fill(0).map((_,j)=>`<div class="lvl-dot ${j<c.level?'on':''}"></div>`).join('');
    return `<div class="card-tile" onclick="openViewer(${i})">
      <div class="card-q">${esc(c.q)}</div>
      <div class="card-foot">
        <div class="card-level">${dots}</div>
        <div class="card-hint">Cliquez pour voir</div>
      </div>
    </div>`;
  }).join('');
}

function renderStats(){
  let total=0,master=0,review=0,newC=0;
  data.decks.forEach(d=>{
    d.cards.forEach(c=>{
      total++;
      if(c.level>=4) master++;
      else if(c.level===0) newC++;
      else review++;
    });
  });
  document.getElementById('sTotal').textContent = total;
  document.getElementById('sMaster').textContent = master;
  document.getElementById('sReview').textContent = review;
  document.getElementById('sNew').textContent = newC;
}

// ============================================
// VIEWER (FLIP CARD MODAL)
// ============================================
function openViewer(index){
  const deck = getDeck();
  if(!deck || !deck.cards.length) return;
  
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search){
    cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  }
  
  viewerIndex = index;
  viewerFlipped = false;
  
  updateViewer(cards);
  document.getElementById('cardViewer').classList.add('open');
}

function updateViewer(cards){
  if(!cards) {
    const deck = getDeck();
    const search = document.getElementById('searchInput').value.toLowerCase();
    cards = deck.cards;
    if(search){
      cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
    }
  }
  
  const card = cards[viewerIndex];
  if(!card) return;
  
  document.getElementById('viewerQ').textContent = card.q;
  document.getElementById('viewerA').textContent = card.a;
  document.getElementById('viewerCount').textContent = `${viewerIndex+1} / ${cards.length}`;
  
  const fc = document.getElementById('viewerCard');
  fc.classList.toggle('flipped', viewerFlipped);
  
  document.getElementById('viewerActions').style.display = viewerFlipped ? 'flex' : 'none';
}

function flipViewer(){
  viewerFlipped = !viewerFlipped;
  document.getElementById('viewerCard').classList.toggle('flipped', viewerFlipped);
  document.getElementById('viewerActions').style.display = viewerFlipped ? 'flex' : 'none';
}

function viewerPrev(){
  const deck = getDeck();
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search) cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  
  if(viewerIndex > 0){
    viewerIndex--;
    viewerFlipped = false;
    updateViewer(cards);
  }
}

function viewerNext(){
  const deck = getDeck();
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search) cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  
  if(viewerIndex < cards.length - 1){
    viewerIndex++;
    viewerFlipped = false;
    updateViewer(cards);
  }
}

function rateViewer(rating){
  const deck = getDeck();
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search) cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  
  const card = cards[viewerIndex];
  const realCard = deck.cards.find(c=>c.id===card.id);
  
  if(realCard){
    switch(rating){
      case 'again': realCard.level = Math.max(0, realCard.level - 1); break;
      case 'hard': break;
      case 'good': realCard.level = Math.min(5, realCard.level + 1); break;
      case 'easy': realCard.level = Math.min(5, realCard.level + 2); break;
    }
    save();
    render();
  }
  
  // Next card
  if(viewerIndex < cards.length - 1){
    viewerIndex++;
    viewerFlipped = false;
    updateViewer(cards);
  } else {
    closeViewer();
    toast('Session termin√©e !', 'success');
  }
}

function closeViewer(){
  document.getElementById('cardViewer').classList.remove('open');
  viewerFlipped = false;
}

function editCurrentCard(){
  const deck = getDeck();
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search) cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  
  const card = cards[viewerIndex];
  if(card){
    closeViewer();
    openCardModal(card.id);
  }
}

function deleteCurrentCard(){
  const deck = getDeck();
  const search = document.getElementById('searchInput').value.toLowerCase();
  let cards = deck.cards;
  if(search) cards = cards.filter(c=>c.q.toLowerCase().includes(search)||c.a.toLowerCase().includes(search));
  
  const card = cards[viewerIndex];
  if(card && confirm('Supprimer cette carte ?')){
    deck.cards = deck.cards.filter(c=>c.id !== card.id);
    save();
    closeViewer();
    render();
    toast('Carte supprim√©e', 'info');
  }
}

// ============================================
// STUDY MODE
// ============================================
let studyQueue = [];
let studyIndex = 0;
let studyFlipped = false;
let studyStats = {again:0,hard:0,good:0,easy:0};

function startStudy(){
  const deck = getDeck();
  if(!deck || !deck.cards.length){
    toast('Aucune carte', 'error');
    return;
  }
  
  studyQueue = [...deck.cards].sort((a,b)=>a.level-b.level);
  studyIndex = 0;
  studyFlipped = false;
  studyStats = {again:0,hard:0,good:0,easy:0};
  
  renderStudy();
}

function renderStudy(){
  const wrap = document.getElementById('studyWrap');
  const deck = getDeck();
  
  if(!studyQueue.length){
    wrap.innerHTML = `<div class="empty">
      <div class="empty-icon">üéØ</div>
      <div class="empty-title">Pr√™t √† √©tudier ?</div>
      <div class="empty-text">Lancez une session pour r√©viser vos cartes</div>
      <button class="btn btn-success" onclick="startStudy()">üöÄ Commencer</button>
    </div>`;
    return;
  }
  
  if(studyIndex >= studyQueue.length){
    const total = studyStats.again+studyStats.hard+studyStats.good+studyStats.easy;
    wrap.innerHTML = `<div class="study-complete">
      <div class="complete-icon">üéâ</div>
      <div class="complete-title">Session termin√©e !</div>
      <div class="complete-sub">${total} cartes r√©vis√©es</div>
      <div class="complete-stats">
        <div class="cs"><div class="cs-val g">${studyStats.good+studyStats.easy}</div><div class="cs-lbl">R√©ussies</div></div>
        <div class="cs"><div class="cs-val o">${studyStats.hard}</div><div class="cs-lbl">Difficiles</div></div>
        <div class="cs"><div class="cs-val r">${studyStats.again}</div><div class="cs-lbl">√Ä revoir</div></div>
      </div>
      <button class="btn btn-primary" onclick="startStudy()">üîÑ Recommencer</button>
    </div>`;
    return;
  }
  
  const card = studyQueue[studyIndex];
  const pct = (studyIndex/studyQueue.length)*100;
  
  wrap.innerHTML = `
    <div class="study-progress">
      <div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
      <div class="prog-text"><span>${studyIndex+1} / ${studyQueue.length}</span><span>Niveau: ${card.level}/5</span></div>
    </div>
    <div class="study-card-wrap">
      <div class="study-card ${studyFlipped?'flipped':''}" onclick="flipStudy()">
        <div class="fc-face fc-front">
          <div class="fc-label">Question</div>
          <div class="fc-text">${esc(card.q)}</div>
          <div class="fc-hint">Cliquez pour retourner</div>
        </div>
        <div class="fc-face fc-back">
          <div class="fc-label">R√©ponse</div>
          <div class="fc-text">${esc(card.a)}</div>
        </div>
      </div>
    </div>
    ${studyFlipped?`<div class="study-actions">
      <button class="rate-btn again" onclick="rateStudy('again')"><span>üòì</span><span>√Ä revoir</span></button>
      <button class="rate-btn hard" onclick="rateStudy('hard')"><span>ü§î</span><span>Difficile</span></button>
      <button class="rate-btn good" onclick="rateStudy('good')"><span>üòä</span><span>Bien</span></button>
      <button class="rate-btn easy" onclick="rateStudy('easy')"><span>üöÄ</span><span>Facile</span></button>
    </div>`:''}
  `;
}

function flipStudy(){
  studyFlipped = !studyFlipped;
  renderStudy();
}

function rateStudy(rating){
  const card = studyQueue[studyIndex];
  const deck = getDeck();
  const realCard = deck.cards.find(c=>c.id===card.id);
  
  if(realCard){
    switch(rating){
      case 'again': realCard.level = Math.max(0, realCard.level-1); studyStats.again++; break;
      case 'hard': studyStats.hard++; break;
      case 'good': realCard.level = Math.min(5, realCard.level+1); studyStats.good++; break;
      case 'easy': realCard.level = Math.min(5, realCard.level+2); studyStats.easy++; break;
    }
    save();
    render();
  }
  
  studyIndex++;
  studyFlipped = false;
  renderStudy();
}

// ============================================
// DECK CRUD
// ============================================
function selectDeck(id){
  data.currentDeck = id;
  save();
  render();
}

function openDeckModal(){
  document.getElementById('inputDeck').value = '';
  document.getElementById('deckModal').classList.add('open');
}

function closeDeckModal(){
  document.getElementById('deckModal').classList.remove('open');
}

function saveDeck(){
  const name = document.getElementById('inputDeck').value.trim();
  if(!name){
    toast('Nom requis', 'error');
    return;
  }
  
  const newDeck = {
    id: 'deck-'+Date.now(),
    name: name,
    cards: []
  };
  
  data.decks.push(newDeck);
  data.currentDeck = newDeck.id;
  save();
  closeDeckModal();
  render();
  toast('Deck cr√©√© !', 'success');
}

// ============================================
// CARD CRUD
// ============================================
function openCardModal(cardId = null){
  editingId = cardId;
  const modal = document.getElementById('cardModal');
  const title = document.getElementById('cardModalTitle');
  const qInput = document.getElementById('inputQ');
  const aInput = document.getElementById('inputA');
  
  if(cardId){
    title.textContent = 'Modifier la carte';
    const deck = getDeck();
    const card = deck?.cards.find(c=>c.id===cardId);
    if(card){
      qInput.value = card.q;
      aInput.value = card.a;
    }
  } else {
    title.textContent = 'Nouvelle carte';
    qInput.value = '';
    aInput.value = '';
  }
  
  modal.classList.add('open');
  qInput.focus();
}

function closeCardModal(){
  document.getElementById('cardModal').classList.remove('open');
  editingId = null;
}

function saveCard(){
  const q = document.getElementById('inputQ').value.trim();
  const a = document.getElementById('inputA').value.trim();
  
  if(!q || !a){
    toast('Question et r√©ponse requises', 'error');
    return;
  }
  
  const deck = getDeck();
  if(!deck){
    toast('S√©lectionnez un deck', 'error');
    return;
  }
  
  if(editingId){
    const card = deck.cards.find(c=>c.id===editingId);
    if(card){
      card.q = q;
      card.a = a;
    }
    toast('Carte modifi√©e !', 'success');
  } else {
    deck.cards.push({
      id: 'card-'+Date.now(),
      q: q,
      a: a,
      level: 0
    });
    toast('Carte cr√©√©e !', 'success');
  }
  
  save();
  closeCardModal();
  render();
}

// ============================================
// IMPORT
// ============================================
function openImport(){
  pendingImport = [];
  document.getElementById('importPreview').classList.remove('show');
  document.getElementById('importConfirm').style.display = 'none';
  document.getElementById('importModal').classList.add('open');
}

function closeImport(){
  document.getElementById('importModal').classList.remove('open');
}

function handleImportFile(file){
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target.result;
      pendingImport = parseCSV(text);
      
      if(pendingImport.length === 0){
        toast('Aucune carte trouv√©e dans le fichier', 'error');
        return;
      }
      
      // Show preview
      const preview = document.getElementById('importPreview');
      const list = document.getElementById('importList');
      const count = document.getElementById('importCount');
      
      list.innerHTML = pendingImport.slice(0,5).map(c=>`
        <div class="import-preview-item">
          <span class="import-preview-q">Q:</span> ${esc(c.q.substring(0,60))}${c.q.length>60?'...':''}
        </div>
      `).join('');
      
      count.textContent = `${pendingImport.length} cartes d√©tect√©es`;
      preview.classList.add('show');
      document.getElementById('importConfirm').style.display = 'block';
      
    } catch(err) {
      console.error(err);
      toast('Erreur de lecture du fichier', 'error');
    }
  };
  reader.readAsText(file);
}

function confirmImport(){
  const deck = getDeck();
  if(!deck){
    toast('S√©lectionnez un deck', 'error');
    return;
  }
  
  let imported = 0;
  pendingImport.forEach(c=>{
    deck.cards.push({
      id: 'card-'+Date.now()+'-'+Math.random().toString(36).substr(2,6),
      q: c.q,
      a: c.a,
      level: 0
    });
    imported++;
  });
  
  save();
  closeImport();
  render();
  toast(`${imported} cartes import√©es !`, 'success');
}

// ============================================
// EXPORT
// ============================================
function exportCSV(){
  const deck = getDeck();
  if(!deck || !deck.cards.length){
    toast('Aucune carte √† exporter', 'error');
    return;
  }
  
  const csv = deck.cards.map(c=>{
    const q = c.q.replace(/"/g,'""');
    const a = c.a.replace(/"/g,'""');
    return `"${q}","${a}"`;
  }).join('\n');
  
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${deck.name.replace(/[^a-z0-9]/gi,'_')}.csv`;
  link.click();
  URL.revokeObjectURL(url);
  
  toast('Deck export√© !', 'success');
}

// ============================================
// UTILS
// ============================================
function esc(s){
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toast(msg, type='info'){
  const container = document.getElementById('toasts');
  const icons = {success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-msg">${msg}</span>`;
  container.appendChild(t);
  setTimeout(()=>{
    t.style.opacity='0';
    t.style.transform='translateX(100px)';
    setTimeout(()=>t.remove(),300);
  },3000);
}

function switchView(v){
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');
  document.querySelector(`[data-view="${v}"]`).classList.add('active');
  
  if(v==='study'){
    if(!studyQueue.length) startStudy();
    else renderStudy();
  }
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded',()=>{
  load();
  render();
  
  // Nav
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>switchView(btn.dataset.view));
  });
  
  // Search
  document.getElementById('searchInput').addEventListener('input', renderCards);
  
  // Import zone
  const zone = document.getElementById('importZone');
  const fileInput = document.getElementById('importFile');
  
  zone.addEventListener('click',()=>fileInput.click());
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('dragover')});
  zone.addEventListener('dragleave',()=>zone.classList.remove('dragover'));
  zone.addEventListener('drop',e=>{
    e.preventDefault();
    zone.classList.remove('dragover');
    if(e.dataTransfer.files[0]) handleImportFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change',e=>{
    if(e.target.files[0]) handleImportFile(e.target.files[0]);
  });
  
  // Keyboard
  document.addEventListener('keydown',e=>{
    // Viewer open
    if(document.getElementById('cardViewer').classList.contains('open')){
      if(e.code==='Space'){e.preventDefault();flipViewer()}
      if(e.key==='ArrowLeft') viewerPrev();
      if(e.key==='ArrowRight') viewerNext();
      if(e.key==='Escape') closeViewer();
      if(viewerFlipped){
        if(e.key==='1') rateViewer('again');
        if(e.key==='2') rateViewer('hard');
        if(e.key==='3') rateViewer('good');
        if(e.key==='4') rateViewer('easy');
      }
      return;
    }
    
    // Study view
    if(document.getElementById('viewStudy').classList.contains('active')){
      if(e.code==='Space'){e.preventDefault();flipStudy()}
      if(studyFlipped){
        if(e.key==='1') rateStudy('again');
        if(e.key==='2') rateStudy('hard');
        if(e.key==='3') rateStudy('good');
        if(e.key==='4') rateStudy('easy');
      }
    }
    
    // General
    if(e.key==='Escape'){
      closeCardModal();
      closeDeckModal();
      closeImport();
    }
    if(e.ctrlKey && e.key==='n'){
      e.preventDefault();
      openCardModal();
    }
  });
});
</script>

</body>
</html>
