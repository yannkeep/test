<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plaidoyer Citoyen</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.2.0/build/index.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0a0a0b;--panel:#111318;--card:#1a1d24;--input:#22262f;
--border:#2d323c;--text:#f0f0f2;--muted:#888;
--accent:#f59e0b;--accent2:#d97706;
--success:#22c55e;--danger:#ef4444;--info:#3b82f6;
--voir:#0ea5e9;--juger:#eab308;--agir:#22c55e;
}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}

/* === LAYOUT === */
#app{display:grid;grid-template-columns:270px 1fr 400px;height:100vh}

/* === SIDEBAR === */
#sidebar{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
#sidebar-header{padding:1.2rem;border-bottom:1px solid var(--border)}
#logo{display:flex;align-items:center;gap:0.7rem}
#logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),#ea580c);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
#logo-text{font-weight:700;font-size:1rem}
#logo-sub{font-size:0.65rem;color:var(--muted)}

#projects-box{padding:0.8rem;border-bottom:1px solid var(--border)}
.sidebar-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;color:var(--muted);margin-bottom:0.5rem}
#projects-list{max-height:160px;overflow-y:auto;margin-bottom:0.5rem}
.project-row{display:flex;align-items:center;gap:0.5rem;padding:0.45rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.85rem;margin-bottom:2px}
.project-row:hover{background:var(--card)}
.project-row.selected{background:var(--accent2);color:#000}
.project-row span{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.project-row button{background:none;border:none;color:var(--danger);cursor:pointer;opacity:0;font-size:0.75rem;padding:2px 5px}
.project-row:hover button{opacity:0.8}
#btn-new-project{width:100%;padding:0.5rem;background:var(--card);border:1px dashed var(--border);border-radius:6px;color:var(--muted);font-size:0.8rem;cursor:pointer}
#btn-new-project:hover{border-color:var(--accent);color:var(--text)}

#nav{flex:1;overflow-y:auto;padding:0.5rem}
.nav-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;color:var(--muted);padding:0.8rem 0.6rem 0.3rem}
.nav-title.c-voir{color:var(--voir)}
.nav-title.c-juger{color:var(--juger)}
.nav-title.c-agir{color:var(--agir)}
.nav-btn{display:block;width:100%;text-align:left;padding:0.5rem 0.7rem;border:none;background:none;color:var(--muted);font-size:0.82rem;border-radius:6px;cursor:pointer;margin-bottom:1px}
.nav-btn:hover{background:var(--card);color:var(--text)}
.nav-btn.active{background:var(--card);color:var(--accent)}

#sidebar-footer{padding:0.7rem 1rem;border-top:1px solid var(--border);font-size:0.7rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
#save-indicator{display:flex;align-items:center;gap:0.4rem}
#save-dot{width:7px;height:7px;border-radius:50%;background:var(--success)}
#save-dot.saving{background:var(--accent);animation:blink 0.8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

/* === MAIN === */
#main{display:flex;flex-direction:column;overflow:hidden}
#main-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);background:var(--panel)}
#main-header h1{font-size:1.15rem;font-weight:600}
#main-content{flex:1;overflow-y:auto;padding:1.5rem}

.page{display:none}
.page.active{display:block;animation:fadeIn 0.2s}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.intro{color:var(--muted);font-size:0.9rem;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:1rem}
.card-head{padding:0.75rem 1rem;border-bottom:1px solid var(--border);font-weight:600;font-size:0.9rem}
.card-body{padding:1rem}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}

.field{margin-bottom:1rem}
.field:last-child{margin-bottom:0}
.field label{display:block;font-size:0.78rem;font-weight:500;color:var(--muted);margin-bottom:0.35rem}
.field input,.field textarea,.field select{width:100%;padding:0.55rem 0.75rem;background:var(--input);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:0.88rem}
.field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--accent)}
.field textarea{min-height:100px;resize:vertical;line-height:1.55}
.field small{display:block;font-size:0.7rem;color:var(--muted);margin-top:0.25rem}

.btn{display:inline-flex;align-items:center;gap:0.4rem;padding:0.5rem 1rem;border:none;border-radius:6px;font-family:inherit;font-size:0.8rem;font-weight:500;cursor:pointer}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--input);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--card)}
.btn-sm{padding:0.35rem 0.7rem;font-size:0.75rem}

/* Stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem}
.stat-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:0.6rem}
.stat-val{font-size:1.6rem;font-weight:700}
.stat-lbl{font-size:0.72rem;color:var(--muted)}

.progress-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.progress-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem}
.progress-title{font-size:0.85rem;font-weight:600;margin-bottom:0.6rem}
.progress-bar{height:8px;background:var(--input);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px}
.progress-lbl{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:0.35rem}

/* Actors */
.actor-cols{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}
.actor-col{background:var(--input);border-radius:8px;padding:0.75rem;min-height:120px}
.actor-col-title{font-size:0.75rem;font-weight:600;margin-bottom:0.5rem;padding-bottom:0.4rem;border-bottom:1px solid var(--border)}
.actor-col.c-ally .actor-col-title{color:var(--success)}
.actor-col.c-neutral .actor-col-title{color:var(--muted)}
.actor-col.c-opponent .actor-col-title{color:var(--danger)}
.actor-chip{display:flex;align-items:center;gap:0.4rem;padding:0.35rem 0.5rem;background:var(--card);border-radius:4px;font-size:0.75rem;margin-bottom:0.35rem}
.actor-chip .stars{color:var(--accent);font-size:0.65rem;margin-left:auto}
.actor-chip .del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.7rem;margin-left:0.3rem}
.actor-chip .del:hover{color:var(--danger)}

.mermaid-box{background:var(--input);border-radius:8px;padding:1rem;margin-top:1rem;overflow-x:auto}

/* Smart & Journal */
.list-item{display:flex;align-items:flex-start;gap:0.6rem;padding:0.6rem;background:var(--input);border-radius:6px;margin-bottom:0.5rem}
.list-item input[type="checkbox"]{margin-top:0.2rem}
.list-item .content{flex:1}
.list-item .text{font-size:0.85rem}
.list-item .text.done{text-decoration:line-through;opacity:0.5}
.list-item .meta{font-size:0.7rem;color:var(--muted);margin-top:0.2rem}
.list-item .icon{font-size:1.1rem}

/* Export */
.export-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
.export-box{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.2rem;background:var(--input);border:2px solid var(--border);border-radius:10px;cursor:pointer}
.export-box:hover{border-color:var(--accent);background:var(--card)}
.export-box .icon{font-size:2rem}
.export-box .label{font-weight:600;font-size:0.9rem}
.export-box .desc{font-size:0.7rem;color:var(--muted)}

/* === PREVIEW === */
#preview{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column}
#preview-header{padding:1rem 1.2rem;border-bottom:1px solid var(--border);font-weight:600;font-size:0.9rem}
#preview-content{flex:1;overflow-y:auto;padding:1.2rem}
#preview-doc{background:#0d0f12;border-radius:8px;padding:1.5rem;font-size:0.85rem;line-height:1.7}
#preview-doc h1{font-size:1.25rem;color:var(--accent);border-bottom:2px solid var(--border);padding-bottom:0.6rem;margin-bottom:0.3rem}
#preview-doc .pmeta{font-size:0.72rem;color:var(--muted);margin-bottom:1.2rem}
#preview-doc h2{font-size:1rem;margin-top:1.3rem;margin-bottom:0.6rem}
#preview-doc h2.c-voir{color:var(--voir)}
#preview-doc h2.c-juger{color:var(--juger)}
#preview-doc h2.c-agir{color:var(--agir)}
#preview-doc h3{font-size:0.9rem;margin-top:0.9rem;margin-bottom:0.4rem}
#preview-doc p{margin-bottom:0.6rem;color:var(--muted)}
#preview-doc p.filled{color:var(--text)}
#preview-doc .empty{font-style:italic;opacity:0.5}
#preview-doc .badge{display:inline-block;padding:0.12rem 0.45rem;border-radius:100px;font-size:0.68rem;margin:0.1rem}
#preview-doc .badge.ally{background:rgba(34,197,94,0.2);color:var(--success)}
#preview-doc .badge.neutral{background:rgba(136,136,136,0.2);color:var(--muted)}
#preview-doc .badge.opponent{background:rgba(239,68,68,0.2);color:var(--danger)}
#preview-actions{padding:1rem 1.2rem;border-top:1px solid var(--border);display:flex;gap:0.5rem;flex-wrap:wrap}
#preview-actions .btn{flex:1}

/* === MODAL === */
#modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000}
#modal-overlay.show{display:flex}
#modal{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:420px;max-width:90vw}
#modal h2{font-size:1.1rem;margin-bottom:1rem}
#modal-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1.2rem}

/* === TOAST === */
#toasts{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:1001;display:flex;flex-direction:column;gap:0.5rem}
.toast{background:var(--card);border:1px solid var(--border);padding:0.7rem 1.2rem;border-radius:8px;font-size:0.85rem;display:flex;align-items:center;gap:0.5rem;box-shadow:0 8px 30px rgba(0,0,0,0.4);animation:toastIn 0.25s}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--danger)}
.toast.warning{border-left:3px solid var(--accent)}
@keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.empty-state{text-align:center;padding:3rem;color:var(--muted)}
.empty-state .icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
.empty-state h3{font-size:1.1rem;color:var(--text);margin-bottom:0.5rem}
.empty-state p{font-size:0.85rem;margin-bottom:1.5rem}

@media(max-width:1100px){#app{grid-template-columns:250px 1fr 340px}.stats-row{grid-template-columns:repeat(2,1fr)}}
@media(max-width:900px){#app{grid-template-columns:1fr}#sidebar,#preview{display:none}}
</style>
</head>
<body>

<div id="app">
<!-- ========== SIDEBAR ========== -->
<aside id="sidebar">
  <div id="sidebar-header">
    <div id="logo">
      <div id="logo-icon">âš–ï¸</div>
      <div><div id="logo-text">Plaidoyer Citoyen</div><div id="logo-sub">Poste de Travail v6</div></div>
    </div>
  </div>
  
  <div id="projects-box">
    <div class="sidebar-title">ğŸ“ Mes projets</div>
    <div id="projects-list"></div>
    <button id="btn-new-project">+ Nouveau projet</button>
  </div>
  
  <nav id="nav">
    <div class="nav-title">ğŸ“Š GÃ©nÃ©ral</div>
    <button class="nav-btn active" data-page="dashboard">ğŸ“Š Tableau de bord</button>
    
    <div class="nav-title c-voir">ğŸ‘ï¸ VOIR</div>
    <button class="nav-btn" data-page="domino">ğŸ¯ Vision (Domino)</button>
    <button class="nav-btn" data-page="profil">ğŸ‘¤ Profil citoyen</button>
    <button class="nav-btn" data-page="fleur">ğŸŒ¸ Fleur du pouvoir</button>
    
    <div class="nav-title c-juger">âš–ï¸ JUGER</div>
    <button class="nav-btn" data-page="acteurs">ğŸ‘¥ Cartographie acteurs</button>
    <button class="nav-btn" data-page="arbre">ğŸŒ³ Arbre Ã  problÃ¨mes</button>
    <button class="nav-btn" data-page="pourquoi">â“ 5 Pourquoi</button>
    <button class="nav-btn" data-page="swot">ğŸ“ SWOT</button>
    <button class="nav-btn" data-page="pestel">ğŸŒ PESTEL</button>
    <button class="nav-btn" data-page="tdc">ğŸ”„ ThÃ©orie du changement</button>
    
    <div class="nav-title c-agir">âœŠ AGIR</div>
    <button class="nav-btn" data-page="pouvoir">âš¡ Avec/Sans/Contre</button>
    <button class="nav-btn" data-page="cibles">ğŸ¯ Cibles & AlliÃ©s</button>
    <button class="nav-btn" data-page="smart">ğŸ“‹ Objectifs SMART</button>
    <button class="nav-btn" data-page="message">ğŸ’¬ Message clÃ©</button>
    <button class="nav-btn" data-page="evaluation">ğŸ“ˆ Suivi-Ã©valuation</button>
    <button class="nav-btn" data-page="journal">ğŸ““ Journal de bord</button>
    
    <div class="nav-title">ğŸ”§ Outils</div>
    <button class="nav-btn" data-page="export">ğŸ’¾ Import / Export</button>
  </nav>
  
  <div id="sidebar-footer">
    <div id="save-indicator"><span id="save-dot"></span><span id="save-text">PrÃªt</span></div>
    <span>IndexedDB</span>
  </div>
</aside>

<!-- ========== MAIN ========== -->
<main id="main">
  <header id="main-header"><h1 id="page-title">Tableau de bord</h1></header>
  <div id="main-content">
  
    <!-- PAGE: Empty -->
    <section class="page active" id="p-empty">
      <div class="empty-state">
        <div class="icon">ğŸ“‚</div>
        <h3>Bienvenue</h3>
        <p>CrÃ©ez un projet ou importez-en un existant</p>
        <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-primary" id="btn-new-empty">+ CrÃ©er un projet</button>
          <label class="btn btn-secondary" style="cursor:pointer">
            ğŸ“¥ Importer JSON
            <input type="file" accept=".json" id="import-home" style="display:none">
          </label>
        </div>
      </div>
    </section>
    
    <!-- PAGE: Dashboard -->
    <section class="page" id="p-dashboard">
      <div class="stats-row">
        <div class="stat-box"><div class="stat-icon" style="background:rgba(14,165,233,0.15);color:var(--voir)">ğŸ“</div><div class="stat-val" id="s-fields">0</div><div class="stat-lbl">Champs remplis</div></div>
        <div class="stat-box"><div class="stat-icon" style="background:rgba(34,197,94,0.15);color:var(--success)">ğŸ‘¥</div><div class="stat-val" id="s-actors">0</div><div class="stat-lbl">Acteurs</div></div>
        <div class="stat-box"><div class="stat-icon" style="background:rgba(245,158,11,0.15);color:var(--accent)">ğŸ¯</div><div class="stat-val" id="s-smart">0</div><div class="stat-lbl">Objectifs</div></div>
        <div class="stat-box"><div class="stat-icon" style="background:rgba(59,130,246,0.15);color:var(--info)">ğŸ““</div><div class="stat-val" id="s-journal">0</div><div class="stat-lbl">EntrÃ©es</div></div>
      </div>
      <div class="progress-row">
        <div class="progress-box"><div class="progress-title" style="color:var(--voir)">ğŸ‘ï¸ VOIR</div><div class="progress-bar"><div class="progress-fill" id="prog-voir" style="width:0%;background:var(--voir)"></div></div><div class="progress-lbl"><span>Analyse</span><span id="prog-voir-pct">0%</span></div></div>
        <div class="progress-box"><div class="progress-title" style="color:var(--juger)">âš–ï¸ JUGER</div><div class="progress-bar"><div class="progress-fill" id="prog-juger" style="width:0%;background:var(--juger)"></div></div><div class="progress-lbl"><span>StratÃ©gie</span><span id="prog-juger-pct">0%</span></div></div>
        <div class="progress-box"><div class="progress-title" style="color:var(--agir)">âœŠ AGIR</div><div class="progress-bar"><div class="progress-fill" id="prog-agir" style="width:0%;background:var(--agir)"></div></div><div class="progress-lbl"><span>Action</span><span id="prog-agir-pct">0%</span></div></div>
      </div>
      <div class="card"><div class="card-head">ğŸ“Œ Informations du projet</div><div class="card-body">
        <div class="row2">
          <div class="field"><label>Nom du projet</label><input type="text" data-field="meta.name" placeholder="Ex: Stop Arizona"></div>
          <div class="field"><label>Organisation</label><input type="text" data-field="meta.organization" placeholder="Collectif..."></div>
        </div>
        <div class="field"><label>Description</label><textarea data-field="meta.description" rows="2" placeholder="RÃ©sumÃ© du projet..."></textarea></div>
      </div></div>
    </section>
    
    <!-- PAGE: Domino -->
    <section class="page" id="p-domino">
      <p class="intro">Clarifiez votre vision du changement : quel est l'horizon de votre plaidoyer ?</p>
      <div class="card"><div class="card-head">ğŸ¯ Vision du changement</div><div class="card-body"><div class="field"><textarea data-field="domino.vision" rows="4" placeholder="DÃ©crivez le changement souhaitÃ©..."></textarea></div></div></div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸš§ Obstacles</div><div class="card-body"><div class="field"><textarea data-field="domino.obstacles" rows="5" placeholder="Obstacles politiques, administratifs..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ’ª Ressources</div><div class="card-body"><div class="field"><textarea data-field="domino.ressources" rows="5" placeholder="RÃ©seaux, expertise, alliÃ©s..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Profil -->
    <section class="page" id="p-profil">
      <p class="intro">DÃ©finissez votre profil en tant que citoyenÂ·ne engagÃ©Â·e.</p>
      <div class="row2">
        <div class="card"><div class="card-head">â¤ï¸ Motivations</div><div class="card-body"><div class="field"><textarea data-field="profil.motivations" rows="4" placeholder="Pourquoi vous engagez-vous ?"></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ› ï¸ CompÃ©tences</div><div class="card-body"><div class="field"><textarea data-field="profil.competences" rows="4" placeholder="Vos compÃ©tences utiles..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head">â° Temps disponible</div><div class="card-body"><div class="field"><textarea data-field="profil.temps" rows="4" placeholder="DisponibilitÃ©s..."></textarea></div></div></div>
        <div class="card"><div class="card-head">âš ï¸ Limites</div><div class="card-body"><div class="field"><textarea data-field="profil.limites" rows="4" placeholder="Contraintes, lignes rouges..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Fleur -->
    <section class="page" id="p-fleur">
      <p class="intro">Analysez les rapports de domination et de privilÃ¨ge (Fleur du Pouvoir).</p>
      <div class="card"><div class="card-head">ğŸ‘¥ Personnes concernÃ©es</div><div class="card-body"><div class="field"><textarea data-field="fleur.identites" rows="3" placeholder="Profils des personnes touchÃ©es..."></textarea></div></div></div>
      <div class="row2">
        <div class="card"><div class="card-head" style="color:var(--success)">âœ… PrivilÃ¨ges</div><div class="card-body"><div class="field"><textarea data-field="fleur.privileges" rows="4" placeholder="AccÃ¨s, capital social..."></textarea></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--danger)">ğŸ¯ Oppressions</div><div class="card-body"><div class="field"><textarea data-field="fleur.oppressions" rows="4" placeholder="Discriminations..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Acteurs -->
    <section class="page" id="p-acteurs">
      <p class="intro">Cartographiez les acteurs clÃ©s de votre plaidoyer.</p>
      <div class="card"><div class="card-head">â• Ajouter un acteur</div><div class="card-body">
        <div class="row2">
          <div class="field"><label>Nom</label><input type="text" id="a-name" placeholder="Nom"></div>
          <div class="field"><label>RÃ´le</label><input type="text" id="a-role" placeholder="Fonction..."></div>
        </div>
        <div class="row2">
          <div class="field"><label>Position</label><select id="a-pos"><option value="ally">ğŸŸ¢ AlliÃ©</option><option value="neutral">ğŸŸ¡ Neutre</option><option value="opponent">ğŸ”´ Opposant</option></select></div>
          <div class="field"><label>Pouvoir (1-5)</label><select id="a-power"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
        </div>
        <button class="btn btn-primary" id="btn-add-actor">Ajouter</button>
      </div></div>
      <div class="actor-cols">
        <div class="actor-col c-ally"><div class="actor-col-title">ğŸŸ¢ AlliÃ©s</div><div id="col-ally"></div></div>
        <div class="actor-col c-neutral"><div class="actor-col-title">ğŸŸ¡ Neutres</div><div id="col-neutral"></div></div>
        <div class="actor-col c-opponent"><div class="actor-col-title">ğŸ”´ Opposants</div><div id="col-opponent"></div></div>
      </div>
      <div class="card" style="margin-top:1rem"><div class="card-head">ğŸ“Š Visualisation</div><div class="card-body">
        <div class="mermaid-box"><pre class="mermaid" id="mermaid-actors"></pre></div>
        <button class="btn btn-secondary btn-sm" style="margin-top:0.7rem" id="btn-refresh-actors">ğŸ”„ RafraÃ®chir</button>
      </div></div>
    </section>
    
    <!-- PAGE: Arbre -->
    <section class="page" id="p-arbre">
      <p class="intro">Identifiez le problÃ¨me central, ses causes (racines) et effets (branches).</p>
      <div class="card"><div class="card-head">ğŸ¯ ProblÃ¨me central</div><div class="card-body"><div class="field"><textarea data-field="arbre.probleme" rows="2" placeholder="Quel est le problÃ¨me ?"></textarea></div></div></div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸŒ± Causes</div><div class="card-body"><div class="field"><textarea data-field="arbre.causes" rows="5" placeholder="Une cause par ligne..."></textarea><small>Une cause par ligne</small></div></div></div>
        <div class="card"><div class="card-head">ğŸƒ Effets</div><div class="card-body"><div class="field"><textarea data-field="arbre.effets" rows="5" placeholder="Un effet par ligne..."></textarea><small>Un effet par ligne</small></div></div></div>
      </div>
      <div class="card"><div class="card-head">ğŸŒ³ Visualisation</div><div class="card-body">
        <div class="mermaid-box"><pre class="mermaid" id="mermaid-tree"></pre></div>
        <button class="btn btn-secondary btn-sm" style="margin-top:0.7rem" id="btn-refresh-tree">ğŸ”„ RafraÃ®chir</button>
      </div></div>
    </section>
    
    <!-- PAGE: 5 Pourquoi -->
    <section class="page" id="p-pourquoi">
      <p class="intro">Remontez Ã  la cause racine avec la mÃ©thode des 5 Pourquoi.</p>
      <div class="card"><div class="card-head">â“ ProblÃ¨me de dÃ©part</div><div class="card-body"><div class="field"><textarea data-field="pourquoi.probleme" rows="2" placeholder="SymptÃ´me observÃ©..."></textarea></div></div></div>
      <div class="card"><div class="card-body">
        <div class="field"><label>1ï¸âƒ£ Pourquoi ?</label><textarea data-field="pourquoi.why1" rows="2"></textarea></div>
        <div class="field"><label>2ï¸âƒ£ Pourquoi ?</label><textarea data-field="pourquoi.why2" rows="2"></textarea></div>
        <div class="field"><label>3ï¸âƒ£ Pourquoi ?</label><textarea data-field="pourquoi.why3" rows="2"></textarea></div>
        <div class="field"><label>4ï¸âƒ£ Pourquoi ?</label><textarea data-field="pourquoi.why4" rows="2"></textarea></div>
        <div class="field"><label>5ï¸âƒ£ Cause racine</label><textarea data-field="pourquoi.why5" rows="2" style="border-color:var(--accent)"></textarea></div>
      </div></div>
    </section>
    
    <!-- PAGE: SWOT -->
    <section class="page" id="p-swot">
      <p class="intro">Analysez vos Forces, Faiblesses, OpportunitÃ©s et Menaces.</p>
      <div class="row2">
        <div class="card"><div class="card-head" style="color:var(--success)">ğŸ’ª Forces</div><div class="card-body"><div class="field"><textarea data-field="swot.forces" rows="4" placeholder="Atouts internes..."></textarea></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--danger)">ğŸ˜° Faiblesses</div><div class="card-body"><div class="field"><textarea data-field="swot.faiblesses" rows="4" placeholder="Limites internes..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head" style="color:var(--info)">ğŸŒŸ OpportunitÃ©s</div><div class="card-body"><div class="field"><textarea data-field="swot.opportunites" rows="4" placeholder="Facteurs favorables..."></textarea></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--accent)">âš ï¸ Menaces</div><div class="card-body"><div class="field"><textarea data-field="swot.menaces" rows="4" placeholder="Risques externes..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: PESTEL -->
    <section class="page" id="p-pestel">
      <p class="intro">Analysez le macro-environnement PESTEL.</p>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ›ï¸ Politique</div><div class="card-body"><div class="field"><textarea data-field="pestel.politique" rows="3" placeholder="Gouvernance, Ã©lections..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ’¶ Ã‰conomique</div><div class="card-body"><div class="field"><textarea data-field="pestel.economique" rows="3" placeholder="Conjoncture, budgets..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ‘¥ Social</div><div class="card-body"><div class="field"><textarea data-field="pestel.social" rows="3" placeholder="Tendances, opinions..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ’» Technologique</div><div class="card-body"><div class="field"><textarea data-field="pestel.technologique" rows="3" placeholder="Innovations..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸŒ± Environnemental</div><div class="card-body"><div class="field"><textarea data-field="pestel.environnemental" rows="3" placeholder="Ã‰cologie, climat..."></textarea></div></div></div>
        <div class="card"><div class="card-head">âš–ï¸ LÃ©gal</div><div class="card-body"><div class="field"><textarea data-field="pestel.legal" rows="3" placeholder="Cadre juridique..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: TdC -->
    <section class="page" id="p-tdc">
      <p class="intro">ThÃ©orie du Changement : comment le changement se produit.</p>
      <div class="card"><div class="card-head">ğŸ¯ Impact final visÃ©</div><div class="card-body"><div class="field"><textarea data-field="tdc.impact" rows="2" placeholder="Changement ultime..."></textarea></div></div></div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ”¹ Individuel interne</div><div class="card-body"><div class="field"><textarea data-field="tdc.individuel_interne" rows="3" placeholder="Connaissances, attitudes..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ”¹ Individuel externe</div><div class="card-body"><div class="field"><textarea data-field="tdc.individuel_externe" rows="3" placeholder="Comportements..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ”¸ Collectif interne</div><div class="card-body"><div class="field"><textarea data-field="tdc.collectif_interne" rows="3" placeholder="Culture, normes..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ”¸ Collectif externe</div><div class="card-body"><div class="field"><textarea data-field="tdc.collectif_externe" rows="3" placeholder="Politiques, lois..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Pouvoir -->
    <section class="page" id="p-pouvoir">
      <p class="intro">DÃ©finissez votre positionnement par rapport au pouvoir.</p>
      <div class="row3">
        <div class="card"><div class="card-head" style="color:var(--success);border-bottom:3px solid var(--success)">ğŸ¤ AVEC</div><div class="card-body"><div class="field"><textarea data-field="pouvoir.avec" rows="6" placeholder="Collaboration, dialogue..."></textarea><small>Ex: Auditions, commissions</small></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--accent);border-bottom:3px solid var(--accent)">ğŸ”„ SANS</div><div class="card-body"><div class="field"><textarea data-field="pouvoir.sans" rows="6" placeholder="Actions autonomes..."></textarea><small>Ex: Projets pilotes, mÃ©dias alternatifs</small></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--danger);border-bottom:3px solid var(--danger)">âœŠ CONTRE</div><div class="card-body"><div class="field"><textarea data-field="pouvoir.contre" rows="6" placeholder="Opposition, mobilisation..."></textarea><small>Ex: Manifs, pÃ©titions</small></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Cibles -->
    <section class="page" id="p-cibles">
      <p class="intro">Identifiez vos cibles de plaidoyer et alliÃ©s stratÃ©giques.</p>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ¯ Cible principale</div><div class="card-body"><div class="field"><textarea data-field="cibles.principale" rows="3" placeholder="Qui dÃ©cide ?"></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ¯ Cibles secondaires</div><div class="card-body"><div class="field"><textarea data-field="cibles.secondaires" rows="3" placeholder="Qui influence ?"></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head" style="color:var(--success)">ğŸ¤ AlliÃ©s</div><div class="card-body"><div class="field"><textarea data-field="cibles.allies" rows="3" placeholder="Organisations alliÃ©es..."></textarea></div></div></div>
        <div class="card"><div class="card-head" style="color:var(--danger)">âš”ï¸ Opposants</div><div class="card-body"><div class="field"><textarea data-field="cibles.opposants" rows="3" placeholder="Qui s'oppose ?"></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: SMART -->
    <section class="page" id="p-smart">
      <p class="intro">Objectifs SMART : SpÃ©cifiques, Mesurables, Atteignables, RÃ©alistes, Temporels.</p>
      <div class="card"><div class="card-head">â• Ajouter un objectif</div><div class="card-body">
        <div class="field"><textarea id="sm-text" rows="2" placeholder="Ex: Obtenir 50 000 signatures d'ici le 1er mars"></textarea></div>
        <div class="row2">
          <div class="field"><label>Indicateur</label><input type="text" id="sm-indicator" placeholder="Ex: Nombre de signatures"></div>
          <div class="field"><label>Ã‰chÃ©ance</label><input type="date" id="sm-deadline"></div>
        </div>
        <button class="btn btn-primary" id="btn-add-smart">Ajouter</button>
      </div></div>
      <div class="card"><div class="card-head">ğŸ“‹ Objectifs</div><div class="card-body" id="smart-list"><p style="color:var(--muted);text-align:center">Aucun objectif</p></div></div>
    </section>
    
    <!-- PAGE: Message -->
    <section class="page" id="p-message">
      <p class="intro">Construisez votre message de plaidoyer percutant.</p>
      <div class="card"><div class="card-head">ğŸ’¬ Message</div><div class="card-body">
        <div class="field"><label>ğŸ£ Accroche</label><textarea data-field="message.accroche" rows="2" placeholder="Phrase percutante..."></textarea></div>
        <div class="field"><label>â— ProblÃ¨me</label><textarea data-field="message.probleme" rows="2" placeholder="Le problÃ¨me..."></textarea></div>
        <div class="field"><label>âš¡ Importance</label><textarea data-field="message.importance" rows="2" placeholder="Pourquoi agir ?"></textarea></div>
        <div class="field"><label>ğŸ‘‰ Appel Ã  l'action</label><textarea data-field="message.action" rows="2" placeholder="Que demandez-vous ?"></textarea></div>
      </div></div>
      <div class="card"><div class="card-head">ğŸ“ AperÃ§u</div><div class="card-body" id="message-preview" style="background:var(--input);border-radius:6px;padding:1rem;color:var(--muted);font-style:italic">Remplissez les champs...</div></div>
    </section>
    
    <!-- PAGE: Evaluation -->
    <section class="page" id="p-evaluation">
      <p class="intro">DÃ©finissez comment suivre et Ã©valuer l'impact de votre plaidoyer.</p>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ“Š Indicateurs</div><div class="card-body"><div class="field"><textarea data-field="evaluation.indicateurs" rows="5" placeholder="Indicateurs quantitatifs et qualitatifs..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ” MÃ©thodes de collecte</div><div class="card-body"><div class="field"><textarea data-field="evaluation.methodes" rows="5" placeholder="Sondages, entretiens..."></textarea></div></div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="card-head">ğŸ“… Calendrier</div><div class="card-body"><div class="field"><textarea data-field="evaluation.calendrier" rows="5" placeholder="FrÃ©quence, jalons..."></textarea></div></div></div>
        <div class="card"><div class="card-head">ğŸ“š LeÃ§ons apprises</div><div class="card-body"><div class="field"><textarea data-field="evaluation.lecons" rows="5" placeholder="Apprentissages..."></textarea></div></div></div>
      </div>
    </section>
    
    <!-- PAGE: Journal -->
    <section class="page" id="p-journal">
      <p class="intro">Tenez un journal de vos actions, rencontres, avancÃ©es.</p>
      <div class="card"><div class="card-head">â• Nouvelle entrÃ©e</div><div class="card-body">
        <div class="row2">
          <div class="field"><label>Date</label><input type="date" id="j-date"></div>
          <div class="field"><label>Type</label><select id="j-type"><option value="action">ğŸ¯ Action</option><option value="rencontre">ğŸ¤ Rencontre</option><option value="victoire">ğŸ† Victoire</option><option value="difficulte">âš ï¸ DifficultÃ©</option><option value="note">ğŸ“ Note</option></select></div>
        </div>
        <div class="field"><textarea id="j-content" rows="2" placeholder="DÃ©crivez..."></textarea></div>
        <button class="btn btn-primary" id="btn-add-journal">Ajouter</button>
      </div></div>
      <div class="card"><div class="card-head">ğŸ““ Historique</div><div class="card-body" id="journal-list"><p style="color:var(--muted);text-align:center">Aucune entrÃ©e</p></div></div>
    </section>
    
    <!-- PAGE: Export -->
    <section class="page" id="p-export">
      <div class="card"><div class="card-head">ğŸ“¤ Exporter le projet</div><div class="card-body">
        <p style="margin-bottom:1rem;color:var(--muted)">Exportez votre projet dans le format souhaitÃ© :</p>
        <div class="export-grid">
          <div class="export-box" id="exp-json"><span class="icon">ğŸ“„</span><span class="label">JSON</span><span class="desc">Sauvegarde complÃ¨te</span></div>
          <div class="export-box" id="exp-md"><span class="icon">ğŸ“</span><span class="label">Markdown</span><span class="desc">Document texte</span></div>
          <div class="export-box" id="exp-html"><span class="icon">ğŸŒ</span><span class="label">HTML</span><span class="desc">Page web</span></div>
          <div class="export-box" id="exp-pdf"><span class="icon">ğŸ“•</span><span class="label">PDF</span><span class="desc">Document</span></div>
          <div class="export-box" id="exp-docx"><span class="icon">ğŸ“˜</span><span class="label">Word</span><span class="desc">Document Ã©ditable</span></div>
          <div class="export-box" id="exp-xlsx"><span class="icon">ğŸ“Š</span><span class="label">Excel</span><span class="desc">Tableur</span></div>
        </div>
      </div></div>
      <div class="card"><div class="card-head">ğŸ“¥ Importer un projet</div><div class="card-body">
        <p style="margin-bottom:0.7rem;color:var(--muted)">Chargez un fichier JSON :</p>
        <input type="file" id="import-file" accept=".json" class="field input">
      </div></div>
    </section>
    
  </div>
</main>

<!-- ========== PREVIEW ========== -->
<aside id="preview">
  <header id="preview-header">ğŸ‘ï¸ AperÃ§u en direct</header>
  <div id="preview-content"><div id="preview-doc"></div></div>
  <div id="preview-actions">
    <button class="btn btn-secondary btn-sm" id="prev-json">JSON</button>
    <button class="btn btn-secondary btn-sm" id="prev-md">MD</button>
    <button class="btn btn-primary btn-sm" id="prev-pdf">PDF</button>
  </div>
</aside>
</div>

<!-- ========== MODAL ========== -->
<div id="modal-overlay">
  <div id="modal">
    <h2>Nouveau projet</h2>
    <div class="field"><label>Nom du projet</label><input type="text" id="m-name" placeholder="Ex: Stop Arizona"></div>
    <div class="field"><label>Description</label><textarea id="m-desc" rows="2" placeholder="Description..."></textarea></div>
    <div id="modal-actions">
      <button class="btn btn-secondary" id="m-cancel">Annuler</button>
      <button class="btn btn-primary" id="m-create">CrÃ©er</button>
    </div>
  </div>
</div>

<div id="toasts"></div>

<script>
// ============================================================================
// APPLICATION PLAIDOYER CITOYEN v6 - FROM SCRATCH
// ============================================================================

(function() {
'use strict';

// --- CONFIG ---
const DB_NAME = 'PlaidoyerDB_v2';
const STORE_NAME = 'projects';

// --- STATE ---
let db = null;
let currentProjectId = null;
let currentProject = null;
let saveTimeout = null;

// --- UTILS ---
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') : '';
const slug = s => (s||'projet').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

function toast(msg, type='info') {
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  const icons = {success:'âœ“',error:'âœ—',warning:'âš ',info:'â„¹'};
  t.innerHTML = `<span>${icons[type]||'â„¹'}</span> ${msg}`;
  $('toasts').appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}

function download(content, filename, mime) {
  const a = document.createElement('a');
  const blob = new Blob([content], {type: mime});
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadBlob(blob, filename) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// --- INDEXEDDB ---
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    
    request.onerror = () => {
      console.error('DB Error:', request.error);
      reject(request.error);
    };
    
    request.onsuccess = () => {
      db = request.result;
      console.log('DB opened successfully');
      resolve(db);
    };
    
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains(STORE_NAME)) {
        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
        console.log('Object store created');
      }
    };
  });
}

function dbPut(project) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.put(project);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

function dbGet(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(id);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbGetAll() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function dbDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.delete(id);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

// --- PROJECT TEMPLATE ---
function createEmptyProject(name, desc) {
  return {
    id: Date.now().toString(),
    modified: new Date().toISOString(),
    meta: { name: name || 'Nouveau projet', description: desc || '', organization: '' },
    domino: { vision: '', obstacles: '', ressources: '' },
    profil: { motivations: '', competences: '', temps: '', limites: '' },
    fleur: { identites: '', privileges: '', oppressions: '' },
    acteurs: [],
    arbre: { probleme: '', causes: '', effets: '' },
    pourquoi: { probleme: '', why1: '', why2: '', why3: '', why4: '', why5: '' },
    swot: { forces: '', faiblesses: '', opportunites: '', menaces: '' },
    pestel: { politique: '', economique: '', social: '', technologique: '', environnemental: '', legal: '' },
    tdc: { impact: '', individuel_interne: '', individuel_externe: '', collectif_interne: '', collectif_externe: '' },
    pouvoir: { avec: '', sans: '', contre: '' },
    cibles: { principale: '', secondaires: '', allies: '', opposants: '' },
    smart: [],
    message: { accroche: '', probleme: '', importance: '', action: '' },
    evaluation: { indicateurs: '', methodes: '', calendrier: '', lecons: '' },
    journal: []
  };
}

// --- RENDER PROJECTS LIST ---
async function renderProjectsList() {
  const list = await dbGetAll();
  const container = $('projects-list');
  
  if (list.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);font-size:0.8rem;text-align:center;padding:0.5rem">Aucun projet</p>';
    return;
  }
  
  container.innerHTML = list.map(p => `
    <div class="project-row ${p.id === currentProjectId ? 'selected' : ''}" data-id="${p.id}">
      <span>ğŸ“</span>
      <span>${esc(p.meta?.name || 'Sans nom')}</span>
      <button data-del="${p.id}">âœ•</button>
    </div>
  `).join('');
  
  // Click handlers
  container.querySelectorAll('.project-row').forEach(row => {
    row.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') return;
      selectProject(row.dataset.id);
    });
  });
  
  container.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteProject(btn.dataset.del);
    });
  });
}

// --- SELECT PROJECT ---
async function selectProject(id) {
  currentProjectId = id;
  currentProject = await dbGet(id);
  
  await renderProjectsList();
  populateFields();
  renderActors();
  renderSmartList();
  renderJournalList();
  updatePreview();
  updateStats();
  showPage('dashboard');
}

// --- DELETE PROJECT ---
async function deleteProject(id) {
  if (!confirm('Supprimer ce projet ?')) return;
  await dbDelete(id);
  
  if (currentProjectId === id) {
    currentProjectId = null;
    currentProject = null;
    $('preview-doc').innerHTML = '';
    showPage('empty');
  }
  
  await renderProjectsList();
  toast('Projet supprimÃ©', 'success');
}

// --- POPULATE FIELDS ---
function populateFields() {
  if (!currentProject) return;
  
  $$('[data-field]').forEach(el => {
    const [section, key] = el.dataset.field.split('.');
    el.value = currentProject[section]?.[key] || '';
  });
  
  updateMessagePreview();
}

// --- SAVE ---
function scheduleSave() {
  if (!currentProject) return;
  
  $('save-dot').classList.add('saving');
  $('save-text').textContent = 'Sauvegarde...';
  
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    currentProject.modified = new Date().toISOString();
    await dbPut(currentProject);
    $('save-dot').classList.remove('saving');
    $('save-text').textContent = 'SauvegardÃ©';
  }, 500);
}

// --- NAVIGATION ---
const PAGE_TITLES = {
  empty: 'Bienvenue',
  dashboard: 'Tableau de bord',
  domino: 'Vision (Domino)',
  profil: 'Profil citoyen',
  fleur: 'Fleur du pouvoir',
  acteurs: 'Cartographie des acteurs',
  arbre: 'Arbre Ã  problÃ¨mes',
  pourquoi: '5 Pourquoi',
  swot: 'Analyse SWOT',
  pestel: 'Analyse PESTEL',
  tdc: 'ThÃ©orie du changement',
  pouvoir: 'Avec/Sans/Contre le pouvoir',
  cibles: 'Cibles & AlliÃ©s',
  smart: 'Objectifs SMART',
  message: 'Message clÃ©',
  evaluation: 'Suivi-Ã©valuation',
  journal: 'Journal de bord',
  export: 'Import / Export'
};

function showPage(pageId) {
  // Hide all pages
  $$('.page').forEach(p => p.classList.remove('active'));
  
  // Show target page
  const target = $('p-' + pageId);
  if (target) target.classList.add('active');
  
  // Update nav buttons
  $$('.nav-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.page === pageId);
  });
  
  // Update title
  $('page-title').textContent = PAGE_TITLES[pageId] || pageId;
  
  // Refresh mermaid if needed
  if (pageId === 'acteurs') refreshActorsMermaid();
  if (pageId === 'arbre') refreshTreeMermaid();
}

// --- STATS ---
function updateStats() {
  if (!currentProject) return;
  
  let filled = 0;
  const countFields = (obj) => {
    if (!obj) return;
    Object.values(obj).forEach(v => {
      if (typeof v === 'string' && v.trim()) filled++;
    });
  };
  
  ['domino','profil','fleur','arbre','pourquoi','swot','pestel','tdc','pouvoir','cibles','message','evaluation'].forEach(k => countFields(currentProject[k]));
  
  $('s-fields').textContent = filled;
  $('s-actors').textContent = currentProject.acteurs?.length || 0;
  $('s-smart').textContent = currentProject.smart?.length || 0;
  $('s-journal').textContent = currentProject.journal?.length || 0;
  
  // Progress
  const calcProgress = (fields) => {
    let done = 0;
    fields.forEach(f => {
      if (f === 'acteurs') { if (currentProject.acteurs?.length) done++; }
      else if (f === 'smart') { if (currentProject.smart?.length) done++; }
      else {
        const [s, k] = f.split('.');
        if (currentProject[s]?.[k]?.trim()) done++;
      }
    });
    return Math.round((done / fields.length) * 100);
  };
  
  const voirPct = calcProgress(['domino.vision', 'profil.motivations', 'fleur.identites']);
  const jugerPct = calcProgress(['arbre.probleme', 'swot.forces', 'pestel.politique', 'acteurs']);
  const agirPct = calcProgress(['pouvoir.avec', 'cibles.principale', 'message.accroche', 'smart']);
  
  $('prog-voir').style.width = voirPct + '%';
  $('prog-voir-pct').textContent = voirPct + '%';
  $('prog-juger').style.width = jugerPct + '%';
  $('prog-juger-pct').textContent = jugerPct + '%';
  $('prog-agir').style.width = agirPct + '%';
  $('prog-agir-pct').textContent = agirPct + '%';
}

// --- ACTORS ---
function addActor() {
  if (!currentProject) return;
  
  const name = $('a-name').value.trim();
  const role = $('a-role').value.trim();
  const pos = $('a-pos').value;
  const power = parseInt($('a-power').value);
  
  if (!name) { toast('Entrez un nom', 'error'); return; }
  
  currentProject.acteurs.push({ id: Date.now(), name, role, position: pos, power });
  
  $('a-name').value = '';
  $('a-role').value = '';
  
  renderActors();
  scheduleSave();
  updatePreview();
  updateStats();
  toast('Acteur ajoutÃ©', 'success');
}

function removeActor(id) {
  if (!currentProject) return;
  currentProject.acteurs = currentProject.acteurs.filter(a => a.id !== id);
  renderActors();
  scheduleSave();
  updatePreview();
  updateStats();
}

function renderActors() {
  if (!currentProject) return;
  
  ['ally', 'neutral', 'opponent'].forEach(pos => {
    const col = $('col-' + pos);
    const actors = currentProject.acteurs.filter(a => a.position === pos);
    
    if (actors.length === 0) {
      col.innerHTML = '<p style="color:var(--muted);font-size:0.75rem;text-align:center">â€”</p>';
    } else {
      col.innerHTML = actors.map(a => `
        <div class="actor-chip">
          <span>${esc(a.name)}</span>
          <span class="stars">${'â˜…'.repeat(a.power)}</span>
          <button class="del" data-actor="${a.id}">âœ•</button>
        </div>
      `).join('');
      
      col.querySelectorAll('[data-actor]').forEach(btn => {
        btn.addEventListener('click', () => removeActor(parseInt(btn.dataset.actor)));
      });
    }
  });
}

async function refreshActorsMermaid() {
  if (!currentProject || typeof mermaid === 'undefined') return;
  
  const allies = currentProject.acteurs.filter(a => a.position === 'ally');
  const neutrals = currentProject.acteurs.filter(a => a.position === 'neutral');
  const opponents = currentProject.acteurs.filter(a => a.position === 'opponent');
  
  let code = 'graph LR\n';
  if (allies.length) {
    code += '  subgraph AlliÃ©s\n';
    allies.forEach((a, i) => code += `    A${i}["${a.name.replace(/"/g, "'")}"]\n`);
    code += '  end\n';
  }
  if (neutrals.length) {
    code += '  subgraph Neutres\n';
    neutrals.forEach((a, i) => code += `    N${i}["${a.name.replace(/"/g, "'")}"]\n`);
    code += '  end\n';
  }
  if (opponents.length) {
    code += '  subgraph Opposants\n';
    opponents.forEach((a, i) => code += `    O${i}["${a.name.replace(/"/g, "'")}"]\n`);
    code += '  end\n';
  }
  if (!allies.length && !neutrals.length && !opponents.length) {
    code += '  X[Ajoutez des acteurs]\n';
  }
  
  const el = $('mermaid-actors');
  el.textContent = code;
  el.removeAttribute('data-processed');
  
  try {
    await mermaid.run({ nodes: [el] });
  } catch (e) {
    console.error('Mermaid error:', e);
  }
}

async function refreshTreeMermaid() {
  if (!currentProject || typeof mermaid === 'undefined') return;
  
  const prob = (currentProject.arbre?.probleme || 'ProblÃ¨me').substring(0, 30).replace(/"/g, "'");
  const causes = (currentProject.arbre?.causes || '').split('\n').filter(c => c.trim());
  const effects = (currentProject.arbre?.effets || '').split('\n').filter(e => e.trim());
  
  let code = 'graph TB\n';
  
  causes.forEach((c, i) => {
    code += `  C${i}["${c.trim().substring(0, 25).replace(/"/g, "'")}"] --> P\n`;
  });
  
  code += `  P["ğŸ¯ ${prob}"]\n`;
  
  effects.forEach((e, i) => {
    code += `  P --> E${i}["${e.trim().substring(0, 25).replace(/"/g, "'")}"]\ n`;
  });
  
  if (!causes.length && !effects.length) {
    code = 'graph TB\n  P[Remplissez causes et effets]\n';
  }
  
  const el = $('mermaid-tree');
  el.textContent = code;
  el.removeAttribute('data-processed');
  
  try {
    await mermaid.run({ nodes: [el] });
  } catch (e) {
    console.error('Mermaid error:', e);
  }
}

// --- SMART ---
function addSmart() {
  if (!currentProject) return;
  
  const text = $('sm-text').value.trim();
  const indicator = $('sm-indicator').value.trim();
  const deadline = $('sm-deadline').value;
  
  if (!text) { toast('DÃ©crivez l\'objectif', 'error'); return; }
  
  currentProject.smart.push({ id: Date.now(), text, indicator, deadline, done: false });
  
  $('sm-text').value = '';
  $('sm-indicator').value = '';
  $('sm-deadline').value = '';
  
  renderSmartList();
  scheduleSave();
  updatePreview();
  updateStats();
  toast('Objectif ajoutÃ©', 'success');
}

function toggleSmart(id) {
  if (!currentProject) return;
  const s = currentProject.smart.find(x => x.id === id);
  if (s) s.done = !s.done;
  renderSmartList();
  scheduleSave();
  updatePreview();
}

function removeSmart(id) {
  if (!currentProject) return;
  currentProject.smart = currentProject.smart.filter(x => x.id !== id);
  renderSmartList();
  scheduleSave();
  updatePreview();
  updateStats();
}

function renderSmartList() {
  if (!currentProject) return;
  
  const container = $('smart-list');
  
  if (!currentProject.smart.length) {
    container.innerHTML = '<p style="color:var(--muted);text-align:center">Aucun objectif</p>';
    return;
  }
  
  container.innerHTML = currentProject.smart.map(s => `
    <div class="list-item">
      <input type="checkbox" ${s.done ? 'checked' : ''} data-toggle="${s.id}">
      <div class="content">
        <div class="text ${s.done ? 'done' : ''}">${esc(s.text)}</div>
        <div class="meta">${s.indicator ? 'ğŸ“Š ' + esc(s.indicator) : ''} ${s.deadline ? 'ğŸ“… ' + s.deadline : ''}</div>
      </div>
      <button class="btn btn-sm btn-secondary" data-remove="${s.id}">âœ•</button>
    </div>
  `).join('');
  
  container.querySelectorAll('[data-toggle]').forEach(cb => {
    cb.addEventListener('change', () => toggleSmart(parseInt(cb.dataset.toggle)));
  });
  
  container.querySelectorAll('[data-remove]').forEach(btn => {
    btn.addEventListener('click', () => removeSmart(parseInt(btn.dataset.remove)));
  });
}

// --- JOURNAL ---
function addJournal() {
  if (!currentProject) return;
  
  const date = $('j-date').value;
  const type = $('j-type').value;
  const content = $('j-content').value.trim();
  
  if (!content) { toast('DÃ©crivez l\'entrÃ©e', 'error'); return; }
  
  currentProject.journal.unshift({ id: Date.now(), date, type, content });
  
  $('j-content').value = '';
  
  renderJournalList();
  scheduleSave();
  updatePreview();
  updateStats();
  toast('EntrÃ©e ajoutÃ©e', 'success');
}

function removeJournal(id) {
  if (!currentProject) return;
  currentProject.journal = currentProject.journal.filter(x => x.id !== id);
  renderJournalList();
  scheduleSave();
  updatePreview();
  updateStats();
}

function renderJournalList() {
  if (!currentProject) return;
  
  const container = $('journal-list');
  const icons = { action: 'ğŸ¯', rencontre: 'ğŸ¤', victoire: 'ğŸ†', difficulte: 'âš ï¸', note: 'ğŸ“' };
  
  if (!currentProject.journal.length) {
    container.innerHTML = '<p style="color:var(--muted);text-align:center">Aucune entrÃ©e</p>';
    return;
  }
  
  container.innerHTML = currentProject.journal.map(j => `
    <div class="list-item">
      <span class="icon">${icons[j.type] || 'ğŸ“'}</span>
      <div class="content">
        <div class="text">${esc(j.content)}</div>
        <div class="meta">${j.date}</div>
      </div>
      <button class="btn btn-sm btn-secondary" data-del-j="${j.id}">âœ•</button>
    </div>
  `).join('');
  
  container.querySelectorAll('[data-del-j]').forEach(btn => {
    btn.addEventListener('click', () => removeJournal(parseInt(btn.dataset.delJ)));
  });
}

// --- MESSAGE PREVIEW ---
function updateMessagePreview() {
  if (!currentProject) return;
  
  const m = currentProject.message || {};
  const el = $('message-preview');
  
  if (!m.accroche && !m.probleme && !m.importance && !m.action) {
    el.innerHTML = '<span style="color:var(--muted)">Remplissez les champs...</span>';
    return;
  }
  
  let html = '';
  if (m.accroche) html += `<strong>${esc(m.accroche)}</strong><br><br>`;
  if (m.probleme) html += `${esc(m.probleme)}<br><br>`;
  if (m.importance) html += `<em>${esc(m.importance)}</em><br><br>`;
  if (m.action) html += `<strong>â†’ ${esc(m.action)}</strong>`;
  
  el.innerHTML = html;
  el.style.fontStyle = 'normal';
  el.style.color = 'var(--text)';
}

// --- PREVIEW ---
function updatePreview() {
  if (!currentProject) {
    $('preview-doc').innerHTML = '<p style="color:var(--muted);text-align:center">Aucun projet sÃ©lectionnÃ©</p>';
    return;
  }
  
  const p = currentProject;
  const f = v => v ? `<p class="filled">${esc(v)}</p>` : '<p class="empty">Non renseignÃ©</p>';
  
  let h = `<h1>${esc(p.meta?.name || 'Sans nom')}</h1>`;
  h += `<p class="pmeta">${p.meta?.description ? esc(p.meta.description) + ' â€” ' : ''}ModifiÃ© le ${new Date(p.modified).toLocaleDateString('fr-FR')}</p>`;
  
  h += `<h2 class="c-voir">ğŸ‘ï¸ VOIR</h2>`;
  h += `<h3>Vision</h3>${f(p.domino?.vision)}`;
  h += `<h3>Obstacles</h3>${f(p.domino?.obstacles)}`;
  h += `<h3>Ressources</h3>${f(p.domino?.ressources)}`;
  
  h += `<h2 class="c-juger">âš–ï¸ JUGER</h2>`;
  h += `<h3>ProblÃ¨me central</h3>${f(p.arbre?.probleme)}`;
  
  if (p.acteurs?.length) {
    h += '<h3>Acteurs</h3><p>';
    p.acteurs.forEach(a => {
      h += `<span class="badge ${a.position}">${esc(a.name)}</span> `;
    });
    h += '</p>';
  }
  
  h += `<h2 class="c-agir">âœŠ AGIR</h2>`;
  h += `<h3>Message clÃ©</h3>`;
  if (p.message?.accroche) h += `<p class="filled"><strong>${esc(p.message.accroche)}</strong></p>`;
  if (p.message?.action) h += `<p class="filled">â†’ ${esc(p.message.action)}</p>`;
  if (!p.message?.accroche && !p.message?.action) h += '<p class="empty">Non renseignÃ©</p>';
  
  if (p.smart?.length) {
    h += '<h3>Objectifs SMART</h3><ul style="margin-left:1.2rem">';
    p.smart.forEach(s => {
      h += `<li style="${s.done ? 'text-decoration:line-through;opacity:0.5' : ''}">${esc(s.text)}</li>`;
    });
    h += '</ul>';
  }
  
  $('preview-doc').innerHTML = h;
}

// --- EXPORTS ---
function exportJSON() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  download(JSON.stringify(currentProject, null, 2), slug(currentProject.meta?.name) + '.json', 'application/json');
  toast('Export JSON OK', 'success');
}

function exportMD() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  const p = currentProject;
  let md = `# ${p.meta?.name || 'Projet'}\n\n`;
  md += `## ğŸ‘ï¸ VOIR\n\n### Vision\n${p.domino?.vision || 'â€”'}\n\n`;
  md += `## âš–ï¸ JUGER\n\n### ProblÃ¨me\n${p.arbre?.probleme || 'â€”'}\n\n`;
  md += `## âœŠ AGIR\n\n### Message\n${p.message?.accroche || ''}\n\nâ†’ ${p.message?.action || ''}\n`;
  download(md, slug(p.meta?.name) + '.md', 'text/markdown');
  toast('Export Markdown OK', 'success');
}

function exportHTML() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  const p = currentProject;
  let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(p.meta?.name)}</title></head><body style="font-family:sans-serif;max-width:800px;margin:2rem auto">`;
  html += `<h1>${esc(p.meta?.name)}</h1>`;
  html += `<h2>Vision</h2><p>${esc(p.domino?.vision) || 'â€”'}</p>`;
  html += `<h2>Message</h2><p><strong>${esc(p.message?.accroche)}</strong></p>`;
  html += `</body></html>`;
  download(html, slug(p.meta?.name) + '.html', 'text/html');
  toast('Export HTML OK', 'success');
}

function exportPDF() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  if (typeof window.jspdf === 'undefined') { toast('PDF non disponible', 'error'); return; }
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const p = currentProject;
    
    doc.setFontSize(18);
    doc.text(p.meta?.name || 'Projet', 20, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text('ExportÃ© le ' + new Date().toLocaleDateString('fr-FR'), 20, 28);
    
    let y = 40;
    const addSection = (title, content) => {
      if (y > 260) { doc.addPage(); y = 20; }
      doc.setFontSize(12);
      doc.setTextColor(0);
      doc.text(title, 20, y);
      y += 7;
      doc.setFontSize(10);
      doc.setTextColor(60);
      const lines = doc.splitTextToSize(content || 'Non renseignÃ©', 170);
      doc.text(lines, 20, y);
      y += lines.length * 5 + 8;
    };
    
    addSection('VISION', p.domino?.vision);
    addSection('PROBLÃˆME', p.arbre?.probleme);
    addSection('MESSAGE', (p.message?.accroche || '') + '\n\nâ†’ ' + (p.message?.action || ''));
    
    doc.save(slug(p.meta?.name) + '.pdf');
    toast('Export PDF OK', 'success');
  } catch (e) {
    console.error('PDF error:', e);
    toast('Erreur PDF: ' + e.message, 'error');
  }
}

function exportDOCX() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  if (typeof window.docx === 'undefined') { toast('DOCX non disponible', 'error'); return; }
  
  try {
    const { Document, Paragraph, TextRun, HeadingLevel, Packer } = window.docx;
    const p = currentProject;
    
    const doc = new Document({
      sections: [{
        children: [
          new Paragraph({ text: p.meta?.name || 'Projet', heading: HeadingLevel.TITLE }),
          new Paragraph({ text: '' }),
          new Paragraph({ text: 'VISION', heading: HeadingLevel.HEADING_1 }),
          new Paragraph({ text: p.domino?.vision || 'Non renseignÃ©' }),
          new Paragraph({ text: '' }),
          new Paragraph({ text: 'PROBLÃˆME', heading: HeadingLevel.HEADING_1 }),
          new Paragraph({ text: p.arbre?.probleme || 'Non renseignÃ©' }),
          new Paragraph({ text: '' }),
          new Paragraph({ text: 'MESSAGE', heading: HeadingLevel.HEADING_1 }),
          new Paragraph({ children: [new TextRun({ text: p.message?.accroche || '', bold: true })] }),
          new Paragraph({ text: 'â†’ ' + (p.message?.action || '') })
        ]
      }]
    });
    
    Packer.toBlob(doc).then(blob => {
      downloadBlob(blob, slug(p.meta?.name) + '.docx');
      toast('Export Word OK', 'success');
    });
  } catch (e) {
    console.error('DOCX error:', e);
    toast('Erreur DOCX: ' + e.message, 'error');
  }
}

function exportXLSX() {
  if (!currentProject) { toast('Aucun projet', 'error'); return; }
  if (typeof XLSX === 'undefined') { toast('Excel non disponible', 'error'); return; }
  
  try {
    const p = currentProject;
    const wb = XLSX.utils.book_new();
    
    const summary = [
      ['Projet Plaidoyer'], [''],
      ['Nom', p.meta?.name || ''],
      ['Description', p.meta?.description || ''],
      [''], ['VOIR'],
      ['Vision', p.domino?.vision || ''],
      [''], ['JUGER'],
      ['ProblÃ¨me', p.arbre?.probleme || ''],
      [''], ['AGIR'],
      ['Message', p.message?.accroche || ''],
      ['Action', p.message?.action || '']
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'RÃ©sumÃ©');
    
    if (p.acteurs?.length) {
      const actors = [['Nom', 'RÃ´le', 'Position', 'Pouvoir'], ...p.acteurs.map(a => [a.name, a.role, a.position, a.power])];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(actors), 'Acteurs');
    }
    
    if (p.smart?.length) {
      const smart = [['Objectif', 'Indicateur', 'Ã‰chÃ©ance', 'Fait'], ...p.smart.map(s => [s.text, s.indicator, s.deadline, s.done ? 'Oui' : 'Non'])];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(smart), 'Objectifs');
    }
    
    if (p.journal?.length) {
      const journal = [['Date', 'Type', 'Contenu'], ...p.journal.map(j => [j.date, j.type, j.content])];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(journal), 'Journal');
    }
    
    XLSX.writeFile(wb, slug(p.meta?.name) + '.xlsx');
    toast('Export Excel OK', 'success');
  } catch (e) {
    console.error('XLSX error:', e);
    toast('Erreur Excel: ' + e.message, 'error');
  }
}

function importJSON(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (ev) => {
    try {
      const raw = JSON.parse(ev.target.result);
      
      // Convertir l'ancien format vers le nouveau
      const data = convertImportFormat(raw);
      
      data.id = Date.now().toString();
      data.modified = new Date().toISOString();
      
      await dbPut(data);
      await renderProjectsList();
      await selectProject(data.id);
      toast('Projet importÃ© !', 'success');
    } catch (err) {
      console.error('Import error:', err);
      toast('Erreur import: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// Convertir les diffÃ©rents formats d'import vers le format interne
function convertImportFormat(raw) {
  const p = createEmptyProject('Import', '');
  
  // Meta / Project
  if (raw.project) {
    p.meta.name = raw.project.name || 'Import';
    p.meta.description = raw.project.description || '';
    p.meta.organization = raw.project.organization || '';
  } else if (raw.meta) {
    p.meta = { ...p.meta, ...raw.meta };
  }
  
  // Domino
  if (raw.domino) {
    p.domino.vision = raw.domino.vision || '';
    p.domino.obstacles = raw.domino.obstacles || '';
    p.domino.ressources = raw.domino.ressources || raw.domino.resources || '';
  }
  
  // Profil
  if (raw.profil) {
    p.profil = { ...p.profil, ...raw.profil };
  }
  
  // Fleur
  if (raw.fleur) {
    p.fleur = { ...p.fleur, ...raw.fleur };
  }
  
  // Acteurs
  if (raw.acteurs && Array.isArray(raw.acteurs)) {
    p.acteurs = raw.acteurs.map((a, i) => ({
      id: Date.now() + i,
      name: a.name || a.nom || '',
      role: a.role || a.fonction || '',
      position: a.position === 'target' ? 'neutral' : (a.position || 'neutral'),
      power: parseInt(a.power || a.pouvoir || 3)
    }));
  }
  
  // Arbre
  if (raw.arbre) {
    p.arbre.probleme = raw.arbre.probleme_central || raw.arbre.probleme || '';
    // Causes: peut Ãªtre string ou array
    if (Array.isArray(raw.arbre.causes)) {
      p.arbre.causes = raw.arbre.causes.join('\n');
    } else {
      p.arbre.causes = raw.arbre.causes || '';
    }
    // Effets: peut Ãªtre string ou array
    if (Array.isArray(raw.arbre.effets)) {
      p.arbre.effets = raw.arbre.effets.join('\n');
    } else {
      p.arbre.effets = raw.arbre.effets || '';
    }
  }
  
  // Pourquoi
  if (raw.pourquoi) {
    p.pourquoi = { ...p.pourquoi, ...raw.pourquoi };
  }
  
  // SWOT (mapping des noms anglais/franÃ§ais)
  if (raw.swot) {
    p.swot.forces = raw.swot.forces || raw.swot.strengths || '';
    p.swot.faiblesses = raw.swot.faiblesses || raw.swot.weaknesses || '';
    p.swot.opportunites = raw.swot.opportunites || raw.swot.opportunities || '';
    p.swot.menaces = raw.swot.menaces || raw.swot.threats || '';
  }
  
  // PESTEL
  if (raw.pestel) {
    p.pestel = { ...p.pestel, ...raw.pestel };
  }
  
  // TdC (mapping des noms)
  if (raw.tdc) {
    p.tdc.impact = raw.tdc.impact || '';
    p.tdc.individuel_interne = raw.tdc.individuel_interne || raw.tdc.changement_interne_individuel || '';
    p.tdc.individuel_externe = raw.tdc.individuel_externe || raw.tdc.changement_externe_individuel || '';
    p.tdc.collectif_interne = raw.tdc.collectif_interne || raw.tdc.changement_interne_collectif || '';
    p.tdc.collectif_externe = raw.tdc.collectif_externe || raw.tdc.changement_externe_collectif || '';
  }
  
  // Pouvoir
  if (raw.pouvoir) {
    p.pouvoir = { ...p.pouvoir, ...raw.pouvoir };
  }
  
  // Cibles
  if (raw.cibles) {
    p.cibles.principale = raw.cibles.principale || '';
    p.cibles.secondaires = raw.cibles.secondaires || '';
    p.cibles.allies = raw.cibles.allies || raw.cibles.alliÃ©s || '';
    p.cibles.opposants = raw.cibles.opposants || '';
  }
  
  // SMART (format ancien: s/m/a/r/t ou format nouveau: text/indicator/deadline/done)
  if (raw.smart && Array.isArray(raw.smart)) {
    p.smart = raw.smart.map((s, i) => ({
      id: Date.now() + i,
      text: s.text || s.s || '',
      indicator: s.indicator || s.m || '',
      deadline: s.deadline || s.t || '',
      done: s.done || false
    }));
  }
  
  // Message
  if (raw.message) {
    p.message = { ...p.message, ...raw.message };
  }
  
  // Evaluation
  if (raw.evaluation) {
    p.evaluation = { ...p.evaluation, ...raw.evaluation };
  }
  
  // Journal (ou checklist convertie en journal)
  if (raw.journal && Array.isArray(raw.journal)) {
    p.journal = raw.journal.map((j, i) => ({
      id: Date.now() + i,
      date: j.date || new Date().toISOString().split('T')[0],
      type: j.type || 'note',
      content: j.content || j.text || ''
    }));
  } else if (raw.checklist && Array.isArray(raw.checklist)) {
    // Convertir checklist en journal
    p.journal = raw.checklist.map((c, i) => ({
      id: Date.now() + i,
      date: new Date().toISOString().split('T')[0],
      type: c.done ? 'victoire' : 'action',
      content: `[${c.phase || ''}] ${c.task || ''}`
    }));
  }
  
  return p;
}

// --- MODAL ---
function openModal() {
  $('modal-overlay').classList.add('show');
  $('m-name').value = '';
  $('m-desc').value = '';
  $('m-name').focus();
}

function closeModal() {
  $('modal-overlay').classList.remove('show');
}

async function createProject() {
  const name = $('m-name').value.trim();
  const desc = $('m-desc').value.trim();
  
  if (!name) { toast('Entrez un nom', 'error'); return; }
  
  const project = createEmptyProject(name, desc);
  await dbPut(project);
  closeModal();
  await renderProjectsList();
  await selectProject(project.id);
  toast('Projet crÃ©Ã©', 'success');
}

// --- INIT ---
async function init() {
  console.log('Initializing...');
  
  try {
    // Open database
    await openDB();
    
    // Init mermaid
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
    }
    
    // Render projects list
    await renderProjectsList();
    
    // Set today's date for journal
    $('j-date').value = new Date().toISOString().split('T')[0];
    
    // --- EVENT LISTENERS ---
    
    // New project buttons
    $('btn-new-project').addEventListener('click', openModal);
    $('btn-new-empty').addEventListener('click', openModal);
    
    // Modal
    $('m-cancel').addEventListener('click', closeModal);
    $('m-create').addEventListener('click', createProject);
    $('modal-overlay').addEventListener('click', (e) => {
      if (e.target === $('modal-overlay')) closeModal();
    });
    
    // Navigation
    $$('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.dataset.page;
        // Permettre l'accÃ¨s Ã  export mÃªme sans projet (pour import)
        if (!currentProject && page !== 'empty' && page !== 'export') {
          toast('SÃ©lectionnez ou importez un projet', 'warning');
          return;
        }
        showPage(page);
      });
    });
    
    // Field auto-save
    $$('[data-field]').forEach(el => {
      el.addEventListener('input', () => {
        if (!currentProject) return;
        
        const [section, key] = el.dataset.field.split('.');
        if (!currentProject[section]) currentProject[section] = {};
        currentProject[section][key] = el.value;
        
        // Update project name in list
        if (section === 'meta' && key === 'name') {
          renderProjectsList();
        }
        
        // Update message preview
        if (section === 'message') {
          updateMessagePreview();
        }
        
        scheduleSave();
        updatePreview();
        updateStats();
      });
    });
    
    // Actors
    $('btn-add-actor').addEventListener('click', addActor);
    $('btn-refresh-actors').addEventListener('click', refreshActorsMermaid);
    
    // Tree
    $('btn-refresh-tree').addEventListener('click', refreshTreeMermaid);
    
    // SMART
    $('btn-add-smart').addEventListener('click', addSmart);
    
    // Journal
    $('btn-add-journal').addEventListener('click', addJournal);
    
    // Exports
    $('exp-json').addEventListener('click', exportJSON);
    $('exp-md').addEventListener('click', exportMD);
    $('exp-html').addEventListener('click', exportHTML);
    $('exp-pdf').addEventListener('click', exportPDF);
    $('exp-docx').addEventListener('click', exportDOCX);
    $('exp-xlsx').addEventListener('click', exportXLSX);
    
    // Preview exports
    $('prev-json').addEventListener('click', exportJSON);
    $('prev-md').addEventListener('click', exportMD);
    $('prev-pdf').addEventListener('click', exportPDF);
    
    // Import
    $('import-file').addEventListener('change', importJSON);
    $('import-home').addEventListener('change', importJSON);
    
    console.log('Initialization complete');
    toast('Application prÃªte', 'success');
    
  } catch (err) {
    console.error('Init error:', err);
    toast('Erreur: ' + err.message, 'error');
  }
}

// Start when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

})();
</script>
</body>
</html>
