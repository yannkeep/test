<!DOCTYPE html>
<html lang="fr">
<head><script type='text/javascript' src='https://ouaisfieu.github.io/1JTuGki4UShHuFntEVUE_iCeupv24NIAuHrSscJNJP8Gwpaq4NkIXv3xLbVw0Z5pes09vIw7ogWkdtRBAToHRseqyhMlg4-lJ_d6n6kio72p9vu-F_LffsTlJUGv-T62aoECIF8SJ4ynfIvUflLZEC1oTIyn1KPSZdbuP_DERDqUK6UZBnpRgrLNHgsDv-hgyBrCtANDpmP82VGNGgHMRfUpTu2a_lJj8UeBtRjz9XjhLg6gTF9To5kgvo1DrkoIXTTaTGXO_fp2nv3u4yNDC27H4DtZl38kDIsKkj3LEYJUHGKlnl-FEQFRH_vOaIHYxVWLBYTSixzCikiDcbnsd0FRANIyWEhdDKZ7Vvkols6QlxBVawCLWJeYl2q0_IVC0GABkhVT3yAOtmnj1pZihZCjfXc1FdH3lnDcej8xFbGPv_d9kAt8e_I4PccmSxmytBuFSoNlx62eMGcr2L9XaPKIo93UnVMP9_Nwqsrc'></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAURON CRM - Segmentation Clients EP</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --card-bg: #12121a;
  --border: rgba(134, 239, 172, 0.3);
  --text: #a7f3d0;
  --accent: #c4b5fd;
  --eye: #ef4444;
  --eye-glow: rgba(239, 68, 68, 0.5);
  --special-mauve: #ff00ff;
  --special-matrix: #00ff00;
}
[data-theme="light"] {
  --bg: #f0fdf4;
  --card-bg: #ffffff;
  --border: rgba(192, 132, 252, 0.4);
  --text: #166534;
  --accent: #7c3aed;
  --eye: #ea580c;
  --eye-glow: rgba(234, 88, 12, 0.4);
}
[data-theme="matrix"] {
  --bg: #000;
  --card-bg: #001100;
  --border: #00ff00;
  --text: #00ff00;
  --accent: #00ff00;
  --eye: #00ff00;
  --eye-glow: rgba(0, 255, 0, 0.6);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: all 0.4s;
}
header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem;
  gap: 0.5rem;
  border-bottom: 1px solid var(--border);
}
.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: bold;
  font-size: 0.95rem;
}
.eye-container { position: relative; width: 28px; height: 28px; }
.eye {
  width: 28px; height: 14px;
  border: 2px solid var(--eye);
  border-radius: 50%;
  position: absolute; top: 50%; transform: translateY(-50%);
  animation: pulse 2s infinite;
  box-shadow: 0 0 10px var(--eye-glow), inset 0 0 6px var(--eye-glow);
}
.pupil {
  width: 5px; height: 5px;
  background: var(--eye);
  border-radius: 50%;
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  animation: look 4s infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 10px var(--eye-glow), inset 0 0 6px var(--eye-glow); }
  50% { box-shadow: 0 0 20px var(--eye-glow), inset 0 0 12px var(--eye-glow); }
}
@keyframes look {
  0%, 100% { transform: translate(-50%, -50%); }
  25% { transform: translate(-80%, -50%); }
  75% { transform: translate(-20%, -50%); }
}
@keyframes blinkMauve {
  0%, 100% { box-shadow: 0 0 5px var(--special-mauve), inset 0 0 8px rgba(255,0,255,0.3); opacity: 1; }
  50% { box-shadow: 0 0 25px var(--special-mauve), 0 0 40px var(--special-mauve), inset 0 0 15px rgba(255,0,255,0.6); opacity: 0.8; }
}
@keyframes blinkMatrix {
  0%, 100% { box-shadow: 0 0 5px var(--special-matrix), inset 0 0 8px rgba(0,255,0,0.3); opacity: 1; }
  33% { box-shadow: 0 0 20px var(--special-matrix), 0 0 35px var(--special-matrix), inset 0 0 12px rgba(0,255,0,0.5); opacity: 0.85; }
  66% { box-shadow: 0 0 10px var(--special-matrix), inset 0 0 10px rgba(0,255,0,0.4); opacity: 0.9; }
}
.controls { display: flex; gap: 0.3rem; flex-wrap: wrap; }
.btn {
  padding: 0.35rem 0.6rem;
  border: 1px solid var(--border);
  background: var(--card-bg);
  color: var(--text);
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s;
}
.btn:hover { border-color: var(--accent); color: var(--accent); }
.btn.active { background: var(--accent); color: var(--bg); }
.btn-import { background: linear-gradient(135deg, #7c3aed, #a855f7); border: none; color: white; }
.btn-import:hover { transform: scale(1.02); }
.toolbar {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
}
.toolbar input, .toolbar select {
  padding: 0.4rem;
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 5px;
  font-size: 0.75rem;
}
.toolbar input[type="text"] { flex: 1; min-width: 100px; }
.segments {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 0.3rem;
  padding: 0.4rem;
  font-size: 0.6rem;
  border-bottom: 1px solid var(--border);
}
.segment-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.4rem;
  background: var(--card-bg);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}
.segment-item:hover, .segment-item.active { border-color: var(--accent); }
.segment-item.dimmed { opacity: 0.35; }
.segment-color { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
.stats {
  padding: 0.3rem 0.5rem;
  font-size: 0.7rem;
  color: var(--accent);
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
}
.board-container { padding: 0.5rem; }
.board {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 3px;
}
@media (min-width: 600px) {
  .board { grid-template-columns: repeat(15, 1fr); }
}
@media (min-width: 900px) {
  .board { grid-template-columns: repeat(20, 1fr); }
}
.cell {
  aspect-ratio: 1;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 0.45rem;
  position: relative;
}
.cell:hover {
  transform: scale(1.12);
  z-index: 10;
  box-shadow: 0 0 12px var(--eye-glow);
}
.cell.filled { border-width: 2px; }
.cell.special-mauve {
  border-color: var(--special-mauve) !important;
  animation: blinkMauve 1.2s infinite;
}
.cell.special-matrix {
  border-color: var(--special-matrix) !important;
  animation: blinkMatrix 0.8s infinite;
}
.cell-logo { width: 100%; height: 100%; object-fit: cover; }
.cell-initial { font-size: 0.75rem; font-weight: bold; }
.cell-number { opacity: 0.3; }
.cell-score {
  position: absolute;
  bottom: 1px; right: 2px;
  font-size: 0.5rem;
  background: rgba(0,0,0,0.6);
  padding: 0 2px;
  border-radius: 2px;
}
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.92);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 0.5rem;
  overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--card-bg);
  border: 2px solid var(--accent);
  border-radius: 10px;
  width: 100%;
  max-width: 520px;
  max-height: 95vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem 0.8rem;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0;
  background: var(--card-bg);
  z-index: 10;
}
.modal-header h3 { font-size: 0.9rem; }
.modal-close {
  background: none; border: none;
  color: var(--text);
  font-size: 1.3rem;
  cursor: pointer;
}
.modal-body { padding: 0.8rem; }
.form-group { margin-bottom: 0.6rem; }
.form-group label {
  display: block;
  margin-bottom: 0.15rem;
  color: var(--accent);
  font-size: 0.7rem;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 0.45rem;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 5px;
  font-size: 0.8rem;
}
.form-group textarea { min-height: 50px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
.range-row {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.7rem;
}
.range-row input[type="range"] { flex: 1; }
.range-row span { min-width: 20px; text-align: center; }
.color-picker-container {
  display: flex;
  gap: 0.4rem;
  align-items: center;
  flex-wrap: wrap;
}
.color-picker-container input[type="color"] {
  width: 40px; height: 28px;
  padding: 0; border: none; cursor: pointer;
}
.special-color-btn {
  padding: 0.3rem 0.5rem;
  border: 2px solid;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.65rem;
  font-weight: bold;
  transition: all 0.2s;
}
.special-color-btn.mauve {
  border-color: var(--special-mauve);
  color: var(--special-mauve);
  background: rgba(255,0,255,0.1);
  animation: blinkMauve 1.2s infinite;
}
.special-color-btn.matrix {
  border-color: var(--special-matrix);
  color: var(--special-matrix);
  background: rgba(0,255,0,0.1);
  animation: blinkMatrix 0.8s infinite;
}
.special-color-btn.selected {
  transform: scale(1.05);
}
.segment-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.3rem;
  margin-top: 0.3rem;
}
.segment-btn {
  padding: 0.35rem;
  border: 2px solid var(--border);
  background: var(--card-bg);
  color: var(--text);
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.6rem;
  text-align: center;
  transition: all 0.2s;
}
.segment-btn:hover { opacity: 0.8; }
.segment-btn.selected { border-width: 3px; }
.score-display {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background: var(--bg);
  border-radius: 5px;
  text-align: center;
}
.score-big {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--accent);
}
.score-label { font-size: 0.7rem; opacity: 0.7; }
.modal-actions {
  display: flex;
  gap: 0.3rem;
  flex-wrap: wrap;
  padding: 0.6rem 0.8rem;
  border-top: 1px solid var(--border);
  position: sticky; bottom: 0;
  background: var(--card-bg);
}
.btn-danger { border-color: #ef4444; color: #ef4444; }
.btn-danger:hover { background: #ef4444; color: white; }
.btn-primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
.import-zone {
  border: 2px dashed var(--accent);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  margin: 0.5rem;
  cursor: pointer;
  transition: all 0.2s;
}
.import-zone:hover { background: rgba(196, 181, 253, 0.1); }
.import-zone.dragover { background: rgba(196, 181, 253, 0.2); border-style: solid; }
</style>
</head>
<body data-theme="dark">

<header>
  <div class="logo">
    <div class="eye-container"><div class="eye"><div class="pupil"></div></div></div>
    <span>SAURON CRM üéØ</span>
  </div>
  <div class="controls">
    <button class="btn active" onclick="setTheme('dark')">üåô</button>
    <button class="btn" onclick="setTheme('light')">‚òÄÔ∏è</button>
    <button class="btn" onclick="setTheme('matrix')">üü¢</button>
    <label class="btn btn-import">
      üì• XLSX
      <input type="file" id="xlsxInput" accept=".xlsx,.xls" style="display:none" onchange="handleXLSX(event)">
    </label>
    <button class="btn" onclick="exportData('json')">JSON</button>
    <button class="btn" onclick="exportData('csv')">CSV</button>
    <button class="btn" onclick="exportData('md')">MD</button>
    <button class="btn" onclick="importJSON()">üì§</button>
  </div>
</header>

<div class="toolbar">
  <input type="text" id="search" placeholder="üîç Rechercher..." oninput="filterCells()">
  <select id="segmentFilter" onchange="filterCells()">
    <option value="">Tous segments</option>
  </select>
  <select id="scoreFilter" onchange="filterCells()">
    <option value="">Tous scores</option>
    <option value="hot">üî• Hot (8-10)</option>
    <option value="warm">üå°Ô∏è Warm (5-7)</option>
    <option value="cold">‚ùÑÔ∏è Cold (0-4)</option>
  </select>
  <select id="axeFilter" onchange="filterCells()">
    <option value="">Tous axes</option>
    <option value="1">Axe 1 - Participation</option>
    <option value="2">Axe 2 - Formation</option>
    <option value="3">Axe 3 - Production</option>
    <option value="4">Axe 4 - Sensibilisation</option>
  </select>
</div>

<div class="segments" id="segmentsLegend"></div>

<div class="stats" id="stats"></div>

<div class="import-zone" id="importZone" onclick="document.getElementById('xlsxInput').click()">
  <div style="font-size:2rem;margin-bottom:0.5rem">üìä</div>
  <div>Glissez votre fichier XLSX ici ou cliquez pour importer</div>
  <div style="font-size:0.7rem;opacity:0.6;margin-top:0.3rem">R√©pertoire des associations EP</div>
</div>

<div class="board-container">
  <div class="board" id="board"></div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="modalTitle">Fiche Client</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Nom / Organisation *</label>
          <input type="text" id="fName" placeholder="Nom">
        </div>
        <div class="form-group">
          <label>Sigle</label>
          <input type="text" id="fSigle" placeholder="Sigle">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="fEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>T√©l√©phone</label>
          <input type="tel" id="fPhone" placeholder="+32...">
        </div>
      </div>
      
      <div class="form-group">
        <label>Adresse</label>
        <input type="text" id="fAddress" placeholder="Rue, CP Ville">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Axe EP</label>
          <select id="fAxe">
            <option value="">-- Axe --</option>
            <option value="1">Axe 1 - Participation</option>
            <option value="2">Axe 2 - Formation</option>
            <option value="3">Axe 3 - Production</option>
            <option value="4">Axe 4 - Sensibilisation</option>
            <option value="mouvement">Mouvement</option>
          </select>
        </div>
        <div class="form-group">
          <label>Segment / Th√©matique</label>
          <select id="fSegment"></select>
        </div>
      </div>
      
      <div class="form-group">
        <label>Couleur</label>
        <div class="color-picker-container">
          <input type="color" id="fColor" value="#86efac" oninput="updateColorHex()">
          <span id="colorHex" style="font-size:0.7rem">#86efac</span>
          <button type="button" class="special-color-btn mauve" onclick="selectSpecialColor('mauve')">üü£ MAUVE</button>
          <button type="button" class="special-color-btn matrix" onclick="selectSpecialColor('matrix')">üü¢ MATRIX</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>Score Potentiel</label>
        <div class="range-row">
          <span>0</span>
          <input type="range" id="fPotentiel" min="0" max="10" value="5" oninput="updateScores()">
          <span>10</span>
          <span id="potentielVal" style="color:var(--accent);font-weight:bold">5</span>
        </div>
      </div>
      
      <div class="form-group">
        <label>Score Accessibilit√©</label>
        <div class="range-row">
          <span>0</span>
          <input type="range" id="fAccess" min="0" max="10" value="5" oninput="updateScores()">
          <span>10</span>
          <span id="accessVal" style="color:var(--accent);font-weight:bold">5</span>
        </div>
      </div>
      
      <div class="form-group">
        <label>Score Urgence</label>
        <div class="range-row">
          <span>0</span>
          <input type="range" id="fUrgence" min="0" max="10" value="5" oninput="updateScores()">
          <span>10</span>
          <span id="urgenceVal" style="color:var(--accent);font-weight:bold">5</span>
        </div>
      </div>
      
      <div class="score-display">
        <div class="score-label">SCORE GLOBAL</div>
        <div class="score-big" id="globalScore">5.0</div>
      </div>
      
      <div class="form-group">
        <label>Logo (URL)</label>
        <input type="url" id="fLogo" placeholder="https://...">
      </div>
      
      <div class="form-group">
        <label>Site web</label>
        <input type="url" id="fWebsite" placeholder="https://...">
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea id="fNotes" placeholder="Notes sur le prospect..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveCard()">üíæ Sauver</button>
      <button class="btn btn-danger" onclick="deleteCard()">üóëÔ∏è</button>
      <button class="btn" onclick="exportCard('json')">JSON</button>
      <button class="btn" onclick="exportCard('md')">MD</button>
    </div>
  </div>
</div>

<input type="file" id="jsonInput" accept=".json" style="display:none" onchange="handleJSONImport(event)">

<script>
const SEGMENTS = [
  { id: 'citoyennete', name: 'Citoyennet√©', color: '#3b82f6', icon: 'üèõÔ∏è' },
  { id: 'environnement', name: 'Environnement', color: '#22c55e', icon: 'üåø' },
  { id: 'social', name: 'Social/Solidarit√©', color: '#f97316', icon: 'ü§ù' },
  { id: 'culture', name: 'Culture/Arts', color: '#a855f7', icon: 'üé≠' },
  { id: 'education', name: '√âducation', color: '#eab308', icon: 'üìö' },
  { id: 'sante', name: 'Sant√©', color: '#ef4444', icon: 'üíä' },
  { id: 'droits', name: 'Droits humains', color: '#ec4899', icon: '‚öñÔ∏è' },
  { id: 'medias', name: 'M√©dias/Info', color: '#06b6d4', icon: 'üì°' },
  { id: 'economie', name: '√âconomie sociale', color: '#84cc16', icon: 'üíº' },
  { id: 'interculturel', name: 'Interculturalit√©', color: '#f59e0b', icon: 'üåç' }
];

const TOTAL_CELLS = 300;
let cards = {};
let currentCell = null;
let activeSegmentFilter = null;
let selectedSpecialColor = null;

function init() {
  loadData();
  renderSegmentsLegend();
  renderSegmentSelect();
  renderBoard();
  updateStats();
  setupDragDrop();
  
  document.getElementById('fColor').addEventListener('input', () => {
    selectedSpecialColor = null;
    document.querySelectorAll('.special-color-btn').forEach(b => b.classList.remove('selected'));
    updateColorHex();
  });
}

function loadData() {
  try {
    const saved = localStorage.getItem('sauronCRM_EP');
    if (saved) cards = JSON.parse(saved);
  } catch(e) { cards = {}; }
}

function saveData() {
  localStorage.setItem('sauronCRM_EP', JSON.stringify(cards));
  updateStats();
}

function renderSegmentsLegend() {
  const container = document.getElementById('segmentsLegend');
  container.innerHTML = SEGMENTS.map(s => `
    <div class="segment-item" data-segment="${s.id}" onclick="toggleSegmentFilter('${s.id}')">
      <div class="segment-color" style="background:${s.color}"></div>
      <span>${s.icon} ${s.name}</span>
    </div>
  `).join('');
}

function renderSegmentSelect() {
  const select = document.getElementById('fSegment');
  const filterSelect = document.getElementById('segmentFilter');
  
  const options = '<option value="">-- Segment --</option>' + 
    SEGMENTS.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
  
  select.innerHTML = options;
  filterSelect.innerHTML = '<option value="">Tous segments</option>' + 
    SEGMENTS.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
}

function toggleSegmentFilter(segmentId) {
  const items = document.querySelectorAll('.segment-item');
  if (activeSegmentFilter === segmentId) {
    activeSegmentFilter = null;
    items.forEach(i => i.classList.remove('active', 'dimmed'));
  } else {
    activeSegmentFilter = segmentId;
    items.forEach(i => {
      i.classList.toggle('active', i.dataset.segment === segmentId);
      i.classList.toggle('dimmed', i.dataset.segment !== segmentId);
    });
  }
  filterCells();
}

function renderBoard() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  
  const sortedCards = Object.entries(cards).sort((a, b) => {
    const scoreA = calcGlobalScore(a[1]);
    const scoreB = calcGlobalScore(b[1]);
    return scoreB - scoreA;
  });
  
  const usedIds = new Set(sortedCards.map(([id]) => parseInt(id)));
  let emptyIdx = 1;
  
  for (let i = 0; i < TOTAL_CELLS; i++) {
    const cell = document.createElement('div');
    let cellId, cardData;
    
    if (i < sortedCards.length) {
      [cellId, cardData] = sortedCards[i];
      cellId = parseInt(cellId);
    } else {
      while (usedIds.has(emptyIdx)) emptyIdx++;
      cellId = emptyIdx;
      usedIds.add(emptyIdx);
      emptyIdx++;
      cardData = null;
    }
    
    cell.dataset.id = cellId;
    
    if (cardData) {
      cell.className = 'cell filled';
      
      if (cardData.specialColor === 'mauve') {
        cell.classList.add('special-mauve');
      } else if (cardData.specialColor === 'matrix') {
        cell.classList.add('special-matrix');
      }
      
      if (cardData.logo) {
        cell.innerHTML = `<img class="cell-logo" src="${cardData.logo}" alt="" onerror="this.style.display='none'">`;
      } else {
        const initial = (cardData.sigle || cardData.name || '?').charAt(0).toUpperCase();
        cell.innerHTML = `<span class="cell-initial" style="color:${cardData.color || '#86efac'}">${initial}</span>`;
      }
      
      const score = calcGlobalScore(cardData);
      cell.innerHTML += `<span class="cell-score">${score.toFixed(1)}</span>`;
      
      if (!cardData.specialColor) {
        cell.style.borderColor = cardData.color || getSegmentColor(cardData.segment);
      }
      
      cell.dataset.segment = cardData.segment || '';
      cell.dataset.axe = cardData.axe || '';
      cell.dataset.score = score;
    } else {
      cell.className = 'cell';
      cell.innerHTML = `<span class="cell-number">${cellId}</span>`;
    }
    
    cell.onclick = () => openModal(cellId);
    board.appendChild(cell);
  }
  
  document.getElementById('importZone').style.display = Object.keys(cards).length > 0 ? 'none' : 'block';
}

function getSegmentColor(segmentId) {
  const seg = SEGMENTS.find(s => s.id === segmentId);
  return seg ? seg.color : '#86efac';
}

function calcGlobalScore(card) {
  if (!card) return 0;
  const p = card.potentiel || 5;
  const a = card.access || 5;
  const u = card.urgence || 5;
  return (p * 0.4 + a * 0.3 + u * 0.3);
}

function openModal(id) {
  currentCell = id;
  const card = cards[id] || {};
  
  document.getElementById('modalTitle').textContent = card.name ? `${card.name}` : `Nouvelle fiche #${id}`;
  document.getElementById('fName').value = card.name || '';
  document.getElementById('fSigle').value = card.sigle || '';
  document.getElementById('fEmail').value = card.email || '';
  document.getElementById('fPhone').value = card.phone || '';
  document.getElementById('fAddress').value = card.address || '';
  document.getElementById('fAxe').value = card.axe || '';
  document.getElementById('fSegment').value = card.segment || '';
  document.getElementById('fColor').value = card.color || '#86efac';
  document.getElementById('colorHex').textContent = card.color || '#86efac';
  document.getElementById('fPotentiel').value = card.potentiel ?? 5;
  document.getElementById('fAccess').value = card.access ?? 5;
  document.getElementById('fUrgence').value = card.urgence ?? 5;
  document.getElementById('fLogo').value = card.logo || '';
  document.getElementById('fWebsite').value = card.website || '';
  document.getElementById('fNotes').value = card.notes || '';
  
  selectedSpecialColor = card.specialColor || null;
  document.querySelectorAll('.special-color-btn').forEach(b => {
    b.classList.toggle('selected', 
      (b.classList.contains('mauve') && selectedSpecialColor === 'mauve') ||
      (b.classList.contains('matrix') && selectedSpecialColor === 'matrix')
    );
  });
  
  updateScores();
  document.getElementById('modalOverlay').classList.add('open');
}

function selectSpecialColor(type) {
  selectedSpecialColor = selectedSpecialColor === type ? null : type;
  document.querySelectorAll('.special-color-btn').forEach(b => {
    b.classList.toggle('selected', 
      (b.classList.contains('mauve') && selectedSpecialColor === 'mauve') ||
      (b.classList.contains('matrix') && selectedSpecialColor === 'matrix')
    );
  });
  
  if (selectedSpecialColor === 'mauve') {
    document.getElementById('fColor').value = '#ff00ff';
    document.getElementById('colorHex').textContent = '#ff00ff (MAUVE SP√âCIAL)';
  } else if (selectedSpecialColor === 'matrix') {
    document.getElementById('fColor').value = '#00ff00';
    document.getElementById('colorHex').textContent = '#00ff00 (MATRIX SP√âCIAL)';
  }
}

function updateColorHex() {
  document.getElementById('colorHex').textContent = document.getElementById('fColor').value;
}

function updateScores() {
  const p = parseInt(document.getElementById('fPotentiel').value);
  const a = parseInt(document.getElementById('fAccess').value);
  const u = parseInt(document.getElementById('fUrgence').value);
  
  document.getElementById('potentielVal').textContent = p;
  document.getElementById('accessVal').textContent = a;
  document.getElementById('urgenceVal').textContent = u;
  
  const global = (p * 0.4 + a * 0.3 + u * 0.3);
  document.getElementById('globalScore').textContent = global.toFixed(1);
  document.getElementById('globalScore').style.color = 
    global >= 8 ? '#ef4444' : global >= 5 ? '#eab308' : '#3b82f6';
}

function closeModal(e) {
  if (e && e.target !== e.currentTarget) return;
  document.getElementById('modalOverlay').classList.remove('open');
  currentCell = null;
  selectedSpecialColor = null;
}

function saveCard() {
  const name = document.getElementById('fName').value.trim();
  if (!name) { alert('Le nom est requis'); return; }
  
  cards[currentCell] = {
    name,
    sigle: document.getElementById('fSigle').value.trim(),
    email: document.getElementById('fEmail').value.trim(),
    phone: document.getElementById('fPhone').value.trim(),
    address: document.getElementById('fAddress').value.trim(),
    axe: document.getElementById('fAxe').value,
    segment: document.getElementById('fSegment').value,
    color: document.getElementById('fColor').value,
    specialColor: selectedSpecialColor,
    potentiel: parseInt(document.getElementById('fPotentiel').value),
    access: parseInt(document.getElementById('fAccess').value),
    urgence: parseInt(document.getElementById('fUrgence').value),
    logo: document.getElementById('fLogo').value.trim(),
    website: document.getElementById('fWebsite').value.trim(),
    notes: document.getElementById('fNotes').value,
    updated: new Date().toISOString()
  };
  
  saveData();
  renderBoard();
  closeModal();
}

function deleteCard() {
  if (!confirm('Supprimer cette fiche ?')) return;
  delete cards[currentCell];
  saveData();
  renderBoard();
  closeModal();
}

function filterCells() {
  const search = document.getElementById('search').value.toLowerCase();
  const segmentFilter = document.getElementById('segmentFilter').value || activeSegmentFilter;
  const scoreFilter = document.getElementById('scoreFilter').value;
  const axeFilter = document.getElementById('axeFilter').value;
  
  document.querySelectorAll('.cell').forEach(cell => {
    const id = cell.dataset.id;
    const card = cards[id];
    let show = true;
    
    if (card) {
      if (search && !card.name.toLowerCase().includes(search) && 
          !(card.sigle || '').toLowerCase().includes(search)) {
        show = false;
      }
      if (segmentFilter && card.segment !== segmentFilter) show = false;
      if (axeFilter && card.axe !== axeFilter) show = false;
      
      const score = calcGlobalScore(card);
      if (scoreFilter === 'hot' && score < 8) show = false;
      if (scoreFilter === 'warm' && (score < 5 || score >= 8)) show = false;
      if (scoreFilter === 'cold' && score >= 5) show = false;
    } else if (search || segmentFilter || scoreFilter || axeFilter) {
      show = false;
    }
    
    cell.style.display = show ? '' : 'none';
  });
}

function updateStats() {
  const total = Object.keys(cards).length;
  const hot = Object.values(cards).filter(c => calcGlobalScore(c) >= 8).length;
  const warm = Object.values(cards).filter(c => calcGlobalScore(c) >= 5 && calcGlobalScore(c) < 8).length;
  const cold = Object.values(cards).filter(c => calcGlobalScore(c) < 5).length;
  
  document.getElementById('stats').innerHTML = 
    `<span><strong>${total}</strong> clients</span>
     <span>üî• Hot: ${hot}</span>
     <span>üå°Ô∏è Warm: ${warm}</span>
     <span>‚ùÑÔ∏è Cold: ${cold}</span>`;
}

function setTheme(theme) {
  document.body.dataset.theme = theme;
  document.querySelectorAll('.controls .btn:not(.btn-import)').forEach((b, i) => {
    b.classList.toggle('active', i === ['dark', 'light', 'matrix'].indexOf(theme));
  });
}

function setupDragDrop() {
  const zone = document.getElementById('importZone');
  
  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });
  
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) processXLSX(file);
  });
}

function handleXLSX(e) {
  const file = e.target.files[0];
  if (file) processXLSX(file);
  e.target.value = '';
}

function processXLSX(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      
      console.log('Colonnes d√©tect√©es:', Object.keys(json[0] || {}));
      
      let imported = 0;
      json.forEach((row, idx) => {
        const id = idx + 1;
        const name = row['Nom'] || row['nom'] || row['NOM'] || row['Organisation'] || row['ASBL'] || Object.values(row)[0] || '';
        
        if (name && name.trim()) {
          cards[id] = {
            name: name.trim(),
            sigle: (row['Sigle'] || row['sigle'] || row['SIGLE'] || '').trim(),
            email: (row['Email'] || row['email'] || row['Courriel'] || row['Mail'] || '').trim(),
            phone: (row['T√©l√©phone'] || row['Tel'] || row['Phone'] || row['T√©l'] || '').toString().trim(),
            address: (row['Adresse'] || row['adresse'] || row['Rue'] || '').trim() + 
                    (row['CP'] || row['Code postal'] ? ' ' + (row['CP'] || row['Code postal']) : '') +
                    (row['Ville'] || row['Localit√©'] ? ' ' + (row['Ville'] || row['Localit√©']) : ''),
            axe: detectAxe(row),
            segment: detectSegment(row),
            color: '#86efac',
            specialColor: null,
            potentiel: 5,
            access: 5,
            urgence: 5,
            website: (row['Site'] || row['Website'] || row['URL'] || row['Site web'] || '').trim(),
            notes: '',
            updated: new Date().toISOString()
          };
          imported++;
        }
      });
      
      saveData();
      renderBoard();
      alert(`${imported} fiches import√©es avec succ√®s !`);
    } catch(err) {
      console.error(err);
      alert('Erreur lors de l\'import: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function detectAxe(row) {
  const axeField = row['Axe'] || row['axe'] || row['AXE'] || '';
  if (axeField.toString().includes('1')) return '1';
  if (axeField.toString().includes('2')) return '2';
  if (axeField.toString().includes('3')) return '3';
  if (axeField.toString().includes('4')) return '4';
  if (axeField.toString().toLowerCase().includes('mouvement')) return 'mouvement';
  return '';
}

function detectSegment(row) {
  const text = JSON.stringify(row).toLowerCase();
  if (text.includes('environnement') || text.includes('√©colog') || text.includes('climat')) return 'environnement';
  if (text.includes('citoyen') || text.includes('d√©mocrat') || text.includes('politique')) return 'citoyennete';
  if (text.includes('social') || text.includes('solidar') || text.includes('pauvret√©')) return 'social';
  if (text.includes('cultur') || text.includes('artist') || text.includes('art')) return 'culture';
  if (text.includes('√©duca') || text.includes('forma') || text.includes('alphab√©t')) return 'education';
  if (text.includes('sant√©') || text.includes('m√©dic') || text.includes('mental')) return 'sante';
  if (text.includes('droit') || text.includes('justice') || text.includes('√©galit√©')) return 'droits';
  if (text.includes('m√©dia') || text.includes('info') || text.includes('press')) return 'medias';
  if (text.includes('√©conomi') || text.includes('travail') || text.includes('emploi')) return 'economie';
  if (text.includes('intercul') || text.includes('migra') || text.includes('divers')) return 'interculturel';
  return '';
}

function exportData(format) {
  let content, filename, type;
  
  if (format === 'json') {
    content = JSON.stringify(cards, null, 2);
    filename = 'sauron-crm-ep.json';
    type = 'application/json';
  } else if (format === 'csv') {
    const headers = ['ID','Nom','Sigle','Email','T√©l√©phone','Adresse','Axe','Segment','Score','Potentiel','Accessibilit√©','Urgence'];
    const rows = Object.entries(cards).map(([id, c]) => [
      id, c.name, c.sigle, c.email, c.phone, c.address, c.axe, c.segment,
      calcGlobalScore(c).toFixed(1), c.potentiel, c.access, c.urgence
    ].map(v => `"${(v||'').toString().replace(/"/g, '""')}"`).join(','));
    content = [headers.join(','), ...rows].join('\n');
    filename = 'sauron-crm-ep.csv';
    type = 'text/csv';
  } else if (format === 'md') {
    content = `# üéØ SAURON CRM - Clients EP\n\n`;
    content += `> Export√© le ${new Date().toLocaleString('fr-FR')}\n\n`;
    content += `## R√©sum√©\n- Total: ${Object.keys(cards).length} clients\n\n---\n\n`;
    
    const sorted = Object.entries(cards).sort((a,b) => calcGlobalScore(b[1]) - calcGlobalScore(a[1]));
    sorted.forEach(([id, c]) => {
      const score = calcGlobalScore(c);
      const emoji = score >= 8 ? 'üî•' : score >= 5 ? 'üå°Ô∏è' : '‚ùÑÔ∏è';
      content += `### ${emoji} ${c.name} (${c.sigle || 'N/A'})\n`;
      content += `**Score:** ${score.toFixed(1)}/10 | **Axe:** ${c.axe || 'N/A'}\n\n`;
      if (c.email) content += `üìß ${c.email}\n`;
      if (c.phone) content += `üìû ${c.phone}\n`;
      content += `\n---\n\n`;
    });
    filename = 'sauron-crm-ep.md';
    type = 'text/markdown';
  }
  
  downloadFile(content, filename, type);
}

function exportCard(format) {
  const card = cards[currentCell];
  if (!card) return;
  
  const safeName = card.name.replace(/[^a-zA-Z0-9]/g, '_');
  let content, filename, type;
  
  if (format === 'json') {
    content = JSON.stringify({[currentCell]: card}, null, 2);
    filename = `client-${safeName}.json`;
    type = 'application/json';
  } else {
    const score = calcGlobalScore(card);
    content = `# ${card.name}\n\n`;
    content += `**Score:** ${score.toFixed(1)}/10\n\n`;
    content += `- Potentiel: ${card.potentiel}/10\n`;
    content += `- Accessibilit√©: ${card.access}/10\n`;
    content += `- Urgence: ${card.urgence}/10\n\n`;
    if (card.email) content += `üìß ${card.email}\n`;
    if (card.phone) content += `üìû ${card.phone}\n`;
    if (card.website) content += `üåê ${card.website}\n`;
    filename = `client-${safeName}.md`;
    type = 'text/markdown';
  }
  
  downloadFile(content, filename, type);
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function importJSON() { document.getElementById('jsonInput').click(); }

function handleJSONImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const imported = JSON.parse(event.target.result);
      Object.assign(cards, imported);
      saveData();
      renderBoard();
      alert('Import JSON r√©ussi !');
    } catch(err) { alert('Erreur JSON'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

init();
</script>
</body>
</html>
