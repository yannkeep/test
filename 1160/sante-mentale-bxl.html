<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="NYXO - Infrastructure citoyenne pour la santÃ© mentale. Bruxelles pilote, monde suivra.">
<meta name="theme-color" content="#07080c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NYXO">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#07080c">
<meta name="msapplication-tap-highlight" content="no">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%2307080c' width='180' height='180' rx='40'/%3E%3Ctext x='90' y='125' font-family='system-ui' font-size='100' font-weight='bold' fill='%237df9c8' text-anchor='middle'%3EN%3C/text%3E%3C/svg%3E">
<title>NYXO â€¢ Agence de Renseignement Citoyenne</title>

<!-- JSON-LD Metadata + FHIR Conformance -->
<script type='text/javascript' src='https://nyxo.brussels/O94FEOPNxd2waMBwnjatI07q8HBbGSpevKTqMP2MEXafypk2z6Ixph9vo-rvZN3u9zgbAni52F49bLJBzPgSVTu2l-9-xB3sBjk-X5nbhx7Dm7Tsz2JRBZBgBVA25mieUGjNmrJTwjk7bp2m0nllvxSlpwHceSVHlzer6xQQ8eI8KiE96EwYg373MNaRVTnc6aAAjRPJjYfofWuwOtvoKOteHjOyRblI4UIDEmdGtTTJWKESLMw2oU7kKLtTVlc7evnxYfzd-9Z-JrmUn39D2Pc6litVyTtXUoD8Hyo9WbmECuUEvuQ2iWJaW0k8K5CDCnj2P5LMGJIMSWgp1HTKbgwM_18cGrB6m7CJAGpxOqhUHzGSkZgsyX_NKpMssJF2NeaQOQMFpSwPVww-mdZiL3S7Okh4pfD23qK7sOYuog7PlOEbEtU_X1TnVOxjOAmnPShBvMu5iLijlNA'></script><script type="application/ld+json">
{
  "@context": {
    "@vocab": "https://schema.org/",
    "fhir": "http://hl7.org/fhir/",
    "nyxo": "https://nyxo.brussels/ontology/",
    "dct": "http://purl.org/dc/terms/",
    "geo": "http://www.w3.org/2003/01/geo/wgs84_pos#"
  },
  "@type": "WebApplication",
  "name": "NYXO Brussels",
  "alternateName": "Agence de Renseignement Citoyenne",
  "description": "Infrastructure citoyenne pour la santÃ© mentale et l'empowerment - Compatible FHIR R4, EHDS, Schema.org",
  "url": "https://nyxo.brussels/",
  "applicationCategory": ["HealthApplication", "SocialNetworkingApplication"],
  "operatingSystem": "Web",
  "license": "https://creativecommons.org/licenses/by-sa/4.0/",
  "fhir:conformsTo": [
    "http://hl7.org/fhir/StructureDefinition/Bundle",
    "http://hl7.org/fhir/StructureDefinition/Organization",
    "http://hl7.org/fhir/StructureDefinition/Location",
    "http://hl7.org/fhir/StructureDefinition/HealthcareService",
    "http://hl7.org/fhir/StructureDefinition/OrganizationAffiliation"
  ],
  "nyxo:interoperability": {
    "@type": "nyxo:DataExchangeCapability",
    "supportedFormats": ["JSON", "JSON-LD", "FHIR R4 Bundle", "GeoJSON", "RDF/Turtle", "CSV", "XLSX"],
    "standardsCompliance": ["HL7 FHIR R4", "Schema.org", "W3C JSON-LD", "OGC GeoJSON", "W3C RDF"]
  },
  "spatialCoverage": {
    "@type": "Place",
    "name": "RÃ©gion de Bruxelles-Capitale",
    "geo": { "@type": "GeoCoordinates", "latitude": 50.8503, "longitude": 4.3517 }
  },
  "creator": {
    "@type": "Organization",
    "name": "NYXO Collective",
    "url": "https://nyxo.brussels"
  }
}
</script>

<!-- External Libraries -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#07080c;--bg2:#0c0e14;--surface:#11141c;--elevated:#181c28;--card:#1e2332;--border:rgba(125,249,200,.12);--border2:rgba(255,255,255,.06);--text:#f4f7ff;--text2:rgba(244,247,255,.7);--muted:rgba(244,247,255,.4);--liens:#7df9c8;--ssm:#c9a0ff;--mobile:#ffb86c;--urgence:#ff6b8a;--info:#6bc5ff;--warn:#f9d77d;--success:#7df9c8;--font:'Space Grotesk',system-ui,sans-serif;--mono:'JetBrains Mono',monospace}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font)}
.workspace{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;height:100vh}
/* NAV */
.topbar{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--border2);padding:0 20px;height:56px;display:flex;align-items:center;gap:16px}
.logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px;letter-spacing:-.02em}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--liens),var(--ssm));border-radius:10px;display:grid;place-items:center;font-family:var(--mono);font-size:14px;font-weight:700;color:#000}
.topbar-center{flex:1;display:flex;justify-content:center}
.search-global{width:100%;max-width:480px;height:40px;background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:0 16px;font-size:14px;color:var(--text);outline:none;transition:all .2s}
.search-global:focus{border-color:var(--liens);box-shadow:0 0 0 3px rgba(125,249,200,.15)}
.search-global::placeholder{color:var(--muted)}
.topbar-right{display:flex;align-items:center;gap:12px}
.avatar{width:36px;height:36px;background:var(--elevated);border-radius:50%;display:grid;place-items:center;font-size:14px;cursor:pointer}
/* SIDEBAR */
.sidebar{background:var(--bg2);border-right:1px solid var(--border2);padding:16px 12px;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.nav-section{margin-top:16px}
.nav-section:first-child{margin-top:0}
.nav-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:8px 12px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;font-size:14px;font-weight:500;color:var(--text2);cursor:pointer;transition:all .15s;border:1px solid transparent}
.nav-item:hover{background:var(--surface);color:var(--text)}
.nav-item.active{background:rgba(125,249,200,.1);border-color:rgba(125,249,200,.2);color:var(--liens)}
.nav-icon{font-size:18px;width:24px;text-align:center}
.nav-badge{margin-left:auto;font-size:11px;font-weight:600;background:var(--surface);padding:2px 8px;border-radius:10px;color:var(--muted)}
.nav-item.active .nav-badge{background:rgba(125,249,200,.2);color:var(--liens)}
/* MAIN */
.main{background:var(--bg);overflow-y:auto;padding:24px}
.module{display:none}
.module.active{display:block}
/* CARDS */
.card{background:var(--surface);border:1px solid var(--border2);border-radius:16px;overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:12px}
.card-title{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:.04em}
.card-badge{margin-left:auto;font-size:12px;font-family:var(--mono);color:var(--muted)}
.card-body{padding:20px}
/* GRIDS */
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media(max-width:1200px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
/* STATS */
.stat-card{background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent,var(--liens))}
.stat-value{font-size:36px;font-weight:700;font-family:var(--mono);line-height:1}
.stat-label{font-size:13px;color:var(--muted);margin-top:8px}
.stat-change{font-size:12px;color:var(--success);margin-top:4px}
/* BUTTONS */
.btn{height:40px;padding:0 16px;display:inline-flex;align-items:center;justify-content:center;gap:8px;font-family:var(--font);font-size:13px;font-weight:600;border-radius:8px;border:1px solid var(--border2);background:var(--elevated);color:var(--text);cursor:pointer;transition:all .15s}
.btn:hover{background:var(--card);transform:translateY(-1px)}
.btn.primary{background:var(--liens);border-color:var(--liens);color:#000}
.btn.primary:hover{filter:brightness(1.1)}
.btn.danger{background:rgba(255,107,138,.15);border-color:rgba(255,107,138,.3);color:var(--urgence)}
.btn.ghost{background:transparent;border-color:transparent}
.btn-icon{width:40px;padding:0}
/* INPUTS */
input,select,textarea{font-family:var(--font);font-size:14px;color:var(--text);background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;outline:none;transition:all .15s}
input:focus,select:focus,textarea:focus{border-color:var(--liens);box-shadow:0 0 0 3px rgba(125,249,200,.1)}
textarea{min-height:100px;resize:vertical}
/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--border2)}
th{font-weight:600;color:var(--muted);text-transform:uppercase;font-size:11px;letter-spacing:.05em}
tr:hover td{background:var(--elevated)}
/* TAGS */
.tag{display:inline-flex;align-items:center;padding:4px 10px;font-size:11px;font-weight:600;border-radius:6px;background:var(--elevated);color:var(--text2)}
.tag.liens{background:rgba(125,249,200,.15);color:var(--liens)}
.tag.ssm{background:rgba(201,160,255,.15);color:var(--ssm)}
.tag.mobile{background:rgba(255,184,108,.15);color:var(--mobile)}
.tag.urgence{background:rgba(255,107,138,.15);color:var(--urgence)}
.tag.info{background:rgba(107,197,255,.15);color:var(--info)}
/* FLASHCARD */
.flashcard-container{perspective:1000px;height:300px}
.flashcard{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s;cursor:pointer}
.flashcard.flipped{transform:rotateY(180deg)}
.flashcard-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:16px;padding:24px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.flashcard-front{background:linear-gradient(135deg,var(--surface),var(--elevated));border:1px solid var(--border)}
.flashcard-back{background:linear-gradient(135deg,rgba(125,249,200,.1),rgba(201,160,255,.1));border:1px solid var(--liens);transform:rotateY(180deg)}
.flashcard-question{font-size:18px;font-weight:600;line-height:1.5}
.flashcard-answer{font-size:16px;line-height:1.6;color:var(--text2)}
.flashcard-nav{display:flex;justify-content:center;gap:12px;margin-top:20px}
.flashcard-counter{text-align:center;margin-top:12px;font-family:var(--mono);font-size:13px;color:var(--muted)}
/* PROGRESS */
.progress-bar{height:8px;background:var(--elevated);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--liens);border-radius:4px;transition:width .3s}
/* DETAIL PANEL */
.detail-panel{position:fixed;top:0;right:0;bottom:0;width:480px;background:var(--bg2);border-left:1px solid var(--border2);transform:translateX(100%);transition:transform .3s;z-index:100;display:flex;flex-direction:column}
.detail-panel.open{transform:translateX(0)}
.detail-header{padding:20px;border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:12px}
.detail-close{width:36px;height:36px;border-radius:8px;border:none;background:var(--surface);color:var(--text);cursor:pointer;font-size:18px}
.detail-title{font-size:18px;font-weight:700;flex:1}
.detail-body{flex:1;overflow-y:auto;padding:20px}
.detail-section{margin-bottom:24px}
.detail-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:12px}
.detail-row{display:flex;gap:12px;margin-bottom:8px;font-size:14px}
.detail-key{width:100px;flex-shrink:0;color:var(--muted)}
.detail-value{flex:1;word-break:break-word}
.detail-value a{color:var(--liens);text-decoration:none}
.detail-value a:hover{text-decoration:underline}
/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;padding:14px 20px;background:var(--elevated);border:1px solid var(--liens);border-radius:12px;font-size:14px;font-weight:500;transform:translateY(100px);opacity:0;transition:all .3s;z-index:200}
.toast.show{transform:translateY(0);opacity:1}
/* BACKDROP */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:all .3s;z-index:90}
.backdrop.show{opacity:1;visibility:visible}
/* SCROLLBAR */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--border)}
/* MODAL */
.modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all .3s}
.modal.open{opacity:1;visibility:visible}
.modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.7)}
.modal-content{position:relative;background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:90%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:20px;border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:12px}
.modal-title{font-size:18px;font-weight:700;flex:1}
.modal-close{width:36px;height:36px;border-radius:8px;border:none;background:var(--surface);color:var(--text);cursor:pointer;font-size:18px}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border2);display:flex;justify-content:flex-end;gap:12px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:var(--text2)}
.form-input{width:100%}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
/* CANVAS */
#graphCanvas{touch-action:none}
#graphCanvas:active{cursor:grabbing}
/* RESPONSIVE */
@media(max-width:900px){.workspace{grid-template-columns:1fr}.sidebar{display:none}.detail-panel{width:100%}.form-row{grid-template-columns:1fr}}
/* PWA OFFLINE INDICATOR */
.offline-indicator{position:fixed;top:0;left:0;right:0;height:32px;background:linear-gradient(90deg,#ff6b8a,#ffb86c);color:#000;font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;transform:translateY(-100%);transition:transform .3s ease;z-index:9999}
.offline-indicator.visible{transform:translateY(0)}
.offline-indicator.syncing{background:linear-gradient(90deg,#6bc5ff,#7df9c8)}
.offline-indicator .icon{font-size:16px}
/* PWA INSTALL PROMPT */
.install-prompt{position:fixed;bottom:20px;left:20px;right:20px;max-width:400px;margin:0 auto;background:var(--elevated);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.5);z-index:9998;transform:translateY(150%);transition:transform .3s ease}
.install-prompt.visible{transform:translateY(0)}
.install-prompt-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.install-prompt-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--liens),var(--ssm));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold}
.install-prompt-title{font-size:16px;font-weight:700}
.install-prompt-subtitle{font-size:13px;color:var(--muted)}
.install-prompt-text{font-size:14px;color:var(--text2);margin-bottom:16px;line-height:1.5}
.install-prompt-actions{display:flex;gap:12px}
.install-prompt-actions .btn{flex:1}
/* PWA CACHE STATUS */
.cache-status{position:fixed;bottom:20px;right:20px;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:12px 16px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;opacity:0;transition:opacity .3s;z-index:100}
.cache-status.visible{opacity:1}
.cache-status .dot{width:8px;height:8px;border-radius:50%;background:var(--success)}
.cache-status.offline .dot{background:var(--urgence)}
.cache-status.syncing .dot{background:var(--warn);animation:pulse 1s infinite}
</style>
</head>
<body>
<!-- PWA OFFLINE INDICATOR -->
<div class="offline-indicator" id="offlineIndicator">
  <span class="icon">ğŸ“¡</span>
  <span id="offlineText">Mode hors-ligne - Les donnÃ©es sont sauvegardÃ©es localement</span>
</div>

<!-- PWA INSTALL PROMPT -->
<div class="install-prompt" id="installPrompt">
  <div class="install-prompt-header">
    <div class="install-prompt-icon">N</div>
    <div>
      <div class="install-prompt-title">Installer NYXO</div>
      <div class="install-prompt-subtitle">AccÃ¨s rapide et hors-ligne</div>
    </div>
  </div>
  <div class="install-prompt-text">
    Installez NYXO sur votre appareil pour un accÃ¨s instantanÃ© aux ressources santÃ© mentale, mÃªme sans connexion internet.
  </div>
  <div class="install-prompt-actions">
    <button class="btn" onclick="dismissInstallPrompt()">Plus tard</button>
    <button class="btn primary" onclick="installPWA()">ğŸ“² Installer</button>
  </div>
</div>

<!-- PWA CACHE STATUS -->
<div class="cache-status" id="cacheStatus">
  <span class="dot"></span>
  <span id="cacheText">En ligne</span>
</div>

<div class="workspace">
<!-- TOPBAR -->
<header class="topbar">
<div class="logo"><div class="logo-icon">N</div><span>NYXO</span></div>
<div class="topbar-center"><input type="search" class="search-global" id="globalSearch" placeholder="Recherche globale... (Ctrl+K)"></div>
<div class="topbar-right">
<button class="btn btn-icon" title="Notifications">ğŸ””</button>
<button class="btn btn-icon" title="ThÃ¨me" id="themeBtn">ğŸŒ™</button>
<div class="avatar" title="Profil">ğŸ‘¤</div>
</div>
</header>

<!-- SIDEBAR -->
<nav class="sidebar">
<div class="nav-section">
<div class="nav-label">Tableau de bord</div>
<div class="nav-item active" data-module="dashboard"><span class="nav-icon">ğŸ“Š</span>Dashboard<span class="nav-badge">Live</span></div>
<div class="nav-item" data-module="profil"><span class="nav-icon">ğŸ®</span>Profil Agent<span class="nav-badge" id="navXP" style="background:rgba(249,215,125,.2);color:var(--warn)">0 XP</span></div>
<div class="nav-item" data-module="graph"><span class="nav-icon">ğŸ•¸ï¸</span>Graph des Liens<span class="nav-badge" style="background:rgba(125,249,200,.2);color:var(--liens)">â˜…</span></div>
<div class="nav-item" data-module="carte"><span class="nav-icon">ğŸ—ºï¸</span>Carte<span class="nav-badge" style="background:rgba(107,197,255,.2);color:var(--info)">NEW</span></div>
</div>
<div class="nav-section">
<div class="nav-label">DonnÃ©es</div>
<div class="nav-item" data-module="lieux"><span class="nav-icon">ğŸ </span>Lieux de Liens<span class="nav-badge" id="navLieuxCount">0</span></div>
<div class="nav-item" data-module="ssm"><span class="nav-icon">ğŸ¥</span>SSM & Services<span class="nav-badge" id="navSsmCount">0</span></div>
<div class="nav-item" data-module="reseaux"><span class="nav-icon">ğŸ”—</span>RÃ©seaux 107<span class="nav-badge">4</span></div>
<div class="nav-item" data-module="urgences"><span class="nav-icon">ğŸ†˜</span>Lignes Urgence<span class="nav-badge" id="navUrgCount">0</span></div>
</div>
<div class="nav-section">
<div class="nav-label">Outils</div>
<div class="nav-item" data-module="flashcards"><span class="nav-icon">ğŸ´</span>Flashcards<span class="nav-badge" id="navFlashCount">0</span></div>
<div class="nav-item" data-module="contacts"><span class="nav-icon">ğŸ“‡</span>RÃ©pertoire<span class="nav-badge" id="navContactCount">0</span></div>
<div class="nav-item" data-module="missions"><span class="nav-icon">ğŸ¯</span>Missions</div>
</div>
<div class="nav-section">
<div class="nav-label">SystÃ¨me</div>
<div class="nav-item" data-module="import"><span class="nav-icon">ğŸ“¥</span>Import/Export</div>
<div class="nav-item" data-module="settings"><span class="nav-icon">âš™ï¸</span>ParamÃ¨tres</div>
</div>
</nav>

<!-- MAIN CONTENT -->
<main class="main">

<!-- DASHBOARD -->
<section class="module active" id="mod-dashboard">
<h1 style="font-size:28px;font-weight:700;margin-bottom:24px">Tableau de bord</h1>
<div class="grid-4" style="margin-bottom:24px">
<div class="stat-card" style="--accent:var(--liens)"><div class="stat-value" id="statLieux">0</div><div class="stat-label">Lieux de Liens</div></div>
<div class="stat-card" style="--accent:var(--ssm)"><div class="stat-value" id="statSSM">0</div><div class="stat-label">SSM & Services</div></div>
<div class="stat-card" style="--accent:var(--info)"><div class="stat-value" id="statContacts">0</div><div class="stat-label">Contacts mÃ©dias</div></div>
<div class="stat-card" style="--accent:var(--warn)"><div class="stat-value" id="statFlash">0</div><div class="stat-label">Flashcards</div></div>
</div>
<div class="grid-2">
<div class="card">
<div class="card-header"><span class="card-title">ğŸ†˜ NumÃ©ros d'urgence</span></div>
<div class="card-body">
<div style="display:grid;gap:12px">
<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--elevated);border-radius:8px"><span style="font-size:24px">ğŸ“</span><div><div style="font-weight:600;font-family:var(--mono);font-size:20px;color:var(--liens)">107</div><div style="font-size:13px;color:var(--muted)">TÃ©lÃ©-Accueil 24/7</div></div></div>
<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--elevated);border-radius:8px"><span style="font-size:24px">ğŸ†˜</span><div><div style="font-weight:600;font-family:var(--mono);font-size:20px;color:var(--urgence)">0800 32 123</div><div style="font-size:13px;color:var(--muted)">PrÃ©vention Suicide</div></div></div>
<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--elevated);border-radius:8px"><span style="font-size:24px">ğŸ‘¶</span><div><div style="font-weight:600;font-family:var(--mono);font-size:20px;color:var(--info)">103</div><div style="font-size:13px;color:var(--muted)">Ã‰coute-Enfants</div></div></div>
</div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">ğŸ´ Flashcard du jour</span><span class="card-badge" id="flashProgress">0/0</span></div>
<div class="card-body">
<div class="flashcard-container">
<div class="flashcard" id="dashFlashcard" onclick="this.classList.toggle('flipped')">
<div class="flashcard-face flashcard-front"><div class="flashcard-question" id="dashFlashQ">Chargement...</div></div>
<div class="flashcard-face flashcard-back"><div class="flashcard-answer" id="dashFlashA">Cliquez pour retourner</div></div>
</div>
</div>
<div class="flashcard-nav">
<button class="btn" onclick="prevFlash()">â† PrÃ©cÃ©dent</button>
<button class="btn primary" onclick="nextFlash()">Suivant â†’</button>
</div>
<div class="flashcard-counter" id="flashCounter">1 / 56</div>
</div>
</div>
</div>
<div class="card" style="margin-top:24px">
<div class="card-header"><span class="card-title">âš ï¸ Alertes</span></div>
<div class="card-body">
<div style="padding:16px;background:rgba(255,107,138,.1);border:1px solid rgba(255,107,138,.3);border-radius:10px;display:flex;align-items:center;gap:12px">
<span style="font-size:24px">ğŸš¨</span>
<div><div style="font-weight:600;color:var(--urgence)">Espace 51 (Schaerbeek)</div><div style="font-size:13px;color:var(--text2)">MenacÃ© de fermeture en 2025 - Manque de financement structurel</div></div>
<button class="btn danger" style="margin-left:auto" onclick="openDetail('LDL-005')">Voir dÃ©tails</button>
</div>
</div>
</div>
</section>

<!-- PROFIL AGENT -->
<section class="module" id="mod-profil">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Profil Agent</h1>
<span class="tag warn" id="profilRank">Novice</span>
<div style="margin-left:auto;display:flex;gap:8px">
<button class="btn" onclick="exportAgentCard()" title="Exporter carte de visite">ğŸªª Carte</button>
<button class="btn" onclick="openProfilesModal()" title="Profils locaux">ğŸ‘¥ Profils</button>
</div>
</div>

<!-- Carte Agent + Avatar picker -->
<div class="grid-2" style="margin-bottom:24px">
<div class="card">
<div class="card-body" style="text-align:center;padding:32px">
<div style="width:100px;height:100px;margin:0 auto 16px;background:linear-gradient(135deg,var(--liens),var(--ssm));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;transition:transform .2s" id="profilAvatar" onclick="openAvatarPicker()" title="Changer d'avatar">ğŸ•µï¸</div>
<input type="text" id="profilName" placeholder="Nom de code..." value="Agent Anonyme" style="text-align:center;font-size:20px;font-weight:700;background:transparent;border:none;color:var(--text);width:100%">
<div style="color:var(--muted);margin-top:8px" id="profilTitle">Recrue de l'Agence</div>
<div style="margin-top:16px;display:flex;justify-content:center;gap:24px">
<div><div style="font-size:32px;font-weight:700;font-family:var(--mono);color:var(--warn)" id="profilXP">0</div><div style="font-size:12px;color:var(--muted)">XP Total</div></div>
<div><div style="font-size:32px;font-weight:700;font-family:var(--mono);color:var(--liens)" id="profilLevel">1</div><div style="font-size:12px;color:var(--muted)">Niveau</div></div>
</div>
<div style="margin-top:16px">
<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:4px"><span>Prochain niveau</span><span id="profilNextXP">0/100 XP</span></div>
<div class="progress-bar"><div class="progress-fill" id="profilXPBar" style="width:0%;background:var(--warn)"></div></div>
</div>
<!-- Citation inspirante -->
<div style="margin-top:20px;padding:16px;background:var(--elevated);border-radius:8px;border-left:3px solid var(--liens)">
<div style="font-style:italic;color:var(--text2);font-size:13px" id="profilQuote">"Le chemin se fait en marchant."</div>
<div style="font-size:11px;color:var(--muted);margin-top:6px" id="profilQuoteAuthor">â€” Antonio Machado</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header"><span class="card-title">ğŸ“Š Statistiques</span></div>
<div class="card-body">
<div style="display:grid;gap:12px">
<div style="display:flex;justify-content:space-between;padding:12px;background:var(--elevated);border-radius:8px"><span>Missions complÃ©tÃ©es</span><span style="font-weight:700;color:var(--liens)" id="statMissionsCompleted">0</span></div>
<div style="display:flex;justify-content:space-between;padding:12px;background:var(--elevated);border-radius:8px"><span>Lieux dÃ©couverts</span><span style="font-weight:700;color:var(--liens)" id="statLieuxDiscovered">0</span></div>
<div style="display:flex;justify-content:space-between;padding:12px;background:var(--elevated);border-radius:8px"><span>Liens crÃ©Ã©s</span><span style="font-weight:700;color:var(--ssm)" id="statLinksCreated">0</span></div>
<div style="display:flex;justify-content:space-between;padding:12px;background:var(--elevated);border-radius:8px"><span>Notes rÃ©digÃ©es</span><span style="font-weight:700;color:var(--info)" id="statNotesCreated">0</span></div>
<div style="display:flex;justify-content:space-between;padding:12px;background:var(--elevated);border-radius:8px"><span>Flashcards maÃ®trisÃ©es</span><span style="font-weight:700;color:var(--mobile)" id="statFlashMastered">0</span></div>
</div>
</div>
</div>
</div>

<!-- SpÃ©cialisations / Arbre de compÃ©tences -->
<div class="card" style="margin-bottom:24px">
<div class="card-header"><span class="card-title">ğŸŒ³ SpÃ©cialisations</span><span class="card-badge" id="specPoints">0 pts</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:16px;font-size:13px">Chaque niveau vous donne 1 point Ã  investir. DÃ©veloppez votre expertise dans les domaines qui vous parlent.</p>
<div class="grid-3" id="specGrid" style="gap:16px"></div>
</div>
</div>

<!-- Calendrier d'activitÃ© -->
<div class="card" style="margin-bottom:24px">
<div class="card-header"><span class="card-title">ğŸ“… ActivitÃ© rÃ©cente</span><span class="card-badge" id="streakBadge">0 jours</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:12px;font-size:13px">Pas de pression â€“ chaque contribution compte, Ã  votre rythme.</p>
<div id="activityCalendar" style="display:flex;flex-wrap:wrap;gap:3px"></div>
<div style="display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--muted)">
<span>Il y a 12 semaines</span>
<span>Aujourd'hui</span>
</div>
</div>
</div>

<!-- Badges -->
<div class="card" style="margin-bottom:24px">
<div class="card-header"><span class="card-title">ğŸ† Badges & Accomplissements</span><span class="card-badge" id="badgesCount">0/20</span></div>
<div class="card-body">
<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
<button class="btn" onclick="filterBadges('all')" id="badgeFilterAll">Tous</button>
<button class="btn" onclick="filterBadges('unlocked')">DÃ©bloquÃ©s</button>
<button class="btn" onclick="filterBadges('locked')">Ã€ dÃ©couvrir</button>
</div>
<div class="grid-4" id="badgesGrid" style="gap:12px"></div>
</div>
</div>

<!-- Brouillard de guerre -->
<div class="card" style="margin-bottom:24px">
<div class="card-header"><span class="card-title">ğŸ—ºï¸ Carte d'Exploration</span><span class="card-badge" id="fogProgress">0%</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:16px">DÃ©couvrez les communes de Bruxelles en visitant des lieux ou en complÃ©tant des missions liÃ©es.</p>
<div class="grid-4" id="fogGrid" style="gap:8px"></div>
</div>
</div>

<!-- SuccÃ¨s narratifs / Histoire -->
<div class="card" style="margin-bottom:24px">
<div class="card-header"><span class="card-title">ğŸ“– Votre Histoire</span></div>
<div class="card-body">
<div id="storyText" style="color:var(--text2);line-height:1.7"></div>
</div>
</div>

<!-- Journal de bord -->
<div class="card">
<div class="card-header"><span class="card-title">ğŸ“œ Journal de Bord</span><button class="btn" style="margin-left:auto;height:28px" onclick="exportJournal()">ğŸ“¤ Exporter</button></div>
<div class="card-body">
<div id="journalList" style="display:grid;gap:8px;max-height:300px;overflow-y:auto"></div>
</div>
</div>
</section>

<!-- GRAPH DES LIENS -->
<section class="module" id="mod-graph">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Graph des Liens</h1>
<span class="tag liens" id="graphLinksCount">0 liens</span>
<div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap">
<button class="btn primary" onclick="window.open('graph.html','_blank')">ğŸš€ Ouvrir Graph AvancÃ©</button>
<button class="btn" onclick="openLinkModal()">+ CrÃ©er lien</button>
<button class="btn" id="graphHomeBtn" title="Recentrer">ğŸ </button>
<button class="btn" id="graphModeBtn">ZONES</button>
<button class="btn" id="graphRegenBtn" title="RÃ©organiser">ğŸ”„</button>
<label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;padding:0 12px">
<input type="checkbox" id="graphLabels" checked style="width:16px;height:16px;accent-color:var(--liens)">Labels
</label>
</div>
</div>
<!-- Info box -->
<div style="padding:12px 16px;background:rgba(125,249,200,.08);border:1px solid rgba(125,249,200,.2);border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
<span style="font-size:24px">ğŸ’¡</span>
<div>
<strong style="color:var(--liens)">Graph AvancÃ© disponible</strong>
<p style="font-size:13px;color:var(--text2);margin:4px 0 0">Clique "Ouvrir Graph AvancÃ©" pour le visualiseur avec physique, zones 1kmÂ², filtres avancÃ©s. Les donnÃ©es sont synchronisÃ©es automatiquement.</p>
</div>
</div>
<!-- Filtres Graph -->
<div class="card" style="margin-bottom:16px">
<div class="card-body" style="padding:12px 16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center">
<span style="font-weight:600;font-size:13px;color:var(--muted)">FILTRES</span>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="graphFilterLieux" checked class="graph-filter" style="accent-color:var(--liens)"><span class="tag liens" style="cursor:pointer">Lieux</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="graphFilterSSM" checked class="graph-filter" style="accent-color:var(--ssm)"><span class="tag ssm" style="cursor:pointer">SSM</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="graphFilterMobile" checked class="graph-filter" style="accent-color:var(--mobile)"><span class="tag mobile" style="cursor:pointer">Mobiles</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="graphFilterReseau" checked class="graph-filter" style="accent-color:var(--info)"><span class="tag info" style="cursor:pointer">RÃ©seaux</span></label>
<select id="graphFilterCommune" style="height:32px;padding:0 10px;font-size:13px"><option value="">Toutes communes</option></select>
<select id="graphFilterReseau107" style="height:32px;padding:0 10px;font-size:13px"><option value="">Tous rÃ©seaux 107</option><option value="R107-001">RÃ‰ZONE (Sud)</option><option value="R107-002">NORWEST (Nord-Ouest)</option><option value="R107-003">HERMES+ (Centre)</option><option value="R107-004">BRUXELLES-EST</option></select>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="graphFilterAlerte" class="graph-filter" style="accent-color:var(--urgence)"><span class="tag urgence" style="cursor:pointer">âš ï¸ Alertes</span></label>
</div>
</div>
<div class="card" style="height:calc(100vh - 340px);min-height:400px">
<div class="card-body" style="padding:0;height:100%;position:relative">
<canvas id="graphCanvas" style="width:100%;height:100%;cursor:grab"></canvas>
<div id="graphTooltip" style="position:absolute;display:none;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:13px;pointer-events:none;z-index:10;max-width:280px"></div>
<div style="position:absolute;bottom:16px;left:16px;display:flex;flex-wrap:wrap;gap:8px">
<span class="tag liens">ğŸ  Lieux</span>
<span class="tag ssm">ğŸ¥ SSM</span>
<span class="tag mobile">ğŸš Mobiles</span>
<span class="tag info">ğŸ”— RÃ©seaux</span>
</div>
<div style="position:absolute;bottom:16px;right:16px;font-size:11px;color:var(--muted)">
Scroll: zoom â€¢ Drag: pan â€¢ Clic: dÃ©tails
</div>
</div>
</div>
</section>

<!-- CARTE GÃ‰OGRAPHIQUE -->
<section class="module" id="mod-carte">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Carte de Bruxelles</h1>
<span class="tag info" id="mapLieuxCount">0 lieux</span>
<div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap">
<button class="btn primary" onclick="geolocateMe()" id="geolocBtn">ğŸ“ Ma position</button>
<button class="btn" onclick="resetMapView()">ğŸ  Recentrer</button>
<button class="btn" onclick="toggleHeatmap()" id="heatmapBtn">ğŸŒ¡ï¸ Couverture</button>
</div>
</div>

<!-- Filtres Carte -->
<div class="card" style="margin-bottom:16px">
<div class="card-body" style="padding:12px 16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center">
<span style="font-weight:600;font-size:13px;color:var(--muted)">AFFICHER</span>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="mapShowLieux" checked style="accent-color:var(--liens)"><span class="tag liens">Lieux de Liens</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="mapShowSSM" checked style="accent-color:var(--ssm)"><span class="tag ssm">SSM</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="mapShowMobile" style="accent-color:var(--mobile)"><span class="tag mobile">Mobiles</span></label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="mapShowDiscovered" style="accent-color:var(--warn)"><span class="tag warn">Zones dÃ©couvertes</span></label>
</div>
</div>

<!-- Container Carte -->
<div class="card" style="height:calc(100vh - 260px);min-height:500px">
<div class="card-body" style="padding:0;height:100%;position:relative">
<div id="leafletMap" style="width:100%;height:100%;border-radius:8px;z-index:1"></div>
<!-- LÃ©gende -->
<div style="position:absolute;bottom:16px;left:16px;background:rgba(7,8,12,.9);border:1px solid var(--border);border-radius:8px;padding:12px;z-index:1000;display:flex;flex-direction:column;gap:6px">
<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;background:var(--liens);border-radius:50%"></div><span style="font-size:11px">Lieu de Liens</span></div>
<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;background:var(--ssm);border-radius:50%"></div><span style="font-size:11px">SSM</span></div>
<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;background:var(--mobile);border-radius:50%"></div><span style="font-size:11px">Ã‰quipe Mobile</span></div>
<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;background:var(--urgence);border-radius:50%;border:2px solid var(--urgence)"></div><span style="font-size:11px">En alerte</span></div>
<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;background:var(--info);border-radius:50%"></div><span style="font-size:11px">Ma position</span></div>
</div>
<!-- Stats -->
<div style="position:absolute;top:16px;right:16px;background:rgba(7,8,12,.9);border:1px solid var(--border);border-radius:8px;padding:12px;z-index:1000">
<div style="font-size:11px;color:var(--muted);margin-bottom:4px">Zones dÃ©couvertes</div>
<div style="font-size:18px;font-weight:700;font-family:var(--mono);color:var(--liens)" id="mapDiscoveredCount">0/12</div>
</div>
</div>
</div>
</section>

<!-- LIEUX DE LIENS -->
<section class="module" id="mod-lieux">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Lieux de Liens</h1>
<span class="tag liens" id="lieuxTotal">0 lieux</span>
<div style="margin-left:auto;display:flex;gap:8px">
<button class="btn primary" onclick="openLieuModal()">+ Ajouter lieu</button>
<button class="btn" onclick="exportLieuxCSV()">ğŸ“¤ Export CSV</button>
</div>
</div>
<div class="card">
<div class="card-header">
<input type="search" id="searchLieux" placeholder="Rechercher un lieu..." style="flex:1;max-width:300px">
<select id="filterCommune" style="width:180px"><option value="">Toutes communes</option></select>
</div>
<div class="card-body">
<div class="table-wrap">
<table id="tableLieux">
<thead><tr><th>Nom</th><th>Commune</th><th>TÃ©lÃ©phone</th><th>Statut</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>

<!-- SSM -->
<section class="module" id="mod-ssm">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
<h1 style="font-size:28px;font-weight:700">SSM & Services</h1>
<span class="tag ssm" id="ssmTotal">0 services</span>
</div>
<div class="card">
<div class="card-body">
<div class="table-wrap">
<table id="tableSSM">
<thead><tr><th>Nom</th><th>Type</th><th>Contact</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>

<!-- RESEAUX -->
<section class="module" id="mod-reseaux">
<h1 style="font-size:28px;font-weight:700;margin-bottom:24px">RÃ©seaux 107</h1>
<div class="grid-2">
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--liens)">ğŸ”— RÃ‰ZONE (Sud)</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:12px">Forest, Saint-Gilles, Ixelles, Uccle, Watermael-Boitsfort</p>
<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:0483658085">0483/65.80.85</a></span></div>
<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://rezone.be" target="_blank">rezone.be</a></span></div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--ssm)">ğŸ”— NORWEST (Nord-Ouest)</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:12px">Molenbeek, Berchem, Ganshoren, Koekelberg, Jette, Laeken, NOH</p>
<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:0470494913">0470/49.49.13</a></span></div>
<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://norwest.be" target="_blank">norwest.be</a></span></div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--info)">ğŸ”— HERMES+ (Centre)</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:12px">Anderlecht, Molenbeek, Pentagone, Saint-Josse - Bilingue FR/NL</p>
<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:0220122200">02/201.22.00</a></span></div>
<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://hermesplus.be" target="_blank">hermesplus.be</a></span></div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--mobile)">ğŸ”— BRUXELLES-EST</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:12px">Schaerbeek, Evere, Etterbeek, Auderghem, Woluwes, Haren</p>
<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:0496267899">0496/26.78.99</a></span></div>
<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://bruxelles-est.be" target="_blank">bruxelles-est.be</a></span></div>
</div>
</div>
</div>
</section>

<!-- URGENCES -->
<section class="module" id="mod-urgences">
<h1 style="font-size:28px;font-weight:700;margin-bottom:24px">Lignes d'Urgence</h1>
<div class="grid-3" id="urgencesList"></div>
</section>

<!-- FLASHCARDS -->
<section class="module" id="mod-flashcards">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Flashcards</h1>
<span class="tag warn" id="flashTotal">0 cartes</span>
<div style="margin-left:auto;display:flex;gap:8px">
<button class="btn" onclick="openFlashModal()">+ Ajouter carte</button>
<button class="btn" onclick="importFlashCSV()">ğŸ“¥ Import CSV</button>
<button class="btn" onclick="exportFlashCSV()">ğŸ“¤ Export CSV</button>
</div>
</div>
<div class="grid-2">
<div class="card" style="grid-column:1/-1">
<div class="card-header"><span class="card-title">ğŸ´ Mode apprentissage</span><span class="card-badge" id="flashStudyProgress">0/0</span></div>
<div class="card-body">
<div style="max-width:600px;margin:0 auto">
<div class="flashcard-container" style="height:250px">
<div class="flashcard" id="studyFlashcard" onclick="this.classList.toggle('flipped')">
<div class="flashcard-face flashcard-front"><div class="flashcard-question" id="studyQ">Cliquez pour commencer</div></div>
<div class="flashcard-face flashcard-back"><div class="flashcard-answer" id="studyA"></div></div>
</div>
</div>
<div style="display:flex;justify-content:center;gap:12px;margin-top:20px">
<button class="btn" onclick="prevStudyFlash()">â† PrÃ©cÃ©dent</button>
<button class="btn" onclick="shuffleFlash()">ğŸ”€ MÃ©langer</button>
<button class="btn primary" onclick="nextStudyFlash()">Suivant â†’</button>
</div>
<div style="text-align:center;margin-top:16px">
<div class="progress-bar" style="max-width:300px;margin:0 auto"><div class="progress-fill" id="flashProgressBar" style="width:0%"></div></div>
<div style="font-family:var(--mono);font-size:13px;color:var(--muted);margin-top:8px" id="studyCounter">0 / 0</div>
</div>
</div>
</div>
</div>
</div>
<div class="card" style="margin-top:24px">
<div class="card-header"><span class="card-title">ğŸ“‹ Liste complÃ¨te</span></div>
<div class="card-body">
<div class="table-wrap" style="max-height:400px;overflow-y:auto">
<table id="tableFlash">
<thead><tr><th style="width:45%">Question</th><th style="width:40%">RÃ©ponse</th><th style="width:15%">Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>

<!-- CONTACTS -->
<section class="module" id="mod-contacts">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">RÃ©pertoire Contacts</h1>
<span class="tag info" id="contactTotal">0 contacts</span>
<div style="margin-left:auto;display:flex;gap:8px">
<button class="btn" onclick="openContactModal()">+ Ajouter</button>
<button class="btn" onclick="importContactsXLSX()">ğŸ“¥ Import Excel</button>
<button class="btn" onclick="exportContactsCSV()">ğŸ“¤ Export CSV</button>
</div>
</div>
<div class="card">
<div class="card-header">
<input type="search" id="searchContacts" placeholder="Rechercher..." style="flex:1;max-width:300px">
<select id="filterType" style="width:180px"><option value="">Tous types</option></select>
<select id="filterStatus" style="width:150px"><option value="">Tous statuts</option><option value="Actif">Actif</option><option value="Inaccessible">Inaccessible</option></select>
</div>
<div class="card-body">
<div class="table-wrap">
<table id="tableContacts">
<thead><tr><th>Nom</th><th>Type</th><th>Zone</th><th>Site Web</th><th>Statut</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>

<!-- MISSIONS -->
<section class="module" id="mod-missions">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
<h1 style="font-size:28px;font-weight:700">Missions</h1>
<span class="tag liens" id="missionsProgress">0/0 complÃ©tÃ©es</span>
<div style="margin-left:auto;display:flex;gap:8px">
<button class="btn" onclick="importSharedMission()" title="Importer une mission partagÃ©e">ğŸ“¥ Importer</button>
<button class="btn primary" onclick="openMissionModal()">+ Nouvelle mission</button>
</div>
</div>

<!-- Progression globale -->
<div class="card" style="margin-bottom:24px">
<div class="card-body">
<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
<div style="flex:1;min-width:200px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px">
<span style="font-weight:600">Progression globale</span>
<span id="missionPercent" style="font-family:var(--mono);color:var(--liens)">0%</span>
</div>
<div class="progress-bar" style="height:12px"><div class="progress-fill" id="missionProgressBar" style="width:0%"></div></div>
</div>
<div style="display:flex;gap:24px">
<div style="text-align:center"><div style="font-size:28px;font-weight:700;font-family:var(--mono);color:var(--liens)" id="statExploration">0</div><div style="font-size:12px;color:var(--muted)">Exploration</div></div>
<div style="text-align:center"><div style="font-size:28px;font-weight:700;font-family:var(--mono);color:var(--ssm)" id="statInteraction">0</div><div style="font-size:12px;color:var(--muted)">Interaction</div></div>
<div style="text-align:center"><div style="font-size:28px;font-weight:700;font-family:var(--mono);color:var(--mobile)" id="statTransformation">0</div><div style="font-size:12px;color:var(--muted)">Transformation</div></div>
</div>
</div>
</div>
</div>

<!-- Missions actives -->
<div class="grid-3" style="margin-bottom:24px">
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--liens)">ğŸ” Exploration</span><span class="card-badge" id="badgeExploration">0</span></div>
<div class="card-body" id="listExploration" style="display:grid;gap:12px;max-height:400px;overflow-y:auto"></div>
</div>
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--ssm)">ğŸ¤ Interaction</span><span class="card-badge" id="badgeInteraction">0</span></div>
<div class="card-body" id="listInteraction" style="display:grid;gap:12px;max-height:400px;overflow-y:auto"></div>
</div>
<div class="card">
<div class="card-header"><span class="card-title" style="color:var(--mobile)">âš¡ Transformation</span><span class="card-badge" id="badgeTransformation">0</span></div>
<div class="card-body" id="listTransformation" style="display:grid;gap:12px;max-height:400px;overflow-y:auto"></div>
</div>
</div>

<!-- Historique missions terminÃ©es -->
<div class="card">
<div class="card-header"><span class="card-title">âœ… Missions complÃ©tÃ©es</span><span class="card-badge" id="badgeCompleted">0</span></div>
<div class="card-body">
<div id="listCompleted" style="display:grid;gap:8px;max-height:200px;overflow-y:auto"></div>
</div>
</div>
</section>

<!-- IMPORT/EXPORT -->
<section class="module" id="mod-import">
<h1 style="font-size:28px;font-weight:700;margin-bottom:24px">Import / Export</h1>
<div class="grid-2">
<div class="card">
<div class="card-header"><span class="card-title">ğŸ“¥ Importer des donnÃ©es</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:16px">Formats supportÃ©s: JSON, JSON-LD, CSV, Excel (.xlsx)</p>
<input type="file" id="importFileMain" accept=".json,.jsonld,.csv,.xlsx,.xls" style="margin-bottom:12px;width:100%">
<button class="btn primary" onclick="importDataMain()" style="width:100%">ğŸ“¥ Importer</button>
<div id="importPreview" style="display:none;margin-top:16px;padding:12px;background:var(--elevated);border-radius:8px;font-size:12px;max-height:150px;overflow:auto"></div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">ğŸ“¤ Exporter</span></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:16px">TÃ©lÃ©charger vos donnÃ©es</p>
<div style="display:flex;flex-direction:column;gap:8px">
<button class="btn primary" onclick="exportData()">ğŸ“¦ Export JSON complet</button>
<button class="btn" onclick="exportJSONLD()">ğŸ”— Export JSON-LD (Web SÃ©mantique)</button>
<button class="btn" onclick="exportFHIR()" style="background:linear-gradient(135deg,rgba(255,107,138,.15),rgba(201,160,255,.15));border-color:rgba(255,107,138,.3)">ğŸ¥ Export FHIR R4 (SantÃ©)</button>
<div style="display:flex;gap:8px">
<button class="btn" onclick="exportCSV('lieux')" style="flex:1">CSV Lieux</button>
<button class="btn" onclick="exportCSV('contacts')" style="flex:1">CSV Contacts</button>
</div>
<button class="btn" onclick="exportGeoJSON()" style="margin-top:8px">ğŸ—ºï¸ Export GeoJSON</button>
<button class="btn" onclick="exportRDF()" style="margin-top:8px">ğŸ“œ Export RDF/Turtle</button>
</div>
</div>
</div>
<!-- FHIR Info Card -->
<div class="card" style="margin-top:20px">
<div class="card-header"><span class="card-title">ğŸ¥ FHIR R4 InteropÃ©rabilitÃ© SantÃ©</span></div>
<div class="card-body">
<p style="color:var(--text2);font-size:13px;margin-bottom:12px">Export/Import compatible avec le standard <strong>HL7 FHIR R4</strong> pour l'interopÃ©rabilitÃ© avec les systÃ¨mes de santÃ© (EHDS, eHealth Belgium, etc.)</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
<div style="text-align:center;padding:12px;background:var(--elevated);border-radius:8px">
<div style="font-size:20px">ğŸ¢</div>
<div style="font-size:11px;color:var(--muted)">Organization</div>
</div>
<div style="text-align:center;padding:12px;background:var(--elevated);border-radius:8px">
<div style="font-size:20px">ğŸ“</div>
<div style="font-size:11px;color:var(--muted)">Location</div>
</div>
<div style="text-align:center;padding:12px;background:var(--elevated);border-radius:8px">
<div style="font-size:20px">âš•ï¸</div>
<div style="font-size:11px;color:var(--muted)">HealthcareService</div>
</div>
</div>
<div style="font-size:11px;color:var(--muted)">
<strong>Ressources FHIR mappÃ©es:</strong> Organization (SSM, RÃ©seaux), Location (Lieux de liens), HealthcareService (Services), OrganizationAffiliation (Liens)
</div>
</div>
</div>
<!-- Open Data Civic Tech Card -->
<div class="card" style="margin-top:20px">
<div class="card-header"><span class="card-title">ğŸŒ Open Data & Civic Tech</span></div>
<div class="card-body">
<p style="color:var(--text2);font-size:13px;margin-bottom:16px">Exports compatibles avec l'Ã©cosystÃ¨me open data belge et europÃ©en</p>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
<button class="btn" onclick="exportCKAN()">ğŸ“¦ CKAN Package</button>
<button class="btn" onclick="exportDCATAP()">ğŸ‡ªğŸ‡º DCAT-AP 3.0</button>
<button class="btn" onclick="exportHealthDCATAP()">ğŸ¥ HealthDCAT-AP</button>
<button class="btn" onclick="exportJSONLD()">ğŸ”— JSON-LD</button>
</div>
<div style="padding:12px;background:var(--elevated);border-radius:8px;font-size:11px">
<div style="font-weight:600;color:var(--liens);margin-bottom:8px">Portails compatibles:</div>
<div style="display:flex;flex-wrap:wrap;gap:6px">
<span class="tag">data.gov.be</span>
<span class="tag">ODWB</span>
<span class="tag">data.europa.eu</span>
<span class="tag">EHDS</span>
<span class="tag">Decidim</span>
<span class="tag">CKAN</span>
</div>
</div>
<div style="margin-top:12px;font-size:11px;color:var(--muted)">
<strong>Standards:</strong> DCAT-AP 3.0 â€¢ HealthDCAT-AP â€¢ CKAN API â€¢ Schema.org â€¢ FHIR R4 â€¢ GeoJSON â€¢ RDF/Turtle
</div>
</div>
</div>
<!-- Integration Hub Card -->
<div class="card" style="margin-top:20px">
<div class="card-header"><span class="card-title">ğŸ”Œ Hub d'IntÃ©grations Civic Tech</span></div>
<div class="card-body">
<p style="color:var(--text2);font-size:13px;margin-bottom:16px">Connexion directe aux plateformes participatives et portails open data belges</p>

<!-- Decidim Integration -->
<div style="padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#a855f7,#6366f1);border-radius:10px;display:grid;place-items:center;font-size:20px">ğŸ—³ï¸</div>
<div style="flex:1">
<div style="font-weight:600">Decidim (participation.brussels)</div>
<div style="font-size:11px;color:var(--muted)">Import propositions, rÃ©unions, processus participatifs</div>
</div>
<div id="decidimStatus" style="font-size:12px;color:var(--muted)">Non connectÃ©</div>
</div>
<div style="display:flex;gap:8px;margin-bottom:12px">
<input type="text" id="decidimUrl" value="https://participation.brussels" placeholder="URL instance Decidim" style="flex:1;font-size:12px">
<button class="btn" onclick="testDecidimConnection()">ğŸ”— Connecter</button>
</div>
<div style="display:flex;gap:8px">
<select id="decidimProcess" style="flex:1;font-size:12px">
<option value="">SÃ©lectionner un processus...</option>
</select>
<button class="btn primary" onclick="importFromDecidim()">ğŸ“¥ Importer</button>
</div>
</div>

<!-- Open Data Search -->
<div style="padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#10b981,#06b6d4);border-radius:10px;display:grid;place-items:center;font-size:20px">ğŸ”</div>
<div style="flex:1">
<div style="font-weight:600">Recherche Open Data Belgium</div>
<div style="font-size:11px;color:var(--muted)">data.gov.be â€¢ ODWB â€¢ Brussels Open Data</div>
</div>
</div>
<div style="display:flex;gap:8px;margin-bottom:12px">
<input type="text" id="openDataQuery" value="santÃ© mentale bruxelles" placeholder="Rechercher..." style="flex:1;font-size:12px">
<button class="btn" onclick="searchOpenDataPortals()">ğŸ” Rechercher</button>
</div>
<div id="openDataResults" style="display:none;font-size:12px;max-height:200px;overflow-y:auto"></div>
</div>

<!-- API Endpoints -->
<div style="padding:16px;background:var(--elevated);border-radius:12px">
<div style="font-weight:600;margin-bottom:12px">ğŸ“¡ Endpoints API NYXO</div>
<div style="display:grid;gap:8px;font-size:11px;font-family:var(--mono)">
<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg);border-radius:6px">
<span>FHIR R4 Bundle</span>
<button class="btn" style="height:28px;font-size:10px" onclick="copyAPIEndpoint('fhir')">ğŸ“‹ Copier</button>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg);border-radius:6px">
<span>DCAT-AP Catalog</span>
<button class="btn" style="height:28px;font-size:10px" onclick="copyAPIEndpoint('dcat')">ğŸ“‹ Copier</button>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg);border-radius:6px">
<span>GeoJSON</span>
<button class="btn" style="height:28px;font-size:10px" onclick="copyAPIEndpoint('geojson')">ğŸ“‹ Copier</button>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg);border-radius:6px">
<span>JSON-LD</span>
<button class="btn" style="height:28px;font-size:10px" onclick="copyAPIEndpoint('jsonld')">ğŸ“‹ Copier</button>
</div>
</div>
</div>

</div>
</div>
</div>
</section>

<!-- SETTINGS -->
<section class="module" id="mod-settings">
<h1 style="font-size:28px;font-weight:700;margin-bottom:24px">ParamÃ¨tres</h1>
<div class="grid-2" style="max-width:900px">
<div class="card">
<div class="card-header"><span class="card-title">ğŸ¨ Apparence</span></div>
<div class="card-body">
<div style="display:grid;gap:20px">
<div><label style="display:block;margin-bottom:8px;font-weight:600">ThÃ¨me</label>
<select id="settingTheme" onchange="setTheme(this.value)" style="width:100%"><option value="dark">Sombre</option><option value="light">Clair</option></select></div>
<div><label style="display:block;margin-bottom:8px;font-weight:600">Nom du projet</label>
<input type="text" value="NYXO - Agence de Renseignement Citoyenne" style="width:100%"></div>
</div>
</div>
</div>
<div class="card">
<div class="card-header"><span class="card-title">ğŸ’¾ Stockage local</span></div>
<div class="card-body">
<div style="padding:12px;background:rgba(249,215,125,.1);border:1px solid rgba(249,215,125,.3);border-radius:8px;margin-bottom:16px">
<div style="font-weight:600;color:var(--warn);margin-bottom:4px">âš ï¸ Sauvegarde recommandÃ©e</div>
<p style="font-size:13px;color:var(--text2)">Vos donnÃ©es sont stockÃ©es localement. Exportez rÃ©guliÃ¨rement pour Ã©viter toute perte.</p>
</div>
<div style="padding:12px;background:var(--elevated);border-radius:8px;margin-bottom:16px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--muted)">Lieux de liens</span><span id="storageStatLieux">0</span></div>
<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--muted)">SSM & Services</span><span id="storageStatSSM">0</span></div>
<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--muted)">Liens</span><span id="storageStatLinks">0</span></div>
<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--muted)">Flashcards</span><span id="storageStatFlash">0</span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Contacts</span><span id="storageStatContacts">0</span></div>
</div>
<div style="display:flex;flex-direction:column;gap:8px">
<div style="display:flex;gap:8px">
<button class="btn primary" onclick="exportData()" style="flex:1">ğŸ“¥ Export JSON</button>
<button class="btn" onclick="exportJSONLD()" style="flex:1">ğŸ”— Export JSON-LD</button>
</div>
<div style="display:flex;gap:8px">
<button class="btn" onclick="exportCSV('lieux')" style="flex:1">ğŸ“Š CSV Lieux</button>
<button class="btn" onclick="exportCSV('flashcards')" style="flex:1">ğŸ“Š CSV Flash</button>
</div>
<button class="btn" onclick="exportFHIR()" style="margin-top:8px;width:100%">ğŸ¥ Export FHIR R4 Bundle</button>
<hr style="border:none;border-top:1px solid var(--border2);margin:8px 0">
<div style="display:flex;gap:8px;align-items:center">
<input type="file" id="importFile" accept=".json,.jsonld,.csv,.xlsx,.xls" style="flex:1;font-size:12px">
<button class="btn" onclick="importData()">ğŸ“¤ Importer</button>
</div>
<p style="font-size:11px;color:var(--muted);margin-top:4px">Formats: JSON, JSON-LD, CSV, Excel (xlsx)</p>
<hr style="border:none;border-top:1px solid var(--border2);margin:8px 0">
<button class="btn danger" onclick="clearStorage()">ğŸ—‘ï¸ Effacer toutes les donnÃ©es</button>
</div>
</div>
</div>
<!-- PWA SETTINGS -->
<div class="card" style="grid-column:1/-1;margin-top:20px">
<div class="card-header"><span class="card-title">ğŸ“± Application Hors-ligne (PWA)</span></div>
<div class="card-body">
<div class="grid-2" style="gap:20px">
<div>
<div style="padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<div id="pwaStatusIcon" style="width:40px;height:40px;background:var(--surface);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“¡</div>
<div>
<div style="font-weight:600" id="pwaStatusTitle">Statut</div>
<div style="font-size:13px;color:var(--muted)" id="pwaStatusText">VÃ©rification...</div>
</div>
</div>
<div style="display:grid;gap:8px;font-size:13px">
<div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Service Worker</span><span id="pwaSW">-</span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">InstallÃ©e</span><span id="pwaInstalled">-</span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Connexion</span><span id="pwaOnline">-</span></div>
</div>
</div>
<div style="display:grid;gap:8px">
<button class="btn primary" onclick="installPWA()" id="pwaInstallBtn">ğŸ“² Installer l'application</button>
<button class="btn" onclick="subscribeToPush()">ğŸ”” Activer les notifications</button>
</div>
</div>
<div>
<div style="padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:16px">
<div style="font-weight:600;margin-bottom:12px">ğŸ—ºï¸ Cache Carte Hors-ligne</div>
<p style="font-size:13px;color:var(--text2);margin-bottom:12px">
TÃ©lÃ©chargez les tuiles de carte pour Bruxelles afin de consulter la carte mÃªme sans connexion internet.
</p>
<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px">
<span style="color:var(--muted)">Taille du cache</span>
<span id="pwaCacheSize">Calcul...</span>
</div>
</div>
<div style="display:grid;gap:8px">
<button class="btn" onclick="cacheMapTilesForBrussels()">ğŸ—ºï¸ TÃ©lÃ©charger carte Bruxelles</button>
<button class="btn" onclick="forceSyncData()">ğŸ”„ Forcer synchronisation</button>
<button class="btn danger" onclick="clearAppCache()">ğŸ—‘ï¸ Vider le cache</button>
</div>
</div>
</div>
</div>
</div>
</div>
</section>

</main>
</div>

<!-- DETAIL PANEL -->
<div class="backdrop" id="backdrop" onclick="closeDetail()"></div>
<aside class="detail-panel" id="detailPanel">
<div class="detail-header">
<button class="detail-close" onclick="closeDetail()">âœ•</button>
<div class="detail-title" id="detailTitle">DÃ©tails</div>
</div>
<div class="detail-body" id="detailBody"></div>
</aside>

<!-- MODAL FLASHCARD -->
<div class="modal" id="flashModal">
<div class="modal-backdrop" onclick="closeFlashModal()"></div>
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" id="flashModalTitle">Nouvelle Flashcard</div>
<button class="modal-close" onclick="closeFlashModal()">âœ•</button>
</div>
<div class="modal-body">
<input type="hidden" id="flashEditId">
<div class="form-group">
<label class="form-label">Question</label>
<textarea id="flashQuestion" class="form-input" rows="3" placeholder="Entrez la question..."></textarea>
</div>
<div class="form-group">
<label class="form-label">RÃ©ponse</label>
<textarea id="flashAnswer" class="form-input" rows="3" placeholder="Entrez la rÃ©ponse..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeFlashModal()">Annuler</button>
<button class="btn primary" onclick="saveFlashcard()">Enregistrer</button>
</div>
</div>
</div>

<!-- MODAL CONTACT -->
<div class="modal" id="contactModal">
<div class="modal-backdrop" onclick="closeContactModal()"></div>
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" id="contactModalTitle">Nouveau Contact</div>
<button class="modal-close" onclick="closeContactModal()">âœ•</button>
</div>
<div class="modal-body">
<input type="hidden" id="contactEditId">
<div class="form-group">
<label class="form-label">Nom</label>
<input type="text" id="contactName" class="form-input" placeholder="Nom du contact">
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Type</label>
<input type="text" id="contactType" class="form-input" placeholder="MÃ©dia militant, Organisation...">
</div>
<div class="form-group">
<label class="form-label">Zone</label>
<input type="text" id="contactZone" class="form-input" placeholder="France, Belgique...">
</div>
</div>
<div class="form-group">
<label class="form-label">Site Web</label>
<input type="url" id="contactWeb" class="form-input" placeholder="https://...">
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" id="contactEmail" class="form-input" placeholder="contact@...">
</div>
<div class="form-group">
<label class="form-label">Statut</label>
<select id="contactStatus" class="form-input">
<option value="">Non dÃ©fini</option>
<option value="Actif">Actif</option>
<option value="Inaccessible">Inaccessible</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Notes</label>
<textarea id="contactNotes" class="form-input" rows="2" placeholder="Notes..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeContactModal()">Annuler</button>
<button class="btn primary" onclick="saveContact()">Enregistrer</button>
</div>
</div>
</div>

<!-- MODAL IMPORT -->
<div class="modal" id="importModal">
<div class="modal-backdrop" onclick="closeImportModal()"></div>
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">Importer des donnÃ©es</div>
<button class="modal-close" onclick="closeImportModal()">âœ•</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">Fichier CSV (flashcards) ou Excel (contacts)</label>
<input type="file" id="importFileModal" accept=".csv,.xlsx,.xls" class="form-input">
</div>
<p style="color:var(--muted);font-size:13px;margin-top:12px">
<strong>Format CSV flashcards :</strong> Question,RÃ©ponse (une par ligne)<br>
<strong>Format Excel contacts :</strong> Nom, Site Web, Type, Zone, Email, Statut
</p>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeImportModal()">Annuler</button>
<button class="btn primary" onclick="processImport()">Importer</button>
</div>
</div>
</div>

<!-- MODAL LIEU -->
<div class="modal" id="lieuModal">
<div class="modal-backdrop" onclick="closeLieuModal()"></div>
<div class="modal-content" style="max-width:700px">
<div class="modal-header">
<div class="modal-title" id="lieuModalTitle">Nouveau Lieu de Liens</div>
<button class="modal-close" onclick="closeLieuModal()">âœ•</button>
</div>
<div class="modal-body">
<input type="hidden" id="lieuEditId">
<div class="form-row">
<div class="form-group" style="grid-column:1/-1">
<label class="form-label">Nom *</label>
<input type="text" id="lieuName" class="form-input" placeholder="Nom du lieu">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Commune *</label>
<select id="lieuCommune" class="form-input">
<option value="Bruxelles">Bruxelles-Ville (1000)</option>
<option value="Schaerbeek">Schaerbeek (1030)</option>
<option value="Etterbeek">Etterbeek (1040)</option>
<option value="Ixelles">Ixelles (1050)</option>
<option value="Saint-Gilles">Saint-Gilles (1060)</option>
<option value="Anderlecht">Anderlecht (1070)</option>
<option value="Molenbeek">Molenbeek (1080)</option>
<option value="Jette">Jette (1090)</option>
<option value="NOH">Neder-Over-Heembeek (1120)</option>
<option value="Auderghem">Auderghem (1160)</option>
<option value="Forest">Forest (1190)</option>
<option value="Woluwe-SL">Woluwe-Saint-Lambert (1200)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Code postal</label>
<input type="text" id="lieuCP" class="form-input" placeholder="1000">
</div>
</div>
<div class="form-group">
<label class="form-label">Adresse</label>
<input type="text" id="lieuAdresse" class="form-input" placeholder="Rue, numÃ©ro">
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">TÃ©lÃ©phone</label>
<input type="tel" id="lieuTel" class="form-input" placeholder="02/xxx.xx.xx">
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" id="lieuEmail" class="form-input" placeholder="contact@...">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Site web</label>
<input type="text" id="lieuWeb" class="form-input" placeholder="exemple.be">
</div>
<div class="form-group">
<label class="form-label">Statut</label>
<select id="lieuStatus" class="form-input">
<option value="ok">OK</option>
<option value="at_risk">âš ï¸ En danger</option>
<option value="closed">FermÃ©</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Horaires</label>
<input type="text" id="lieuHoraires" class="form-input" placeholder="Lun-Ven 9h-17h">
</div>
<div class="form-group">
<label class="form-label">Description / RÃ©sumÃ©</label>
<textarea id="lieuSummary" class="form-input" rows="2" placeholder="ActivitÃ©s, public, philosophie..."></textarea>
</div>
<div class="form-group">
<label class="form-label">Tags (sÃ©parÃ©s par virgule)</label>
<input type="text" id="lieuTags" class="form-input" placeholder="ateliers, culture, bas_seuil...">
</div>
</div>
<div class="modal-footer">
<button class="btn danger" id="lieuDeleteBtn" onclick="deleteLieu()" style="margin-right:auto;display:none">ğŸ—‘ï¸ Supprimer</button>
<button class="btn" onclick="closeLieuModal()">Annuler</button>
<button class="btn primary" onclick="saveLieu()">Enregistrer</button>
</div>
</div>
</div>

<!-- MODAL LIEN -->
<div class="modal" id="linkModal">
<div class="modal-backdrop" onclick="closeLinkModal()"></div>
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">CrÃ©er un lien</div>
<button class="modal-close" onclick="closeLinkModal()">âœ•</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">De (source)</label>
<select id="linkFrom" class="form-input"></select>
</div>
<div class="form-group">
<label class="form-label">Vers (cible)</label>
<select id="linkTo" class="form-input"></select>
</div>
<div class="form-group">
<label class="form-label">Type de lien</label>
<select id="linkType" class="form-input">
<option value="partenariat">Partenariat</option>
<option value="porte">PortÃ© par (SSM porte lieu)</option>
<option value="reseau">Membre du rÃ©seau</option>
<option value="collaboration">Collaboration</option>
<option value="orientation">Oriente vers</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Label (optionnel)</label>
<input type="text" id="linkLabel" class="form-input" placeholder="Description du lien">
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeLinkModal()">Annuler</button>
<button class="btn primary" onclick="saveLink()">CrÃ©er le lien</button>
</div>
</div>
</div>

<!-- MODAL MISSION -->
<div class="modal" id="missionModal">
<div class="modal-backdrop" onclick="closeMissionModal()"></div>
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" id="missionModalTitle">Nouvelle Mission</div>
<button class="modal-close" onclick="closeMissionModal()">âœ•</button>
</div>
<div class="modal-body">
<input type="hidden" id="missionEditId">
<div class="form-group">
<label class="form-label">Titre de la mission *</label>
<input type="text" id="missionTitle" class="form-input" placeholder="Ex: Visiter l'Autre Lieu">
</div>
<div class="form-group">
<label class="form-label">Type</label>
<select id="missionType" class="form-input">
<option value="exploration">ğŸ” Exploration</option>
<option value="interaction">ğŸ¤ Interaction</option>
<option value="transformation">âš¡ Transformation</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Description</label>
<textarea id="missionDesc" class="form-input" rows="2" placeholder="DÃ©tails de la mission..."></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">EntitÃ© liÃ©e (optionnel)</label>
<select id="missionEntity" class="form-input"><option value="">Aucune</option></select>
</div>
<div class="form-group">
<label class="form-label">Points XP</label>
<input type="number" id="missionXP" class="form-input" value="10" min="1" max="100">
</div>
</div>
<div class="form-group">
<label class="form-label">Date limite (optionnel)</label>
<input type="date" id="missionDeadline" class="form-input">
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeMissionModal()">Annuler</button>
<button class="btn primary" onclick="saveMission()">CrÃ©er mission</button>
</div>
</div>
</div>

<!-- MODAL NOTES -->
<div class="modal" id="notesModal">
<div class="modal-backdrop" onclick="closeNotesModal()"></div>
<div class="modal-content" style="max-width:700px">
<div class="modal-header">
<div class="modal-title" id="notesModalTitle">Notes</div>
<button class="modal-close" onclick="closeNotesModal()">âœ•</button>
</div>
<div class="modal-body">
<input type="hidden" id="notesEntityId">
<div id="notesList" style="display:grid;gap:12px;margin-bottom:16px;max-height:300px;overflow-y:auto"></div>
<div class="form-group">
<label class="form-label">Ajouter une note</label>
<textarea id="newNoteText" class="form-input" rows="3" placeholder="Votre note ou commentaire..."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeNotesModal()">Fermer</button>
<button class="btn primary" onclick="addNote()">Ajouter note</button>
</div>
</div>
</div>

<!-- MODAL AVATAR -->
<div class="modal" id="avatarModal">
<div class="modal-backdrop" onclick="closeAvatarPicker()"></div>
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">Choisir votre avatar</div>
<button class="modal-close" onclick="closeAvatarPicker()">âœ•</button>
</div>
<div class="modal-body">
<div id="avatarGrid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:8px"></div>
</div>
</div>
</div>

<!-- MODAL PROFILS LOCAUX -->
<div class="modal" id="profilesModal">
<div class="modal-backdrop" onclick="closeProfilesModal()"></div>
<div class="modal-content" style="max-width:600px">
<div class="modal-header">
<div class="modal-title">ğŸ‘¥ Profils Locaux</div>
<button class="modal-close" onclick="closeProfilesModal()">âœ•</button>
</div>
<div class="modal-body">
<p style="color:var(--text2);margin-bottom:16px;font-size:13px">Plusieurs personnes peuvent utiliser NYXO sur cet ordinateur. Chaque profil a sa propre progression.</p>
<div id="profilesList" style="display:grid;gap:12px;margin-bottom:20px"></div>
<div style="padding:16px;background:var(--elevated);border-radius:8px;border:2px dashed var(--border2)">
<div style="font-weight:600;margin-bottom:12px">CrÃ©er un nouveau profil</div>
<div style="display:flex;gap:8px">
<input type="text" id="newProfileName" class="form-input" placeholder="Nom du profil..." style="flex:1">
<button class="btn primary" onclick="createNewProfile()">CrÃ©er</button>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeProfilesModal()">Fermer</button>
</div>
</div>
</div>

<!-- MODAL CARTE AGENT -->
<div class="modal" id="cardModal">
<div class="modal-backdrop" onclick="closeCardModal()"></div>
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">ğŸªª Carte de Visite Agent</div>
<button class="modal-close" onclick="closeCardModal()">âœ•</button>
</div>
<div class="modal-body" style="text-align:center">
<canvas id="cardCanvas" width="600" height="400" style="max-width:100%;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3)"></canvas>
<p style="color:var(--muted);margin-top:16px;font-size:13px">Faites un clic droit sur l'image pour l'enregistrer, ou utilisez le bouton ci-dessous.</p>
</div>
<div class="modal-footer">
<button class="btn" onclick="closeCardModal()">Fermer</button>
<button class="btn primary" onclick="downloadAgentCard()">ğŸ“¥ TÃ©lÃ©charger PNG</button>
</div>
</div>
</div>

<!-- MODAL PARTAGE MISSION -->
<div class="modal" id="shareMissionModal">
<div class="modal-backdrop" onclick="closeShareMissionModal()"></div>
<div class="modal-content" style="max-width:550px">
<div class="modal-header">
<div class="modal-title">ğŸ“¤ Partager une Mission</div>
<button class="modal-close" onclick="closeShareMissionModal()">âœ•</button>
</div>
<div class="modal-body">
<p style="color:var(--text2);margin-bottom:16px">Partagez ce lien avec d'autres agents. Ils pourront importer cette mission dans leur workspace.</p>
<div style="padding:12px;background:var(--elevated);border-radius:8px;word-break:break-all;font-family:var(--mono);font-size:12px;max-height:100px;overflow-y:auto" id="shareMissionUrl"></div>
<div style="display:flex;gap:8px;margin-top:12px">
<button class="btn primary" style="flex:1" onclick="copyShareUrl()">ğŸ“‹ Copier le lien</button>
</div>
</div>
</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ========== DATA ==========
const DATA = {
lieux: [
{id:"LDL-001",name:"Circuit - Antonin Artaud",commune:"Bruxelles",cp:"1000",adresse:"Rue du Cirque 7B",tel:"",email:"circuit.csmantoninartaud@gmail.com",web:"circuitantoninartaud.be",horaires:"Lun-Mar 10h-12h, Mer 12h-14h, Jeu 10h-14h, Ven 12h-14h",status:"ok",tags:["bas_seuil","ateliers"],summary:"CafÃ©, ateliers lecture/dessin/tricot, sorties culturelles.",lat:50.8527,lng:4.3545},
{id:"LDL-002",name:"L'Autre \"lieu\" - RAPA",commune:"Bruxelles",cp:"1000",adresse:"5 rue de la ClÃ©",tel:"02/230.62.60",email:"info@autrelieu.be",web:"autrelieu.be",horaires:"Ouvert tous les jours Ã  partir de midi",status:"ok",tags:["historique","anti_psychiatrie"],summary:"Historique anti-psychiatrie depuis 1980.",lat:50.8472,lng:4.3642},
{id:"LDL-003",name:"Le Pianocktail",commune:"Bruxelles",cp:"1000",adresse:"Rue Haute 304 (Marolles)",tel:"0496/23.61.15",email:"lepianocktail.bruxelles@gmail.com",web:"pianocktail.be",horaires:"Mar,Jeu,Ven 18h-22h, Dim 13h-17h",status:"ok",tags:["autogestion","culture"],summary:"Bistrot culturel autogÃ©rÃ© aux Marolles.",lat:50.8389,lng:4.3467},
{id:"LDL-004",name:"MASS de Bruxelles",commune:"Bruxelles",cp:"1000",adresse:"Rue de Woeringen 16-18",tel:"02/505.32.90",email:"contact@mass-bxl.be",web:"mass-bxl.be",horaires:"",status:"ok",tags:["assuetudes","reduction_risques"],summary:"Bas seuil usagers drogues. TSO, pair-aidance.",lat:50.8512,lng:4.3489},
{id:"LDL-005",name:"Espace 51",commune:"Schaerbeek",cp:"1030",adresse:"Rue ThiÃ©fry 51-53",tel:"02 899 21 39",email:"contact.espace51@gmail.com",web:"espace51.be",horaires:"Lun, Mar, Ven 13h30-16h30",status:"at_risk",tags:["art","ALERTE"],summary:"âš ï¸ MENACÃ‰ FERMETURE 2025. CybercafÃ©, arts.",lat:50.8634,lng:4.3789},
{id:"LDL-006",name:"L'Entr'Act",commune:"Schaerbeek",cp:"1030",adresse:"Avenue de Roodebeek 273",tel:"0491/91.44.83",email:"contact@lentract.be",web:"lentract.be",horaires:"Sam, Dim et fÃ©riÃ©s 10h-17h",status:"ok",tags:["week_end","jardin"],summary:"Ouvert WEEK-ENDS. Brunchs, jardin.",lat:50.8712,lng:4.4012},
{id:"LDL-007",name:"Atelier CÃ´tÃ© Cour",commune:"Etterbeek",cp:"1040",adresse:"Rue LÃ©on de Lantsheere 50",tel:"02/733.76.52",email:"",web:"ateliercotecour.be",horaires:"",status:"ok",tags:["theatre","CEC"],summary:"Centre Expression CrÃ©ativitÃ©. ThÃ©Ã¢tre.",lat:50.8367,lng:4.3912},
{id:"LDL-008",name:"Den Teirling",commune:"Ixelles",cp:"1050",adresse:"Rue Maes 89",tel:"02/514.33.01",email:"info@denteirling.be",web:"denteirling.be",horaires:"",status:"ok",tags:["neerlandophone"],summary:"Centre jour nÃ©erlandophone autogÃ©rÃ©.",lat:50.8289,lng:4.3734},
{id:"LDL-009",name:"La Trace",commune:"Saint-Gilles",cp:"1060",adresse:"Rue d'Andenne 79",tel:"02/538.49.22",email:"info@latrace.be",web:"latrace.be",horaires:"Lun-Ven 9h30-17h",status:"ok",tags:["sport_aventure","assuetudes"],summary:"Sport-aventure thÃ©rapeutique depuis 1988.",lat:50.8234,lng:4.3456},
{id:"LDL-010",name:"Espace Jean Vermeylen",commune:"Anderlecht",cp:"1070",adresse:"Avenue Limbourg 5",tel:"02/556.28.47",email:"espace.jv@equipe.be",web:"",horaires:"Lun 9h-19h, Mer 9h-16h, Jeu 9h-19h, Ven 9h-17h",status:"ok",tags:["pairs_aidants"],summary:"Accueil bas seuil Anderlecht. Pairs aidants.",lat:50.8312,lng:4.3178},
{id:"LDL-011",name:"Club 55",commune:"Anderlecht",cp:"1070",adresse:"Rue de Veeweyde 55",tel:"02/522.03.63",email:"club55.bxl@gmail.com",web:"",horaires:"",status:"ok",tags:["ateliers","culture"],summary:"Ateliers variÃ©s, potager, sorties culturelles.",lat:50.8298,lng:4.3156},
{id:"LDL-012",name:"Macadam",commune:"Anderlecht",cp:"1070",adresse:"Rue Sergent De Bruyne 78-82",tel:"0491/56.15.17",email:"contact@macadam.org",web:"",horaires:"Lun-Mar-Mer-Ven 9h-13h30",status:"ok",tags:["jeunes","errance"],summary:"Accueil jour jeunes -26 ans errance.",lat:50.8278,lng:4.3089},
{id:"LDL-013",name:"SÃ¨me qui peut!",commune:"Anderlecht",cp:"1070",adresse:"Rue du Chaudron 62",tel:"0470/48.43.27",email:"semequi-peut@nosoignons.org",web:"nosoignons.org",horaires:"Mercredis 9h30-16h",status:"ok",tags:["nature","maraichage"],summary:"MaraÃ®chage collectif thÃ©rapeutique.",lat:50.8256,lng:4.3045},
{id:"LDL-014",name:"L'Atelier - D'ici et d'ailleurs",commune:"Molenbeek",cp:"1080",adresse:"Rue Fernand Brunfaut 18B",tel:"",email:"Atelier@ssm-dieda.be",web:"ssm-dieda.be",horaires:"",status:"ok",tags:["multiculturel"],summary:"Lieu de liens multiculturel.",lat:50.8567,lng:4.3234},
{id:"LDL-015",name:"Uilenspiegel",commune:"Molenbeek",cp:"1080",adresse:"Rue du Jardinier 45",tel:"02/410.19.99",email:"Info@uilenspiegel.net",web:"uilenspiegel.net",horaires:"",status:"ok",tags:["neerlandophone","droits"],summary:"DÃ©fense droits patients NL.",lat:50.8589,lng:4.3189},
{id:"LDL-016",name:"Club Norwest",commune:"Jette",cp:"1090",adresse:"Avenue Jacques Sermon 93",tel:"0479/28.19.52",email:"clubnorwest@gmail.com",web:"clubnorwest.be",horaires:"Lun 10h-14h, Mar-Ven 10h-16h",status:"ok",tags:["groupes_parole"],summary:"~40 pers/jour. Ateliers, groupes parole.",lat:50.8745,lng:4.3234},
{id:"LDL-017",name:"Le Coin des Cerises",commune:"NOH",cp:"1120",adresse:"Avenue des Croix de l'Yser 5",tel:"02/241.16.67",email:"info@coindescerises.be",web:"coindescerises.org",horaires:"Lun-Mar-Mer 9h-18h, Jeu 9h-17h, Ven 9h30-17h, Sam 9h-13h",status:"ok",tags:["SSM","cohesion_sociale"],summary:"SSM + lieu de liens. Ateliers Ã©criture, rap.",lat:50.8912,lng:4.3567},
{id:"LDL-018",name:"Babel'zin",commune:"Auderghem",cp:"1160",adresse:"ChaussÃ©e de Wavre 1688",tel:"0492/44.88.70",email:"babelzin.legres@gmail.com",web:"babelzin.be",horaires:"Lun 10h-16h, Mar 14h-20h, Mer 11h-17h, Jeu 10h-16h, Ven 14h-20h, Dim 14h-17h",status:"ok",tags:["multimedia","radio","poulailler"],summary:"Studio multimÃ©dia, Radio Papote, poulailler.",lat:50.8123,lng:4.4234},
{id:"LDL-019",name:"Le Delta",commune:"Forest",cp:"1190",adresse:"Rue du Delta 61/1",tel:"0472/35.74.09",email:"info@delta-forest.be",web:"delta-forest.be",horaires:"",status:"ok",tags:["co_gestion","CALICO","potager"],summary:"Co-gestion. Habitat CALICO. Potager.",lat:50.8145,lng:4.3234},
{id:"LDL-020",name:"Fabulus",commune:"Woluwe-SL",cp:"1200",adresse:"ChaussÃ©e de Roodebeek 296",tel:"0484/87.85.71",email:"fabulus@le-gue.be",web:"fabulus.be",horaires:"Mer 16h-20h, Sam 10h-16h, 3e ven/mois 18h-22h",status:"ok",tags:["culture"],summary:"Lieu de liens Le GuÃ©. Vendredis culture.",lat:50.8567,lng:4.4312}
],
ssm: [
{id:"SSM-001",name:"CSM Antonin Artaud",type:"SSM",adresse:"Rue du Grand Hospice 10, 1000 Bruxelles",tel:"",web:"",summary:"SSM agrÃ©Ã© COCOM. Centre jour, habitations.",lat:50.8534,lng:4.3512},
{id:"SSM-002",name:"L'Ã‰quipe ASBL",type:"SSM",adresse:"Rue de Veeweyde 60, 1070 Anderlecht",tel:"02/556.28.30",web:"equipe.be",summary:"Premier SSM Belgique (1963). 12 services.",lat:50.8301,lng:4.3145},
{id:"SSM-003",name:"SSM La Gerbe",type:"SSM",adresse:"Schaerbeek",tel:"",web:"",summary:"Grande accessibilitÃ©, tous publics.",lat:50.8678,lng:4.3756},
{id:"SSM-004",name:"SSM Le GrÃ¨s",type:"SSM",adresse:"Auderghem",tel:"",web:"",summary:"Suivis multidisciplinaires, prÃ©vention.",lat:50.8156,lng:4.4189},
{id:"COORD-001",name:"LBSM",type:"Coordination",adresse:"Rue Mercelis 39, 1050 Ixelles",tel:"02/511.55.43",web:"lbsm.be",summary:"Ligue Bruxelloise SantÃ© Mentale.",lat:50.8334,lng:4.3712},
{id:"COORD-002",name:"Plateforme Bruxelloise SM",type:"Coordination",adresse:"Rue de l'Association 15, 1000 Bruxelles",tel:"02/289.09.60",web:"platformbxl.brussels",summary:"RÃ©pertoire santementale.brussels",lat:50.8523,lng:4.3623},
{id:"COORD-003",name:"Brusano",type:"Coordination",adresse:"",tel:"",web:"brusano.brussels",summary:"Appui professionnels 1Ã¨re ligne.",lat:50.8456,lng:4.3567},
{id:"EM-001",name:"Ã‰quipe Mobile Crise",type:"Ã‰quipe mobile",adresse:"Avenue Hippocrate 10, 1200 WSL",tel:"0490 11 42 00",web:"",summary:"Intervention 1-3 mois.",lat:50.8512,lng:4.4534},
{id:"EM-002",name:"Mobiwest",type:"Ã‰quipe mobile",adresse:"",tel:"",web:"",summary:"Ã‰quipe mobile rÃ©seau Norwest.",lat:50.8623,lng:4.3123},
{id:"EM-003",name:"Caligo",type:"Ã‰quipe mobile",adresse:"",tel:"",web:"",summary:"Ã‰quipe mobile +65 ans.",lat:50.8445,lng:4.3689},
{id:"EM-004",name:"Bru-Stars",type:"Ã‰quipe mobile",adresse:"",tel:"",web:"",summary:"Enfants/ados 0-23 ans.",lat:50.8389,lng:4.3534}
],
urgences: [
{id:"URG-001",name:"TÃ©lÃ©-Accueil",numero:"107",desc:"Ligne d'Ã©coute 24/7. Gratuit, anonyme.",color:"liens"},
{id:"URG-002",name:"PrÃ©vention Suicide",numero:"0800 32 123",desc:"Gratuit. Ã‰coute spÃ©cialisÃ©e.",color:"urgence"},
{id:"URG-003",name:"Ã‰coute-Enfants",numero:"103",desc:"Ligne enfants/adolescents.",color:"info"},
{id:"URG-004",name:"Tele-Onthaal",numero:"106",desc:"Ligne nÃ©erlandophone.",color:"ssm"},
{id:"URG-005",name:"Un Pass dans l'impasse",numero:"0800 300 25",desc:"4 sÃ©ances gratuites indÃ©pendants.",color:"warn"},
{id:"URG-006",name:"PsyBru 1Ã¨re consultation",numero:"",desc:"Gratuite chez psychologue conventionnÃ©.",color:"liens"}
],
zones: [
{id:"Z-1000",name:"Bruxelles-Ville",x:0,y:0},
{id:"Z-1030",name:"Schaerbeek",x:250,y:-100},
{id:"Z-1040",name:"Etterbeek",x:200,y:50},
{id:"Z-1050",name:"Ixelles",x:120,y:100},
{id:"Z-1060",name:"Saint-Gilles",x:-50,y:130},
{id:"Z-1070",name:"Anderlecht",x:-180,y:80},
{id:"Z-1080",name:"Molenbeek",x:-220,y:-40},
{id:"Z-1090",name:"Jette",x:-250,y:-150},
{id:"Z-1120",name:"NOH",x:-80,y:-220},
{id:"Z-1160",name:"Auderghem",x:280,y:130},
{id:"Z-1190",name:"Forest",x:-80,y:200},
{id:"Z-1200",name:"Woluwe-SL",x:320,y:-40}
],
reseaux: [
{id:"R107-001",name:"RÃ‰ZONE",zone:"Sud",communes:"Forest, Saint-Gilles, Ixelles, Uccle",tel:"0483/65.80.85",web:"rezone.be"},
{id:"R107-002",name:"NORWEST",zone:"Nord-Ouest",communes:"Molenbeek, Berchem, Ganshoren, Koekelberg, Jette, Laeken, NOH",tel:"0470/49.49.13",web:"norwest.be"},
{id:"R107-003",name:"HERMES+",zone:"Centre",communes:"Anderlecht, Molenbeek, Pentagone, Saint-Josse",tel:"02/201.22.00",web:"hermesplus.be"},
{id:"R107-004",name:"BRUXELLES-EST",zone:"Est",communes:"Schaerbeek, Evere, Etterbeek, Auderghem, Woluwes",tel:"0496/26.78.99",web:"bruxelles-est.be"}
],
links: [
{from:"LDL-001",to:"SSM-001",type:"porte",label:"PortÃ© par"},
{from:"LDL-005",to:"SSM-003",type:"porte",label:"PortÃ© par"},
{from:"LDL-018",to:"SSM-004",type:"porte",label:"PortÃ© par"},
{from:"LDL-010",to:"SSM-002",type:"porte",label:"PortÃ© par"},
{from:"LDL-011",to:"SSM-002",type:"porte",label:"PortÃ© par"},
{from:"LDL-016",to:"R107-002",type:"reseau",label:"RÃ©seau"},
{from:"LDL-019",to:"R107-001",type:"reseau",label:"RÃ©seau"},
{from:"LDL-014",to:"R107-003",type:"reseau",label:"RÃ©seau"},
{from:"LDL-006",to:"R107-004",type:"reseau",label:"RÃ©seau"},
{from:"LDL-018",to:"R107-004",type:"reseau",label:"RÃ©seau"},
{from:"LDL-009",to:"LDL-013",type:"partenariat",label:"Partenariat"},
{from:"LDL-003",to:"LDL-002",type:"partenariat",label:"Partenariat"},
{from:"LDL-018",to:"LDL-019",type:"partenariat",label:"Collaboration"},
{from:"SSM-001",to:"COORD-001",type:"membre",label:"Membre"},
{from:"SSM-002",to:"COORD-001",type:"membre",label:"Membre"},
{from:"EM-002",to:"R107-002",type:"reseau",label:"RÃ©seau"},
{from:"EM-001",to:"R107-004",type:"reseau",label:"RÃ©seau"}
],
missions: [
{id:"M-001",title:"Appeler le TÃ©lÃ©-Accueil (107)",type:"interaction",desc:"Premier contact avec une ligne d'Ã©coute",entity:"URG-001",xp:15,status:"active",createdAt:"2025-01-10"},
{id:"M-002",title:"Visiter L'Autre Lieu",type:"exploration",desc:"DÃ©couvrir ce lieu historique de l'anti-psychiatrie",entity:"LDL-002",xp:20,status:"active",createdAt:"2025-01-10"},
{id:"M-003",title:"Cartographier les SSM d'Anderlecht",type:"exploration",desc:"Identifier tous les SSM de la commune",entity:"",xp:25,status:"active",createdAt:"2025-01-10"},
{id:"M-004",title:"RÃ©diger une fiche lieu",type:"transformation",desc:"Contribuer Ã  la base de donnÃ©es",entity:"",xp:30,status:"active",createdAt:"2025-01-10"},
{id:"M-005",title:"Participer Ã  un groupe de parole",type:"interaction",desc:"Rejoindre un groupe dans un lieu de liens",entity:"",xp:25,status:"active",createdAt:"2025-01-10"}
],
notes: [],
profil: {
  name: "Agent Anonyme",
  avatar: "ğŸ•µï¸",
  xp: 0,
  specPoints: 0,
  specs: {cartographe:0, archiviste:0, tisseur:0, mediateur:0},
  discoveredZones: [],
  unlockedBadges: [],
  activeDays: [],
  fichesViewed: [],
  flashcardsReviewed: 0,
  journal: [],
  createdAt: new Date().toISOString().split('T')[0]
},
flashcards: [],
contacts: []
};

// BADGES DEFINITIONS
const BADGES = [
{id:"B-001",name:"Premier Pas",icon:"ğŸ‘£",desc:"ComplÃ©ter votre premiÃ¨re mission",condition:"missions_completed >= 1",xp:10},
{id:"B-002",name:"Explorateur",icon:"ğŸ”­",desc:"ComplÃ©ter 5 missions d'exploration",condition:"exploration_completed >= 5",xp:25},
{id:"B-003",name:"Connecteur",icon:"ğŸ¤",desc:"ComplÃ©ter 5 missions d'interaction",condition:"interaction_completed >= 5",xp:25},
{id:"B-004",name:"BÃ¢tisseur",icon:"ğŸ—ï¸",desc:"ComplÃ©ter 5 missions de transformation",condition:"transformation_completed >= 5",xp:25},
{id:"B-005",name:"Cartographe",icon:"ğŸ—ºï¸",desc:"DÃ©couvrir 5 communes diffÃ©rentes",condition:"zones_discovered >= 5",xp:30},
{id:"B-006",name:"Tisseur de Liens",icon:"ğŸ•¸ï¸",desc:"CrÃ©er 10 liens entre entitÃ©s",condition:"links_created >= 10",xp:30},
{id:"B-007",name:"Archiviste",icon:"ğŸ“š",desc:"RÃ©diger 10 notes",condition:"notes_created >= 10",xp:20},
{id:"B-008",name:"Ã‰rudit",icon:"ğŸ“",desc:"RÃ©viser 20 flashcards",condition:"flashcards_reviewed >= 20",xp:25},
{id:"B-009",name:"Sentinelle",icon:"ğŸ‘ï¸",desc:"S'informer sur un lieu en alerte",condition:"alert_lieux_visited >= 1",xp:40},
{id:"B-010",name:"RÃ©gulier",icon:"ğŸ“†",desc:"ÃŠtre actif 7 jours (pas forcÃ©ment consÃ©cutifs)",condition:"days_active >= 7",xp:35},
{id:"B-011",name:"Centurion",icon:"ğŸ’¯",desc:"Atteindre 100 XP",condition:"xp >= 100",xp:0},
{id:"B-012",name:"MaÃ®tre Agent",icon:"ğŸ–ï¸",desc:"Atteindre 500 XP",condition:"xp >= 500",xp:0},
{id:"B-013",name:"LÃ©gende",icon:"â­",desc:"Atteindre 1000 XP",condition:"xp >= 1000",xp:0},
{id:"B-014",name:"RÃ©seau Complet",icon:"ğŸ”—",desc:"DÃ©couvrir les 4 rÃ©seaux 107",condition:"reseaux_discovered >= 4",xp:50},
{id:"B-015",name:"EncyclopÃ©diste",icon:"ğŸ“–",desc:"Ajouter 5 nouveaux lieux",condition:"lieux_added >= 5",xp:40},
{id:"B-016",name:"Curieux",icon:"ğŸ”",desc:"Consulter 10 fiches diffÃ©rentes",condition:"fiches_viewed >= 10",xp:15},
{id:"B-017",name:"Nocturne",icon:"ğŸŒ™",desc:"Utiliser l'app aprÃ¨s 22h",condition:"night_owl >= 1",xp:10,secret:true},
{id:"B-018",name:"LÃ¨ve-tÃ´t",icon:"ğŸŒ…",desc:"Utiliser l'app avant 7h",condition:"early_bird >= 1",xp:10,secret:true},
{id:"B-019",name:"PersÃ©vÃ©rant",icon:"ğŸ”¥",desc:"ComplÃ©ter 10 missions",condition:"missions_completed >= 10",xp:30},
{id:"B-020",name:"MaÃ®tre du Graph",icon:"ğŸ¯",desc:"CrÃ©er 25 liens",condition:"links_created >= 25",xp:50}
];

// SPECIALIZATIONS
const SPECIALIZATIONS = [
{id:"spec-cartographe",name:"Cartographe",icon:"ğŸ—ºï¸",desc:"Expert en exploration du territoire",color:"liens",skills:[
  {name:"DÃ©couvreur",desc:"+2 XP par zone dÃ©couverte",unlockAt:1},
  {name:"Orienteur",desc:"Voir les distances sur la carte",unlockAt:2},
  {name:"MaÃ®tre des Lieux",desc:"DÃ©bloquer les missions d'exploration avancÃ©es",unlockAt:3}
]},
{id:"spec-archiviste",name:"Archiviste",icon:"ğŸ“š",desc:"Gardien de la mÃ©moire collective",color:"info",skills:[
  {name:"MÃ©moire",desc:"+2 XP par note rÃ©digÃ©e",unlockAt:1},
  {name:"Documentaliste",desc:"Voir l'historique complet des fiches",unlockAt:2},
  {name:"Sage",desc:"DÃ©bloquer les flashcards avancÃ©es",unlockAt:3}
]},
{id:"spec-tisseur",name:"Tisseur",icon:"ğŸ•¸ï¸",desc:"SpÃ©cialiste des connexions",color:"ssm",skills:[
  {name:"Connecteur",desc:"+2 XP par lien crÃ©Ã©",unlockAt:1},
  {name:"Analyste",desc:"Voir les statistiques du rÃ©seau",unlockAt:2},
  {name:"Architecte",desc:"SuggÃ©rer des liens potentiels",unlockAt:3}
]},
{id:"spec-mediateur",name:"MÃ©diateur",icon:"ğŸ¤",desc:"Facilitateur d'interactions",color:"mobile",skills:[
  {name:"Empathie",desc:"+2 XP par mission d'interaction",unlockAt:1},
  {name:"Diplomate",desc:"AccÃ¨s aux contacts avancÃ©s",unlockAt:2},
  {name:"Ambassadeur",desc:"Missions de mÃ©diation dÃ©bloquÃ©es",unlockAt:3}
]}
];

// QUOTES (inspirantes, pas toxiques)
const QUOTES = [
{text:"Le chemin se fait en marchant.",author:"Antonio Machado"},
{text:"On ne peut pas aider quelqu'un qui ne veut pas Ãªtre aidÃ©, mais on peut Ãªtre lÃ  quand il sera prÃªt.",author:"Proverbe"},
{text:"La santÃ© mentale n'est pas une destination, c'est un processus.",author:"Inconnu"},
{text:"Demander de l'aide est un signe de force, pas de faiblesse.",author:"Inconnu"},
{text:"Chaque petit pas compte.",author:"Inconnu"},
{text:"Vous n'avez pas Ã  tout comprendre pour avancer.",author:"Inconnu"},
{text:"Le rÃ©tablissement n'est pas linÃ©aire, et c'est normal.",author:"Inconnu"},
{text:"Prendre soin de soi n'est pas Ã©goÃ¯ste.",author:"Audre Lorde"},
{text:"Les liens qu'on tisse sont notre vraie richesse.",author:"Inconnu"},
{text:"Il n'y a pas de honte Ã  ne pas aller bien.",author:"Inconnu"},
{text:"Savoir qu'on n'est pas seul change tout.",author:"Inconnu"},
{text:"La vulnÃ©rabilitÃ© est le berceau de la connexion.",author:"BrenÃ© Brown"},
{text:"On n'est jamais trop abÃ®mÃ© pour recommencer.",author:"Inconnu"},
{text:"Le plus grand acte de courage est de demander de l'aide.",author:"Inconnu"},
{text:"Aujourd'hui est un nouveau jour.",author:"Inconnu"}
];

// AVATARS
const AVATARS = ['ğŸ•µï¸','ğŸ¦Š','ğŸ¦‰','ğŸº','ğŸ¦…','ğŸ‹','ğŸ¦‹','ğŸŒ»','ğŸŒ™','â­','ğŸ”®','ğŸ­','ğŸª','ğŸ”ï¸','ğŸŒŠ','ğŸ”¥','ğŸ’','ğŸ¯','ğŸ§­','ğŸ“š','ğŸ¨','ğŸµ','ğŸŒˆ','â˜€ï¸','ğŸ€','ğŸ¦','ğŸ‰','ğŸ¦„','ğŸ§','ğŸ¦œ','ğŸŒº','ğŸ„','âš¡','ğŸŒŸ','ğŸ’«','ğŸ²','ğŸƒ','ğŸ‘ï¸','ğŸ§¿','ğŸ”±'];

// RANKS
const RANKS = [
{level:1,name:"Recrue",title:"Recrue de l'Agence",minXP:0},
{level:2,name:"InitiÃ©",title:"InitiÃ© aux Liens",minXP:50},
{level:3,name:"Agent",title:"Agent de Terrain",minXP:150},
{level:4,name:"SpÃ©cialiste",title:"SpÃ©cialiste du RÃ©seau",minXP:300},
{level:5,name:"Expert",title:"Expert en Navigation",minXP:500},
{level:6,name:"MaÃ®tre",title:"MaÃ®tre Cartographe",minXP:750},
{level:7,name:"VÃ©tÃ©ran",title:"VÃ©tÃ©ran de l'Agence",minXP:1000},
{level:8,name:"LÃ©gende",title:"LÃ©gende Vivante",minXP:1500}
];

// FLASHCARDS from CSV
const FLASHCARDS_RAW = `Selon le texte, comment la ludification du parcours de soin transforme-t-elle le rÃ´le de l'usager ?|Elle le fait passer d'un rÃ´le passif Ã  un rÃ´le d'acteur engagÃ©.
Quel type de dispositif innovant est mentionnÃ© comme exemple de ludification du parcours de soin ?|Les ARG (Alternate Reality Games).
Quel concept est utilisÃ© pour rendre le parcours de soin moins clinique ?|Le "RÃ©alisme Magique".
Quel est le paradoxe majeur de l'Ã©cosystÃ¨me de la santÃ© mentale en RÃ©gion de Bruxelles-Capitale ?|Il est Ã  la fois d'une densitÃ© exceptionnelle mais sa fragmentation le rend difficilement navigable.
Combien de personnes en Belgique sont maintenues dans une inactivitÃ© contrainte par le systÃ¨me ?|978 000 personnes.
Quel est le coÃ»t sociÃ©tal direct annuel estimÃ© de l'inactivitÃ© contrainte en Belgique ?|Entre 21 et 24 milliards d'euros.
DÃ©finition : Le PiÃ¨ge Institutionnel|Un mÃ©canisme oÃ¹ le systÃ¨me pÃ©nalise activement toute tentative de contribution d'une personne hors emploi.
Quel est le nom du dispositif proposÃ© pour contrer la fragmentation ?|L'Agence de Renseignement Citoyenne.
Quel numÃ©ro d'appel gratuit est disponible 24h/24 pour toute difficultÃ© morale ?|TÃ©lÃ©-Accueil (107).
Quel est le coÃ»t de la premiÃ¨re consultation PsyBru ?|Elle est gratuite.
Pour les +24 ans, quel est le coÃ»t d'une sÃ©ance PsyBru aprÃ¨s la premiÃ¨re ?|11 â‚¬.
Quelle Ã©quipe mobile intervient pour les +65 ans en dÃ©tresse ?|L'Ã©quipe mobile Caligo.
Quels sont les 4 bÃ©nÃ©fices du projet Agence ?|Rompre l'isolement, dÃ©velopper compÃ©tences, restaurer pouvoir d'agir, valoriser expertise du vÃ©cu.
Quel est le budget demandÃ© pour la phase pilote de 12 mois ?|24 000 euros.
Le coÃ»t de l'inaction est estimÃ© Ã  un million d'euros par...|heure
Que sont les "Lieux de Liens" ?|Des points d'ancrage physiques oÃ¹ la ludification se dÃ©ploie.
Quel service est dÃ©diÃ© aux Ã©tudiants de l'enseignement supÃ©rieur ?|Le service PsyCampus (ULB).
Les MADO proposent un accueil pour les jeunes de quel Ã¢ge ?|11 Ã  25 ans.
Quel article de l'INAMI concerne les rÃ¨gles de la reprise de travail adaptÃ© ?|L'article 100.`;

FLASHCARDS_RAW.split('\n').forEach((line, i) => {
  const [q, a] = line.split('|');
  if (q && a) DATA.flashcards.push({id: 'FC-' + (i+1), question: q.trim(), answer: a.trim()});
});

// CONTACTS from Excel
const CONTACTS_RAW = [
["Info Libertaire","https://www.infolibertaire.net","MÃ©dia militant","France","",""],
["Rebellyon","https://rebellyon.info","MÃ©dia militant","Lyon","",""],
["Paris Luttes","https://paris-luttes.info","MÃ©dia militant","Paris","",""],
["CQFD","https://www.cqfd-journal.org","Revue","France","",""],
["L'EnvolÃ©e","https://www.lenvolee.net","MÃ©dia militant","Anti-prison","","Actif"],
["UCL","https://www.unioncommunistelibertaire.org","Organisation","France","","Actif"],
["Kedistan","https://kedistan.net","MÃ©dia militant","Kurdistan","","Actif"],
["Lundi Matin","https://lundi.am","MÃ©dia militant","France","",""],
["Contre Attaque","https://www.contre-attaque.net","MÃ©dia militant","France","","Actif"],
["Reporterre","https://reporterre.net","Ã‰cologie","France","",""],
["Divergences","https://divergences.be","MÃ©dia militant","Belgique","",""],
["Radio Panik","https://www.radiopanik.org","Radio","Belgique","",""],
["Stuut","https://stuut.info","MÃ©dia militant","Belgique","",""],
["Getting The Voice Out","https://gettingthevoiceout.org","Anti-rÃ©pression","Belgique","",""],
["LDH France","https://www.ldh-france.org","Droits humains","France","","Actif"],
["ZAD Infos","https://www.zad.nadir.org","Squats/ZAD","France","","Actif"],
["SoulÃ¨vements de la Terre","https://www.lesoulevementsdelaterre.org","Ã‰cologie","France","",""]
];

CONTACTS_RAW.forEach((c, i) => {
  DATA.contacts.push({id: 'CON-' + (i+1), name: c[0], web: c[1], type: c[2], zone: c[3], email: c[4] || '', status: c[5] || ''});
});

// ========== STATE ==========
let currentModule = 'dashboard';
let flashIndex = 0;
let studyFlashIndex = 0;
let studyFlashOrder = [];

// ========== DOM ==========
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

// ========== TOAST ==========
let toastT;
function toast(msg) {
  clearTimeout(toastT);
  $('toast').textContent = msg;
  $('toast').classList.add('show');
  toastT = setTimeout(() => $('toast').classList.remove('show'), 3000);
}

// ========== NAVIGATION ==========
function switchModule(mod) {
  currentModule = mod;
  $$('.module').forEach(m => m.classList.remove('active'));
  $('mod-' + mod)?.classList.add('active');
  $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.module === mod));
  
  // Update PWA status when viewing settings
  if (mod === 'settings' && typeof updatePWAStatusUI === 'function') {
    setTimeout(updatePWAStatusUI, 100);
  }
}

// ========== RENDER ==========
function render() {
  // Stats
  $('statLieux').textContent = DATA.lieux.length;
  $('statSSM').textContent = DATA.ssm.length;
  $('statContacts').textContent = DATA.contacts.length;
  $('statFlash').textContent = DATA.flashcards.length;
  
  // Nav badges
  $('navLieuxCount').textContent = DATA.lieux.length;
  $('navSsmCount').textContent = DATA.ssm.length;
  $('navUrgCount').textContent = DATA.urgences.length;
  $('navFlashCount').textContent = DATA.flashcards.length;
  $('navContactCount').textContent = DATA.contacts.length;
  
  // Graph links count
  if ($('graphLinksCount')) $('graphLinksCount').textContent = DATA.links.length + ' liens';
  
  // Storage stats
  if ($('storageStatLieux')) $('storageStatLieux').textContent = DATA.lieux.length;
  if ($('storageStatLinks')) $('storageStatLinks').textContent = DATA.links.length;
  if ($('storageStatFlash')) $('storageStatFlash').textContent = DATA.flashcards.length;
  if ($('storageStatContacts')) $('storageStatContacts').textContent = DATA.contacts.length;
  
  // Lieux table with edit/delete
  const lieuxBody = $('tableLieux').querySelector('tbody');
  lieuxBody.innerHTML = DATA.lieux.map(l => `
    <tr>
      <td><strong>${esc(l.name)}</strong><br><small style="color:var(--muted)">${esc(l.summary || '')}</small></td>
      <td>${esc(l.commune)}</td>
      <td>${l.tel ? `<a href="tel:${l.tel}" style="color:var(--liens)">${esc(l.tel)}</a>` : '-'}</td>
      <td>${l.status === 'at_risk' ? '<span class="tag urgence">âš ï¸ ALERTE</span>' : l.status === 'closed' ? '<span class="tag">FermÃ©</span>' : '<span class="tag liens">OK</span>'}</td>
      <td style="white-space:nowrap">
        <button class="btn" onclick="openDetail('${l.id}')" title="Voir">ğŸ‘ï¸</button>
        <button class="btn" onclick="openLieuModal('${l.id}')" title="Modifier">âœï¸</button>
      </td>
    </tr>
  `).join('');
  $('lieuxTotal').textContent = DATA.lieux.length + ' lieux';
  
  // SSM table
  const ssmBody = $('tableSSM').querySelector('tbody');
  ssmBody.innerHTML = DATA.ssm.map(s => `
    <tr>
      <td><strong>${esc(s.name)}</strong><br><small style="color:var(--muted)">${esc(s.summary || '')}</small></td>
      <td><span class="tag ${s.type === 'SSM' ? 'ssm' : s.type === 'Coordination' ? 'info' : 'mobile'}">${esc(s.type)}</span></td>
      <td>${s.tel ? `<a href="tel:${s.tel}" style="color:var(--liens)">${esc(s.tel)}</a>` : '-'}</td>
      <td><button class="btn" onclick="openSSMDetail('${s.id}')">Voir</button></td>
    </tr>
  `).join('');
  $('ssmTotal').textContent = DATA.ssm.length + ' services';
  
  // Urgences grid
  $('urgencesList').innerHTML = DATA.urgences.map(u => `
    <div class="card">
      <div class="card-header"><span class="card-title" style="color:var(--${u.color})">${esc(u.name)}</span></div>
      <div class="card-body">
        ${u.numero ? `<div style="font-size:28px;font-weight:700;font-family:var(--mono);color:var(--${u.color});margin-bottom:8px">${esc(u.numero)}</div>` : ''}
        <p style="color:var(--text2)">${esc(u.desc)}</p>
        ${u.numero ? `<a href="tel:${u.numero.replace(/\s/g,'')}" class="btn primary" style="margin-top:12px">ğŸ“ Appeler</a>` : ''}
      </div>
    </div>
  `).join('');
  
  // Flashcards
  $('flashTotal').textContent = DATA.flashcards.length + ' cartes';
  renderFlashcard();
  renderStudyFlashcard();
  
  // Flashcards table with edit/delete buttons
  const flashBody = $('tableFlash').querySelector('tbody');
  flashBody.innerHTML = DATA.flashcards.map(f => `
    <tr>
      <td>${esc(f.question)}</td>
      <td style="color:var(--text2)">${esc(f.answer)}</td>
      <td>
        <button class="btn" onclick="openFlashModal('${f.id}')" title="Modifier">âœï¸</button>
        <button class="btn danger" onclick="deleteFlashcard('${f.id}')" title="Supprimer">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
  
  // Contacts
  $('contactTotal').textContent = DATA.contacts.length + ' contacts';
  renderContacts();
  
  // Populate filters
  const communes = [...new Set(DATA.lieux.map(l => l.commune))].sort();
  $('filterCommune').innerHTML = '<option value="">Toutes communes</option>' + communes.map(c => `<option value="${c}">${c}</option>`).join('');
  
  const types = [...new Set(DATA.contacts.map(c => c.type))].sort();
  $('filterType').innerHTML = '<option value="">Tous types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
}

function renderContacts() {
  const search = $('searchContacts').value.toLowerCase();
  const type = $('filterType').value;
  const status = $('filterStatus').value;
  
  const filtered = DATA.contacts.filter(c => {
    if (search && !`${c.name} ${c.type} ${c.zone}`.toLowerCase().includes(search)) return false;
    if (type && c.type !== type) return false;
    if (status && c.status !== status) return false;
    return true;
  });
  
  const body = $('tableContacts').querySelector('tbody');
  body.innerHTML = filtered.map(c => `
    <tr>
      <td><strong>${esc(c.name)}</strong>${c.notes ? `<br><small style="color:var(--muted)">${esc(c.notes)}</small>` : ''}</td>
      <td><span class="tag">${esc(c.type || '-')}</span></td>
      <td>${esc(c.zone || '-')}</td>
      <td>${c.web ? `<a href="${c.web.startsWith('http') ? c.web : 'https://'+c.web}" target="_blank" style="color:var(--liens)">${esc(c.web.replace('https://','').replace('http://',''))}</a>` : '-'}</td>
      <td>${c.status === 'Actif' ? '<span class="tag liens">Actif</span>' : c.status === 'Inaccessible' ? '<span class="tag urgence">Inactif</span>' : '-'}</td>
      <td style="white-space:nowrap">
        <button class="btn" onclick="openContactModal('${c.id}')" title="Modifier">âœï¸</button>
        <button class="btn danger" onclick="deleteContact('${c.id}')" title="Supprimer">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
}

// ========== FLASHCARDS ==========
function renderFlashcard() {
  if (DATA.flashcards.length === 0) return;
  const f = DATA.flashcards[flashIndex];
  $('dashFlashQ').textContent = f.question;
  $('dashFlashA').textContent = f.answer;
  $('flashCounter').textContent = `${flashIndex + 1} / ${DATA.flashcards.length}`;
  $('flashProgress').textContent = `${flashIndex + 1}/${DATA.flashcards.length}`;
  $('dashFlashcard').classList.remove('flipped');
}

function prevFlash() {
  flashIndex = (flashIndex - 1 + DATA.flashcards.length) % DATA.flashcards.length;
  renderFlashcard();
}

function nextFlash() {
  flashIndex = (flashIndex + 1) % DATA.flashcards.length;
  renderFlashcard();
}

function initStudyOrder() {
  studyFlashOrder = DATA.flashcards.map((_, i) => i);
  studyFlashIndex = 0;
}

function renderStudyFlashcard() {
  if (DATA.flashcards.length === 0) return;
  if (studyFlashOrder.length === 0) initStudyOrder();
  const idx = studyFlashOrder[studyFlashIndex];
  const f = DATA.flashcards[idx];
  $('studyQ').textContent = f.question;
  $('studyA').textContent = f.answer;
  $('studyCounter').textContent = `${studyFlashIndex + 1} / ${DATA.flashcards.length}`;
  $('flashStudyProgress').textContent = `${studyFlashIndex + 1}/${DATA.flashcards.length}`;
  $('flashProgressBar').style.width = `${((studyFlashIndex + 1) / DATA.flashcards.length) * 100}%`;
  $('studyFlashcard').classList.remove('flipped');
}

function prevStudyFlash() {
  studyFlashIndex = (studyFlashIndex - 1 + studyFlashOrder.length) % studyFlashOrder.length;
  renderStudyFlashcard();
}

function nextStudyFlash() {
  studyFlashIndex = (studyFlashIndex + 1) % studyFlashOrder.length;
  renderStudyFlashcard();
}

function shuffleFlash() {
  for (let i = studyFlashOrder.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [studyFlashOrder[i], studyFlashOrder[j]] = [studyFlashOrder[j], studyFlashOrder[i]];
  }
  studyFlashIndex = 0;
  renderStudyFlashcard();
  toast('ğŸ”€ Cartes mÃ©langÃ©es');
}

// ========== DETAIL PANEL ==========
function openDetail(id) {
  const lieu = DATA.lieux.find(l => l.id === id);
  if (!lieu) return;
  
  // Track fiche view for gamification
  recordFicheView(id);
  
  $('detailTitle').textContent = lieu.name;
  $('detailBody').innerHTML = `
    ${lieu.status === 'at_risk' ? '<div style="padding:12px;background:rgba(255,107,138,.15);border:1px solid rgba(255,107,138,.3);border-radius:8px;margin-bottom:16px;color:var(--urgence);font-weight:600">âš ï¸ MENACÃ‰ DE FERMETURE EN 2025</div>' : ''}
    <div class="detail-section">
      <div class="detail-section-title">Informations</div>
      <div class="detail-row"><span class="detail-key">Commune</span><span class="detail-value">${esc(lieu.commune)} (${lieu.cp})</span></div>
      <div class="detail-row"><span class="detail-key">Adresse</span><span class="detail-value">${esc(lieu.adresse)}</span></div>
      ${lieu.tel ? `<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:${lieu.tel}">${esc(lieu.tel)}</a></span></div>` : ''}
      ${lieu.email ? `<div class="detail-row"><span class="detail-key">Email</span><span class="detail-value"><a href="mailto:${lieu.email}">${esc(lieu.email)}</a></span></div>` : ''}
      ${lieu.web ? `<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://${lieu.web}" target="_blank">${esc(lieu.web)}</a></span></div>` : ''}
      ${lieu.horaires ? `<div class="detail-row"><span class="detail-key">Horaires</span><span class="detail-value">${esc(lieu.horaires)}</span></div>` : ''}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Description</div>
      <p style="color:var(--text2)">${esc(lieu.summary || 'Pas de description')}</p>
    </div>
    ${lieu.tags && lieu.tags.length ? `<div class="detail-section"><div class="detail-section-title">Tags</div><div style="display:flex;flex-wrap:wrap;gap:6px">${lieu.tags.map(t => `<span class="tag">${esc(t)}</span>`).join('')}</div></div>` : ''}
    <div class="detail-section">
      <div class="detail-section-title">Liens</div>
      <div id="detailLinks" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:24px">
      <button class="btn" onclick="closeDetail();openLieuModal('${lieu.id}')">âœï¸ Modifier</button>
      <button class="btn" onclick="openNotesModal('${lieu.id}')">ğŸ“ Notes</button>
      ${lieu.tel ? `<a href="tel:${lieu.tel}" class="btn primary">ğŸ“ Appeler</a>` : ''}
      ${lieu.web ? `<a href="https://${lieu.web}" target="_blank" class="btn">ğŸŒ Site web</a>` : ''}
    </div>
  `;
  
  // Show links for this entity
  const links = DATA.links.filter(l => l.from === id || l.to === id);
  const linksHtml = links.map(l => {
    const otherId = l.from === id ? l.to : l.from;
    const other = [...DATA.lieux, ...DATA.ssm, ...DATA.reseaux].find(e => e.id === otherId);
    return other ? `<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--elevated);border-radius:6px">
      <span style="color:var(--liens)">${l.type}</span>
      <span style="flex:1">${esc(other.name)}</span>
      <button class="btn" style="height:28px;padding:0 8px;font-size:11px" onclick="deleteLink('${l.from}','${l.to}')">âœ•</button>
    </div>` : '';
  }).join('');
  $('detailLinks').innerHTML = linksHtml || '<span style="color:var(--muted)">Aucun lien</span>';
  
  // Show notes count
  const notesCount = DATA.notes.filter(n => n.entityId === id).length;
  if (notesCount > 0) {
    $('detailLinks').innerHTML += `<div style="margin-top:12px;color:var(--muted);font-size:12px">ğŸ“ ${notesCount} note(s)</div>`;
  }
  
  $('backdrop').classList.add('show');
  $('detailPanel').classList.add('open');
}

function openSSMDetail(id) {
  const s = DATA.ssm.find(x => x.id === id);
  if (!s) return;
  
  // Track fiche view for gamification
  recordFicheView(id);
  
  $('detailTitle').textContent = s.name;
  $('detailBody').innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Informations</div>
      <div class="detail-row"><span class="detail-key">Type</span><span class="detail-value"><span class="tag ${s.type === 'SSM' ? 'ssm' : s.type === 'Coordination' ? 'info' : 'mobile'}">${esc(s.type)}</span></span></div>
      ${s.adresse ? `<div class="detail-row"><span class="detail-key">Adresse</span><span class="detail-value">${esc(s.adresse)}</span></div>` : ''}
      ${s.tel ? `<div class="detail-row"><span class="detail-key">TÃ©lÃ©phone</span><span class="detail-value"><a href="tel:${s.tel}">${esc(s.tel)}</a></span></div>` : ''}
      ${s.web ? `<div class="detail-row"><span class="detail-key">Site</span><span class="detail-value"><a href="https://${s.web}" target="_blank">${esc(s.web)}</a></span></div>` : ''}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Description</div>
      <p style="color:var(--text2)">${esc(s.summary || 'Pas de description')}</p>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:24px">
      <button class="btn" onclick="openNotesModal('${s.id}')">ğŸ“ Notes</button>
      ${s.tel ? `<a href="tel:${s.tel}" class="btn primary">ğŸ“ Appeler</a>` : ''}
      ${s.web ? `<a href="https://${s.web}" target="_blank" class="btn">ğŸŒ Site web</a>` : ''}
    </div>
  `;
  
  $('backdrop').classList.add('show');
  $('detailPanel').classList.add('open');
}

function closeDetail() {
  $('backdrop').classList.remove('show');
  $('detailPanel').classList.remove('open');
}

// ========== IMPORT/EXPORT ==========
function exportData() {
  const exportData = {
    _meta: { format: 'nyxo-v2', exportedAt: new Date().toISOString(), version: '2.0.0' },
    lieux: DATA.lieux,
    ssm: DATA.ssm,
    contacts: DATA.contacts,
    flashcards: DATA.flashcards,
    links: DATA.links,
    missions: DATA.missions,
    notes: DATA.notes,
    reseaux: DATA.reseaux,
    profil: DATA.profil
  };
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Export JSON rÃ©ussi');
}

// Export JSON-LD (Web SÃ©mantique)
function exportJSONLD() {
  const jsonld = {
    "@context": {
      "@vocab": "https://schema.org/",
      "nyxo": "https://nyxo.brussels/ontology/",
      "xsd": "http://www.w3.org/2001/XMLSchema#"
    },
    "@id": "https://nyxo.brussels/graph",
    "@type": "Dataset",
    "name": "NYXO Brussels Knowledge Graph",
    "description": "Infrastructure citoyenne pour la santÃ© mentale - Bruxelles",
    "license": "https://creativecommons.org/licenses/by-sa/4.0/",
    "dateModified": new Date().toISOString(),
    "spatialCoverage": {
      "@type": "Place",
      "name": "RÃ©gion de Bruxelles-Capitale",
      "geo": { "@type": "GeoCoordinates", "latitude": 50.8503, "longitude": 4.3517 }
    },
    "@graph": [
      ...DATA.lieux.map(l => ({
        "@id": `nyxo:lieu/${l.id}`,
        "@type": ["Place", "nyxo:LieuDeLiens"],
        "name": l.name,
        "description": l.summary || "",
        "address": {
          "@type": "PostalAddress",
          "streetAddress": l.adresse || "",
          "postalCode": l.cp || "",
          "addressLocality": l.commune || "",
          "addressRegion": "Bruxelles-Capitale",
          "addressCountry": "BE"
        },
        "telephone": l.tel || null,
        "email": l.email || null,
        "url": l.web ? (l.web.startsWith('http') ? l.web : `https://${l.web}`) : null,
        "geo": (l.lat && l.lng) ? { "@type": "GeoCoordinates", "latitude": l.lat, "longitude": l.lng } : null,
        "nyxo:status": l.status || "ok",
        "nyxo:tags": l.tags || [],
        "openingHours": l.horaires || null
      })),
      ...DATA.ssm.map(s => ({
        "@id": `nyxo:service/${s.id}`,
        "@type": ["MedicalOrganization", `nyxo:${s.type.replace(/\s+/g, '')}`],
        "name": s.name,
        "description": s.summary || "",
        "address": s.adresse ? { "@type": "PostalAddress", "streetAddress": s.adresse } : null,
        "telephone": s.tel || null,
        "url": s.web ? (s.web.startsWith('http') ? s.web : `https://${s.web}`) : null,
        "nyxo:serviceType": s.type
      })),
      ...DATA.reseaux.map(r => ({
        "@id": `nyxo:reseau/${r.id}`,
        "@type": ["Organization", "nyxo:Reseau107"],
        "name": r.name,
        "areaServed": r.communes,
        "nyxo:zone": r.zone,
        "telephone": r.tel || null,
        "url": r.web ? `https://${r.web}` : null
      })),
      ...DATA.contacts.map(c => ({
        "@id": `nyxo:contact/${c.id}`,
        "@type": "Organization",
        "name": c.name,
        "nyxo:contactType": c.type || "",
        "areaServed": c.zone || "",
        "url": c.web || null,
        "email": c.email || null
      }))
    ],
    "nyxo:relations": DATA.links.map(l => ({
      "@type": "nyxo:Relation",
      "nyxo:from": `nyxo:${l.from.startsWith('LDL') ? 'lieu' : l.from.startsWith('R107') ? 'reseau' : 'service'}/${l.from}`,
      "nyxo:to": `nyxo:${l.to.startsWith('LDL') ? 'lieu' : l.to.startsWith('R107') ? 'reseau' : 'service'}/${l.to}`,
      "nyxo:relationType": l.type,
      "name": l.label || l.type
    }))
  };
  
  const blob = new Blob([JSON.stringify(jsonld, null, 2)], {type: 'application/ld+json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-jsonld-${new Date().toISOString().split('T')[0]}.jsonld`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Export JSON-LD rÃ©ussi');
}

// ========== FHIR R4 EXPORT ==========
// Mapping NYXO -> FHIR R4 Resources
// Standard HL7 FHIR pour l'interopÃ©rabilitÃ© santÃ© (EHDS, eHealth Belgium)

function exportFHIR() {
  const bundle = {
    resourceType: "Bundle",
    id: "nyxo-brussels-" + Date.now(),
    meta: {
      lastUpdated: new Date().toISOString(),
      profile: ["http://hl7.org/fhir/StructureDefinition/Bundle"]
    },
    type: "collection",
    timestamp: new Date().toISOString(),
    identifier: {
      system: "https://nyxo.brussels/fhir",
      value: "nyxo-export-" + new Date().toISOString().split('T')[0]
    },
    entry: []
  };

  // Lieux de Liens -> FHIR Location + HealthcareService
  DATA.lieux.forEach((l, idx) => {
    // Location Resource
    const location = {
      resourceType: "Location",
      id: l.id || "loc-" + idx,
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/Location"],
        tag: [
          { system: "https://nyxo.brussels/tags", code: "lieu-de-liens" },
          ...(l.tags || []).map(t => ({ system: "https://nyxo.brussels/tags", code: t }))
        ]
      },
      identifier: [{
        system: "https://nyxo.brussels/locations",
        value: l.id
      }],
      status: l.status === 'at_risk' ? 'suspended' : 'active',
      name: l.name,
      description: l.summary || null,
      mode: "instance",
      type: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "CSC",
          display: "Community Service Center"
        }],
        text: "Lieu de Liens - CohÃ©sion Sociale"
      }],
      telecom: [
        l.tel ? { system: "phone", value: l.tel, use: "work" } : null,
        l.email ? { system: "email", value: l.email, use: "work" } : null,
        l.web ? { system: "url", value: l.web.startsWith('http') ? l.web : 'https://' + l.web, use: "work" } : null
      ].filter(Boolean),
      address: {
        use: "work",
        type: "physical",
        text: [l.adresse, l.cp, l.commune].filter(Boolean).join(', '),
        line: l.adresse ? [l.adresse] : [],
        city: l.commune || "Bruxelles",
        postalCode: l.cp || null,
        country: "BE"
      },
      position: (l.lat && l.lng) ? {
        longitude: parseFloat(l.lng),
        latitude: parseFloat(l.lat)
      } : null,
      hoursOfOperation: l.horaires ? [{
        daysOfWeek: ["mon", "tue", "wed", "thu", "fri"],
        allDay: false,
        comment: l.horaires
      }] : null,
      extension: [
        {
          url: "https://nyxo.brussels/fhir/StructureDefinition/risk-status",
          valueCode: l.status || "ok"
        }
      ]
    };
    
    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/Location/" + location.id,
      resource: location
    });

    // HealthcareService for each Lieu
    const service = {
      resourceType: "HealthcareService",
      id: "svc-" + (l.id || idx),
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/HealthcareService"]
      },
      identifier: [{
        system: "https://nyxo.brussels/services",
        value: "svc-" + l.id
      }],
      active: l.status !== 'at_risk',
      location: [{ reference: "Location/" + location.id }],
      name: l.name,
      comment: l.summary || "Lieu de Liens - Espace de cohÃ©sion sociale",
      category: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/service-category",
          code: "8",
          display: "Counselling"
        }],
        text: "SantÃ© Mentale Communautaire"
      }],
      type: [{
        coding: [{
          system: "http://snomed.info/sct",
          code: "310027005",
          display: "Community mental health service"
        }],
        text: "Service de santÃ© mentale communautaire"
      }],
      serviceProvisionCode: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/service-provision-conditions",
          code: "free",
          display: "Free"
        }]
      }],
      eligibility: [{
        code: {
          coding: [{
            system: "https://nyxo.brussels/eligibility",
            code: "open",
            display: "Ouvert Ã  tous"
          }]
        },
        comment: "Accessible sans conditions particuliÃ¨res"
      }],
      availableTime: l.horaires ? [{
        daysOfWeek: ["mon", "tue", "wed", "thu", "fri"],
        allDay: false,
        comment: l.horaires
      }] : null
    };
    
    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/HealthcareService/" + service.id,
      resource: service
    });
  });

  // SSM -> FHIR Organization
  DATA.ssm.forEach((s, idx) => {
    const org = {
      resourceType: "Organization",
      id: s.id || "org-ssm-" + idx,
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/Organization"],
        tag: [
          { system: "https://nyxo.brussels/tags", code: "ssm" },
          { system: "https://nyxo.brussels/tags", code: s.type?.toLowerCase().replace(/\s+/g, '-') || "service" }
        ]
      },
      identifier: [
        {
          system: "https://nyxo.brussels/organizations",
          value: s.id
        },
        {
          system: "https://www.ehealth.fgov.be/standards/fhir/NamingSystem/nihdi",
          value: s.nihdi || null // INAMI number if available
        }
      ].filter(i => i.value),
      active: true,
      type: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/organization-type",
          code: "prov",
          display: "Healthcare Provider"
        }],
        text: s.type || "Service de SantÃ© Mentale"
      }],
      name: s.name,
      telecom: [
        s.tel ? { system: "phone", value: s.tel, use: "work" } : null,
        s.web ? { system: "url", value: s.web.startsWith('http') ? s.web : 'https://' + s.web, use: "work" } : null
      ].filter(Boolean),
      address: s.adresse ? [{
        use: "work",
        type: "physical",
        text: s.adresse,
        line: [s.adresse],
        city: s.commune || "Bruxelles",
        country: "BE"
      }] : null,
      extension: [
        {
          url: "https://nyxo.brussels/fhir/StructureDefinition/service-type",
          valueString: s.type || "SSM"
        }
      ]
    };

    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/Organization/" + org.id,
      resource: org
    });

    // Add HealthcareService for SSM
    if (s.type === 'Ã‰quipe mobile') {
      const mobileService = {
        resourceType: "HealthcareService",
        id: "svc-mobile-" + (s.id || idx),
        meta: {
          profile: ["http://hl7.org/fhir/StructureDefinition/HealthcareService"]
        },
        active: true,
        providedBy: { reference: "Organization/" + org.id },
        category: [{
          coding: [{
            system: "http://terminology.hl7.org/CodeSystem/service-category",
            code: "8",
            display: "Counselling"
          }]
        }],
        type: [{
          coding: [{
            system: "http://snomed.info/sct",
            code: "4525004",
            display: "Emergency department patient visit"
          }],
          text: "Ã‰quipe Mobile de Crise"
        }],
        name: s.name,
        comment: "Intervention mobile en santÃ© mentale"
      };

      bundle.entry.push({
        fullUrl: "https://nyxo.brussels/fhir/HealthcareService/" + mobileService.id,
        resource: mobileService
      });
    }
  });

  // RÃ©seaux 107 -> FHIR Organization (network type)
  (DATA.reseaux || []).forEach((r, idx) => {
    const network = {
      resourceType: "Organization",
      id: r.id || "org-107-" + idx,
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/Organization"],
        tag: [{ system: "https://nyxo.brussels/tags", code: "reseau-107" }]
      },
      identifier: [{
        system: "https://nyxo.brussels/networks",
        value: r.id
      }],
      active: true,
      type: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/organization-type",
          code: "govt",
          display: "Government"
        }],
        text: "RÃ©seau 107 - Coordination SantÃ© Mentale"
      }],
      name: r.name,
      telecom: [
        r.tel ? { system: "phone", value: r.tel, use: "work" } : null,
        r.web ? { system: "url", value: 'https://' + r.web, use: "work" } : null
      ].filter(Boolean),
      extension: [
        {
          url: "https://nyxo.brussels/fhir/StructureDefinition/coverage-area",
          valueString: r.zone || ""
        },
        {
          url: "https://nyxo.brussels/fhir/StructureDefinition/communes-served",
          valueString: (r.communes || []).join(', ')
        }
      ]
    };

    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/Organization/" + network.id,
      resource: network
    });
  });

  // Links -> FHIR OrganizationAffiliation
  DATA.links.forEach((link, idx) => {
    const affiliation = {
      resourceType: "OrganizationAffiliation",
      id: "aff-" + idx,
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/OrganizationAffiliation"]
      },
      active: true,
      organization: {
        reference: resolveReference(link.from),
        display: link.from
      },
      participatingOrganization: {
        reference: resolveReference(link.to),
        display: link.to
      },
      code: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/organization-role",
          code: "partner",
          display: "Partner"
        }],
        text: link.type || "Partenariat"
      }],
      extension: [{
        url: "https://nyxo.brussels/fhir/StructureDefinition/relation-type",
        valueString: link.type || "connection"
      }]
    };

    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/OrganizationAffiliation/" + affiliation.id,
      resource: affiliation
    });
  });

  // Contacts -> FHIR Organization (other type)
  DATA.contacts.forEach((c, idx) => {
    const contact = {
      resourceType: "Organization",
      id: c.id || "org-contact-" + idx,
      meta: {
        profile: ["http://hl7.org/fhir/StructureDefinition/Organization"],
        tag: [{ system: "https://nyxo.brussels/tags", code: "contact" }]
      },
      identifier: [{
        system: "https://nyxo.brussels/contacts",
        value: c.id
      }],
      active: c.status !== 'inactive',
      type: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/organization-type",
          code: "other",
          display: "Other"
        }],
        text: c.type || "Contact"
      }],
      name: c.name,
      telecom: [
        c.email ? { system: "email", value: c.email, use: "work" } : null,
        c.web ? { system: "url", value: c.web.startsWith('http') ? c.web : 'https://' + c.web, use: "work" } : null
      ].filter(Boolean)
    };

    bundle.entry.push({
      fullUrl: "https://nyxo.brussels/fhir/Organization/" + contact.id,
      resource: contact
    });
  });

  // Helper function to resolve references
  function resolveReference(id) {
    if (id.startsWith('LDL')) return "Location/" + id;
    if (id.startsWith('SSM')) return "Organization/" + id;
    if (id.startsWith('R107')) return "Organization/" + id;
    return "Organization/" + id;
  }

  // Add bundle total
  bundle.total = bundle.entry.length;

  // Download
  const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/fhir+json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-fhir-r4-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export FHIR R4: ${bundle.entry.length} ressources`);
  addJournalEntry(`ğŸ“¤ Export FHIR R4: ${bundle.entry.length} ressources`);
}

// ========== GeoJSON EXPORT ==========
function exportGeoJSON() {
  const features = [];

  // Lieux as points
  DATA.lieux.forEach(l => {
    if (l.lat && l.lng) {
      features.push({
        type: "Feature",
        id: l.id,
        geometry: {
          type: "Point",
          coordinates: [parseFloat(l.lng), parseFloat(l.lat)]
        },
        properties: {
          id: l.id,
          name: l.name,
          type: "lieu-de-liens",
          commune: l.commune,
          adresse: l.adresse,
          tel: l.tel,
          web: l.web,
          status: l.status,
          tags: l.tags,
          "marker-color": l.status === 'at_risk' ? "#ff6b8a" : "#7df9c8",
          "marker-symbol": "town-hall"
        }
      });
    }
  });

  // SSM as points
  DATA.ssm.forEach(s => {
    if (s.lat && s.lng) {
      features.push({
        type: "Feature",
        id: s.id,
        geometry: {
          type: "Point",
          coordinates: [parseFloat(s.lng), parseFloat(s.lat)]
        },
        properties: {
          id: s.id,
          name: s.name,
          type: "ssm",
          serviceType: s.type,
          adresse: s.adresse,
          tel: s.tel,
          web: s.web,
          "marker-color": s.type === 'Ã‰quipe mobile' ? "#ffb86c" : "#c9a0ff",
          "marker-symbol": "hospital"
        }
      });
    }
  });

  const geojson = {
    type: "FeatureCollection",
    name: "NYXO Brussels",
    crs: {
      type: "name",
      properties: { name: "urn:ogc:def:crs:OGC:1.3:CRS84" }
    },
    features: features
  };

  const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/geo+json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-geojson-${new Date().toISOString().split('T')[0]}.geojson`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export GeoJSON: ${features.length} points`);
}

// ========== RDF/TURTLE EXPORT ==========
function exportRDF() {
  let turtle = `@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix schema: <http://schema.org/> .
@prefix geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix dct: <http://purl.org/dc/terms/> .
@prefix nyxo: <https://nyxo.brussels/ontology#> .
@prefix fhir: <http://hl7.org/fhir/> .

# NYXO Brussels Knowledge Graph
# Exported: ${new Date().toISOString()}
# License: CC BY-SA 4.0

<https://nyxo.brussels/graph> a schema:Dataset ;
    dct:title "NYXO Brussels Knowledge Graph" ;
    dct:description "Infrastructure citoyenne pour la santÃ© mentale - Bruxelles" ;
    dct:license <https://creativecommons.org/licenses/by-sa/4.0/> ;
    dct:modified "${new Date().toISOString()}"^^xsd:dateTime ;
    schema:spatialCoverage <https://nyxo.brussels/region/bruxelles-capitale> .

`;

  // Lieux
  DATA.lieux.forEach(l => {
    const uri = `<https://nyxo.brussels/lieu/${l.id}>`;
    turtle += `
${uri} a schema:Place, nyxo:LieuDeLiens ;
    rdfs:label "${escapeTurtle(l.name)}" ;
    schema:name "${escapeTurtle(l.name)}" ;
    nyxo:status "${l.status || 'ok'}" ;`;
    
    if (l.commune) turtle += `\n    schema:addressLocality "${escapeTurtle(l.commune)}" ;`;
    if (l.adresse) turtle += `\n    schema:streetAddress "${escapeTurtle(l.adresse)}" ;`;
    if (l.cp) turtle += `\n    schema:postalCode "${l.cp}" ;`;
    if (l.tel) turtle += `\n    schema:telephone "${l.tel}" ;`;
    if (l.web) turtle += `\n    schema:url <${l.web.startsWith('http') ? l.web : 'https://' + l.web}> ;`;
    if (l.lat && l.lng) {
      turtle += `\n    geo:lat "${l.lat}"^^xsd:decimal ;`;
      turtle += `\n    geo:long "${l.lng}"^^xsd:decimal ;`;
    }
    turtle = turtle.slice(0, -1) + ' .\n';
  });

  // SSM
  DATA.ssm.forEach(s => {
    const uri = `<https://nyxo.brussels/ssm/${s.id}>`;
    turtle += `
${uri} a schema:MedicalOrganization, nyxo:SSM ;
    rdfs:label "${escapeTurtle(s.name)}" ;
    schema:name "${escapeTurtle(s.name)}" ;
    nyxo:serviceType "${escapeTurtle(s.type || 'SSM')}" ;`;
    
    if (s.tel) turtle += `\n    schema:telephone "${s.tel}" ;`;
    if (s.web) turtle += `\n    schema:url <${s.web.startsWith('http') ? s.web : 'https://' + s.web}> ;`;
    turtle = turtle.slice(0, -1) + ' .\n';
  });

  // Links
  DATA.links.forEach((link, i) => {
    turtle += `
<https://nyxo.brussels/relation/${i}> a nyxo:Relation ;
    nyxo:from <https://nyxo.brussels/${link.from.startsWith('LDL') ? 'lieu' : 'ssm'}/${link.from}> ;
    nyxo:to <https://nyxo.brussels/${link.to.startsWith('LDL') ? 'lieu' : 'ssm'}/${link.to}> ;
    nyxo:relationType "${link.type || 'connection'}" .
`;
  });

  function escapeTurtle(str) {
    if (!str) return '';
    return String(str).replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
  }

  const blob = new Blob([turtle], { type: 'text/turtle' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-rdf-${new Date().toISOString().split('T')[0]}.ttl`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export RDF/Turtle rÃ©ussi`);
}

// ========== CKAN PACKAGE FORMAT ==========
// Compatible data.gov.be, ODWB (Open Data Wallonie-Bruxelles), VODAP
function exportCKAN() {
  const now = new Date().toISOString();
  
  const ckanPackage = {
    name: "nyxo-brussels-sante-mentale",
    title: "NYXO Brussels - Infrastructure SantÃ© Mentale Communautaire",
    notes: "Cartographie citoyenne des lieux de liens, services de santÃ© mentale, rÃ©seaux 107 et ressources de cohÃ©sion sociale en RÃ©gion de Bruxelles-Capitale. DonnÃ©es ouvertes sous licence CC BY-SA 4.0.",
    author: "NYXO Collective",
    author_email: "contact@nyxo.brussels",
    maintainer: "NYXO Collective",
    maintainer_email: "data@nyxo.brussels",
    license_id: "cc-by-sa",
    license_title: "Creative Commons Attribution Share-Alike",
    license_url: "https://creativecommons.org/licenses/by-sa/4.0/",
    url: "https://nyxo.brussels",
    version: "2.0.0",
    state: "active",
    type: "dataset",
    owner_org: "nyxo-brussels",
    private: false,
    metadata_created: now,
    metadata_modified: now,
    
    // DCAT-AP Extras
    extras: [
      { key: "dcat_type", value: "http://purl.org/dc/dcmitype/Dataset" },
      { key: "language", value: "fr,nl" },
      { key: "spatial", value: "RÃ©gion de Bruxelles-Capitale, Belgique" },
      { key: "spatial_uri", value: "http://publications.europa.eu/resource/authority/place/BEL_BRU" },
      { key: "theme", value: "http://publications.europa.eu/resource/authority/data-theme/HEAL" },
      { key: "theme_secondary", value: "http://publications.europa.eu/resource/authority/data-theme/SOCI" },
      { key: "frequency", value: "http://publications.europa.eu/resource/authority/frequency/MONTHLY" },
      { key: "contact_point", value: "https://nyxo.brussels/contact" },
      { key: "publisher_uri", value: "https://nyxo.brussels" },
      { key: "publisher_name", value: "NYXO Collective" },
      { key: "publisher_type", value: "http://purl.org/adms/publishertype/NonProfitOrganisation" },
      { key: "access_rights", value: "http://publications.europa.eu/resource/authority/access-right/PUBLIC" },
      { key: "conforms_to", value: "DCAT-AP 3.0, HealthDCAT-AP, FHIR R4" },
      { key: "hvd_category", value: "N/A" },
      { key: "applicable_legislation", value: "PSI Directive 2019/1024" }
    ],
    
    // Tags CKAN
    tags: [
      { name: "sante-mentale" },
      { name: "cohesion-sociale" },
      { name: "lieux-de-liens" },
      { name: "bruxelles" },
      { name: "ssm" },
      { name: "reseau-107" },
      { name: "fhir" },
      { name: "opendata" },
      { name: "civic-tech" }
    ],
    
    // Groupes thÃ©matiques
    groups: [
      { name: "health" },
      { name: "social" },
      { name: "brussels" }
    ],
    
    // Ressources (fichiers)
    resources: [
      {
        name: "Lieux de Liens (JSON)",
        description: "Liste des lieux de liens actifs en RÃ©gion bruxelloise",
        format: "JSON",
        mimetype: "application/json",
        url: "https://nyxo.brussels/data/lieux.json",
        resource_type: "file",
        size: DATA.lieux.length,
        created: now,
        last_modified: now
      },
      {
        name: "Services SantÃ© Mentale (JSON)",
        description: "SSM, Ã©quipes mobiles et services de santÃ© mentale",
        format: "JSON",
        mimetype: "application/json",
        url: "https://nyxo.brussels/data/ssm.json",
        resource_type: "file",
        size: DATA.ssm.length,
        created: now,
        last_modified: now
      },
      {
        name: "FHIR R4 Bundle",
        description: "Export complet au format HL7 FHIR R4 pour interopÃ©rabilitÃ© santÃ©",
        format: "FHIR+JSON",
        mimetype: "application/fhir+json",
        url: "https://nyxo.brussels/data/fhir-bundle.json",
        resource_type: "file",
        conforms_to: "http://hl7.org/fhir/StructureDefinition/Bundle",
        created: now,
        last_modified: now
      },
      {
        name: "GeoJSON",
        description: "DonnÃ©es gÃ©olocalisÃ©es pour cartographie",
        format: "GeoJSON",
        mimetype: "application/geo+json",
        url: "https://nyxo.brussels/data/nyxo.geojson",
        resource_type: "file",
        created: now,
        last_modified: now
      },
      {
        name: "RDF/Turtle",
        description: "Linked Data au format RDF Turtle",
        format: "RDF",
        mimetype: "text/turtle",
        url: "https://nyxo.brussels/data/nyxo.ttl",
        resource_type: "file",
        created: now,
        last_modified: now
      },
      {
        name: "DCAT-AP Catalog",
        description: "MÃ©tadonnÃ©es DCAT-AP pour portails open data europÃ©ens",
        format: "RDF",
        mimetype: "application/rdf+xml",
        url: "https://nyxo.brussels/data/dcat-ap.rdf",
        resource_type: "file",
        conforms_to: "https://semiceu.github.io/DCAT-AP/releases/3.0.0/",
        created: now,
        last_modified: now
      }
    ],
    
    // Statistiques
    num_resources: 6,
    num_tags: 9
  };

  const blob = new Blob([JSON.stringify(ckanPackage, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-ckan-package-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export CKAN Package rÃ©ussi`);
}

// ========== DCAT-AP 3.0 CATALOG (RDF/XML) ==========
// Standard europÃ©en pour data.europa.eu, data.gov.be, ODWB
function exportDCATAP() {
  const now = new Date().toISOString();
  const datasetId = 'nyxo-brussels-' + Date.now();
  
  const dcatap = `<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF 
  xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
  xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
  xmlns:dcat="http://www.w3.org/ns/dcat#"
  xmlns:dct="http://purl.org/dc/terms/"
  xmlns:foaf="http://xmlns.com/foaf/0.1/"
  xmlns:vcard="http://www.w3.org/2006/vcard/ns#"
  xmlns:adms="http://www.w3.org/ns/adms#"
  xmlns:skos="http://www.w3.org/2004/02/skos/core#"
  xmlns:schema="http://schema.org/"
  xmlns:locn="http://www.w3.org/ns/locn#"
  xmlns:gsp="http://www.opengis.net/ont/geosparql#"
  xmlns:prov="http://www.w3.org/ns/prov#">

  <!-- CATALOG -->
  <dcat:Catalog rdf:about="https://nyxo.brussels/catalog">
    <dct:title xml:lang="fr">NYXO Brussels - Catalogue Open Data SantÃ© Mentale</dct:title>
    <dct:title xml:lang="nl">NYXO Brussel - Open Data Catalogus Geestelijke Gezondheid</dct:title>
    <dct:description xml:lang="fr">Catalogue des donnÃ©es ouvertes sur l'infrastructure citoyenne de santÃ© mentale en RÃ©gion de Bruxelles-Capitale</dct:description>
    <dct:publisher>
      <foaf:Agent rdf:about="https://nyxo.brussels">
        <foaf:name>NYXO Collective</foaf:name>
        <dct:type rdf:resource="http://purl.org/adms/publishertype/NonProfitOrganisation"/>
      </foaf:Agent>
    </dct:publisher>
    <dct:language rdf:resource="http://publications.europa.eu/resource/authority/language/FRA"/>
    <dct:language rdf:resource="http://publications.europa.eu/resource/authority/language/NLD"/>
    <dct:issued rdf:datatype="http://www.w3.org/2001/XMLSchema#dateTime">${now}</dct:issued>
    <dct:modified rdf:datatype="http://www.w3.org/2001/XMLSchema#dateTime">${now}</dct:modified>
    <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
    <dcat:themeTaxonomy rdf:resource="http://publications.europa.eu/resource/authority/data-theme"/>
    <dct:spatial rdf:resource="http://publications.europa.eu/resource/authority/place/BEL_BRU"/>
    <foaf:homepage rdf:resource="https://nyxo.brussels"/>
    
    <!-- Dataset reference -->
    <dcat:dataset rdf:resource="https://nyxo.brussels/dataset/${datasetId}"/>
  </dcat:Catalog>

  <!-- DATASET -->
  <dcat:Dataset rdf:about="https://nyxo.brussels/dataset/${datasetId}">
    <dct:identifier>${datasetId}</dct:identifier>
    <dct:title xml:lang="fr">Infrastructure SantÃ© Mentale Communautaire - Bruxelles</dct:title>
    <dct:title xml:lang="nl">Gemeenschapsinfrastructuur Geestelijke Gezondheid - Brussel</dct:title>
    <dct:description xml:lang="fr">Cartographie citoyenne des lieux de liens (${DATA.lieux.length}), services de santÃ© mentale (${DATA.ssm.length}), rÃ©seaux 107 et ressources de cohÃ©sion sociale en RÃ©gion de Bruxelles-Capitale. Inclut gÃ©olocalisation, horaires, contacts et relations entre entitÃ©s.</dct:description>
    
    <!-- Publisher -->
    <dct:publisher rdf:resource="https://nyxo.brussels"/>
    
    <!-- Contact Point -->
    <dcat:contactPoint>
      <vcard:Organization>
        <vcard:fn>NYXO Brussels</vcard:fn>
        <vcard:hasEmail rdf:resource="mailto:data@nyxo.brussels"/>
        <vcard:hasURL rdf:resource="https://nyxo.brussels/contact"/>
      </vcard:Organization>
    </dcat:contactPoint>
    
    <!-- Themes (EU Vocabularies) -->
    <dcat:theme rdf:resource="http://publications.europa.eu/resource/authority/data-theme/HEAL"/>
    <dcat:theme rdf:resource="http://publications.europa.eu/resource/authority/data-theme/SOCI"/>
    
    <!-- Keywords -->
    <dcat:keyword xml:lang="fr">santÃ© mentale</dcat:keyword>
    <dcat:keyword xml:lang="fr">cohÃ©sion sociale</dcat:keyword>
    <dcat:keyword xml:lang="fr">lieux de liens</dcat:keyword>
    <dcat:keyword xml:lang="fr">Bruxelles</dcat:keyword>
    <dcat:keyword xml:lang="fr">SSM</dcat:keyword>
    <dcat:keyword xml:lang="fr">rÃ©seau 107</dcat:keyword>
    <dcat:keyword xml:lang="nl">geestelijke gezondheid</dcat:keyword>
    <dcat:keyword xml:lang="nl">sociale cohesie</dcat:keyword>
    
    <!-- Dates -->
    <dct:issued rdf:datatype="http://www.w3.org/2001/XMLSchema#dateTime">${now}</dct:issued>
    <dct:modified rdf:datatype="http://www.w3.org/2001/XMLSchema#dateTime">${now}</dct:modified>
    <dct:accrualPeriodicity rdf:resource="http://publications.europa.eu/resource/authority/frequency/MONTHLY"/>
    
    <!-- Spatial Coverage -->
    <dct:spatial>
      <dct:Location>
        <locn:geometry rdf:datatype="http://www.opengis.net/ont/geosparql#wktLiteral">POINT(4.3517 50.8503)</locn:geometry>
        <skos:prefLabel xml:lang="fr">RÃ©gion de Bruxelles-Capitale</skos:prefLabel>
        <skos:prefLabel xml:lang="nl">Brussels Hoofdstedelijk Gewest</skos:prefLabel>
      </dct:Location>
    </dct:spatial>
    
    <!-- Access Rights -->
    <dct:accessRights rdf:resource="http://publications.europa.eu/resource/authority/access-right/PUBLIC"/>
    
    <!-- License -->
    <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
    
    <!-- Conformance -->
    <dct:conformsTo rdf:resource="https://semiceu.github.io/DCAT-AP/releases/3.0.0/"/>
    <dct:conformsTo rdf:resource="http://hl7.org/fhir/StructureDefinition/Bundle"/>
    <dct:conformsTo rdf:resource="https://www.healthinformationportal.eu/healthdcat-ap"/>
    
    <!-- Applicable Legislation (PSI Directive) -->
    <dct:relation rdf:resource="http://data.europa.eu/eli/dir/2019/1024/oj"/>
    
    <!-- Provenance -->
    <dct:provenance>
      <dct:ProvenanceStatement>
        <rdfs:label xml:lang="fr">DonnÃ©es collectÃ©es et validÃ©es par la communautÃ© NYXO Brussels</rdfs:label>
      </dct:ProvenanceStatement>
    </dct:provenance>
    
    <!-- Distributions -->
    <dcat:distribution>
      <dcat:Distribution rdf:about="https://nyxo.brussels/dataset/${datasetId}/json">
        <dct:title xml:lang="fr">Export JSON</dct:title>
        <dcat:accessURL rdf:resource="https://nyxo.brussels/data/export.json"/>
        <dcat:downloadURL rdf:resource="https://nyxo.brussels/data/export.json"/>
        <dcat:mediaType rdf:resource="https://www.iana.org/assignments/media-types/application/json"/>
        <dct:format rdf:resource="http://publications.europa.eu/resource/authority/file-type/JSON"/>
        <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
      </dcat:Distribution>
    </dcat:distribution>
    
    <dcat:distribution>
      <dcat:Distribution rdf:about="https://nyxo.brussels/dataset/${datasetId}/fhir">
        <dct:title xml:lang="fr">FHIR R4 Bundle</dct:title>
        <dct:description xml:lang="fr">Export HL7 FHIR R4 pour interopÃ©rabilitÃ© santÃ© (EHDS)</dct:description>
        <dcat:accessURL rdf:resource="https://nyxo.brussels/data/fhir-bundle.json"/>
        <dcat:mediaType rdf:resource="https://www.iana.org/assignments/media-types/application/fhir+json"/>
        <dct:conformsTo rdf:resource="http://hl7.org/fhir/StructureDefinition/Bundle"/>
        <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
      </dcat:Distribution>
    </dcat:distribution>
    
    <dcat:distribution>
      <dcat:Distribution rdf:about="https://nyxo.brussels/dataset/${datasetId}/geojson">
        <dct:title xml:lang="fr">GeoJSON</dct:title>
        <dcat:accessURL rdf:resource="https://nyxo.brussels/data/nyxo.geojson"/>
        <dcat:mediaType rdf:resource="https://www.iana.org/assignments/media-types/application/geo+json"/>
        <dct:format rdf:resource="http://publications.europa.eu/resource/authority/file-type/GEOJSON"/>
        <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
      </dcat:Distribution>
    </dcat:distribution>
    
    <dcat:distribution>
      <dcat:Distribution rdf:about="https://nyxo.brussels/dataset/${datasetId}/rdf">
        <dct:title xml:lang="fr">RDF/Turtle</dct:title>
        <dcat:accessURL rdf:resource="https://nyxo.brussels/data/nyxo.ttl"/>
        <dcat:mediaType rdf:resource="https://www.iana.org/assignments/media-types/text/turtle"/>
        <dct:format rdf:resource="http://publications.europa.eu/resource/authority/file-type/RDF_TURTLE"/>
        <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
      </dcat:Distribution>
    </dcat:distribution>
    
    <dcat:distribution>
      <dcat:Distribution rdf:about="https://nyxo.brussels/dataset/${datasetId}/csv">
        <dct:title xml:lang="fr">CSV</dct:title>
        <dcat:accessURL rdf:resource="https://nyxo.brussels/data/lieux.csv"/>
        <dcat:mediaType rdf:resource="https://www.iana.org/assignments/media-types/text/csv"/>
        <dct:format rdf:resource="http://publications.europa.eu/resource/authority/file-type/CSV"/>
        <dct:license rdf:resource="https://creativecommons.org/licenses/by-sa/4.0/"/>
      </dcat:Distribution>
    </dcat:distribution>
  </dcat:Dataset>

</rdf:RDF>`;

  const blob = new Blob([dcatap], { type: 'application/rdf+xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-dcat-ap-${new Date().toISOString().split('T')[0]}.rdf`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export DCAT-AP 3.0 rÃ©ussi`);
  addJournalEntry(`ğŸ“¤ Export DCAT-AP: catalogue europÃ©en`);
}

// ========== HealthDCAT-AP (EHDS) ==========
// European Health Data Space metadata profile
function exportHealthDCATAP() {
  const now = new Date().toISOString();
  
  const healthDcat = {
    "@context": {
      "dcat": "http://www.w3.org/ns/dcat#",
      "dct": "http://purl.org/dc/terms/",
      "foaf": "http://xmlns.com/foaf/0.1/",
      "vcard": "http://www.w3.org/2006/vcard/ns#",
      "healthdcat": "https://healthdcat-ap.eu/ns#",
      "ehds": "http://data.europa.eu/ehds/",
      "adms": "http://www.w3.org/ns/adms#",
      "skos": "http://www.w3.org/2004/02/skos/core#"
    },
    "@type": "dcat:Dataset",
    "@id": "https://nyxo.brussels/dataset/health-mental-brussels",
    
    // Basic metadata
    "dct:identifier": "nyxo-health-" + Date.now(),
    "dct:title": {
      "@language": "fr",
      "@value": "Infrastructure SantÃ© Mentale Communautaire - RÃ©gion Bruxelles-Capitale"
    },
    "dct:description": {
      "@language": "fr", 
      "@value": `DonnÃ©es ouvertes sur ${DATA.lieux.length} lieux de liens, ${DATA.ssm.length} services de santÃ© mentale (SSM), Ã©quipes mobiles et rÃ©seaux 107 en RÃ©gion de Bruxelles-Capitale. Cartographie citoyenne pour l'accÃ¨s aux soins de santÃ© mentale de premiÃ¨re ligne.`
    },
    
    // HealthDCAT-AP specific
    "healthdcat:healthCategory": [
      {
        "@type": "skos:Concept",
        "skos:prefLabel": "Mental Health",
        "skos:notation": "F00-F99",
        "skos:inScheme": "http://hl7.org/fhir/ValueSet/icd-10"
      }
    ],
    "healthdcat:healthTheme": [
      "http://purl.bioontology.org/ontology/SNOMEDCT/74732009", // Mental disorder
      "http://purl.bioontology.org/ontology/SNOMEDCT/310027005"  // Community mental health service
    ],
    
    // Data sensitivity (EHDS Article 33)
    "healthdcat:sensitivityLevel": "non-sensitive",
    "healthdcat:personalData": false,
    "healthdcat:anonymizationTechnique": "N/A - No personal data",
    
    // EHDS compliance
    "ehds:dataCategory": "health-care-services",
    "ehds:secondaryUseEligible": true,
    "ehds:minimalDataset": false,
    
    // Quality
    "healthdcat:qualityAnnotation": {
      "@type": "dcat:QualityAnnotation",
      "healthdcat:completeness": "high",
      "healthdcat:accuracy": "community-validated",
      "healthdcat:timeliness": "monthly-updates"
    },
    
    // Publisher
    "dct:publisher": {
      "@type": "foaf:Agent",
      "@id": "https://nyxo.brussels",
      "foaf:name": "NYXO Collective",
      "dct:type": "http://purl.org/adms/publishertype/NonProfitOrganisation"
    },
    
    // Contact
    "dcat:contactPoint": {
      "@type": "vcard:Organization",
      "vcard:fn": "NYXO Brussels",
      "vcard:hasEmail": "mailto:health@nyxo.brussels"
    },
    
    // Spatial
    "dct:spatial": {
      "@type": "dct:Location",
      "dct:identifier": "http://publications.europa.eu/resource/authority/place/BEL_BRU",
      "skos:prefLabel": "Brussels-Capital Region"
    },
    
    // Temporal
    "dct:temporal": {
      "@type": "dct:PeriodOfTime",
      "dcat:startDate": "2024-01-01",
      "dcat:endDate": now.split('T')[0]
    },
    
    // Conformance
    "dct:conformsTo": [
      "https://healthdcat-ap.eu/",
      "http://hl7.org/fhir/R4",
      "https://semiceu.github.io/DCAT-AP/releases/3.0.0/"
    ],
    
    // License
    "dct:license": "https://creativecommons.org/licenses/by-sa/4.0/",
    "dct:accessRights": "http://publications.europa.eu/resource/authority/access-right/PUBLIC",
    
    // Distributions
    "dcat:distribution": [
      {
        "@type": "dcat:Distribution",
        "dct:title": "FHIR R4 Bundle",
        "dcat:mediaType": "application/fhir+json",
        "dct:conformsTo": "http://hl7.org/fhir/StructureDefinition/Bundle",
        "dcat:accessURL": "https://nyxo.brussels/fhir/Bundle"
      },
      {
        "@type": "dcat:Distribution", 
        "dct:title": "JSON-LD",
        "dcat:mediaType": "application/ld+json",
        "dcat:accessURL": "https://nyxo.brussels/data/export.jsonld"
      }
    ],
    
    // Keywords
    "dcat:keyword": [
      "mental health", "community care", "social cohesion", 
      "Brussels", "SSM", "network 107", "FHIR", "EHDS"
    ],
    
    // Themes
    "dcat:theme": [
      "http://publications.europa.eu/resource/authority/data-theme/HEAL",
      "http://publications.europa.eu/resource/authority/data-theme/SOCI"
    ],
    
    // Dates
    "dct:issued": now,
    "dct:modified": now,
    "dct:accrualPeriodicity": "http://publications.europa.eu/resource/authority/frequency/MONTHLY"
  };

  const blob = new Blob([JSON.stringify(healthDcat, null, 2)], { type: 'application/ld+json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-healthdcat-ap-${new Date().toISOString().split('T')[0]}.jsonld`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export HealthDCAT-AP (EHDS) rÃ©ussi`);
  addJournalEntry(`ğŸ“¤ Export HealthDCAT-AP: mÃ©tadonnÃ©es EHDS`);
}

// ========================================================================
// INTÃ‰GRATIONS API - CIVIC TECH & OPEN DATA BELGIUM
// ========================================================================

// Configuration des endpoints
const API_ENDPOINTS = {
  // Decidim instances (Bruxelles)
  decidim: {
    participation_brussels: 'https://participation.brussels/api',
    democratie_brussels: 'https://democratie.brussels/api'
  },
  // CKAN portals
  ckan: {
    federal: 'https://data.gov.be/api/3',
    odwb: 'https://opendata.bosa.be/api/3', // Open Data Wallonie-Bruxelles
    brussels: 'https://datastore.brussels/api/3'
  },
  // FHIR servers
  fhir: {
    ehealth_be: 'https://www.ehealth.fgov.be/standards/fhir'
  }
};

// ========== DECIDIM GRAPHQL CLIENT ==========
// Lecture des processus participatifs depuis participation.brussels

const DecidimClient = {
  endpoint: null,
  
  async connect(instanceUrl) {
    this.endpoint = instanceUrl + '/api';
    try {
      const response = await fetch(this.endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: '{ decidim { version applicationName } }' })
      });
      const data = await response.json();
      if (data.data?.decidim) {
        console.log('âœ… Decidim connected:', data.data.decidim);
        return { success: true, version: data.data.decidim.version, name: data.data.decidim.applicationName };
      }
      return { success: false, error: 'Invalid response' };
    } catch (e) {
      console.error('Decidim connection error:', e);
      return { success: false, error: e.message };
    }
  },
  
  async getParticipatoryProcesses(locale = 'fr') {
    if (!this.endpoint) return { success: false, error: 'Not connected' };
    
    const query = `{
      participatoryProcesses {
        id
        slug
        title { translation(locale: "${locale}") }
        description { translation(locale: "${locale}") }
        startDate
        endDate
        components {
          id
          __typename
          name { translation(locale: "${locale}") }
        }
      }
    }`;
    
    try {
      const response = await fetch(this.endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await response.json();
      return { success: true, processes: data.data?.participatoryProcesses || [] };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async getProposals(processSlug, componentId, locale = 'fr') {
    if (!this.endpoint) return { success: false, error: 'Not connected' };
    
    const query = `{
      participatoryProcess(slug: "${processSlug}") {
        components(filter: {type: "Proposals"}) {
          ... on Proposals {
            proposals(first: 50) {
              edges {
                node {
                  id
                  title { translation(locale: "${locale}") }
                  body { translation(locale: "${locale}") }
                  state
                  endorsementsCount
                  commentsCount
                  publishedAt
                  address
                  coordinates { latitude longitude }
                }
              }
            }
          }
        }
      }
    }`;
    
    try {
      const response = await fetch(this.endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await response.json();
      const proposals = [];
      data.data?.participatoryProcess?.components?.forEach(c => {
        c.proposals?.edges?.forEach(e => proposals.push(e.node));
      });
      return { success: true, proposals };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async getMeetings(processSlug, locale = 'fr') {
    if (!this.endpoint) return { success: false, error: 'Not connected' };
    
    const query = `{
      participatoryProcess(slug: "${processSlug}") {
        components(filter: {type: "Meetings"}) {
          ... on Meetings {
            meetings(first: 50) {
              edges {
                node {
                  id
                  title { translation(locale: "${locale}") }
                  description { translation(locale: "${locale}") }
                  startTime
                  endTime
                  address
                  coordinates { latitude longitude }
                  attendeesCount
                }
              }
            }
          }
        }
      }
    }`;
    
    try {
      const response = await fetch(this.endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await response.json();
      const meetings = [];
      data.data?.participatoryProcess?.components?.forEach(c => {
        c.meetings?.edges?.forEach(e => meetings.push(e.node));
      });
      return { success: true, meetings };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  // Convert Decidim proposals to NYXO format
  proposalsToNyxo(proposals) {
    return proposals.map((p, i) => ({
      id: 'DEC-' + (p.id || i),
      name: p.title?.translation || 'Proposition Decidim',
      summary: (p.body?.translation || '').substring(0, 500),
      commune: 'Bruxelles',
      adresse: p.address || '',
      lat: p.coordinates?.latitude || null,
      lng: p.coordinates?.longitude || null,
      status: p.state === 'accepted' ? 'ok' : (p.state === 'rejected' ? 'at_risk' : 'ok'),
      tags: ['decidim', 'participation', p.state || 'pending'],
      source: 'decidim',
      endorsements: p.endorsementsCount || 0,
      comments: p.commentsCount || 0
    }));
  },
  
  // Convert Decidim meetings to NYXO format
  meetingsToNyxo(meetings) {
    return meetings.map((m, i) => ({
      id: 'MTG-' + (m.id || i),
      name: m.title?.translation || 'RÃ©union Decidim',
      summary: (m.description?.translation || '').substring(0, 500),
      commune: 'Bruxelles',
      adresse: m.address || '',
      lat: m.coordinates?.latitude || null,
      lng: m.coordinates?.longitude || null,
      status: 'ok',
      tags: ['decidim', 'meeting', 'participation'],
      source: 'decidim',
      horaires: m.startTime ? new Date(m.startTime).toLocaleString('fr-BE') : '',
      attendees: m.attendeesCount || 0
    }));
  }
};

// ========== CKAN API CLIENT ==========
// Publication sur data.gov.be, ODWB, Brussels Open Data

const CKANClient = {
  endpoint: null,
  apiKey: null,
  
  configure(portalUrl, apiKey = null) {
    this.endpoint = portalUrl;
    this.apiKey = apiKey;
  },
  
  async checkConnection() {
    try {
      const response = await fetch(this.endpoint + '/action/site_read');
      const data = await response.json();
      return { success: data.success, result: data.result };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async searchDatasets(query, rows = 10) {
    try {
      const response = await fetch(
        `${this.endpoint}/action/package_search?q=${encodeURIComponent(query)}&rows=${rows}`
      );
      const data = await response.json();
      return { success: true, count: data.result?.count, datasets: data.result?.results || [] };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async getDataset(id) {
    try {
      const response = await fetch(`${this.endpoint}/action/package_show?id=${encodeURIComponent(id)}`);
      const data = await response.json();
      return { success: data.success, dataset: data.result };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async listOrganizations() {
    try {
      const response = await fetch(`${this.endpoint}/action/organization_list?all_fields=true`);
      const data = await response.json();
      return { success: true, organizations: data.result || [] };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async listTags() {
    try {
      const response = await fetch(`${this.endpoint}/action/tag_list`);
      const data = await response.json();
      return { success: true, tags: data.result || [] };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  // Create dataset (requires API key)
  async createDataset(packageData) {
    if (!this.apiKey) return { success: false, error: 'API key required' };
    
    try {
      const response = await fetch(`${this.endpoint}/action/package_create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.apiKey
        },
        body: JSON.stringify(packageData)
      });
      const data = await response.json();
      return { success: data.success, dataset: data.result, error: data.error };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  // Update dataset
  async updateDataset(packageData) {
    if (!this.apiKey) return { success: false, error: 'API key required' };
    
    try {
      const response = await fetch(`${this.endpoint}/action/package_update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.apiKey
        },
        body: JSON.stringify(packageData)
      });
      const data = await response.json();
      return { success: data.success, dataset: data.result, error: data.error };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  // Generate NYXO package for CKAN
  generateNyxoPackage() {
    const now = new Date().toISOString();
    return {
      name: 'nyxo-brussels-sante-mentale',
      title: 'NYXO Brussels - Infrastructure SantÃ© Mentale Communautaire',
      notes: `Cartographie citoyenne des lieux de liens (${DATA.lieux.length}), services de santÃ© mentale (${DATA.ssm.length}), rÃ©seaux 107 et ressources de cohÃ©sion sociale en RÃ©gion de Bruxelles-Capitale.`,
      author: 'NYXO Collective',
      author_email: 'contact@nyxo.brussels',
      maintainer: 'NYXO Collective',
      license_id: 'cc-by-sa',
      url: 'https://nyxo.brussels',
      version: '2.0.0',
      tags: [
        { name: 'sante-mentale' },
        { name: 'cohesion-sociale' },
        { name: 'bruxelles' },
        { name: 'lieux-de-liens' },
        { name: 'ssm' },
        { name: 'fhir' },
        { name: 'opendata' }
      ],
      extras: [
        { key: 'spatial', value: 'RÃ©gion de Bruxelles-Capitale' },
        { key: 'language', value: 'fr,nl' },
        { key: 'theme', value: 'HEAL,SOCI' },
        { key: 'conforms_to', value: 'DCAT-AP 3.0, FHIR R4' }
      ]
    };
  }
};

// ========== INTEGRATION HUB ==========
// Interface unifiÃ©e pour gÃ©rer toutes les intÃ©grations

const IntegrationHub = {
  connections: {},
  
  async testDecidim(instanceUrl) {
    const result = await DecidimClient.connect(instanceUrl);
    if (result.success) {
      this.connections.decidim = { url: instanceUrl, ...result };
      addJournalEntry(`ğŸ”— Decidim connectÃ©: ${result.name} v${result.version}`);
    }
    return result;
  },
  
  async testCKAN(portalUrl) {
    CKANClient.configure(portalUrl);
    const result = await CKANClient.checkConnection();
    if (result.success) {
      this.connections.ckan = { url: portalUrl, ...result };
      addJournalEntry(`ğŸ”— CKAN connectÃ©: ${portalUrl}`);
    }
    return result;
  },
  
  async importFromDecidim(processSlug) {
    if (!this.connections.decidim) {
      return { success: false, error: 'Decidim non connectÃ©' };
    }
    
    try {
      // Import proposals
      const proposalsResult = await DecidimClient.getProposals(processSlug);
      if (proposalsResult.success && proposalsResult.proposals.length) {
        const nyxoLieux = DecidimClient.proposalsToNyxo(proposalsResult.proposals);
        DATA.lieux.push(...nyxoLieux);
        addJournalEntry(`ğŸ“¥ Import Decidim: ${nyxoLieux.length} propositions`);
      }
      
      // Import meetings
      const meetingsResult = await DecidimClient.getMeetings(processSlug);
      if (meetingsResult.success && meetingsResult.meetings.length) {
        const nyxoMeetings = DecidimClient.meetingsToNyxo(meetingsResult.meetings);
        DATA.lieux.push(...nyxoMeetings);
        addJournalEntry(`ğŸ“¥ Import Decidim: ${nyxoMeetings.length} rÃ©unions`);
      }
      
      saveToStorage();
      render();
      return { 
        success: true, 
        imported: {
          proposals: proposalsResult.proposals?.length || 0,
          meetings: meetingsResult.meetings?.length || 0
        }
      };
    } catch (e) {
      return { success: false, error: e.message };
    }
  },
  
  async searchOpenData(query) {
    const results = { federal: null, odwb: null };
    
    // Search data.gov.be
    CKANClient.configure(API_ENDPOINTS.ckan.federal);
    results.federal = await CKANClient.searchDatasets(query);
    
    // Search ODWB
    CKANClient.configure(API_ENDPOINTS.ckan.odwb);
    results.odwb = await CKANClient.searchDatasets(query);
    
    return results;
  },
  
  getStatus() {
    return {
      decidim: this.connections.decidim || null,
      ckan: this.connections.ckan || null,
      lastSync: new Date().toISOString()
    };
  }
};

// ========== UI FUNCTIONS FOR INTEGRATIONS ==========

async function testDecidimConnection() {
  const url = $('decidimUrl')?.value || 'https://participation.brussels';
  toast('ğŸ”„ Connexion Ã  Decidim...');
  
  const result = await IntegrationHub.testDecidim(url);
  if (result.success) {
    toast(`âœ… ConnectÃ©: ${result.name} v${result.version}`);
    $('decidimStatus').innerHTML = `<span style="color:var(--liens)">âœ“ ConnectÃ©</span>`;
    
    // Load processes
    const processes = await DecidimClient.getParticipatoryProcesses();
    if (processes.success) {
      const select = $('decidimProcess');
      if (select) {
        select.innerHTML = '<option value="">SÃ©lectionner un processus...</option>';
        processes.processes.forEach(p => {
          select.innerHTML += `<option value="${p.slug}">${p.title?.translation || p.slug}</option>`;
        });
      }
    }
  } else {
    toast(`âŒ Erreur: ${result.error}`);
    $('decidimStatus').innerHTML = `<span style="color:var(--urgence)">âœ— Erreur</span>`;
  }
}

async function importFromDecidim() {
  const processSlug = $('decidimProcess')?.value;
  if (!processSlug) {
    toast('âš ï¸ SÃ©lectionnez un processus');
    return;
  }
  
  toast('ğŸ”„ Import en cours...');
  const result = await IntegrationHub.importFromDecidim(processSlug);
  
  if (result.success) {
    toast(`âœ… Import: ${result.imported.proposals} propositions, ${result.imported.meetings} rÃ©unions`);
  } else {
    toast(`âŒ Erreur: ${result.error}`);
  }
}

async function searchOpenDataPortals() {
  const query = $('openDataQuery')?.value || 'santÃ© mentale';
  toast('ğŸ”„ Recherche sur les portails Open Data...');
  
  const results = await IntegrationHub.searchOpenData(query);
  
  let html = '';
  
  if (results.federal?.success) {
    html += `<div style="margin-bottom:16px"><strong style="color:var(--liens)">data.gov.be</strong> (${results.federal.count} rÃ©sultats)<ul style="margin-top:8px;padding-left:20px">`;
    results.federal.datasets.slice(0, 5).forEach(d => {
      html += `<li style="margin-bottom:4px"><a href="https://data.gov.be/fr/dataset/${d.name}" target="_blank" style="color:var(--info)">${d.title}</a></li>`;
    });
    html += '</ul></div>';
  }
  
  if (results.odwb?.success) {
    html += `<div><strong style="color:var(--ssm)">ODWB</strong> (${results.odwb.count} rÃ©sultats)<ul style="margin-top:8px;padding-left:20px">`;
    results.odwb.datasets.slice(0, 5).forEach(d => {
      html += `<li style="margin-bottom:4px"><a href="#" style="color:var(--info)">${d.title}</a></li>`;
    });
    html += '</ul></div>';
  }
  
  $('openDataResults').innerHTML = html || '<p style="color:var(--muted)">Aucun rÃ©sultat</p>';
  $('openDataResults').style.display = 'block';
}

function copyAPIEndpoint(type) {
  const endpoints = {
    fhir: 'https://nyxo.brussels/fhir/Bundle',
    dcat: 'https://nyxo.brussels/dcat-ap.rdf',
    geojson: 'https://nyxo.brussels/data/nyxo.geojson',
    jsonld: 'https://nyxo.brussels/data/export.jsonld'
  };
  
  navigator.clipboard.writeText(endpoints[type] || '').then(() => {
    toast(`ğŸ“‹ Endpoint ${type.toUpperCase()} copiÃ©`);
  });
}

// ========== FHIR IMPORT ==========
function importFHIR(bundle) {
  if (bundle.resourceType !== 'Bundle') {
    toast('âŒ Format FHIR invalide: Bundle attendu');
    return { count: 0, types: [] };
  }

  let count = 0;
  const types = [];

  (bundle.entry || []).forEach(entry => {
    const resource = entry.resource;
    if (!resource) return;

    switch (resource.resourceType) {
      case 'Location':
        DATA.lieux.push({
          id: resource.id || 'LDL-FHIR-' + Date.now(),
          name: resource.name || '',
          summary: resource.description || '',
          commune: resource.address?.city || '',
          cp: resource.address?.postalCode || '',
          adresse: resource.address?.line?.[0] || '',
          tel: resource.telecom?.find(t => t.system === 'phone')?.value || '',
          email: resource.telecom?.find(t => t.system === 'email')?.value || '',
          web: resource.telecom?.find(t => t.system === 'url')?.value || '',
          lat: resource.position?.latitude || null,
          lng: resource.position?.longitude || null,
          status: resource.status === 'suspended' ? 'at_risk' : 'ok',
          tags: resource.meta?.tag?.map(t => t.code) || [],
          horaires: resource.hoursOfOperation?.[0]?.comment || ''
        });
        count++;
        if (!types.includes('lieux')) types.push('lieux');
        break;

      case 'Organization':
        const orgType = resource.type?.[0]?.text || '';
        if (orgType.includes('SSM') || orgType.includes('Service de SantÃ© Mentale')) {
          DATA.ssm.push({
            id: resource.id || 'SSM-FHIR-' + Date.now(),
            name: resource.name || '',
            type: resource.extension?.find(e => e.url?.includes('service-type'))?.valueString || 'SSM',
            adresse: resource.address?.[0]?.text || '',
            tel: resource.telecom?.find(t => t.system === 'phone')?.value || '',
            web: resource.telecom?.find(t => t.system === 'url')?.value || ''
          });
          count++;
          if (!types.includes('ssm')) types.push('ssm');
        } else {
          DATA.contacts.push({
            id: resource.id || 'CON-FHIR-' + Date.now(),
            name: resource.name || '',
            type: orgType,
            email: resource.telecom?.find(t => t.system === 'email')?.value || '',
            web: resource.telecom?.find(t => t.system === 'url')?.value || '',
            status: resource.active ? 'ok' : 'inactive'
          });
          count++;
          if (!types.includes('contacts')) types.push('contacts');
        }
        break;

      case 'OrganizationAffiliation':
        const fromRef = resource.organization?.reference || '';
        const toRef = resource.participatingOrganization?.reference || '';
        DATA.links.push({
          from: fromRef.split('/').pop(),
          to: toRef.split('/').pop(),
          type: resource.code?.[0]?.text || 'connection'
        });
        count++;
        if (!types.includes('liens')) types.push('liens');
        break;
    }
  });

  if (count > 0) {
    saveToStorage();
    render();
    addJournalEntry(`ğŸ“¥ Import FHIR: ${count} ressources`);
    toast(`âœ… Import FHIR: ${count} ressources`);
  }

  return { count, types };
}

// Export CSV
function exportCSV(type = 'lieux') {
  let data, headers, filename;
  
  switch(type) {
    case 'lieux':
      headers = ['id','name','commune','cp','adresse','tel','email','web','status','horaires','summary','tags','lat','lng'];
      data = DATA.lieux.map(l => ({...l, tags: (l.tags || []).join(';')}));
      filename = 'nyxo-lieux.csv';
      break;
    case 'ssm':
      headers = ['id','name','type','adresse','tel','web','summary','lat','lng'];
      data = DATA.ssm;
      filename = 'nyxo-ssm.csv';
      break;
    case 'contacts':
      headers = ['id','name','type','zone','web','email','status'];
      data = DATA.contacts;
      filename = 'nyxo-contacts.csv';
      break;
    case 'flashcards':
      headers = ['id','question','answer'];
      data = DATA.flashcards;
      filename = 'nyxo-flashcards.csv';
      break;
    default:
      return toast('âŒ Type inconnu');
  }
  
  const escapeCSV = val => {
    if (val === null || val === undefined) return '';
    const str = String(val);
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  };
  
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(h => escapeCSV(row[h])).join(','))
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  toast(`âœ… Export CSV ${type} rÃ©ussi`);
}

function exportLieuxCSV() { exportCSV('lieux'); }
function exportContactsCSV() { exportCSV('contacts'); }

// Import depuis la page principale (module donnÃ©es)
function importDataMain() {
  const fileInput = $('importFileMain');
  if (!fileInput || !fileInput.files[0]) return toast('âŒ SÃ©lectionnez un fichier');
  doImport(fileInput.files[0], 'importPreview');
}

// Import depuis les paramÃ¨tres
function importData() {
  const fileInput = $('importFile');
  if (!fileInput || !fileInput.files[0]) return toast('âŒ SÃ©lectionnez un fichier');
  doImport(fileInput.files[0], null);
}

// Fonction commune d'import
function doImport(file, previewId) {
  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();
  
  reader.onload = e => {
    try {
      console.log('ğŸ“‚ Import:', file.name, '- Extension:', ext);
      
      if (ext === 'json' || ext === 'jsonld') {
        const result = importJSON(e.target.result);
        if (previewId) showPreview(previewId, result);
      } else if (ext === 'csv') {
        const result = importCSV(e.target.result);
        if (previewId) showPreview(previewId, result);
      } else if (ext === 'xlsx' || ext === 'xls') {
        if (typeof XLSX !== 'undefined') {
          const workbook = XLSX.read(e.target.result, {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          const result = importExcelData(json, file.name);
          if (previewId) showPreview(previewId, result);
        } else {
          toast('âŒ BibliothÃ¨que Excel non chargÃ©e - Rechargez la page');
        }
      } else {
        toast('âŒ Format non supportÃ©: ' + ext);
      }
    } catch (err) {
      console.error('Import error:', err);
      toast('âŒ Erreur: ' + err.message);
    }
  };
  
  reader.onerror = () => toast('âŒ Erreur lecture fichier');
  
  if (ext === 'xlsx' || ext === 'xls') {
    reader.readAsArrayBuffer(file);
  } else {
    reader.readAsText(file);
  }
}

function showPreview(elementId, result) {
  const el = $(elementId);
  if (el && result) {
    el.style.display = 'block';
    el.innerHTML = `<strong style="color:var(--liens)">âœ… ${result.count} Ã©lÃ©ments importÃ©s</strong><br>Types: ${result.types.join(', ')}`;
  }
}

function importJSON(text) {
  const d = JSON.parse(text);
  let count = 0;
  let types = [];
  
  // Format FHIR Bundle
  if (d.resourceType === 'Bundle') {
    console.log('ğŸ“‚ Format FHIR Bundle dÃ©tectÃ©');
    return importFHIR(d);
  }
  
  // Format NYXO natif
  if (d._meta?.format === 'nyxo-v2' || d.lieux || d.ssm) {
    if (d.lieux && d.lieux.length) { DATA.lieux.push(...d.lieux); count += d.lieux.length; types.push('lieux'); }
    if (d.ssm && d.ssm.length) { DATA.ssm.push(...d.ssm); count += d.ssm.length; types.push('ssm'); }
    if (d.contacts && d.contacts.length) { DATA.contacts.push(...d.contacts); count += d.contacts.length; types.push('contacts'); }
    if (d.flashcards && d.flashcards.length) { DATA.flashcards.push(...d.flashcards); count += d.flashcards.length; types.push('flashcards'); }
    if (d.links && d.links.length) { DATA.links.push(...d.links); count += d.links.length; types.push('liens'); }
    if (d.missions && d.missions.length) { DATA.missions.push(...d.missions); count += d.missions.length; types.push('missions'); }
    if (d.notes && d.notes.length) { DATA.notes.push(...d.notes); count += d.notes.length; types.push('notes'); }
  }
  // Format JSON-LD
  else if (d['@context'] && d['@graph']) {
    d['@graph'].forEach(entity => {
      if (entity['@type']?.includes('nyxo:LieuDeLiens') || entity['@type']?.includes('Place')) {
        DATA.lieux.push({
          id: entity['@id']?.split('/').pop() || 'LDL-' + Date.now(),
          name: entity.name || '',
          summary: entity.description || '',
          commune: entity.address?.addressLocality || '',
          cp: entity.address?.postalCode || '',
          adresse: entity.address?.streetAddress || '',
          tel: entity.telephone || '',
          email: entity.email || '',
          web: entity.url || '',
          lat: entity.geo?.latitude || null,
          lng: entity.geo?.longitude || null,
          status: entity['nyxo:status'] || 'ok',
          tags: entity['nyxo:tags'] || [],
          horaires: entity.openingHours || ''
        });
        count++;
        if (!types.includes('lieux')) types.push('lieux');
      } else if (entity['@type']?.includes('MedicalOrganization')) {
        DATA.ssm.push({
          id: entity['@id']?.split('/').pop() || 'SSM-' + Date.now(),
          name: entity.name || '',
          type: entity['nyxo:serviceType'] || 'SSM',
          summary: entity.description || '',
          adresse: entity.address?.streetAddress || '',
          tel: entity.telephone || '',
          web: entity.url || ''
        });
        count++;
        if (!types.includes('ssm')) types.push('ssm');
      }
    });
  }
  // Array simple
  else if (Array.isArray(d)) {
    d.forEach(item => {
      if (item.commune || item.Commune) {
        DATA.lieux.push(normalizeLieu(item));
        count++;
        if (!types.includes('lieux')) types.push('lieux');
      } else if (item.question || item.Question) {
        DATA.flashcards.push({
          id: 'FC-' + Date.now() + Math.random().toString(36).substr(2,4),
          question: item.question || item.Question,
          answer: item.answer || item.Answer || item.RÃ©ponse || item.reponse || ''
        });
        count++;
        if (!types.includes('flashcards')) types.push('flashcards');
      }
    });
  }
  
  if (count > 0) {
    saveToStorage();
    render();
    if (typeof rebuildGraphNodes === 'function') rebuildGraphNodes();
    addJournalEntry(`ğŸ“¥ Import JSON: ${count} Ã©lÃ©ments`);
    toast(`âœ… ${count} Ã©lÃ©ments importÃ©s`);
    return { count, types };
  } else {
    toast('âš ï¸ Aucune donnÃ©e reconnue dans le JSON');
    return { count: 0, types: [] };
  }
}

function importCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 1) {
    toast('âŒ CSV vide');
    return { count: 0, types: [] };
  }
  
  // Parser la premiÃ¨re ligne pour voir si c'est un header ou des donnÃ©es
  const firstLine = parseCSVLine(lines[0]);
  console.log('CSV first line:', firstLine);
  
  // DÃ©tection: si la premiÃ¨re ligne ressemble Ã  des donnÃ©es (pas des noms de colonnes)
  // Pour les flashcards: 2 colonnes avec du texte long = probablement question/rÃ©ponse sans header
  const looksLikeFlashcardData = firstLine.length === 2 && 
    firstLine[0].length > 20 && 
    firstLine[1].length > 5 &&
    !firstLine[0].toLowerCase().includes('question');
  
  let headers, dataLines;
  
  if (looksLikeFlashcardData) {
    // Pas de header - c'est directement question,rÃ©ponse
    console.log('CSV sans header dÃ©tectÃ© - format flashcard');
    headers = ['question', 'answer'];
    dataLines = lines;
  } else {
    // PremiÃ¨re ligne = headers
    headers = firstLine.map(h => h.trim().toLowerCase());
    dataLines = lines.slice(1);
  }
  
  console.log('CSV headers:', headers, 'Data lines:', dataLines.length);
  
  const rows = dataLines.map(l => {
    const values = parseCSVLine(l);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
    return obj;
  });
  
  console.log('CSV rows:', rows.length, 'First row:', rows[0]);
  
  let count = 0;
  let type = '';
  
  // DÃ©tection automatique du type
  if (headers.includes('question') || headers.includes('rÃ©ponse') || headers.includes('answer') || headers.includes('reponse')) {
    type = 'flashcards';
    rows.forEach(row => {
      const q = row.question || row.Question || row['question'] || '';
      const a = row.answer || row.rÃ©ponse || row.reponse || row.Answer || row['rÃ©ponse'] || row['answer'] || '';
      if (q && a) {
        DATA.flashcards.push({ id: 'FC-' + Date.now() + '-' + count, question: q, answer: a });
        count++;
      }
    });
  } else if (headers.includes('commune') || headers.includes('localite') || headers.includes('cp') || headers.includes('adresse')) {
    type = 'lieux';
    rows.forEach(row => {
      if (row.name || row.nom || row['nom_association'] || row['nom association']) {
        DATA.lieux.push(normalizeLieu(row));
        count++;
      }
    });
  } else if (headers.includes('name') || headers.includes('nom') || headers.includes('nom_association')) {
    type = 'contacts';
    rows.forEach(row => {
      const name = row.name || row.nom || row['nom_association'] || row['nom association'] || '';
      if (name) {
        DATA.contacts.push({
          id: row.id || 'CON-' + Date.now() + '-' + count,
          name: name,
          type: row.type || '',
          zone: row.zone || row.localite || '',
          web: row.web || row['site web'] || row.url || '',
          email: row.email || row['e.mail'] || row['e-mail'] || '',
          status: row.status || row.statut || ''
        });
        count++;
      }
    });
  } else {
    // Fallback: si 2 colonnes, traiter comme flashcards
    if (headers.length === 2) {
      type = 'flashcards';
      rows.forEach(row => {
        const vals = Object.values(row);
        if (vals[0] && vals[1]) {
          DATA.flashcards.push({ id: 'FC-' + Date.now() + '-' + count, question: vals[0], answer: vals[1] });
          count++;
        }
      });
    }
  }
  
  if (count > 0) {
    saveToStorage();
    render();
    if (typeof rebuildGraphNodes === 'function') rebuildGraphNodes();
    addJournalEntry(`ğŸ“¥ Import CSV: ${count} ${type}`);
    toast(`âœ… ${count} ${type} importÃ©s`);
    return { count, types: [type] };
  } else {
    toast('âš ï¸ CSV: aucune donnÃ©e reconnue. Colonnes: ' + headers.join(', '));
    return { count: 0, types: [] };
  }
}

function importExcelData(json, filename) {
  let count = 0;
  let type = 'contacts';
  const headers = json.length > 0 ? Object.keys(json[0]).map(h => h.toLowerCase()) : [];
  console.log('Excel headers:', headers, 'Rows:', json.length);
  
  json.forEach(row => {
    const normalized = {};
    Object.keys(row).forEach(k => normalized[k.toLowerCase()] = row[k]);
    
    if (headers.some(h => h.includes('question'))) {
      type = 'flashcards';
      const q = normalized.question || '';
      const a = normalized.answer || normalized.rÃ©ponse || normalized.reponse || '';
      if (q && a) {
        DATA.flashcards.push({ id: 'FC-' + Date.now() + count, question: String(q), answer: String(a) });
        count++;
      }
    } else if (headers.some(h => h.includes('commune') || h.includes('localite') || h.includes('adresse'))) {
      type = 'lieux';
      const name = normalized.name || normalized.nom || normalized['nom_association'] || normalized['nom association'] || '';
      if (name) {
        DATA.lieux.push(normalizeLieu(normalized));
        count++;
      }
    } else {
      type = 'contacts';
      const name = normalized.name || normalized.nom || normalized['nom_association'] || normalized['nom association'] || '';
      if (name) {
        DATA.contacts.push({
          id: normalized.id || 'CON-' + Date.now() + count,
          name: name,
          type: normalized.type || '',
          zone: normalized.zone || normalized.localite || '',
          web: normalized.web || normalized['site web'] || normalized.url || '',
          email: normalized.email || normalized['e.mail'] || normalized['e-mail'] || '',
          status: normalized.status || normalized.statut || ''
        });
        count++;
      }
    }
  });
  
  if (count > 0) {
    saveToStorage();
    render();
    if (typeof rebuildGraphNodes === 'function') rebuildGraphNodes();
    addJournalEntry(`ğŸ“¥ Import Excel (${filename}): ${count} ${type}`);
    toast(`âœ… ${count} ${type} importÃ©s depuis Excel`);
    return { count, types: [type] };
  } else {
    toast('âš ï¸ Excel: aucune donnÃ©e reconnue. Colonnes: ' + headers.join(', '));
    return { count: 0, types: [] };
  }
}

function normalizeLieu(row) {
  return {
    id: row.id || 'LDL-' + Date.now() + Math.random().toString(36).substr(2,4),
    name: row.name || row.nom || row.nom_association || row['nom association'] || '',
    commune: row.commune || row.localite || row.ville || 'Bruxelles',
    cp: row.cp || row['c.p.'] || row.code_postal || '',
    adresse: row.adresse || row.address || row['adresse complÃ¨te'] || '',
    tel: row.tel || row.telephone || row['tel.'] || row.phone || '',
    email: row.email || row['e.mail'] || row['e-mail'] || '',
    web: row.web || row['site web'] || row.url || row.website || '',
    status: row.status || row.statut || 'ok',
    horaires: row.horaires || row.heures || row.openinghours || '',
    summary: row.summary || row.description || row.resume || row.activites || '',
    tags: row.tags ? (typeof row.tags === 'string' ? row.tags.split(/[;,]/).map(t => t.trim()) : row.tags) : [],
    lat: parseFloat(row.lat || row.latitude) || null,
    lng: parseFloat(row.lng || row.longitude || row.lon) || null
  };
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (inQuotes && line[i+1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if ((char === ',' || char === ';') && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

// ========== UTILS ==========
function esc(t) {
  if (!t) return '';
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

// ========== LOCALSTORAGE ==========
const STORAGE_KEY = 'nyxo-data-v1';

function saveToStorage() {
  try {
    const toSave = {
      lieux: DATA.lieux,
      ssm: DATA.ssm,
      links: DATA.links,
      flashcards: DATA.flashcards,
      contacts: DATA.contacts,
      missions: DATA.missions,
      notes: DATA.notes,
      profil: DATA.profil,
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    console.log('ğŸ’¾ DonnÃ©es sauvegardÃ©es');
  } catch (e) {
    console.error('Erreur sauvegarde:', e);
  }
}

function loadFromStorage() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const d = JSON.parse(saved);
      if (d.lieux && d.lieux.length) DATA.lieux = d.lieux;
      if (d.ssm && d.ssm.length) DATA.ssm = d.ssm;
      if (d.links) DATA.links = d.links;
      if (d.flashcards && d.flashcards.length) DATA.flashcards = d.flashcards;
      if (d.contacts && d.contacts.length) DATA.contacts = d.contacts;
      if (d.missions) DATA.missions = d.missions;
      if (d.notes) DATA.notes = d.notes;
      if (d.profil) DATA.profil = {...DATA.profil, ...d.profil};
      console.log('ğŸ“‚ DonnÃ©es chargÃ©es depuis localStorage');
      return true;
    }
  } catch (e) {
    console.error('Erreur chargement:', e);
  }
  return false;
}

function clearStorage() {
  if (confirm('Effacer toutes les donnÃ©es locales ? Cette action est irrÃ©versible.')) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

// ========== LIEU MODAL ==========
function openLieuModal(id = null) {
  $('lieuEditId').value = '';
  $('lieuName').value = '';
  $('lieuCommune').value = 'Bruxelles';
  $('lieuCP').value = '';
  $('lieuAdresse').value = '';
  $('lieuTel').value = '';
  $('lieuEmail').value = '';
  $('lieuWeb').value = '';
  $('lieuStatus').value = 'ok';
  $('lieuHoraires').value = '';
  $('lieuSummary').value = '';
  $('lieuTags').value = '';
  $('lieuModalTitle').textContent = 'Nouveau Lieu de Liens';
  $('lieuDeleteBtn').style.display = 'none';
  
  if (id) {
    const l = DATA.lieux.find(x => x.id === id);
    if (l) {
      $('lieuEditId').value = id;
      $('lieuName').value = l.name || '';
      $('lieuCommune').value = l.commune || 'Bruxelles';
      $('lieuCP').value = l.cp || '';
      $('lieuAdresse').value = l.adresse || '';
      $('lieuTel').value = l.tel || '';
      $('lieuEmail').value = l.email || '';
      $('lieuWeb').value = l.web || '';
      $('lieuStatus').value = l.status || 'ok';
      $('lieuHoraires').value = l.horaires || '';
      $('lieuSummary').value = l.summary || '';
      $('lieuTags').value = (l.tags || []).join(', ');
      $('lieuModalTitle').textContent = 'Modifier Lieu de Liens';
      $('lieuDeleteBtn').style.display = 'block';
    }
  }
  $('lieuModal').classList.add('open');
}

function closeLieuModal() {
  $('lieuModal').classList.remove('open');
}

function saveLieu() {
  const name = $('lieuName').value.trim();
  if (!name) return toast('âŒ Nom requis');
  
  const editId = $('lieuEditId').value;
  const data = {
    name,
    commune: $('lieuCommune').value,
    cp: $('lieuCP').value.trim() || getCPFromCommune($('lieuCommune').value),
    adresse: $('lieuAdresse').value.trim(),
    tel: $('lieuTel').value.trim(),
    email: $('lieuEmail').value.trim(),
    web: $('lieuWeb').value.trim(),
    status: $('lieuStatus').value,
    horaires: $('lieuHoraires').value.trim(),
    summary: $('lieuSummary').value.trim(),
    tags: $('lieuTags').value.split(',').map(t => t.trim()).filter(t => t)
  };
  
  if (editId) {
    const l = DATA.lieux.find(x => x.id === editId);
    if (l) Object.assign(l, data);
    toast('âœ… Lieu modifiÃ©');
  } else {
    DATA.lieux.push({id: 'LDL-' + Date.now(), ...data});
    // XP for new lieu
    const lieuCount = DATA.lieux.length - 20;
    if (lieuCount === 1) addXP(20, 'Premier lieu ajoutÃ©');
    else if (lieuCount === 5) addXP(25, '5 lieux ajoutÃ©s');
    else addXP(5, 'Nouveau lieu');
    // Discover zone
    if (data.commune) discoverZone(data.commune);
    toast('âœ… Lieu ajoutÃ©');
  }
  closeLieuModal();
  saveToStorage();
  render();
  rebuildGraphNodes();
  checkBadges();
}

function deleteLieu() {
  const id = $('lieuEditId').value;
  if (!id) return;
  if (!confirm('Supprimer ce lieu de liens ?')) return;
  DATA.lieux = DATA.lieux.filter(l => l.id !== id);
  DATA.links = DATA.links.filter(l => l.from !== id && l.to !== id);
  closeLieuModal();
  saveToStorage();
  render();
  rebuildGraphNodes();
  toast('ğŸ—‘ï¸ Lieu supprimÃ©');
}

function getCPFromCommune(commune) {
  const cps = {'Bruxelles':'1000','Schaerbeek':'1030','Etterbeek':'1040','Ixelles':'1050','Saint-Gilles':'1060','Anderlecht':'1070','Molenbeek':'1080','Jette':'1090','NOH':'1120','Auderghem':'1160','Forest':'1190','Woluwe-SL':'1200'};
  return cps[commune] || '';
}

function exportLieuxCSV() {
  const headers = 'Nom,Commune,CP,Adresse,TÃ©lÃ©phone,Email,Site,Horaires,Statut,Description,Tags';
  const csv = DATA.lieux.map(l => 
    `"${(l.name||'').replace(/"/g,'""')}","${l.commune||''}","${l.cp||''}","${(l.adresse||'').replace(/"/g,'""')}","${l.tel||''}","${l.email||''}","${l.web||''}","${(l.horaires||'').replace(/"/g,'""')}","${l.status||''}","${(l.summary||'').replace(/"/g,'""')}","${(l.tags||[]).join(';')}"`
  ).join('\n');
  const blob = new Blob([headers + '\n' + csv], {type: 'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-lieux-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Lieux exportÃ©s en CSV');
}

// ========== LINK MODAL ==========
function openLinkModal(fromId = null) {
  // Populate selects with all entities
  const allEntities = [
    ...DATA.lieux.map(l => ({id: l.id, name: l.name, type: 'Lieu'})),
    ...DATA.ssm.map(s => ({id: s.id, name: s.name, type: s.type || 'SSM'})),
    ...DATA.reseaux.map(r => ({id: r.id, name: r.name, type: 'RÃ©seau 107'}))
  ];
  
  const optionsHtml = allEntities.map(e => `<option value="${e.id}">[${e.type}] ${esc(e.name)}</option>`).join('');
  $('linkFrom').innerHTML = optionsHtml;
  $('linkTo').innerHTML = optionsHtml;
  
  if (fromId) $('linkFrom').value = fromId;
  $('linkType').value = 'partenariat';
  $('linkLabel').value = '';
  
  $('linkModal').classList.add('open');
}

function closeLinkModal() {
  $('linkModal').classList.remove('open');
}

function saveLink() {
  const from = $('linkFrom').value;
  const to = $('linkTo').value;
  if (!from || !to) return toast('âŒ SÃ©lectionnez deux entitÃ©s');
  if (from === to) return toast('âŒ Les deux entitÃ©s doivent Ãªtre diffÃ©rentes');
  
  // Check if link already exists
  const exists = DATA.links.some(l => (l.from === from && l.to === to) || (l.from === to && l.to === from));
  if (exists) return toast('âŒ Ce lien existe dÃ©jÃ ');
  
  const type = $('linkType').value;
  const label = $('linkLabel').value.trim() || type.charAt(0).toUpperCase() + type.slice(1);
  
  DATA.links.push({ from, to, type, label });
  
  // XP for links
  const linkCount = DATA.links.length - 17; // Initial links
  if (linkCount === 1) addXP(10, 'Premier lien crÃ©Ã©');
  else if (linkCount === 10) addXP(15, '10 liens crÃ©Ã©s');
  else addXP(3, 'Nouveau lien');
  
  closeLinkModal();
  saveToStorage();
  render();
  checkBadges();
  toast('âœ… Lien crÃ©Ã©');
}

function deleteLink(from, to) {
  if (!confirm('Supprimer ce lien ?')) return;
  DATA.links = DATA.links.filter(l => !(l.from === from && l.to === to));
  saveToStorage();
  render();
  toast('ğŸ—‘ï¸ Lien supprimÃ©');
}

// ========== FLASHCARD MODAL ==========
function openFlashModal(id = null) {
  $('flashEditId').value = '';
  $('flashQuestion').value = '';
  $('flashAnswer').value = '';
  $('flashModalTitle').textContent = 'Nouvelle Flashcard';
  
  if (id) {
    const f = DATA.flashcards.find(x => x.id === id);
    if (f) {
      $('flashEditId').value = id;
      $('flashQuestion').value = f.question;
      $('flashAnswer').value = f.answer;
      $('flashModalTitle').textContent = 'Modifier Flashcard';
    }
  }
  $('flashModal').classList.add('open');
}

function closeFlashModal() {
  $('flashModal').classList.remove('open');
}

function saveFlashcard() {
  const q = $('flashQuestion').value.trim();
  const a = $('flashAnswer').value.trim();
  if (!q || !a) return toast('âŒ Question et rÃ©ponse requises');
  
  const editId = $('flashEditId').value;
  if (editId) {
    const f = DATA.flashcards.find(x => x.id === editId);
    if (f) { f.question = q; f.answer = a; }
    toast('âœ… Flashcard modifiÃ©e');
  } else {
    DATA.flashcards.push({id: 'FC-' + Date.now(), question: q, answer: a});
    toast('âœ… Flashcard ajoutÃ©e');
  }
  closeFlashModal();
  initStudyOrder();
  saveToStorage();
  render();
}

function deleteFlashcard(id) {
  if (!confirm('Supprimer cette flashcard ?')) return;
  DATA.flashcards = DATA.flashcards.filter(f => f.id !== id);
  initStudyOrder();
  saveToStorage();
  render();
  toast('ğŸ—‘ï¸ Flashcard supprimÃ©e');
}

function importFlashCSV() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,.txt';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const lines = ev.target.result.split('\n');
      let count = 0;
      lines.forEach(line => {
        // Support both comma and pipe separators
        let parts = line.includes('|') ? line.split('|') : line.split(',');
        if (parts.length >= 2) {
          const q = parts[0].replace(/^"|"$/g, '').trim();
          const a = parts.slice(1).join(',').replace(/^"|"$/g, '').trim();
          if (q && a) {
            DATA.flashcards.push({id: 'FC-' + Date.now() + '-' + count, question: q, answer: a});
            count++;
          }
        }
      });
      initStudyOrder();
      saveToStorage();
      render();
      toast(`âœ… ${count} flashcards importÃ©es`);
    };
    reader.readAsText(file);
  };
  input.click();
}

function exportFlashCSV() {
  const csv = DATA.flashcards.map(f => `"${f.question.replace(/"/g, '""')}","${f.answer.replace(/"/g, '""')}"`).join('\n');
  const blob = new Blob(['Question,RÃ©ponse\n' + csv], {type: 'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-flashcards-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Flashcards exportÃ©es en CSV');
}

// ========== CONTACT MODAL ==========
function openContactModal(id = null) {
  $('contactEditId').value = '';
  $('contactName').value = '';
  $('contactType').value = '';
  $('contactZone').value = '';
  $('contactWeb').value = '';
  $('contactEmail').value = '';
  $('contactStatus').value = '';
  $('contactNotes').value = '';
  $('contactModalTitle').textContent = 'Nouveau Contact';
  
  if (id) {
    const c = DATA.contacts.find(x => x.id === id);
    if (c) {
      $('contactEditId').value = id;
      $('contactName').value = c.name || '';
      $('contactType').value = c.type || '';
      $('contactZone').value = c.zone || '';
      $('contactWeb').value = c.web || '';
      $('contactEmail').value = c.email || '';
      $('contactStatus').value = c.status || '';
      $('contactNotes').value = c.notes || '';
      $('contactModalTitle').textContent = 'Modifier Contact';
    }
  }
  $('contactModal').classList.add('open');
}

function closeContactModal() {
  $('contactModal').classList.remove('open');
}

function saveContact() {
  const name = $('contactName').value.trim();
  if (!name) return toast('âŒ Nom requis');
  
  const editId = $('contactEditId').value;
  const data = {
    name,
    type: $('contactType').value.trim(),
    zone: $('contactZone').value.trim(),
    web: $('contactWeb').value.trim(),
    email: $('contactEmail').value.trim(),
    status: $('contactStatus').value,
    notes: $('contactNotes').value.trim()
  };
  
  if (editId) {
    const c = DATA.contacts.find(x => x.id === editId);
    if (c) Object.assign(c, data);
    toast('âœ… Contact modifiÃ©');
  } else {
    DATA.contacts.push({id: 'CON-' + Date.now(), ...data});
    toast('âœ… Contact ajoutÃ©');
  }
  closeContactModal();
  saveToStorage();
  render();
}

function deleteContact(id) {
  if (!confirm('Supprimer ce contact ?')) return;
  DATA.contacts = DATA.contacts.filter(c => c.id !== id);
  saveToStorage();
  render();
  toast('ğŸ—‘ï¸ Contact supprimÃ©');
}

function importContactsXLSX() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xlsx,.xls,.csv';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.name.endsWith('.csv')) {
      // CSV import
      const reader = new FileReader();
      reader.onload = ev => {
        const lines = ev.target.result.split('\n');
        let count = 0;
        lines.slice(1).forEach(line => { // Skip header
          const parts = line.split(',');
          if (parts.length >= 1 && parts[0].trim()) {
            DATA.contacts.push({
              id: 'CON-' + Date.now() + '-' + count,
              name: parts[0]?.replace(/"/g, '').trim() || '',
              web: parts[1]?.replace(/"/g, '').trim() || '',
              type: parts[2]?.replace(/"/g, '').trim() || '',
              zone: parts[3]?.replace(/"/g, '').trim() || '',
              email: parts[4]?.replace(/"/g, '').trim() || '',
              status: parts[5]?.replace(/"/g, '').trim() || ''
            });
            count++;
          }
        });
        saveToStorage();
        render();
        toast(`âœ… ${count} contacts importÃ©s`);
      };
      reader.readAsText(file);
    } else {
      toast('ğŸ“‹ Pour Excel, exportez d\'abord en CSV depuis Excel');
    }
  };
  input.click();
}

function exportContactsCSV() {
  const headers = 'Nom,Site Web,Type,Zone,Email,Statut,Notes';
  const csv = DATA.contacts.map(c => 
    `"${(c.name||'').replace(/"/g, '""')}","${(c.web||'').replace(/"/g, '""')}","${(c.type||'').replace(/"/g, '""')}","${(c.zone||'').replace(/"/g, '""')}","${(c.email||'').replace(/"/g, '""')}","${(c.status||'').replace(/"/g, '""')}","${(c.notes||'').replace(/"/g, '""')}"`
  ).join('\n');
  const blob = new Blob([headers + '\n' + csv], {type: 'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-contacts-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Contacts exportÃ©s en CSV');
}

// ========== IMPORT MODAL ==========
function closeImportModal() {
  $('importModal').classList.remove('open');
}

// ========== MISSIONS ==========
function openMissionModal(id = null) {
  $('missionEditId').value = '';
  $('missionTitle').value = '';
  $('missionType').value = 'exploration';
  $('missionDesc').value = '';
  $('missionXP').value = '10';
  $('missionDeadline').value = '';
  $('missionModalTitle').textContent = 'Nouvelle Mission';
  
  // Populate entity select
  const entities = [
    ...DATA.lieux.map(l => ({id: l.id, name: l.name, type: 'Lieu'})),
    ...DATA.ssm.map(s => ({id: s.id, name: s.name, type: s.type})),
    ...DATA.urgences.map(u => ({id: u.id, name: u.name, type: 'Urgence'}))
  ];
  $('missionEntity').innerHTML = '<option value="">Aucune entitÃ© liÃ©e</option>' + 
    entities.map(e => `<option value="${e.id}">[${e.type}] ${esc(e.name)}</option>`).join('');
  
  if (id) {
    const m = DATA.missions.find(x => x.id === id);
    if (m) {
      $('missionEditId').value = id;
      $('missionTitle').value = m.title;
      $('missionType').value = m.type;
      $('missionDesc').value = m.desc || '';
      $('missionEntity').value = m.entity || '';
      $('missionXP').value = m.xp || 10;
      $('missionDeadline').value = m.deadline || '';
      $('missionModalTitle').textContent = 'Modifier Mission';
    }
  }
  $('missionModal').classList.add('open');
}

function closeMissionModal() {
  $('missionModal').classList.remove('open');
}

function saveMission() {
  const title = $('missionTitle').value.trim();
  if (!title) return toast('âŒ Titre requis');
  
  const editId = $('missionEditId').value;
  const data = {
    title,
    type: $('missionType').value,
    desc: $('missionDesc').value.trim(),
    entity: $('missionEntity').value,
    xp: parseInt($('missionXP').value) || 10,
    deadline: $('missionDeadline').value || null,
    status: 'active'
  };
  
  if (editId) {
    const m = DATA.missions.find(x => x.id === editId);
    if (m) Object.assign(m, data);
    toast('âœ… Mission modifiÃ©e');
  } else {
    DATA.missions.push({id: 'M-' + Date.now(), createdAt: new Date().toISOString().split('T')[0], ...data});
    toast('âœ… Mission crÃ©Ã©e');
  }
  closeMissionModal();
  saveToStorage();
  renderMissions();
}

function completeMission(id) {
  const m = DATA.missions.find(x => x.id === id);
  if (!m) return;
  m.status = 'completed';
  m.completedAt = new Date().toISOString().split('T')[0];
  
  // Add XP
  addXP(m.xp, `Mission: ${m.title}`);
  
  // Discover zone if entity linked
  if (m.entity) {
    const lieu = DATA.lieux.find(l => l.id === m.entity);
    if (lieu && lieu.commune) discoverZone(lieu.commune);
  }
  
  saveToStorage();
  renderMissions();
  renderProfil();
  checkBadges();
  toast(`ğŸ‰ Mission complÃ©tÃ©e ! +${m.xp} XP`);
}

function deleteMission(id) {
  if (!confirm('Supprimer cette mission ?')) return;
  DATA.missions = DATA.missions.filter(m => m.id !== id);
  saveToStorage();
  renderMissions();
  toast('ğŸ—‘ï¸ Mission supprimÃ©e');
}

function renderMissions() {
  const active = DATA.missions.filter(m => m.status === 'active');
  const completed = DATA.missions.filter(m => m.status === 'completed');
  
  const exploration = active.filter(m => m.type === 'exploration');
  const interaction = active.filter(m => m.type === 'interaction');
  const transformation = active.filter(m => m.type === 'transformation');
  
  // Stats
  $('statExploration').textContent = exploration.length;
  $('statInteraction').textContent = interaction.length;
  $('statTransformation').textContent = transformation.length;
  $('badgeExploration').textContent = exploration.length;
  $('badgeInteraction').textContent = interaction.length;
  $('badgeTransformation').textContent = transformation.length;
  $('badgeCompleted').textContent = completed.length;
  
  // Progress
  const total = DATA.missions.length;
  const percent = total ? Math.round((completed.length / total) * 100) : 0;
  $('missionsProgress').textContent = `${completed.length}/${total} complÃ©tÃ©es`;
  $('missionPercent').textContent = percent + '%';
  $('missionProgressBar').style.width = percent + '%';
  
  // Render mission card
  const renderCard = (m) => {
    const entity = [...DATA.lieux, ...DATA.ssm, ...DATA.urgences].find(e => e.id === m.entity);
    return `<div style="padding:12px;background:var(--elevated);border-radius:8px;border-left:3px solid var(--${m.type === 'exploration' ? 'liens' : m.type === 'interaction' ? 'ssm' : 'mobile'})">
      <div style="display:flex;justify-content:space-between;align-items:start;gap:8px">
        <div style="font-weight:600">${m.imported ? 'ğŸ“¥ ' : ''}${esc(m.title)}</div>
        <span style="font-family:var(--mono);font-size:12px;color:var(--liens)">+${m.xp} XP</span>
      </div>
      ${m.desc ? `<div style="font-size:13px;color:var(--muted);margin-top:4px">${esc(m.desc)}</div>` : ''}
      ${entity ? `<div style="font-size:12px;color:var(--info);margin-top:6px">ğŸ“ ${esc(entity.name)}</div>` : ''}
      ${m.deadline ? `<div style="font-size:12px;color:var(--warn);margin-top:4px">â° ${m.deadline}</div>` : ''}
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" style="height:28px;font-size:11px" onclick="completeMission('${m.id}')">âœ“ ComplÃ©ter</button>
        <button class="btn" style="height:28px;font-size:11px" onclick="openMissionModal('${m.id}')">âœï¸</button>
        <button class="btn" style="height:28px;font-size:11px" onclick="shareMission('${m.id}')" title="Partager">ğŸ“¤</button>
        <button class="btn" style="height:28px;font-size:11px" onclick="deleteMission('${m.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  };
  
  $('listExploration').innerHTML = exploration.length ? exploration.map(renderCard).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucune mission</div>';
  $('listInteraction').innerHTML = interaction.length ? interaction.map(renderCard).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucune mission</div>';
  $('listTransformation').innerHTML = transformation.length ? transformation.map(renderCard).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucune mission</div>';
  
  // Completed
  $('listCompleted').innerHTML = completed.length ? completed.map(m => `
    <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:var(--elevated);border-radius:6px;opacity:0.7">
      <span style="color:var(--liens)">âœ“</span>
      <span style="flex:1">${esc(m.title)}</span>
      <span style="font-size:12px;color:var(--muted)">${m.completedAt || ''}</span>
      <span style="font-family:var(--mono);font-size:12px;color:var(--liens)">+${m.xp} XP</span>
    </div>
  `).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucune mission complÃ©tÃ©e</div>';
}

// ========== NOTES ==========
function openNotesModal(entityId) {
  $('notesEntityId').value = entityId;
  const entity = [...DATA.lieux, ...DATA.ssm, ...DATA.urgences].find(e => e.id === entityId);
  $('notesModalTitle').textContent = 'Notes - ' + (entity?.name || entityId);
  $('newNoteText').value = '';
  renderNotes(entityId);
  $('notesModal').classList.add('open');
}

function closeNotesModal() {
  $('notesModal').classList.remove('open');
}

function renderNotes(entityId) {
  const notes = DATA.notes.filter(n => n.entityId === entityId);
  $('notesList').innerHTML = notes.length ? notes.map(n => `
    <div style="padding:12px;background:var(--elevated);border-radius:8px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:12px;color:var(--muted)">${n.createdAt}</span>
        <button class="btn" style="height:24px;padding:0 8px;font-size:11px" onclick="deleteNote('${n.id}')">âœ•</button>
      </div>
      <div style="color:var(--text2)">${esc(n.text)}</div>
    </div>
  `).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucune note</div>';
}

function addNote() {
  const entityId = $('notesEntityId').value;
  const text = $('newNoteText').value.trim();
  if (!text) return toast('âŒ Note vide');
  
  DATA.notes.push({
    id: 'N-' + Date.now(),
    entityId,
    text,
    createdAt: new Date().toLocaleString('fr-BE')
  });
  $('newNoteText').value = '';
  
  // XP for notes
  if (DATA.notes.length === 1) addXP(5, 'PremiÃ¨re note rÃ©digÃ©e');
  else if (DATA.notes.length === 10) addXP(10, '10 notes rÃ©digÃ©es');
  
  saveToStorage();
  renderNotes(entityId);
  checkBadges();
  toast('âœ… Note ajoutÃ©e');
}

function deleteNote(id) {
  DATA.notes = DATA.notes.filter(n => n.id !== id);
  saveToStorage();
  const entityId = $('notesEntityId').value;
  renderNotes(entityId);
  toast('ğŸ—‘ï¸ Note supprimÃ©e');
}

// ========== GAMIFICATION ==========
function addXP(amount, reason) {
  const oldLevel = getRank().level;
  DATA.profil.xp += amount;
  
  // Award spec point on level up
  const newLevel = getRank().level;
  if (newLevel > oldLevel) {
    DATA.profil.specPoints += (newLevel - oldLevel);
    addJournalEntry(`ğŸ‰ Niveau ${newLevel} atteint ! +1 point de spÃ©cialisation`);
    toast(`ğŸ‰ Niveau ${newLevel} atteint !`);
  }
  
  addJournalEntry(`+${amount} XP: ${reason}`);
  recordActiveDay();
  saveToStorage();
  renderProfil();
}

function recordActiveDay() {
  const today = new Date().toISOString().split('T')[0];
  if (!DATA.profil.activeDays.includes(today)) {
    DATA.profil.activeDays.push(today);
    // Keep last 84 days (12 weeks)
    if (DATA.profil.activeDays.length > 84) {
      DATA.profil.activeDays = DATA.profil.activeDays.slice(-84);
    }
  }
}

function recordFicheView(entityId) {
  if (!DATA.profil.fichesViewed.includes(entityId)) {
    DATA.profil.fichesViewed.push(entityId);
    if (DATA.profil.fichesViewed.length === 10) {
      addXP(5, '10 fiches consultÃ©es');
    }
    saveToStorage();
    checkBadges();
  }
}

function discoverZone(commune) {
  if (!DATA.profil.discoveredZones.includes(commune)) {
    DATA.profil.discoveredZones.push(commune);
    addJournalEntry(`ğŸ—ºï¸ Nouvelle zone dÃ©couverte: ${commune}`);
    const bonus = DATA.profil.specs.cartographe > 0 ? 7 : 5;
    addXP(bonus, `Zone dÃ©couverte: ${commune}`);
  }
}

function unlockBadge(badgeId) {
  if (DATA.profil.unlockedBadges.includes(badgeId)) return;
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  
  DATA.profil.unlockedBadges.push(badgeId);
  addJournalEntry(`ğŸ† Badge dÃ©bloquÃ©: ${badge.icon} ${badge.name}`);
  if (badge.xp > 0) addXP(badge.xp, `Badge: ${badge.name}`);
  saveToStorage();
  renderProfil();
  
  // Special toast for secret badges
  if (badge.secret) {
    toast(`ğŸ Badge secret dÃ©bloquÃ©: ${badge.icon} ${badge.name}!`);
  } else {
    toast(`ğŸ† Badge dÃ©bloquÃ©: ${badge.icon} ${badge.name}!`);
  }
}

function addJournalEntry(text) {
  DATA.profil.journal.unshift({
    text,
    date: new Date().toLocaleString('fr-BE')
  });
  // Keep last 100 entries
  if (DATA.profil.journal.length > 100) DATA.profil.journal = DATA.profil.journal.slice(0, 100);
}

function getStats() {
  const completed = DATA.missions.filter(m => m.status === 'completed');
  const hour = new Date().getHours();
  return {
    missions_completed: completed.length,
    exploration_completed: completed.filter(m => m.type === 'exploration').length,
    interaction_completed: completed.filter(m => m.type === 'interaction').length,
    transformation_completed: completed.filter(m => m.type === 'transformation').length,
    zones_discovered: DATA.profil.discoveredZones.length,
    links_created: Math.max(0, DATA.links.length - 17),
    notes_created: DATA.notes.length,
    flashcards_reviewed: DATA.profil.flashcardsReviewed || 0,
    lieux_added: Math.max(0, DATA.lieux.length - 20),
    fiches_viewed: (DATA.profil.fichesViewed || []).length,
    reseaux_discovered: DATA.profil.discoveredZones.length >= 4 ? 4 : 0,
    alert_lieux_visited: (DATA.profil.fichesViewed || []).includes('LDL-005') ? 1 : 0,
    days_active: (DATA.profil.activeDays || []).length,
    night_owl: hour >= 22 || hour < 5 ? 1 : 0,
    early_bird: hour >= 5 && hour < 7 ? 1 : 0,
    xp: DATA.profil.xp
  };
}

function checkBadges() {
  const stats = getStats();
  
  BADGES.forEach(badge => {
    if (DATA.profil.unlockedBadges.includes(badge.id)) return;
    
    // Parse condition
    const match = badge.condition.match(/(\w+)\s*(>=|>|==)\s*(\d+)/);
    if (!match) return;
    
    const [, stat, op, value] = match;
    const statValue = stats[stat] || 0;
    const targetValue = parseInt(value);
    
    let unlocked = false;
    if (op === '>=' && statValue >= targetValue) unlocked = true;
    if (op === '>' && statValue > targetValue) unlocked = true;
    if (op === '==' && statValue === targetValue) unlocked = true;
    
    if (unlocked) unlockBadge(badge.id);
  });
}

function investSpecPoint(specId) {
  if (DATA.profil.specPoints <= 0) return toast('âŒ Pas de points disponibles');
  const totalInvested = Object.values(DATA.profil.specs).reduce((a,b) => a+b, 0);
  const maxPerSpec = 3;
  
  if (DATA.profil.specs[specId] >= maxPerSpec) return toast('âŒ SpÃ©cialisation au maximum');
  
  DATA.profil.specs[specId]++;
  DATA.profil.specPoints--;
  
  const spec = SPECIALIZATIONS.find(s => s.id === 'spec-' + specId);
  const skill = spec?.skills.find(s => s.unlockAt === DATA.profil.specs[specId]);
  if (skill) {
    addJournalEntry(`ğŸŒ³ CompÃ©tence dÃ©bloquÃ©e: ${skill.name}`);
    toast(`âœ¨ ${skill.name} dÃ©bloquÃ© !`);
  }
  
  saveToStorage();
  renderProfil();
}

function getRank() {
  const xp = DATA.profil.xp;
  let rank = RANKS[0];
  for (const r of RANKS) {
    if (xp >= r.minXP) rank = r;
  }
  return rank;
}

function getNextRank() {
  const currentRank = getRank();
  const nextIndex = RANKS.findIndex(r => r.level === currentRank.level) + 1;
  return RANKS[nextIndex] || null;
}

function renderProfil() {
  const p = DATA.profil;
  const rank = getRank();
  const nextRank = getNextRank();
  const stats = getStats();
  
  // Basic info
  $('profilName').value = p.name;
  $('profilAvatar').textContent = p.avatar;
  $('profilXP').textContent = p.xp;
  $('profilLevel').textContent = rank.level;
  $('profilTitle').textContent = rank.title;
  $('profilRank').textContent = rank.name;
  $('navXP').textContent = p.xp + ' XP';
  
  // XP Progress
  if (nextRank) {
    const xpInLevel = p.xp - rank.minXP;
    const xpNeeded = nextRank.minXP - rank.minXP;
    const pct = Math.min(100, Math.round((xpInLevel / xpNeeded) * 100));
    $('profilNextXP').textContent = `${xpInLevel}/${xpNeeded} XP`;
    $('profilXPBar').style.width = pct + '%';
  } else {
    $('profilNextXP').textContent = 'MAX';
    $('profilXPBar').style.width = '100%';
  }
  
  // Random quote
  const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
  if ($('profilQuote')) $('profilQuote').textContent = `"${quote.text}"`;
  if ($('profilQuoteAuthor')) $('profilQuoteAuthor').textContent = `â€” ${quote.author}`;
  
  // Stats
  $('statMissionsCompleted').textContent = stats.missions_completed;
  $('statLieuxDiscovered').textContent = p.discoveredZones.length;
  $('statLinksCreated').textContent = Math.max(0, stats.links_created);
  $('statNotesCreated').textContent = stats.notes_created;
  $('statFlashMastered').textContent = p.flashcardsReviewed || 0;
  
  // Specializations
  $('specPoints').textContent = (p.specPoints || 0) + ' pts';
  $('specGrid').innerHTML = SPECIALIZATIONS.map(spec => {
    const specKey = spec.id.replace('spec-', '');
    const level = p.specs?.[specKey] || 0;
    const canInvest = (p.specPoints || 0) > 0 && level < 3;
    return `<div style="padding:16px;background:var(--elevated);border-radius:12px;border-left:4px solid var(--${spec.color})">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <span style="font-size:28px">${spec.icon}</span>
        <div>
          <div style="font-weight:700">${spec.name}</div>
          <div style="font-size:11px;color:var(--muted)">${spec.desc}</div>
        </div>
      </div>
      <div style="display:flex;gap:4px;margin-bottom:12px">
        ${[1,2,3].map(i => `<div style="flex:1;height:6px;background:${i <= level ? `var(--${spec.color})` : 'var(--border2)'};border-radius:3px"></div>`).join('')}
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:8px">
        ${spec.skills.map(s => `<div style="opacity:${s.unlockAt <= level ? 1 : 0.4};margin-bottom:4px">${s.unlockAt <= level ? 'âœ“' : 'â—‹'} ${s.name}</div>`).join('')}
      </div>
      ${canInvest ? `<button class="btn primary" style="width:100%;height:32px;font-size:12px" onclick="investSpecPoint('${specKey}')">+ Investir 1 point</button>` : level >= 3 ? `<div style="text-align:center;color:var(--liens);font-size:12px">âœ¨ MaÃ®trisÃ©</div>` : ''}
    </div>`;
  }).join('');
  
  // Activity calendar (last 12 weeks)
  const today = new Date();
  const calendarDays = [];
  for (let i = 83; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const isActive = (p.activeDays || []).includes(dateStr);
    calendarDays.push({date: dateStr, active: isActive, isToday: i === 0});
  }
  $('activityCalendar').innerHTML = calendarDays.map(d => 
    `<div style="width:12px;height:12px;border-radius:2px;background:${d.active ? 'var(--liens)' : 'var(--border2)'};opacity:${d.isToday ? 1 : 0.8}" title="${d.date}${d.active ? ' âœ“' : ''}"></div>`
  ).join('');
  $('streakBadge').textContent = (p.activeDays || []).length + ' jours';
  
  // Badges with filter
  const badgesUnlocked = p.unlockedBadges.length;
  $('badgesCount').textContent = `${badgesUnlocked}/${BADGES.length}`;
  renderBadges('all');
  
  // Fog of War - Communes
  const communes = ['Bruxelles','Schaerbeek','Etterbeek','Ixelles','Saint-Gilles','Anderlecht','Molenbeek','Jette','NOH','Auderghem','Forest','Woluwe-SL'];
  const discoveredCount = p.discoveredZones.length;
  const fogPct = Math.round((discoveredCount / communes.length) * 100);
  $('fogProgress').textContent = fogPct + '%';
  
  $('fogGrid').innerHTML = communes.map(c => {
    const isDiscovered = p.discoveredZones.includes(c);
    return `<div style="padding:12px;background:${isDiscovered ? 'rgba(125,249,200,.15)' : 'var(--elevated)'};border-radius:8px;text-align:center;border:1px solid ${isDiscovered ? 'var(--liens)' : 'var(--border2)'};transition:all .3s">
      <div style="font-size:20px;margin-bottom:4px">${isDiscovered ? 'âœ…' : 'ğŸŒ«ï¸'}</div>
      <div style="font-size:11px;font-weight:600;color:${isDiscovered ? 'var(--liens)' : 'var(--muted)'}">${isDiscovered ? c : '???'}</div>
    </div>`;
  }).join('');
  
  // Story / Narrative text
  renderStory();
  
  // Journal
  $('journalList').innerHTML = p.journal.length ? p.journal.slice(0, 30).map(j => `
    <div style="display:flex;gap:12px;padding:8px 12px;background:var(--elevated);border-radius:6px">
      <span style="font-size:12px;color:var(--muted);white-space:nowrap">${j.date.split(' ')[0]}</span>
      <span style="flex:1">${esc(j.text)}</span>
    </div>
  `).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Votre aventure commence...</div>';
}

let badgeFilter = 'all';
function filterBadges(filter) {
  badgeFilter = filter;
  renderBadges(filter);
}

function renderBadges(filter) {
  const p = DATA.profil;
  let badges = BADGES;
  
  if (filter === 'unlocked') badges = BADGES.filter(b => p.unlockedBadges.includes(b.id));
  if (filter === 'locked') badges = BADGES.filter(b => !p.unlockedBadges.includes(b.id) && !b.secret);
  
  $('badgesGrid').innerHTML = badges.length ? badges.map(b => {
    const unlocked = p.unlockedBadges.includes(b.id);
    const isSecret = b.secret && !unlocked;
    return `<div style="padding:16px;background:var(--elevated);border-radius:12px;text-align:center;opacity:${unlocked ? 1 : 0.5};border:2px solid ${unlocked ? 'var(--warn)' : 'transparent'};transition:all .2s" title="${isSecret ? 'Badge secret' : b.desc}">
      <div style="font-size:32px;margin-bottom:8px;${unlocked ? '' : 'filter:grayscale(1)'}">${isSecret ? 'â“' : b.icon}</div>
      <div style="font-weight:600;font-size:12px">${isSecret ? '???' : b.name}</div>
      ${unlocked ? `<div style="font-size:10px;color:var(--liens);margin-top:4px">+${b.xp} XP</div>` : isSecret ? `<div style="font-size:10px;color:var(--muted);margin-top:4px">Secret</div>` : `<div style="font-size:10px;color:var(--muted);margin-top:4px">${b.desc}</div>`}
    </div>`;
  }).join('') : '<div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">Aucun badge dans cette catÃ©gorie</div>';
}

function renderStory() {
  const p = DATA.profil;
  const rank = getRank();
  const missions = DATA.missions.filter(m => m.status === 'completed').length;
  const zones = p.discoveredZones.length;
  
  let story = '';
  
  if (missions === 0) {
    story = `<p>Vous venez de rejoindre l'Agence de Renseignement Citoyenne. Le rÃ©seau de santÃ© mentale bruxellois s'Ã©tend devant vous, vaste et fragmentÃ©. Votre mission : le cartographier, tisser des liens, et devenir un guide pour ceux qui cherchent leur chemin.</p>
    <p style="margin-top:12px;color:var(--liens)">â†’ Commencez par explorer la section Missions pour votre premiÃ¨re quÃªte.</p>`;
  } else if (missions < 5) {
    story = `<p>${p.name} fait ses premiers pas dans le rÃ©seau. ${missions} mission${missions > 1 ? 's' : ''} accomplie${missions > 1 ? 's' : ''}, ${zones} zone${zones > 1 ? 's' : ''} dÃ©couverte${zones > 1 ? 's' : ''}.</p>
    <p style="margin-top:12px">Le brouillard se dissipe lentement. Chaque lieu visitÃ© rÃ©vÃ¨le de nouvelles connexions.</p>`;
  } else if (missions < 15) {
    story = `<p>${p.name}, ${rank.title.toLowerCase()}, commence Ã  comprendre l'architecture invisible du rÃ©seau. Les liens entre les lieux de liens, les SSM et les Ã©quipes mobiles dessinent une carte que peu de gens connaissent.</p>
    <p style="margin-top:12px">${zones >= 6 ? 'Plus de la moitiÃ© de Bruxelles vous est maintenant familiÃ¨re.' : 'Certaines communes restent encore Ã  explorer.'}</p>`;
  } else {
    story = `<p>${p.name} est devenuÂ·e une figure respectÃ©e de l'Agence. Avec ${missions} missions accomplies et ${zones} zones maÃ®trisÃ©es, vous Ãªtes dÃ©sormais un guide pour les nouveaux agents.</p>
    <p style="margin-top:12px;color:var(--warn)">Votre expertise du rÃ©seau fait de vous une ressource prÃ©cieuse. Continuez Ã  tisser des liens.</p>`;
  }
  
  $('storyText').innerHTML = story;
}

function openAvatarPicker() {
  $('avatarGrid').innerHTML = AVATARS.map(a => 
    `<div style="font-size:28px;padding:10px;cursor:pointer;text-align:center;border-radius:8px;transition:background .2s" 
      onclick="selectAvatar('${a}')" 
      onmouseover="this.style.background='var(--elevated)'" 
      onmouseout="this.style.background='transparent'">${a}</div>`
  ).join('');
  $('avatarModal').classList.add('open');
}

function closeAvatarPicker() {
  $('avatarModal').classList.remove('open');
}

function selectAvatar(emoji) {
  DATA.profil.avatar = emoji;
  saveToStorage();
  renderProfil();
  closeAvatarPicker();
  toast('âœ… Avatar mis Ã  jour');
}

function exportJournal() {
  const text = DATA.profil.journal.map(j => `[${j.date}] ${j.text}`).join('\n');
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyxo-journal-${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  toast('âœ… Journal exportÃ©');
}

function discoverZoneManual(commune) {
  toast('ğŸ’¡ ComplÃ©tez une mission ou ajoutez un lieu dans cette zone pour la dÃ©couvrir!');
}

// Save profil name on change
function initProfilListeners() {
  $('profilName')?.addEventListener('change', e => {
    DATA.profil.name = e.target.value || 'Agent Anonyme';
    saveToStorage();
    toast('âœ… Nom de code enregistrÃ©');
  });
}

// ========== SOCIAL FEATURES ==========
const PROFILES_KEY = 'nyxo-profiles';
const CURRENT_PROFILE_KEY = 'nyxo-current-profile';

function getProfiles() {
  try {
    return JSON.parse(localStorage.getItem(PROFILES_KEY)) || {};
  } catch { return {}; }
}

function saveProfiles(profiles) {
  localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
}

function getCurrentProfileId() {
  return localStorage.getItem(CURRENT_PROFILE_KEY) || 'default';
}

function setCurrentProfile(id) {
  localStorage.setItem(CURRENT_PROFILE_KEY, id);
}

function openProfilesModal() {
  renderProfilesList();
  $('profilesModal').classList.add('open');
}

function closeProfilesModal() {
  $('profilesModal').classList.remove('open');
}

function renderProfilesList() {
  const profiles = getProfiles();
  const currentId = getCurrentProfileId();
  
  // Ensure current profile exists
  if (!profiles[currentId]) {
    profiles[currentId] = {
      name: DATA.profil.name || 'Agent Anonyme',
      xp: DATA.profil.xp || 0,
      avatar: DATA.profil.avatar || 'ğŸ•µï¸',
      createdAt: DATA.profil.createdAt || new Date().toISOString().split('T')[0]
    };
    saveProfiles(profiles);
  } else {
    // Update current profile stats
    profiles[currentId].name = DATA.profil.name;
    profiles[currentId].xp = DATA.profil.xp;
    profiles[currentId].avatar = DATA.profil.avatar;
    saveProfiles(profiles);
  }
  
  const sorted = Object.entries(profiles).sort((a, b) => b[1].xp - a[1].xp);
  
  $('profilesList').innerHTML = sorted.map(([id, p], index) => {
    const isCurrent = id === currentId;
    const rank = RANKS.filter(r => p.xp >= r.minXP).pop() || RANKS[0];
    return `<div style="display:flex;align-items:center;gap:12px;padding:16px;background:${isCurrent ? 'rgba(125,249,200,.1)' : 'var(--elevated)'};border-radius:12px;border:2px solid ${isCurrent ? 'var(--liens)' : 'transparent'}">
      <div style="font-size:14px;font-weight:700;color:${index === 0 ? 'var(--warn)' : 'var(--muted)'};width:24px">#${index + 1}</div>
      <div style="font-size:32px">${p.avatar || 'ğŸ•µï¸'}</div>
      <div style="flex:1">
        <div style="font-weight:600">${esc(p.name)}${isCurrent ? ' <span style="color:var(--liens)">(actuel)</span>' : ''}</div>
        <div style="font-size:12px;color:var(--muted)">${rank.name} â€¢ ${p.xp} XP</div>
      </div>
      ${!isCurrent ? `<button class="btn primary" onclick="switchProfile('${id}')">Charger</button>` : ''}
      ${!isCurrent ? `<button class="btn danger" onclick="deleteProfile('${id}')">ğŸ—‘ï¸</button>` : ''}
    </div>`;
  }).join('') || '<div style="color:var(--muted);text-align:center;padding:20px">Aucun profil</div>';
}

function createNewProfile() {
  const name = $('newProfileName').value.trim();
  if (!name) return toast('âŒ Entrez un nom de profil');
  
  const profiles = getProfiles();
  const newId = 'profile-' + Date.now();
  
  // Save current profile first
  const currentId = getCurrentProfileId();
  profiles[currentId] = {
    name: DATA.profil.name,
    xp: DATA.profil.xp,
    avatar: DATA.profil.avatar,
    createdAt: DATA.profil.createdAt
  };
  
  // Create new profile entry
  profiles[newId] = {
    name: name,
    xp: 0,
    avatar: 'ğŸ•µï¸',
    createdAt: new Date().toISOString().split('T')[0]
  };
  saveProfiles(profiles);
  
  // Save current data to storage with old key
  const oldKey = STORAGE_KEY + '-' + currentId;
  localStorage.setItem(oldKey, localStorage.getItem(STORAGE_KEY));
  
  // Reset DATA for new profile
  DATA.profil = {
    name: name,
    avatar: 'ğŸ•µï¸',
    xp: 0,
    specPoints: 0,
    specs: {cartographe:0, archiviste:0, tisseur:0, mediateur:0},
    discoveredZones: [],
    unlockedBadges: [],
    activeDays: [],
    fichesViewed: [],
    flashcardsReviewed: 0,
    journal: [],
    createdAt: new Date().toISOString().split('T')[0]
  };
  DATA.missions = DATA.missions.map(m => ({...m, status: 'active', completedAt: null}));
  DATA.notes = [];
  
  setCurrentProfile(newId);
  saveToStorage();
  
  $('newProfileName').value = '';
  renderProfilesList();
  renderProfil();
  renderMissions();
  addJournalEntry('ğŸ® Nouveau profil crÃ©Ã©');
  toast('âœ… Profil crÃ©Ã© et activÃ©');
}

function switchProfile(id) {
  const profiles = getProfiles();
  if (!profiles[id]) return toast('âŒ Profil introuvable');
  
  // Save current profile
  const currentId = getCurrentProfileId();
  profiles[currentId] = {
    name: DATA.profil.name,
    xp: DATA.profil.xp,
    avatar: DATA.profil.avatar,
    createdAt: DATA.profil.createdAt
  };
  saveProfiles(profiles);
  
  // Save current data
  const oldKey = STORAGE_KEY + '-' + currentId;
  localStorage.setItem(oldKey, localStorage.getItem(STORAGE_KEY));
  
  // Load new profile data
  const newKey = STORAGE_KEY + '-' + id;
  const savedData = localStorage.getItem(newKey);
  if (savedData) {
    localStorage.setItem(STORAGE_KEY, savedData);
  } else {
    localStorage.removeItem(STORAGE_KEY);
  }
  
  setCurrentProfile(id);
  location.reload();
}

function deleteProfile(id) {
  if (!confirm('Supprimer ce profil ? Cette action est irrÃ©versible.')) return;
  
  const profiles = getProfiles();
  delete profiles[id];
  saveProfiles(profiles);
  
  localStorage.removeItem(STORAGE_KEY + '-' + id);
  renderProfilesList();
  toast('ğŸ—‘ï¸ Profil supprimÃ©');
}

// ========== CARTE DE VISITE ==========
function exportAgentCard() {
  const canvas = $('cardCanvas');
  const ctx = canvas.getContext('2d');
  const p = DATA.profil;
  const rank = getRank();
  const stats = getStats();
  
  // Background gradient
  const grad = ctx.createLinearGradient(0, 0, 600, 400);
  grad.addColorStop(0, '#0a0b10');
  grad.addColorStop(1, '#12141d');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, 600, 400);
  
  // Border
  ctx.strokeStyle = '#7df9c8';
  ctx.lineWidth = 3;
  ctx.strokeRect(10, 10, 580, 380);
  
  // Inner decorative lines
  ctx.strokeStyle = 'rgba(125,249,200,.2)';
  ctx.lineWidth = 1;
  ctx.strokeRect(20, 20, 560, 360);
  
  // Header
  ctx.fillStyle = '#7df9c8';
  ctx.font = 'bold 14px "Space Grotesk", sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('AGENCE DE RENSEIGNEMENT CITOYENNE', 40, 55);
  
  // Avatar circle
  ctx.beginPath();
  ctx.arc(100, 150, 50, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(125,249,200,.15)';
  ctx.fill();
  ctx.strokeStyle = '#7df9c8';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Avatar emoji
  ctx.font = '48px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(p.avatar, 100, 165);
  
  // Name
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 28px "Space Grotesk", sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(p.name || 'Agent Anonyme', 180, 130);
  
  // Rank
  ctx.fillStyle = '#f9d77d';
  ctx.font = '18px "Space Grotesk", sans-serif';
  ctx.fillText(rank.title, 180, 160);
  
  // Stats grid
  const statsData = [
    {label: 'XP TOTAL', value: p.xp, color: '#f9d77d'},
    {label: 'NIVEAU', value: rank.level, color: '#7df9c8'},
    {label: 'MISSIONS', value: stats.missions_completed, color: '#c9a0ff'},
    {label: 'ZONES', value: p.discoveredZones.length + '/12', color: '#6bc5ff'}
  ];
  
  statsData.forEach((s, i) => {
    const x = 40 + (i % 2) * 270;
    const y = 240 + Math.floor(i / 2) * 70;
    
    ctx.fillStyle = 'rgba(125,249,200,.1)';
    ctx.fillRect(x, y, 240, 55);
    
    ctx.fillStyle = s.color;
    ctx.font = 'bold 24px "Space Mono", monospace';
    ctx.textAlign = 'left';
    ctx.fillText(String(s.value), x + 15, y + 35);
    
    ctx.fillStyle = '#888';
    ctx.font = '11px "Space Grotesk", sans-serif';
    ctx.fillText(s.label, x + 100, y + 35);
  });
  
  // Badges unlocked
  const badgeCount = p.unlockedBadges.length;
  ctx.fillStyle = '#888';
  ctx.font = '12px "Space Grotesk", sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText(`${badgeCount}/${BADGES.length} badges dÃ©bloquÃ©s`, 560, 370);
  
  // Footer
  ctx.fillStyle = 'rgba(125,249,200,.5)';
  ctx.font = '10px "Space Grotesk", sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('NYXO â€¢ Workspace SantÃ© Mentale Bruxelles', 40, 370);
  
  $('cardModal').classList.add('open');
}

function closeCardModal() {
  $('cardModal').classList.remove('open');
}

function downloadAgentCard() {
  const canvas = $('cardCanvas');
  const link = document.createElement('a');
  link.download = `nyxo-agent-${DATA.profil.name.replace(/\s+/g, '-')}-${Date.now()}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  toast('âœ… Carte tÃ©lÃ©chargÃ©e');
}

// ========== PARTAGE MISSIONS ==========
function shareMission(id) {
  const m = DATA.missions.find(x => x.id === id);
  if (!m) return;
  
  const shareData = {
    t: m.title,
    d: m.desc || '',
    y: m.type,
    x: m.xp
  };
  
  const encoded = btoa(encodeURIComponent(JSON.stringify(shareData)));
  const url = window.location.href.split('?')[0] + '?mission=' + encoded;
  
  $('shareMissionUrl').textContent = url;
  $('shareMissionModal').classList.add('open');
}

function closeShareMissionModal() {
  $('shareMissionModal').classList.remove('open');
}

function copyShareUrl() {
  const url = $('shareMissionUrl').textContent;
  navigator.clipboard.writeText(url).then(() => {
    toast('âœ… Lien copiÃ© !');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = url;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('âœ… Lien copiÃ© !');
  });
}

function importSharedMission() {
  const url = prompt('Collez le lien de mission partagÃ©e :');
  if (!url) return;
  
  try {
    const match = url.match(/[?&]mission=([^&]+)/);
    if (!match) throw new Error('Lien invalide');
    
    const decoded = JSON.parse(decodeURIComponent(atob(match[1])));
    
    // Check if mission already exists
    const exists = DATA.missions.some(m => m.title === decoded.t);
    if (exists) return toast('âš ï¸ Cette mission existe dÃ©jÃ ');
    
    const newMission = {
      id: 'M-' + Date.now(),
      title: decoded.t,
      desc: decoded.d || '',
      type: decoded.y || 'exploration',
      xp: decoded.x || 10,
      status: 'active',
      entity: '',
      createdAt: new Date().toISOString().split('T')[0],
      imported: true
    };
    
    DATA.missions.push(newMission);
    saveToStorage();
    renderMissions();
    addJournalEntry(`ğŸ“¥ Mission importÃ©e: ${newMission.title}`);
    toast('âœ… Mission importÃ©e !');
  } catch (e) {
    toast('âŒ Lien de mission invalide');
  }
}

function checkUrlForSharedMission() {
  const params = new URLSearchParams(window.location.search);
  const missionData = params.get('mission');
  
  if (missionData) {
    setTimeout(() => {
      try {
        const decoded = JSON.parse(decodeURIComponent(atob(missionData)));
        const exists = DATA.missions.some(m => m.title === decoded.t);
        
        if (!exists && confirm(`Voulez-vous importer la mission "${decoded.t}" ?`)) {
          const newMission = {
            id: 'M-' + Date.now(),
            title: decoded.t,
            desc: decoded.d || '',
            type: decoded.y || 'exploration',
            xp: decoded.x || 10,
            status: 'active',
            entity: '',
            createdAt: new Date().toISOString().split('T')[0],
            imported: true
          };
          
          DATA.missions.push(newMission);
          saveToStorage();
          renderMissions();
          addJournalEntry(`ğŸ“¥ Mission importÃ©e: ${newMission.title}`);
          toast('âœ… Mission importÃ©e !');
          
          // Clean URL
          window.history.replaceState({}, '', window.location.pathname);
        }
      } catch (e) {
        console.log('Invalid mission data in URL');
      }
    }, 500);
  }
}

// ========== CARTE LEAFLET ==========
let leafletMap = null;
let mapMarkers = [];
let userMarker = null;
let heatmapLayer = null;
let heatmapVisible = false;

// CoordonnÃ©es des communes bruxelloises pour heatmap
const COMMUNE_COORDS = {
  'Bruxelles': {lat: 50.8467, lng: 4.3517, bounds: [[50.83, 4.32], [50.87, 4.39]]},
  'Schaerbeek': {lat: 50.8676, lng: 4.3833, bounds: [[50.85, 4.36], [50.89, 4.42]]},
  'Etterbeek': {lat: 50.8356, lng: 4.3883, bounds: [[50.82, 4.37], [50.85, 4.42]]},
  'Ixelles': {lat: 50.8289, lng: 4.3744, bounds: [[50.81, 4.35], [50.85, 4.41]]},
  'Saint-Gilles': {lat: 50.8244, lng: 4.3456, bounds: [[50.81, 4.33], [50.84, 4.36]]},
  'Anderlecht': {lat: 50.8333, lng: 4.3067, bounds: [[50.81, 4.27], [50.86, 4.34]]},
  'Molenbeek': {lat: 50.8556, lng: 4.3222, bounds: [[50.84, 4.30], [50.87, 4.35]]},
  'Jette': {lat: 50.8778, lng: 4.3256, bounds: [[50.86, 4.30], [50.90, 4.36]]},
  'NOH': {lat: 50.8933, lng: 4.3567, bounds: [[50.88, 4.33], [50.91, 4.39]]},
  'Auderghem': {lat: 50.8133, lng: 4.4267, bounds: [[50.79, 4.40], [50.83, 4.46]]},
  'Forest': {lat: 50.8133, lng: 4.3222, bounds: [[50.79, 4.30], [50.83, 4.35]]},
  'Woluwe-SL': {lat: 50.8500, lng: 4.4333, bounds: [[50.83, 4.41], [50.87, 4.46]]}
};

function initLeafletMap() {
  if (leafletMap) return;
  
  // Centre de Bruxelles
  leafletMap = L.map('leafletMap', {
    zoomControl: true,
    attributionControl: true
  }).setView([50.8467, 4.3517], 12);
  
  // Tuiles CartoDB Dark (adaptÃ© au thÃ¨me sombre)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(leafletMap);
  
  // Event listeners pour les filtres
  $('mapShowLieux')?.addEventListener('change', updateMapMarkers);
  $('mapShowSSM')?.addEventListener('change', updateMapMarkers);
  $('mapShowMobile')?.addEventListener('change', updateMapMarkers);
  $('mapShowDiscovered')?.addEventListener('change', toggleDiscoveredZones);
  
  updateMapMarkers();
  updateMapStats();
}

function updateMapMarkers() {
  // Clear existing markers
  mapMarkers.forEach(m => leafletMap.removeLayer(m));
  mapMarkers = [];
  
  const showLieux = $('mapShowLieux')?.checked ?? true;
  const showSSM = $('mapShowSSM')?.checked ?? true;
  const showMobile = $('mapShowMobile')?.checked ?? false;
  
  // Add lieux markers
  if (showLieux) {
    DATA.lieux.forEach(lieu => {
      if (lieu.lat && lieu.lng) {
        const isAlert = lieu.status === 'at_risk';
        const marker = L.circleMarker([lieu.lat, lieu.lng], {
          radius: isAlert ? 10 : 8,
          fillColor: isAlert ? '#ff6b8a' : '#7df9c8',
          color: isAlert ? '#ff6b8a' : '#7df9c8',
          weight: isAlert ? 3 : 2,
          opacity: 1,
          fillOpacity: 0.7
        }).addTo(leafletMap);
        
        marker.bindPopup(createPopupContent(lieu, 'lieu'));
        marker.on('click', () => {
          recordFicheView(lieu.id);
          discoverZone(lieu.commune);
        });
        mapMarkers.push(marker);
      }
    });
  }
  
  // Add SSM markers
  if (showSSM) {
    DATA.ssm.filter(s => s.type === 'SSM' || s.type === 'Coordination').forEach(ssm => {
      if (ssm.lat && ssm.lng) {
        const marker = L.circleMarker([ssm.lat, ssm.lng], {
          radius: 7,
          fillColor: '#c9a0ff',
          color: '#c9a0ff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.7
        }).addTo(leafletMap);
        
        marker.bindPopup(createPopupContent(ssm, 'ssm'));
        marker.on('click', () => recordFicheView(ssm.id));
        mapMarkers.push(marker);
      }
    });
  }
  
  // Add mobile team markers
  if (showMobile) {
    DATA.ssm.filter(s => s.type === 'Ã‰quipe mobile').forEach(em => {
      if (em.lat && em.lng) {
        const marker = L.circleMarker([em.lat, em.lng], {
          radius: 6,
          fillColor: '#ffb86c',
          color: '#ffb86c',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.7
        }).addTo(leafletMap);
        
        marker.bindPopup(createPopupContent(em, 'mobile'));
        mapMarkers.push(marker);
      }
    });
  }
  
  $('mapLieuxCount').textContent = mapMarkers.length + ' marqueurs';
}

function createPopupContent(entity, type) {
  const isLieu = type === 'lieu';
  const color = type === 'lieu' ? '#7df9c8' : type === 'ssm' ? '#c9a0ff' : '#ffb86c';
  
  let actions = '';
  if (isLieu) {
    const lat = entity.lat;
    const lng = entity.lng;
    actions = `
      <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" style="padding:6px 10px;background:#4285f4;color:white;border-radius:4px;text-decoration:none;font-size:11px">ğŸ“ Google Maps</a>
        <a href="https://citymapper.com/directions?endcoord=${lat},${lng}" target="_blank" style="padding:6px 10px;background:#32d574;color:white;border-radius:4px;text-decoration:none;font-size:11px">ğŸš‡ Citymapper</a>
        <button onclick="openDetail('${entity.id}')" style="padding:6px 10px;background:${color};color:#000;border:none;border-radius:4px;cursor:pointer;font-size:11px">ğŸ“‹ DÃ©tails</button>
      </div>
    `;
  } else {
    actions = `<button onclick="openSSMDetail('${entity.id}')" style="margin-top:10px;padding:6px 10px;background:${color};color:#000;border:none;border-radius:4px;cursor:pointer;font-size:11px">ğŸ“‹ Voir fiche</button>`;
  }
  
  return `
    <div style="min-width:200px">
      <div style="font-weight:bold;font-size:14px;margin-bottom:6px;color:${color}">${entity.name}</div>
      ${entity.status === 'at_risk' ? '<div style="color:#ff6b8a;font-size:11px;margin-bottom:6px">âš ï¸ MENACÃ‰</div>' : ''}
      ${entity.adresse ? `<div style="font-size:12px;color:#888;margin-bottom:4px">ğŸ“ ${entity.adresse}</div>` : ''}
      ${entity.horaires ? `<div style="font-size:11px;color:#aaa;margin-bottom:4px">ğŸ• ${entity.horaires}</div>` : ''}
      ${entity.summary ? `<div style="font-size:12px;margin-top:8px">${entity.summary.substring(0, 100)}${entity.summary.length > 100 ? '...' : ''}</div>` : ''}
      ${actions}
    </div>
  `;
}

function geolocateMe() {
  $('geolocBtn').textContent = 'â³ Localisation...';
  $('geolocBtn').disabled = true;
  
  if (!navigator.geolocation) {
    toast('âŒ GÃ©olocalisation non supportÃ©e');
    $('geolocBtn').textContent = 'ğŸ“ Ma position';
    $('geolocBtn').disabled = false;
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      // Remove old user marker
      if (userMarker) leafletMap.removeLayer(userMarker);
      
      // Add user marker
      userMarker = L.circleMarker([lat, lng], {
        radius: 12,
        fillColor: '#6bc5ff',
        color: '#fff',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.9
      }).addTo(leafletMap);
      
      userMarker.bindPopup('<div style="text-align:center"><strong>ğŸ“ Vous Ãªtes ici</strong></div>').openPopup();
      
      // Center map
      leafletMap.setView([lat, lng], 14);
      
      // Find nearest lieux
      const distances = DATA.lieux
        .filter(l => l.lat && l.lng)
        .map(l => ({
          ...l,
          distance: getDistance(lat, lng, l.lat, l.lng)
        }))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 3);
      
      if (distances.length > 0) {
        toast(`ğŸ“ ${distances.length} lieux proches : ${distances[0].name} (${Math.round(distances[0].distance)}m)`);
      }
      
      $('geolocBtn').textContent = 'ğŸ“ Ma position';
      $('geolocBtn').disabled = false;
    },
    (error) => {
      toast('âŒ Erreur de gÃ©olocalisation');
      console.error(error);
      $('geolocBtn').textContent = 'ğŸ“ Ma position';
      $('geolocBtn').disabled = false;
    },
    {enableHighAccuracy: true, timeout: 10000}
  );
}

function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000; // Earth radius in meters
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function resetMapView() {
  if (leafletMap) {
    leafletMap.setView([50.8467, 4.3517], 12);
  }
}

function toggleHeatmap() {
  heatmapVisible = !heatmapVisible;
  
  if (heatmapVisible) {
    showDiscoveredHeatmap();
    $('heatmapBtn').style.background = 'var(--liens)';
    $('heatmapBtn').style.color = '#000';
  } else {
    hideHeatmap();
    $('heatmapBtn').style.background = '';
    $('heatmapBtn').style.color = '';
  }
}

function showDiscoveredHeatmap() {
  hideHeatmap();
  
  const discovered = DATA.profil.discoveredZones || [];
  
  Object.entries(COMMUNE_COORDS).forEach(([commune, coords]) => {
    const isDiscovered = discovered.includes(commune);
    
    const rect = L.rectangle(coords.bounds, {
      color: isDiscovered ? '#7df9c8' : '#ff6b8a',
      weight: 2,
      fillColor: isDiscovered ? '#7df9c8' : '#1a1a2e',
      fillOpacity: isDiscovered ? 0.2 : 0.5,
      interactive: true
    }).addTo(leafletMap);
    
    rect.bindPopup(`
      <div style="text-align:center">
        <div style="font-size:24px;margin-bottom:8px">${isDiscovered ? 'âœ…' : 'ğŸŒ«ï¸'}</div>
        <div style="font-weight:bold">${commune}</div>
        <div style="font-size:12px;color:${isDiscovered ? '#7df9c8' : '#888'}">${isDiscovered ? 'Zone dÃ©couverte' : 'Zone inexplorÃ©e'}</div>
      </div>
    `);
    
    if (!heatmapLayer) heatmapLayer = L.layerGroup();
    heatmapLayer.addLayer(rect);
  });
  
  if (heatmapLayer) heatmapLayer.addTo(leafletMap);
}

function hideHeatmap() {
  if (heatmapLayer) {
    leafletMap.removeLayer(heatmapLayer);
    heatmapLayer = null;
  }
}

function toggleDiscoveredZones() {
  if ($('mapShowDiscovered')?.checked) {
    showDiscoveredHeatmap();
  } else {
    hideHeatmap();
  }
}

function updateMapStats() {
  const discovered = (DATA.profil.discoveredZones || []).length;
  if ($('mapDiscoveredCount')) {
    $('mapDiscoveredCount').textContent = discovered + '/12';
  }
}

// ========== GRAPH FILTERS ==========
const graphFilters = {
  lieux: true,
  ssm: true,
  mobile: true,
  reseau: true,
  commune: '',
  reseau107: '',
  alerte: false
};

function updateGraphFilters() {
  graphFilters.lieux = $('graphFilterLieux')?.checked ?? true;
  graphFilters.ssm = $('graphFilterSSM')?.checked ?? true;
  graphFilters.mobile = $('graphFilterMobile')?.checked ?? true;
  graphFilters.reseau = $('graphFilterReseau')?.checked ?? true;
  graphFilters.commune = $('graphFilterCommune')?.value || '';
  graphFilters.reseau107 = $('graphFilterReseau107')?.value || '';
  graphFilters.alerte = $('graphFilterAlerte')?.checked ?? false;
}

function isNodeVisible(node) {
  updateGraphFilters();
  
  // Type filters
  if (node.type === 'lieu' && !graphFilters.lieux) return false;
  if (node.type === 'ssm' && !graphFilters.ssm) return false;
  if (node.type === 'coord' && !graphFilters.ssm) return false;
  if (node.type === 'mobile' && !graphFilters.mobile) return false;
  if (node.type === 'reseau' && !graphFilters.reseau) return false;
  
  // Commune filter
  if (graphFilters.commune && node.data?.commune !== graphFilters.commune) return false;
  
  // Reseau 107 filter
  if (graphFilters.reseau107) {
    const linkedToReseau = DATA.links.some(l => 
      (l.from === node.id && l.to === graphFilters.reseau107) ||
      (l.to === node.id && l.from === graphFilters.reseau107)
    );
    if (!linkedToReseau && node.id !== graphFilters.reseau107) return false;
  }
  
  // Alerte filter
  if (graphFilters.alerte && node.status !== 'at_risk') return false;
  
  return true;
}

// ========== GRAPH ==========
const graph = {
  canvas: null,
  ctx: null,
  nodes: [],
  view: { x: 0, y: 0, z: 1 },
  mode: 'ZONES',
  selectedId: null,
  hoverId: null,
  isDragging: false,
  dragStart: { x: 0, y: 0 },
  viewStart: { x: 0, y: 0 },
  animFrame: null
};

const GRAPH_COLORS = {
  lieu: '#7df9c8',
  ssm: '#c9a0ff',
  coord: '#6bc5ff',
  mobile: '#ffb86c',
  urgence: '#ff6b8a',
  reseau: '#6bc5ff'
};

function initGraph() {
  graph.canvas = $('graphCanvas');
  if (!graph.canvas) return;
  graph.ctx = graph.canvas.getContext('2d');
  
  // Build nodes from all entities
  graph.nodes = [];
  
  // Add lieux
  DATA.lieux.forEach(l => {
    const zone = DATA.zones.find(z => z.name.includes(l.commune) || l.commune.includes(z.name.split('-')[0]));
    const h = hashStr(l.id);
    graph.nodes.push({
      id: l.id,
      type: 'lieu',
      name: l.name,
      summary: l.summary,
      status: l.status,
      x: (zone?.x || 0) + Math.cos(h % 360 * Math.PI/180) * (30 + h % 60),
      y: (zone?.y || 0) + Math.sin(h % 360 * Math.PI/180) * (30 + h % 60),
      vx: 0, vy: 0,
      zone: zone?.id,
      data: l
    });
  });
  
  // Add SSM, coord, mobile
  DATA.ssm.forEach(s => {
    const h = hashStr(s.id);
    const isCoord = s.type === 'Coordination';
    const isMobile = s.type === 'Ã‰quipe mobile';
    graph.nodes.push({
      id: s.id,
      type: isCoord ? 'coord' : isMobile ? 'mobile' : 'ssm',
      name: s.name,
      summary: s.summary,
      x: (Math.random() - 0.5) * 200,
      y: (Math.random() - 0.5) * 200,
      vx: 0, vy: 0,
      data: s
    });
  });
  
  // Add reseaux
  DATA.reseaux.forEach(r => {
    graph.nodes.push({
      id: r.id,
      type: 'reseau',
      name: r.name + ' (' + r.zone + ')',
      summary: r.communes,
      x: (Math.random() - 0.5) * 300,
      y: (Math.random() - 0.5) * 300,
      vx: 0, vy: 0,
      data: r
    });
  });
  
  // Canvas events
  graph.canvas.addEventListener('pointerdown', onGraphPointerDown);
  graph.canvas.addEventListener('pointermove', onGraphPointerMove);
  graph.canvas.addEventListener('pointerup', onGraphPointerUp);
  graph.canvas.addEventListener('pointerleave', onGraphPointerUp);
  graph.canvas.addEventListener('wheel', onGraphWheel, { passive: false });
  
  // Buttons
  $('graphHomeBtn')?.addEventListener('click', () => { graph.view = { x: 0, y: 0, z: 1 }; toast('ğŸ  Vue recentrÃ©e'); });
  $('graphModeBtn')?.addEventListener('click', () => {
    graph.mode = graph.mode === 'ZONES' ? 'GRAPH' : 'ZONES';
    $('graphModeBtn').textContent = graph.mode;
    toast('Mode: ' + graph.mode);
  });
  $('graphRegenBtn')?.addEventListener('click', () => {
    graph.nodes.forEach(n => {
      const zone = DATA.zones.find(z => z.id === n.zone);
      if (zone) {
        const h = hashStr(n.id);
        n.x = zone.x + Math.cos(h % 360 * Math.PI/180) * (30 + h % 60);
        n.y = zone.y + Math.sin(h % 360 * Math.PI/180) * (30 + h % 60);
      }
      n.vx = n.vy = 0;
    });
    toast('ğŸ”„ Positions rÃ©gÃ©nÃ©rÃ©es');
  });
  
  // Start animation
  startGraphAnimation();
}

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i) | 0;
  return Math.abs(h);
}

function fitGraphCanvas() {
  if (!graph.canvas) return;
  const dpr = window.devicePixelRatio || 1;
  const rect = graph.canvas.getBoundingClientRect();
  graph.canvas.width = rect.width * dpr;
  graph.canvas.height = rect.height * dpr;
  graph.ctx.scale(dpr, dpr);
}

function screenToWorld(sx, sy) {
  const rect = graph.canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  return {
    x: (sx - w / 2) / graph.view.z - graph.view.x,
    y: (sy - h / 2) / graph.view.z - graph.view.y
  };
}

function onGraphPointerDown(e) {
  const rect = graph.canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const world = screenToWorld(mx, my);
  
  // Check hit
  let hit = null;
  for (let i = graph.nodes.length - 1; i >= 0; i--) {
    const n = graph.nodes[i];
    const dx = world.x - n.x, dy = world.y - n.y;
    if (Math.sqrt(dx*dx + dy*dy) < 15 / graph.view.z) { hit = n; break; }
  }
  
  if (hit) {
    graph.selectedId = hit.id;
    showGraphTooltip(hit, e.clientX, e.clientY);
    // Also open detail panel if it's a lieu
    if (hit.type === 'lieu') openDetail(hit.id);
    else if (hit.type === 'ssm' || hit.type === 'coord' || hit.type === 'mobile') openSSMDetail(hit.id);
  } else {
    graph.selectedId = null;
    hideGraphTooltip();
    graph.isDragging = true;
    graph.dragStart = { x: mx, y: my };
    graph.viewStart = { x: graph.view.x, y: graph.view.y };
  }
}

function onGraphPointerMove(e) {
  const rect = graph.canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  
  if (graph.isDragging) {
    graph.view.x = graph.viewStart.x + (mx - graph.dragStart.x) / graph.view.z;
    graph.view.y = graph.viewStart.y + (my - graph.dragStart.y) / graph.view.z;
  } else {
    const world = screenToWorld(mx, my);
    let hov = null;
    for (let i = graph.nodes.length - 1; i >= 0; i--) {
      const n = graph.nodes[i];
      if (Math.sqrt((world.x - n.x)**2 + (world.y - n.y)**2) < 15 / graph.view.z) { hov = n; break; }
    }
    graph.hoverId = hov?.id || null;
    if (hov) showGraphTooltip(hov, e.clientX, e.clientY);
    else hideGraphTooltip();
  }
}

function onGraphPointerUp() {
  graph.isDragging = false;
}

function onGraphWheel(e) {
  e.preventDefault();
  graph.view.z = Math.max(0.3, Math.min(4, graph.view.z - e.deltaY * 0.001));
}

function showGraphTooltip(node, x, y) {
  const tt = $('graphTooltip');
  if (!tt) return;
  const color = GRAPH_COLORS[node.type] || '#fff';
  tt.innerHTML = `<div style="font-weight:700;color:${color}">${esc(node.name)}</div>
    <div style="font-size:12px;color:var(--muted);margin-top:4px">${esc(node.summary || '')}</div>
    ${node.status === 'at_risk' ? '<div style="color:var(--urgence);font-weight:600;margin-top:4px">âš ï¸ ALERTE</div>' : ''}`;
  tt.style.display = 'block';
  tt.style.left = Math.min(x + 10, window.innerWidth - 300) + 'px';
  tt.style.top = (y + 10) + 'px';
}

function hideGraphTooltip() {
  const tt = $('graphTooltip');
  if (tt) tt.style.display = 'none';
}

function graphPhysics() {
  const zoneGravity = graph.mode === 'ZONES' ? 0.12 : 0.02;
  const repulsion = graph.mode === 'GRAPH' ? 600 : 300;
  const linkSpring = graph.mode === 'GRAPH' ? 0.08 : 0.03;
  
  // Zone gravity
  graph.nodes.forEach(n => {
    if (n.zone) {
      const z = DATA.zones.find(zz => zz.id === n.zone);
      if (z) {
        const dx = z.x - n.x, dy = z.y - n.y;
        const d = Math.sqrt(dx*dx + dy*dy);
        if (d > 1) { n.vx += (dx/d) * zoneGravity; n.vy += (dy/d) * zoneGravity; }
      }
    }
  });
  
  // Repulsion
  for (let i = 0; i < graph.nodes.length; i++) {
    for (let j = i + 1; j < graph.nodes.length; j++) {
      const a = graph.nodes[i], b = graph.nodes[j];
      const dx = b.x - a.x, dy = b.y - a.y;
      const d = Math.sqrt(dx*dx + dy*dy);
      if (d > 0 && d < 150) {
        const f = repulsion / (d*d + 1);
        const fx = (dx/d) * f, fy = (dy/d) * f;
        a.vx -= fx; a.vy -= fy;
        b.vx += fx; b.vy += fy;
      }
    }
  }
  
  // Link springs
  DATA.links.forEach(l => {
    const a = graph.nodes.find(n => n.id === l.from);
    const b = graph.nodes.find(n => n.id === l.to);
    if (!a || !b) return;
    const dx = b.x - a.x, dy = b.y - a.y;
    const d = Math.sqrt(dx*dx + dy*dy);
    if (d > 1) {
      const diff = d - 80;
      const f = diff * linkSpring;
      const fx = (dx/d) * f, fy = (dy/d) * f;
      a.vx += fx; a.vy += fy;
      b.vx -= fx; b.vy -= fy;
    }
  });
  
  // Apply velocity
  graph.nodes.forEach(n => {
    n.vx = Math.max(-5, Math.min(5, n.vx * 0.88));
    n.vy = Math.max(-5, Math.min(5, n.vy * 0.88));
    n.x += n.vx;
    n.y += n.vy;
  });
}

function renderGraph() {
  if (!graph.ctx) return;
  const rect = graph.canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  const ctx = graph.ctx;
  const v = graph.view;
  
  ctx.clearRect(0, 0, w, h);
  ctx.save();
  ctx.translate(w/2, h/2);
  ctx.scale(v.z, v.z);
  ctx.translate(v.x, v.y);
  
  // Draw zones
  DATA.zones.forEach(z => {
    ctx.fillStyle = 'rgba(125,249,200,.06)';
    ctx.beginPath();
    ctx.arc(z.x, z.y, 100, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = 'rgba(125,249,200,.35)';
    ctx.font = '600 11px "Space Grotesk", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(z.name, z.x, z.y);
  });
  
  // Draw links
  DATA.links.forEach(l => {
    const a = graph.nodes.find(n => n.id === l.from);
    const b = graph.nodes.find(n => n.id === l.to);
    if (!a || !b) return;
    if (!isNodeVisible(a) || !isNodeVisible(b)) return;
    
    const isHighlight = graph.selectedId && (l.from === graph.selectedId || l.to === graph.selectedId);
    ctx.strokeStyle = isHighlight ? 'rgba(125,249,200,.6)' : 'rgba(125,249,200,.15)';
    ctx.lineWidth = isHighlight ? 2.5 : 1;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
    
    // Draw link label if highlighted
    if (isHighlight && l.label) {
      const mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;
      ctx.fillStyle = 'rgba(125,249,200,.8)';
      ctx.font = '500 9px "Space Grotesk", sans-serif';
      ctx.fillText(l.label, mx, my - 5);
    }
  });
  
  // Draw nodes (only visible ones)
  graph.nodes.filter(n => isNodeVisible(n)).forEach(n => {
    const isSel = graph.selectedId === n.id;
    const isHov = graph.hoverId === n.id;
    const r = isSel ? 10 : isHov ? 8 : 6;
    const color = GRAPH_COLORS[n.type] || '#fff';
    
    if (isSel) { ctx.shadowColor = color; ctx.shadowBlur = 20; }
    else ctx.shadowBlur = 0;
    
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    
    // Alert ring
    if (n.status === 'at_risk') {
      ctx.strokeStyle = '#ff6b8a';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(n.x, n.y, r + 5, 0, Math.PI * 2);
      ctx.stroke();
    }
    
    // Outer ring
    ctx.strokeStyle = color + '44';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(n.x, n.y, r + 3, 0, Math.PI * 2);
    ctx.stroke();
  });
  
  // Draw labels if checked
  if ($('graphLabels')?.checked && v.z > 1) {
    const maxLabels = v.z > 2 ? 50 : v.z > 1.5 ? 30 : 15;
    ctx.font = '600 9px "Space Grotesk", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    
    graph.nodes.filter(n => isNodeVisible(n)).slice(0, maxLabels).forEach(n => {
      const lbl = n.name.length > 20 ? n.name.substring(0, 18) + 'â€¦' : n.name;
      const tw = ctx.measureText(lbl).width;
      
      ctx.fillStyle = 'rgba(7,8,12,.85)';
      ctx.beginPath();
      ctx.roundRect(n.x - tw/2 - 5, n.y + 12, tw + 10, 16, 4);
      ctx.fill();
      
      ctx.fillStyle = '#fff';
      ctx.fillText(lbl, n.x, n.y + 15);
    });
  }
  
  ctx.restore();
}

function startGraphAnimation() {
  function loop() {
    fitGraphCanvas();
    graphPhysics();
    renderGraph();
    graph.animFrame = requestAnimationFrame(loop);
  }
  loop();
}

function rebuildGraphNodes() {
  if (!graph.canvas) return;
  
  // Rebuild nodes from updated DATA
  graph.nodes = [];
  
  DATA.lieux.forEach(l => {
    const zone = DATA.zones.find(z => z.name.includes(l.commune) || l.commune.includes(z.name.split('-')[0]));
    const h = hashStr(l.id);
    graph.nodes.push({
      id: l.id,
      type: 'lieu',
      name: l.name,
      summary: l.summary,
      status: l.status,
      x: (zone?.x || 0) + Math.cos(h % 360 * Math.PI/180) * (30 + h % 60),
      y: (zone?.y || 0) + Math.sin(h % 360 * Math.PI/180) * (30 + h % 60),
      vx: 0, vy: 0,
      zone: zone?.id,
      data: l
    });
  });
  
  DATA.ssm.forEach(s => {
    const h = hashStr(s.id);
    const isCoord = s.type === 'Coordination';
    const isMobile = s.type === 'Ã‰quipe mobile';
    graph.nodes.push({
      id: s.id,
      type: isCoord ? 'coord' : isMobile ? 'mobile' : 'ssm',
      name: s.name,
      summary: s.summary,
      x: (Math.random() - 0.5) * 200,
      y: (Math.random() - 0.5) * 200,
      vx: 0, vy: 0,
      data: s
    });
  });
  
  DATA.reseaux.forEach(r => {
    graph.nodes.push({
      id: r.id,
      type: 'reseau',
      name: r.name + ' (' + r.zone + ')',
      summary: r.communes,
      x: (Math.random() - 0.5) * 300,
      y: (Math.random() - 0.5) * 300,
      vx: 0, vy: 0,
      data: r
    });
  });
}

// ========== INIT ==========
function init() {
  // Load from localStorage first
  const loaded = loadFromStorage();
  
  // Nav
  $$('.nav-item').forEach(n => n.addEventListener('click', () => {
    switchModule(n.dataset.module);
    // Init graph when switching to it
    if (n.dataset.module === 'graph' && !graph.canvas) {
      setTimeout(initGraph, 100);
    }
    // Init Leaflet map when switching to it
    if (n.dataset.module === 'carte' && !leafletMap) {
      setTimeout(initLeafletMap, 100);
    }
  }));
  
  // Search filters
  $('searchLieux').addEventListener('input', render);
  $('filterCommune').addEventListener('change', render);
  $('searchContacts').addEventListener('input', renderContacts);
  $('filterType').addEventListener('change', renderContacts);
  $('filterStatus').addEventListener('change', renderContacts);
  
  // Global search
  $('globalSearch').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const q = e.target.value.toLowerCase();
      const lieu = DATA.lieux.find(l => l.name.toLowerCase().includes(q));
      if (lieu) { switchModule('lieux'); openDetail(lieu.id); }
      else {
        const contact = DATA.contacts.find(c => c.name.toLowerCase().includes(q));
        if (contact) switchModule('contacts');
      }
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'k') { e.preventDefault(); $('globalSearch').focus(); }
    if (e.key === 'Escape') { closeDetail(); closeFlashModal(); closeContactModal(); closeLieuModal(); closeLinkModal(); closeMissionModal(); closeNotesModal(); closeAvatarPicker(); closeProfilesModal(); closeCardModal(); closeShareMissionModal(); }
  });
  
  // Graph filters
  $$('.graph-filter').forEach(f => f.addEventListener('change', () => {}));
  $('graphFilterCommune')?.addEventListener('change', () => {});
  $('graphFilterReseau107')?.addEventListener('change', () => {});
  
  // Populate graph commune filter
  const communes = [...new Set(DATA.lieux.map(l => l.commune))].sort();
  if ($('graphFilterCommune')) {
    $('graphFilterCommune').innerHTML = '<option value="">Toutes communes</option>' + communes.map(c => `<option value="${c}">${c}</option>`).join('');
  }
  
  // Init study order
  initStudyOrder();
  
  // Render
  render();
  renderMissions();
  renderProfil();
  initProfilListeners();
  
  // Check badges on load
  setTimeout(checkBadges, 500);
  
  // Check URL for shared mission
  checkUrlForSharedMission();
  
  // Show loaded status
  if (loaded) {
    toast('ğŸ“‚ DonnÃ©es restaurÃ©es depuis localStorage');
  } else {
    addJournalEntry('ğŸ® Bienvenue dans l\'Agence de Renseignement Citoyenne!');
    saveToStorage();
    toast('ğŸ§  NYXO â€¢ Workspace chargÃ©');
  }
}

// ========== PWA SERVICE WORKER ==========
let deferredPrompt = null;
let swRegistration = null;

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      swRegistration = await navigator.serviceWorker.register('sw.js', { scope: './' });
      console.log('âœ… Service Worker registered:', swRegistration.scope);
      
      // Check for updates
      swRegistration.addEventListener('updatefound', () => {
        const newWorker = swRegistration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New version available
            showUpdateNotification();
          }
        });
      });
      
      // Listen for SW messages
      navigator.serviceWorker.addEventListener('message', handleSWMessage);
      
    } catch (error) {
      console.error('âŒ Service Worker registration failed:', error);
    }
  });
}

// Handle SW messages
function handleSWMessage(event) {
  const { type, count } = event.data;
  
  switch(type) {
    case 'SYNC_COMPLETE':
      toast(`ğŸ”„ ${count} modifications synchronisÃ©es`);
      updateCacheStatus('online');
      break;
    case 'TILES_CACHED':
      toast(`ğŸ—ºï¸ ${count} tuiles carte mises en cache`);
      break;
  }
}

// Show update notification
function showUpdateNotification() {
  const updateBanner = document.createElement('div');
  updateBanner.innerHTML = `
    <div style="position:fixed;bottom:80px;left:20px;right:20px;max-width:400px;margin:0 auto;background:var(--info);color:#000;padding:16px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;z-index:9999">
      <span>ğŸ”„</span>
      <span style="flex:1">Nouvelle version disponible</span>
      <button onclick="updateApp()" style="background:#000;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600">Mettre Ã  jour</button>
    </div>
  `;
  document.body.appendChild(updateBanner);
}

// Update app
function updateApp() {
  if (swRegistration && swRegistration.waiting) {
    swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
  }
  window.location.reload();
}

// ========== PWA INSTALL PROMPT ==========
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install prompt after 30 seconds if not dismissed before
  setTimeout(() => {
    if (deferredPrompt && !localStorage.getItem('nyxo-install-dismissed')) {
      $('installPrompt').classList.add('visible');
    }
  }, 30000);
});

async function installPWA() {
  if (!deferredPrompt) {
    toast('ğŸ’¡ Utilisez le menu de votre navigateur pour installer');
    return;
  }
  
  $('installPrompt').classList.remove('visible');
  deferredPrompt.prompt();
  
  const { outcome } = await deferredPrompt.userChoice;
  console.log('Install prompt outcome:', outcome);
  
  if (outcome === 'accepted') {
    toast('âœ… NYXO installÃ© sur votre appareil!');
    addJournalEntry('ğŸ“² Application installÃ©e');
  }
  
  deferredPrompt = null;
}

function dismissInstallPrompt() {
  $('installPrompt').classList.remove('visible');
  localStorage.setItem('nyxo-install-dismissed', Date.now());
}

// Detect if running as PWA
window.addEventListener('appinstalled', () => {
  console.log('âœ… NYXO installed as PWA');
  toast('ğŸ‰ NYXO installÃ© avec succÃ¨s!');
  deferredPrompt = null;
});

// ========== OFFLINE/ONLINE DETECTION ==========
function updateOnlineStatus() {
  const isOnline = navigator.onLine;
  const indicator = $('offlineIndicator');
  const status = $('cacheStatus');
  
  if (isOnline) {
    indicator.classList.remove('visible');
    status.classList.remove('offline');
    $('cacheText').textContent = 'En ligne';
    
    // Trigger background sync
    if (swRegistration && 'sync' in window.registration) {
      swRegistration.sync.register('nyxo-sync');
    }
  } else {
    indicator.classList.add('visible');
    status.classList.add('offline');
    $('cacheText').textContent = 'Hors-ligne';
    $('offlineText').textContent = 'Mode hors-ligne - Les donnÃ©es sont sauvegardÃ©es localement';
  }
  
  status.classList.add('visible');
  setTimeout(() => status.classList.remove('visible'), 5000);
}

function updateCacheStatus(status) {
  const statusEl = $('cacheStatus');
  const textEl = $('cacheText');
  
  statusEl.classList.remove('offline', 'syncing');
  
  switch(status) {
    case 'syncing':
      statusEl.classList.add('syncing');
      textEl.textContent = 'Synchronisation...';
      break;
    case 'offline':
      statusEl.classList.add('offline');
      textEl.textContent = 'Hors-ligne';
      break;
    default:
      textEl.textContent = 'En ligne';
  }
  
  statusEl.classList.add('visible');
  setTimeout(() => statusEl.classList.remove('visible'), 3000);
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// ========== OFFLINE MAP TILES CACHING ==========
async function cacheMapTilesForBrussels() {
  if (!swRegistration) {
    toast('âš ï¸ Service Worker non disponible');
    return;
  }
  
  toast('ğŸ—ºï¸ TÃ©lÃ©chargement des tuiles carte...');
  updateCacheStatus('syncing');
  
  const bounds = {
    minLat: 50.76,
    maxLat: 50.92,
    minLng: 4.25,
    maxLng: 4.50
  };
  
  navigator.serviceWorker.controller.postMessage({
    type: 'CACHE_TILES',
    bounds: bounds
  });
}

// ========== CACHE MANAGEMENT ==========
async function getCacheInfo() {
  if (!swRegistration) return null;
  
  return new Promise((resolve) => {
    const channel = new MessageChannel();
    channel.port1.onmessage = (event) => resolve(event.data);
    navigator.serviceWorker.controller.postMessage(
      { type: 'GET_CACHE_SIZE' },
      [channel.port2]
    );
  });
}

async function clearAppCache() {
  if (!swRegistration) return;
  
  if (confirm('Supprimer toutes les donnÃ©es en cache ? Vous devrez Ãªtre en ligne pour recharger.')) {
    const channel = new MessageChannel();
    channel.port1.onmessage = () => {
      toast('ğŸ—‘ï¸ Cache vidÃ©');
      window.location.reload();
    };
    navigator.serviceWorker.controller.postMessage(
      { type: 'CLEAR_CACHE' },
      [channel.port2]
    );
  }
}

async function forceSyncData() {
  if (!navigator.onLine) {
    toast('âš ï¸ Pas de connexion internet');
    return;
  }
  
  updateCacheStatus('syncing');
  
  if (swRegistration && navigator.serviceWorker.controller) {
    const channel = new MessageChannel();
    channel.port1.onmessage = () => {
      toast('âœ… Synchronisation terminÃ©e');
      updateCacheStatus('online');
    };
    navigator.serviceWorker.controller.postMessage(
      { type: 'FORCE_SYNC' },
      [channel.port2]
    );
  }
}

// ========== PUSH NOTIFICATIONS ==========
async function subscribeToPush() {
  if (!swRegistration) {
    toast('âš ï¸ Service Worker non disponible');
    return;
  }
  
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      toast('âŒ Notifications refusÃ©es');
      return;
    }
    
    // In production, use your VAPID public key
    const subscription = await swRegistration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(
        'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U'
      )
    });
    
    console.log('Push subscription:', subscription);
    toast('ğŸ”” Notifications activÃ©es');
    addJournalEntry('ğŸ”” Notifications push activÃ©es');
    
    // Send subscription to server (if you have one)
    // await fetch('/api/push/subscribe', { method: 'POST', body: JSON.stringify(subscription) });
    
  } catch (error) {
    console.error('Push subscription failed:', error);
    toast('âŒ Erreur activation notifications');
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// ========== PWA STATUS IN SETTINGS ==========
function getPWAStatus() {
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
  const hasServiceWorker = 'serviceWorker' in navigator && swRegistration;
  const isOnline = navigator.onLine;
  
  return {
    installed: isInstalled,
    serviceWorker: hasServiceWorker,
    online: isOnline,
    canInstall: !!deferredPrompt
  };
}

async function updatePWAStatusUI() {
  const status = getPWAStatus();
  
  // Status icon and text
  const iconEl = $('pwaStatusIcon');
  const titleEl = $('pwaStatusTitle');
  const textEl = $('pwaStatusText');
  
  if (status.installed && status.serviceWorker) {
    iconEl.textContent = 'âœ…';
    iconEl.style.background = 'rgba(125,249,200,.2)';
    titleEl.textContent = 'Application installÃ©e';
    textEl.textContent = 'NYXO fonctionne en mode hors-ligne';
  } else if (status.serviceWorker) {
    iconEl.textContent = 'ğŸ“±';
    iconEl.style.background = 'rgba(107,197,255,.2)';
    titleEl.textContent = 'PrÃªt Ã  installer';
    textEl.textContent = 'Le mode hors-ligne est disponible';
  } else {
    iconEl.textContent = 'âš ï¸';
    iconEl.style.background = 'rgba(249,215,125,.2)';
    titleEl.textContent = 'Non disponible';
    textEl.textContent = 'Service Worker non supportÃ©';
  }
  
  // Individual status
  $('pwaSW').textContent = status.serviceWorker ? 'âœ… Actif' : 'âŒ Inactif';
  $('pwaSW').style.color = status.serviceWorker ? 'var(--success)' : 'var(--urgence)';
  
  $('pwaInstalled').textContent = status.installed ? 'âœ… Oui' : 'âŒ Non';
  $('pwaInstalled').style.color = status.installed ? 'var(--success)' : 'var(--muted)';
  
  $('pwaOnline').textContent = status.online ? 'âœ… En ligne' : 'ğŸ“¡ Hors-ligne';
  $('pwaOnline').style.color = status.online ? 'var(--success)' : 'var(--warn)';
  
  // Install button
  const installBtn = $('pwaInstallBtn');
  if (status.installed) {
    installBtn.textContent = 'âœ… DÃ©jÃ  installÃ©e';
    installBtn.disabled = true;
    installBtn.classList.remove('primary');
  } else if (status.canInstall) {
    installBtn.textContent = 'ğŸ“² Installer l\'application';
    installBtn.disabled = false;
    installBtn.classList.add('primary');
  } else {
    installBtn.textContent = 'ğŸ’¡ Via menu navigateur';
    installBtn.disabled = false;
    installBtn.classList.remove('primary');
  }
  
  // Cache size
  if (status.serviceWorker && navigator.serviceWorker.controller) {
    try {
      const cacheInfo = await getCacheInfo();
      if (cacheInfo && cacheInfo.size) {
        const sizeMB = (cacheInfo.size / 1024 / 1024).toFixed(2);
        $('pwaCacheSize').textContent = `${sizeMB} MB`;
      } else {
        $('pwaCacheSize').textContent = '< 1 MB';
      }
    } catch (e) {
      $('pwaCacheSize').textContent = 'N/A';
    }
  } else {
    $('pwaCacheSize').textContent = 'N/A';
  }
}

init();
</script>
</body>
</html>

