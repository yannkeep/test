<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BROL 2.1 ‚Äî Dashboard</title>

  <style>
    :root{
      --bg:#020617;
      --panel: rgba(3,7,18,.92);
      --panel2: rgba(15,23,42,.92);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border: rgba(148,163,184,.55);
      --ring: rgba(56,189,248,.55);

      --g1:#22c55e;
      --g2:#38bdf8;
      --g3:#f97316;
      --g4:#a855f7;

      --r:18px;
      --shadow: 0 18px 40px rgba(0,0,0,.92);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.22), transparent 55%),
        var(--bg);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* subtle scanlines */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: linear-gradient(rgba(15,23,42,.24) 1px, transparent 1px);
      background-size: 100% 2px;
      mix-blend-mode: soft-light;
      opacity:.7;
      z-index:0;
    }

    header{
      position:sticky;
      top:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      border-bottom:1px solid rgba(30,64,175,.7);
      background: rgba(3,7,18,.88);
      backdrop-filter: blur(14px);
      box-shadow: 0 16px 40px rgba(0,0,0,.9);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .logo{
      width:46px;height:46px;border-radius:16px;
      padding:2px;
      background: conic-gradient(from 180deg, var(--g1), var(--g2), var(--g3), var(--g4), var(--g1));
      box-shadow: 0 0 0 1px #020617, 0 0 24px rgba(56,189,248,.75);
      flex:0 0 auto;
    }
    .logo > div{
      width:100%;height:100%;
      border-radius:14px;
      display:grid;
      place-items:center;
      font-family: var(--mono);
      font-weight:800;
      letter-spacing:.12em;
      color:#bbf7d0;
      background: radial-gradient(circle at 30% 20%, #0f172a, #020617);
    }

    .titles{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .titles .t1{
      font-size:1.02rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titles .t2{
      font-size:.82rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60ch;
    }

    .status{
      text-align:right;
      font-size:.8rem;
      color: var(--muted);
      max-width:40ch;
    }
    .status strong{ color:var(--text); }

    main{
      position:relative;
      z-index:1;
      flex:1;
      padding:12px;
      display:grid;
      grid-template-columns: minmax(280px, 1.2fr) minmax(420px, 2fr) minmax(260px, 1fr);
      gap:10px;
      overflow:hidden;
    }

    @media (max-width: 1100px){
      main{ grid-template-columns: 1fr 1.6fr; grid-template-rows:auto auto; }
      .right{ grid-column: 1 / -1; }
    }
    @media (max-width: 860px){
      body{ overflow:auto; }
      main{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 220px;
    }
    .panel:before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(168,85,247,.18), transparent 60%);
      mix-blend-mode: soft-light;
      opacity:.75;
    }

    .panel > .inner{
      position:relative;
      z-index:1;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      height:100%;
      min-height:0;
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    h2{
      margin:0;
      font-size: .98rem;
      letter-spacing:.02em;
    }

    .muted{ color:var(--muted); font-size:.82rem; }

    input[type="search"], select, button{
      font-family: var(--sans);
      color: var(--text);
      background: rgba(15,23,42,.92);
      border: 1px solid rgba(51,65,85,.98);
      border-radius: 999px;
      outline:none;
    }

    input[type="search"]{
      padding:8px 10px;
      font-size:.86rem;
      flex:1;
      min-width: 160px;
    }

    select{
      padding:7px 10px;
      font-size:.84rem;
    }

    .pill{
      font-family: var(--mono);
      font-size:.74rem;
      color: var(--muted);
      border:1px solid rgba(148,163,184,.6);
      padding:2px 8px;
      border-radius:999px;
    }

    /* List */
    .list{
      border:1px solid rgba(55,65,81,.98);
      border-radius: 14px;
      background:#020617;
      padding:6px;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }
    .scroll{
      overflow:auto;
      padding-right:4px;
      min-height:0;
    }

    .groupTitle{
      margin:10px 6px 6px;
      font-family: var(--mono);
      font-size:.74rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: var(--muted);
    }

    .item{
      width:100%;
      text-align:left;
      border-radius: 12px;
      border:1px solid rgba(55,65,81,.92);
      background: rgba(15,23,42,.92);
      padding:8px 9px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      transition: transform .15s, box-shadow .15s, border-color .15s, background .15s;
    }

    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(148,163,184,.9);
      box-shadow: 0 10px 22px rgba(0,0,0,.85);
      background: rgba(15,23,42, 1);
    }

    .item[aria-selected="true"]{
      background: rgba(22,163,74,.16);
      border-color: rgba(34,197,94,.85);
      box-shadow: 0 12px 26px rgba(0,0,0,.92);
    }

    .item:focus-visible{
      box-shadow: 0 0 0 3px var(--ring), 0 12px 26px rgba(0,0,0,.92);
      border-color: rgba(56,189,248,.95);
    }

    .metaL{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .title{
      font-size:.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      font-size:.78rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .metaR{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      min-width:0;
    }
    .file{
      font-family: var(--mono);
      font-size:.72rem;
      color:#9ca3af;
      max-width: 150px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      font-family: var(--mono);
      font-size:.72rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(75,85,99,.9);
      color: var(--muted);
    }
    .tag.base{ border-color: rgba(34,197,94,.8); color:#bbf7d0;}
    .tag.brol{ border-color: rgba(56,189,248,.8); color:#bae6fd;}
    .tag.univ{ border-color: rgba(168,85,247,.8); color:#e9d5ff;}
    .tag.intra{ border-color: rgba(249,115,22,.8); color:#fed7aa;}
    .tag.ia{ border-color: rgba(248,113,113,.8); color:#fecaca;}
    .tag.meta{ border-color: rgba(148,163,184,.85); color:#e5e7eb;}

    mark{
      background: rgba(56,189,248,.25);
      color: var(--text);
      padding:0 .12em;
      border-radius:.25em;
    }

    /* Viewer */
    .viewerHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .viewerTitle{
      font-size: 1rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60ch;
    }
    .viewerSub{ font-size:.82rem; color:var(--muted); }

    .badges{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-family: var(--mono);
      font-size:.74rem;
      color: var(--muted);
      border:1px solid rgba(148,163,184,.75);
      padding:2px 8px;
      border-radius:999px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background: var(--g1);
      box-shadow: 0 0 10px rgba(34,197,94,.85);
    }

    .frame{
      border:1px solid rgba(55,65,81,.98);
      border-radius: 14px;
      background:#020617;
      overflow:hidden;
      flex:1;
      min-height: 220px;
      display:flex;
      flex-direction:column;
    }
    iframe{
      border:0;
      width:100%;
      height:100%;
      flex:1;
      background:#020617;
    }
    .viewerFoot{
      border-top:1px solid rgba(31,41,55,.98);
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:.82rem;
      color: var(--muted);
    }
    .openBtn{
      font-family: var(--mono);
      font-size:.76rem;
      text-decoration:none;
      color:#e0f2fe;
      border:1px solid rgba(56,189,248,.85);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(15,23,42,.92);
      transition: transform .15s, box-shadow .15s, background .15s;
    }
    .openBtn:hover{
      transform: translateY(-1px);
      background: rgba(15,23,42, 1);
      box-shadow: 0 10px 22px rgba(0,0,0,.85);
    }

    /* Right side */
    .gridBtns{ display:flex; flex-wrap:wrap; gap:6px; }
    .embedBtn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,.98);
      background:#020617;
      color: var(--text);
      font-family: var(--mono);
      font-size:.76rem;
      padding:7px 9px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: transform .15s, box-shadow .15s, border-color .15s, background .15s;
    }
    .embedBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(148,163,184,.9);
      background: rgba(15,23,42, 1);
      box-shadow: 0 10px 22px rgba(0,0,0,.85);
    }

    .howto{
      border:1px solid rgba(55,65,81,.98);
      border-radius: 14px;
      background:#020617;
      padding:10px;
      font-size:.82rem;
      color: var(--muted);
    }
    .howto kbd{
      font-family: var(--mono);
      font-size:.74rem;
      border:1px solid rgba(148,163,184,.55);
      background: rgba(15,23,42,.85);
      padding:1px 6px;
      border-radius:7px;
      color: var(--text);
    }

    footer{
      z-index:1;
      padding:8px 12px;
      border-top:1px solid rgba(30,64,175,.6);
      background: rgba(3,7,18,.88);
      color: var(--muted);
      font-size:.78rem;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"><div>BROL</div></div>
    <div class="titles">
      <div class="t1">BROL 2.1 ‚Äî Dashboard central</div>
      <div class="t2">Modules, embeds, et un viewer propre (clavier + √©tat partageable)</div>
    </div>
  </div>
  <div class="status">
    <div><strong>Niveau 0</strong> ‚Äî mode ‚Äúhub‚Äù</div>
    <div>Raccourcis : <span class="pill">‚Üë ‚Üì</span> <span class="pill">Enter</span> <span class="pill">/</span></div>
  </div>
</header>

<main>
  <!-- Left -->
  <section class="panel">
    <div class="inner">
      <div>
        <div class="row" style="justify-content:space-between;">
          <h2>Pages & modules</h2>
          <span class="pill" id="count">0</span>
        </div>
        <div class="row" style="margin-top:6px;">
          <input id="q" type="search" placeholder="Rechercher‚Ä¶ (titre / fichier / description)" />
          <select id="cat">
            <option value="all">Toutes cat√©gories</option>
            <option value="base">La Base</option>
            <option value="brol">BROL & fichiers</option>
            <option value="univ">Univers & jeu</option>
            <option value="intra">Liens en vrac</option>
            <option value="ia">IA fictive</option>
            <option value="meta">Tests</option>
          </select>
        </div>
        <div class="row" style="margin-top:6px;justify-content:space-between;">
          <div class="muted">Astuce : tape <span class="pill">/</span> pour focus la recherche</div>
          <div class="muted" id="hint"></div>
        </div>
      </div>

      <div class="list" role="listbox" aria-label="Liste des modules">
        <div class="scroll" id="list"></div>
      </div>
    </div>
  </section>

  <!-- Center -->
  <section class="panel">
    <div class="inner">
      <div class="viewerHead">
        <div style="min-width:0;">
          <div class="viewerTitle" id="vTitle">‚Äî</div>
          <div class="viewerSub" id="vSub">‚Äî</div>
        </div>
        <div class="badges">
          <span class="badge"><span class="dot"></span><span id="vCat">‚Äî</span></span>
          <span class="badge" id="vKind">‚Äî</span>
        </div>
      </div>

      <div class="frame">
        <iframe id="frame" title="Viewer"></iframe>
        <div class="viewerFoot">
          <div style="min-width:0;">
            <span class="muted">Fichier/URL :</span>
            <span id="vFile" class="pill" style="display:inline-block;max-width:60ch;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></span>
          </div>
          <a class="openBtn" id="open" target="_blank" rel="noopener noreferrer">Ouvrir</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Right -->
  <section class="panel right">
    <div class="inner">
      <div>
        <h2>Distractions & annexes</h2>
        <div class="muted" style="margin-top:4px;">Ce sont des embeds externes. Ils remplacent la s√©lection courante.</div>
      </div>

      <div class="gridBtns" id="embeds"></div>

      <div class="howto">
        <div style="color:var(--text);font-weight:650;margin-bottom:6px;">Contr√¥les ‚Äúpro‚Äù</div>
        <div>‚Ä¢ <kbd>/</kbd> : focus recherche</div>
        <div>‚Ä¢ <kbd>‚Üë</kbd><kbd>‚Üì</kbd> : naviguer dans la liste</div>
        <div>‚Ä¢ <kbd>Enter</kbd> : ouvrir l‚Äôitem s√©lectionn√©</div>
        <div style="margin-top:8px;">L‚Äô√©tat est persist√© (localStorage) et partageable via <span class="pill">#module=...</span></div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div>BROL 2.1 ‚Äî version ‚Äúclean + clavier + partage‚Äù</div>
  <div class="muted">Tu veux encore plus ? command palette, drag-resize panels, previews et favs ‚≠ê</div>
</footer>

<script>
/**
 * ‚úÖ High-level moves:
 * - state in one place
 * - robust URL building
 * - keyboard UX
 * - highlight matches
 * - persist last selection
 */

/* ----------------- Config ----------------- */
/**
 * Si tu es sur GitHub Pages, mets par ex:
 * const BASE_URL = "https://yannkeep.github.io/test/room/1/";
 * En CodePen, laisse vide (relative).
 */
const BASE_URL = ""; // <-- change if needed

/* ----------------- Data ----------------- */
const modules = [
  { id:"site-ultime", title:"LE SITE ULTIME (index)", file:"index.html", category:"base", kind:"niveaux -1 ‚Üí 3", description:"Le fichier qui permet de partir de z√©ro et monter progressivement." },
  { id:"scratchy", title:"Support technique", file:"404.html", category:"base", kind:"au cas o√π", description:"Il faut √©teindre et rallumer." },
  { id:"branques2", title:"Politique des Cookies", file:"browniz-politik.html", category:"base", kind:"d√©butant+", description:"Si tu passes pas ce test, t'as rat√© ta vie." },
  { id:"pas-a-pas", title:"Boussole de valeurs", file:"valeurs.html", category:"base", kind:"boussole", description:"Pour faire le point de temps en temps." },

  { id:"hub-illustre", title:"Hub illustr√©", file:"portail.html", category:"brol", kind:"codigic", description:"Pour faire tout √† fait autre chose." },
  { id:"rolex", title:"Lien suspect", file:"777.html", category:"brol", kind:"#pirat√©", description:"Pour faire encore autre chose." },
  { id:"amazing", title:"Lien HYPER suspect", file:"amazing.html", category:"brol", kind:"#vendu", description:"Pour faire encore TOUT autre chose." },

  { id:"stic-anarchie", title:"STIC de l‚Äôanarchie ‚Äì jeu licornes & bisounours", file:"stic-anarchie.html", category:"univ", kind:"jeu pas fun", description:"Version ultra color√©e / Scratch-like pour jouer avec le capitalisme." },

  { id:"detective", title:"Agence d√©tective publique", file:"veilleuxses.html", category:"intra", kind:"site m√©tier", description:"Vitrine + intranet l√©ger pour une activit√© de d√©tective / enqu√™te." },
  { id:"extranet", title:"Extronet organisation lambda", file:"xyno.html", category:"intra", kind:"extronet", description:"Mod√®le extranet." },
  { id:"kalifox", title:"Extronet organisation b√™ta", file:"kalifox.html", category:"intra", kind:"outil", description:"Parce que bon parfois." },

  { id:"gork", title:"GORK / Pauvre Gork", file:"minitel.html", category:"ia", kind:"graph", description:"Il voudrait √™tre d√©branch√©." },
  { id:"gorki", title:"GORKI / Pauvre GorkI", file:"terminal-ia.html", category:"ia", kind:"grave", description:"Il voudrait AUSSI √™tre d√©branch√©." },

  // ‚úÖ Fix de ton bug: "ib" -> "meta"
  { id:"test-1", title:"√Ä r√©ussir d'urgence", file:"test-1.html", category:"meta", kind:"bisous", description:"C'est √ßa ou rien." },

  { id:"mon-projet", title:"Mon projet secret", file:"veille-1160.html", category:"univ", kind:"univers perso", description:"Description courte de ce que contient cette page." },
];

const embeds = {
  penguin: { label:"üêß Tarot", url:"https://ouaisfieu.appsmith.com/app/tarotboulotproto-v3-1/tarotsimpletirage-68555a12a22d7c48aa0d27ad", description:"Tarot de Boulot et de Marseille sans illustration." },
  intranet:{ label:"üêß Intranet", url:"https://boot-a-rat.vercel.app/", description:"C'est par l√† que √ßa se passe." },
  youtube:  { label:"‚ñ∂Ô∏è YouTube", url:"https://www.youtube.com/embed/dQw4w9WgXcQ", description:"Exemple d‚Äôembed YouTube." },
  spotify:  { label:"üéµ Spotify", url:"https://open.spotify.com/embed/playlist/7eTeIkIqbfmyXnC6Ilo4d2?si=QRW5lAbiRwerORLkra3Raw", description:"Exemple de playlist Spotify (embed)." },
  speaker:  { label:"üêß Charg√© de com‚Äô", url:"https://ouaisfieu.github.io/offre/", description:"Charg√© de communication en boucle sur la communication." },
  king:     { label:"üêß Pingouin", url:"https://dl.ouaisfi.eu/", description:"Pingouins." },
  dices:    { label:"üêß D√©s", url:"https://tirage-one.vercel.app/", description:"Application de tirage." },
};

/* ----------------- Helpers ----------------- */
const $ = (s, r=document) => r.querySelector(s);

const categoryLabel = (cat) => ({
  base:"La Base",
  brol:"BAC √Ä SPAM",
  univ:"Univers & jeu",
  intra:"Liens en vrac",
  ia:"IA fictive",
  meta:"Tests",
}[cat] || "Autre");

const tagClass = (cat) => (["base","brol","univ","intra","ia","meta"].includes(cat) ? cat : "meta");

const buildUrl = (path) => {
  if (!path) return "";
  // absolute already?
  if (/^https?:\/\//i.test(path)) return path;
  return (BASE_URL ? BASE_URL.replace(/\/?$/, "/") : "") + path.replace(/^\//,"");
};

const escapeHtml = (s="") =>
  s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

const highlight = (text, q) => {
  if (!q) return escapeHtml(text);
  const t = text ?? "";
  const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "ig");
  return escapeHtml(t).replace(re, "<mark>$1</mark>");
};

const getHash = () => {
  const h = location.hash.slice(1);
  const p = new URLSearchParams(h.replaceAll("&","&"));
  return {
    module: p.get("module"),
    embed: p.get("embed"),
  };
};

const setHash = (obj) => {
  const p = new URLSearchParams();
  if (obj.module) p.set("module", obj.module);
  if (obj.embed) p.set("embed", obj.embed);
  const s = p.toString();
  history.replaceState(null, "", s ? `#${s}` : "#");
};

/* ----------------- State ----------------- */
const state = {
  q: "",
  cat: "all",
  filtered: [],
  activeIndex: 0,
  activeModuleId: null,
  mode: "module", // module | embed
};

const LS_KEY = "brol-dashboard:v1";

/* ----------------- Elements ----------------- */
const elQ = $("#q");
const elCat = $("#cat");
const elList = $("#list");
const elCount = $("#count");
const elHint = $("#hint");

const vTitle = $("#vTitle");
const vSub = $("#vSub");
const vCat = $("#vCat");
const vKind = $("#vKind");
const vFile = $("#vFile");
const frame = $("#frame");
const open = $("#open");

const elEmbeds = $("#embeds");

/* ----------------- Render list ----------------- */
function applyFilter(){
  const q = state.q.trim().toLowerCase();
  const cat = state.cat;

  let arr = modules.filter(m => {
    if (cat !== "all" && m.category !== cat) return false;
    if (!q) return true;
    const hay = `${m.title} ${m.file} ${(m.description||"")}`.toLowerCase();
    return hay.includes(q);
  });

  // tri stable ‚Äúpro‚Äù
  arr = arr.slice().sort((a,b) => {
    const ca = categoryLabel(a.category), cb = categoryLabel(b.category);
    if (ca !== cb) return ca.localeCompare(cb, "fr");
    return a.title.localeCompare(b.title, "fr");
  });

  state.filtered = arr;
  state.activeIndex = Math.min(state.activeIndex, Math.max(0, arr.length-1));

  elCount.textContent = `${arr.length} module${arr.length>1?"s":""}`;
  elHint.textContent = q ? `Recherche : ‚Äú${state.q}‚Äù` : "";

  renderGroups();
}

function renderGroups(){
  elList.innerHTML = "";
  if (!state.filtered.length){
    elList.innerHTML = `<div class="muted" style="padding:10px;">Aucun module ne correspond.</div>`;
    return;
  }

  // group by category
  const groups = new Map();
  for (const m of state.filtered){
    if (!groups.has(m.category)) groups.set(m.category, []);
    groups.get(m.category).push(m);
  }

  // render
  let globalIndex = 0;
  for (const [cat, items] of groups){
    const gt = document.createElement("div");
    gt.className = "groupTitle";
    gt.textContent = categoryLabel(cat);
    elList.appendChild(gt);

    for (const m of items){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "item";
      btn.setAttribute("role","option");
      btn.dataset.id = m.id;
      btn.dataset.index = String(globalIndex);
      btn.setAttribute("aria-selected", m.id === state.activeModuleId ? "true" : "false");

      const q = state.q.trim();
      btn.innerHTML = `
        <div class="metaL">
          <div class="title">${highlight(m.title, q)}</div>
          <div class="sub">${highlight(m.description || "", q)}</div>
        </div>
        <div class="metaR">
          <div class="file" title="${escapeHtml(m.file)}">${highlight(m.file, q)}</div>
          <div class="tag ${tagClass(m.category)}">${escapeHtml(m.kind || "")}</div>
        </div>
      `;

      btn.addEventListener("click", () => {
        state.activeIndex = Number(btn.dataset.index);
        selectModule(m.id, { user:true });
        focusActive();
      });

      elList.appendChild(btn);
      globalIndex++;
    }
  }

  // ensure roving selection exists
  if (!state.activeModuleId && state.filtered[0]){
    selectModule(state.filtered[0].id, { user:false });
  }
  focusActive(false);
}

function focusActive(scroll=true){
  const btn = elList.querySelector(`.item[data-index="${state.activeIndex}"]`);
  if (!btn) return;
  if (scroll) btn.scrollIntoView({ block:"nearest" });
}

/* ----------------- Viewer ----------------- */
function selectModule(id, { user } = { user:false }){
  const m = modules.find(x => x.id === id);
  if (!m) return;

  state.mode = "module";
  state.activeModuleId = id;

  // aria selection
  elList.querySelectorAll(".item").forEach(b => {
    b.setAttribute("aria-selected", b.dataset.id === id ? "true" : "false");
  });

  vTitle.textContent = m.title;
  vSub.textContent = m.description || "";
  vCat.textContent = categoryLabel(m.category);
  vKind.textContent = m.kind || "‚Äî";

  const url = buildUrl(m.file);
  vFile.textContent = m.file;
  frame.src = url;
  open.href = url;

  // persist + hash
  setHash({ module:id, embed:null });
  persist();

  if (user) {
    // optional: small UX feedback hook
  }
}

function selectEmbed(key){
  const e = embeds[key];
  if (!e) return;

  state.mode = "embed";
  state.activeModuleId = null;

  elList.querySelectorAll(".item").forEach(b => b.setAttribute("aria-selected","false"));

  vTitle.textContent = e.label;
  vSub.textContent = e.description || "";
  vCat.textContent = "Embed externe";
  vKind.textContent = "annexe / distraction";

  vFile.textContent = e.url;
  frame.src = e.url;
  open.href = e.url;

  setHash({ module:null, embed:key });
  persist();
}

/* ----------------- Embeds UI ----------------- */
function renderEmbeds(){
  elEmbeds.innerHTML = "";
  Object.entries(embeds).forEach(([key, e]) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "embedBtn";
    b.textContent = e.label;
    b.addEventListener("click", () => selectEmbed(key));
    elEmbeds.appendChild(b);
  });
}

/* ----------------- Persist / restore ----------------- */
function persist(){
  const data = {
    q: state.q,
    cat: state.cat,
    module: state.mode === "module" ? state.activeModuleId : null,
    embed: state.mode === "embed" ? getHash().embed : null,
  };
  try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
}

function restore(){
  // priority 1: hash
  const h = getHash();
  if (h.embed && embeds[h.embed]) return { mode:"embed", embed:h.embed };
  if (h.module && modules.some(m => m.id === h.module)) return { mode:"module", module:h.module };

  // priority 2: localStorage
  try{
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (data?.q) state.q = data.q;
    if (data?.cat) state.cat = data.cat;

    if (data?.embed && embeds[data.embed]) return { mode:"embed", embed:data.embed };
    if (data?.module && modules.some(m => m.id === data.module)) return { mode:"module", module:data.module };

    return null;
  }catch{ return null; }
}

/* ----------------- Keyboard UX ----------------- */
function onKeydown(e){
  // "/" focus search
  if (e.key === "/" && document.activeElement !== elQ){
    e.preventDefault();
    elQ.focus();
    return;
  }

  // list navigation only if not typing in input/select
  const typing = ["INPUT","SELECT","TEXTAREA"].includes(document.activeElement?.tagName);
  if (typing) return;

  if (e.key === "ArrowDown"){
    e.preventDefault();
    state.activeIndex = Math.min(state.activeIndex + 1, state.filtered.length - 1);
    focusActive();
  }
  if (e.key === "ArrowUp"){
    e.preventDefault();
    state.activeIndex = Math.max(state.activeIndex - 1, 0);
    focusActive();
  }
  if (e.key === "Enter"){
    e.preventDefault();
    const m = state.filtered[state.activeIndex];
    if (m) selectModule(m.id, { user:true });
  }
}

/* ----------------- Init ----------------- */
function init(){
  renderEmbeds();

  // wire inputs
  elQ.value = state.q;
  elCat.value = state.cat;

  elQ.addEventListener("input", () => {
    state.q = elQ.value;
    state.activeIndex = 0;
    applyFilter();
    persist();
  });

  elCat.addEventListener("change", () => {
    state.cat = elCat.value;
    state.activeIndex = 0;
    applyFilter();
    persist();
  });

  window.addEventListener("keydown", onKeydown);

  applyFilter();

  const restored = restore();
  if (restored?.mode === "embed") selectEmbed(restored.embed);
  else if (restored?.mode === "module") selectModule(restored.module, { user:false });
  else {
    // default
    selectModule("site-ultime", { user:false });
  }
}

init();
</script>
</body>
</html>
